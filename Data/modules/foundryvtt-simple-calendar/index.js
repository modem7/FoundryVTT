(()=>{var e={162:function(e,t,s){var a,n,i;n=[],a=function(){function t(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function a(e,t,s){var a=new XMLHttpRequest;a.open("GET",e),a.responseType="blob",a.onload=function(){c(a.response,t,s)},a.onerror=function(){console.error("could not download file")},a.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function i(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(s){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof s.g&&s.g.global===s.g?s.g:void 0,r=o.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),c=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype&&!r?function(e,t,s){var r=o.URL||o.webkitURL,c=document.createElement("a");t=t||e.name||"download",c.download=t,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?i(c):n(c.href)?a(e,t,s):i(c,c.target="_blank")):(c.href=r.createObjectURL(e),setTimeout((function(){r.revokeObjectURL(c.href)}),4e4),setTimeout((function(){i(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,s,o){if(s=s||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,o),s);else if(n(e))a(e,s,o);else{var r=document.createElement("a");r.href=e,r.target="_blank",setTimeout((function(){i(r)}))}}:function(e,t,s,n){if((n=n||open("","_blank"))&&(n.document.title=n.document.body.innerText="downloading..."),"string"==typeof e)return a(e,t,s);var i="application/octet-stream"===e.type,c=/constructor/i.test(o.HTMLElement)||o.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||i&&c||r)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=l?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=e:location=e,n=null},d.readAsDataURL(e)}else{var h=o.URL||o.webkitURL,m=h.createObjectURL(e);n?n.location=m:location.href=m,n=null,setTimeout((function(){h.revokeObjectURL(m)}),4e4)}});o.saveAs=c.saveAs=c,e.exports=c},void 0===(i="function"==typeof a?a.apply(t,n):a)||(e.exports=i)}},t={};function s(a){var n=t[a];if(void 0!==n)return n.exports;var i=t[a]={exports:{}};return e[a].call(i.exports,i,i.exports,s),i.exports}s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={};s.r(e),s.d(e,{Calendars:()=>c,DateSelector:()=>Je,DateSelectorPositions:()=>M,Icons:()=>f,LeapYearRules:()=>h,MoonYearResetOptions:()=>y,NoteRepeat:()=>l,PresetTimeOfDay:()=>C,YearNamingRules:()=>m,activateFullCalendarListeners:()=>Ke,addNote:()=>Xe,addSidebarButton:()=>Qe,advanceTimeToPreset:()=>et,changeDate:()=>tt,chooseRandomDate:()=>st,clockStatus:()=>at,configureCalendar:()=>nt,currentDateTime:()=>it,currentDateTimeDisplay:()=>ot,dateToTimestamp:()=>rt,formatDateTime:()=>ct,formatTimestamp:()=>lt,getAllCalendars:()=>dt,getAllMonths:()=>ht,getAllMoons:()=>mt,getAllSeasons:()=>ut,getAllThemes:()=>pt,getAllWeekdays:()=>gt,getCurrentCalendar:()=>ft,getCurrentDay:()=>yt,getCurrentMonth:()=>Ct,getCurrentSeason:()=>bt,getCurrentTheme:()=>St,getCurrentWeekday:()=>wt,getCurrentYear:()=>vt,getLeapYearConfiguration:()=>Dt,getNotes:()=>kt,getNotesForDay:()=>Tt,getTimeConfiguration:()=>Mt,isOpen:()=>It,isPrimaryGM:()=>Nt,pauseClock:()=>Lt,removeNote:()=>Pt,runMigration:()=>jt,searchNotes:()=>Ot,secondsToInterval:()=>At,setDate:()=>xt,setTheme:()=>Et,showCalendar:()=>Ft,startClock:()=>Rt,stopClock:()=>Wt,timestamp:()=>Yt,timestampPlusInterval:()=>$t,timestampToDate:()=>qt});const t="foundryvtt-simple-calendar",a=`module.${t}`;var n;!function(e){e.Theme="theme",e.OpenOnLoad="open-on-load",e.OpenCompact="open-compact",e.RememberPosition="remember-position",e.RememberCompactPosition="remember-compact-position",e.AppPosition="app-position",e.AppCompactPosition="app-compact-position",e.NoteReminderNotification="note-reminder-notification",e.NoteListOpenDirection="note-list-open-direction",e.AlwaysShowNoteList="always-show-note-list",e.PersistentOpen="persistent-open",e.CompactViewScale="compact-view-scale",e.CalendarMainApp="calendar-main-app",e.CalendarConfigurationMenu="calendar-configuration-menu",e.CalendarConfiguration="calendar-configuration",e.ActiveCalendar="active-calendar",e.GlobalConfiguration="global-configuration",e.YearConfiguration="year-config",e.WeekdayConfiguration="weekday-config",e.MonthConfiguration="month-config",e.CurrentDate="current-date",e.Notes="notes",e.AllowPlayersToAddNotes="allow-players-add-notes",e.DefaultNoteVisibility="default-note-visibility",e.LeapYearRule="leap-year-rule",e.TimeConfiguration="time-configuration",e.GeneralConfiguration="general-configuration",e.SeasonConfiguration="season-configuration",e.MoonConfiguration="moon-configuration",e.NoteCategories="note-categories"}(n||(n={}));const i=[{key:"dark",name:"FSC.Configuration.Theme.Dark",system:!1,module:!1},{key:"light",name:"FSC.Configuration.Theme.Light",system:!1,module:!1},{key:"classic",name:"FSC.Configuration.Theme.Classic",system:!1,module:!1},{key:"wfrp4e",name:"FSC.Configuration.Theme.WFRP4E",system:!0,module:!1},{key:"forbidden-lands",name:"FSC.Predefined.ForbiddenLands",system:!0,module:!1},{key:"dsa5",name:"FSC.Predefined.DSA-TDE5e",system:!0,module:!1},{key:"sfrpg",name:"FSC.Predefined.Starfinder",system:!0,module:!1},{key:"wrath-and-glory",name:"FSC.Predefined.Warhammer40kWG",system:!0,module:!1},{key:"eclipsephase",name:"FSC.Predefined.EclipsePhase",system:!0,module:!1}];var o,r,c,l;!function(e){e.Active="active",e.Current="current"}(o||(o={})),function(e){e.none="none",e.v1To2="v1-v2"}(r||(r={})),function(e){e.Gregorian="gregorian",e.DarkSun="darksun",e.Eberron="eberron",e.Exandrian="exandrian",e.ForbiddenLands="forbidden-lands",e.Harptos="harptos",e.GolarianPF1E="golarianpf1e",e.GolarianPF2E="golarianpf2e",e.Greyhawk="greyhawk",e.TravellerImperialCalendar="traveller-ic",e.WarhammerImperialCalendar="warhammer"}(c||(c={})),function(e){e[e.Never=0]="Never",e[e.Weekly=1]="Weekly",e[e.Monthly=2]="Monthly",e[e.Yearly=3]="Yearly"}(l||(l={}));var d,h,m,u,p,g,f,y,C,b,S,w,v,D,k,T,M,I,N,L,P;!function(e){e.None="none",e.Start="start",e.End="end",e.Middle="mid",e.Exact="exact"}(d||(d={})),function(e){e.None="none",e.Gregorian="gregorian",e.Custom="custom"}(h||(h={})),function(e){e.Default="default",e.Repeat="repeat",e.Random="random"}(m||(m={})),function(e){e.mainAppUpdate="main-app-update",e.primary="primary",e.clock="clock",e.checkClockRunning="check-clock-running",e.journal="journal",e.dateTimeChange="date-time-change",e.noteUpdate="note-update",e.emitHook="emit-hook",e.setActiveCalendar="set-calendar"}(u||(u={})),function(e){e.setDate="set-date",e.changeDateTime="change-date-time",e.advanceTimeToPreset="advance-time-to-preset"}(p||(p={})),function(e){e.None="none",e.Self="self",e.ThirdParty="third-party",e.Mixed="mixed"}(g||(g={})),function(e){e.None="none",e.Logo="logo",e.Clock="clock",e.Midday="midday",e.Midnight="midnight",e.Sunrise="sunrise",e.Sunset="sunset",e.NewMoon="new",e.WaxingCrescent="waxing-crescent",e.FirstQuarter="first-quarter",e.WaxingGibbous="waxing-gibbous",e.Full="full",e.WaningGibbous="waning-gibbous",e.LastQuarter="last-quarter",e.WaningCrescent="waning-crescent",e.Spring="spring",e.Summer="summer",e.Fall="fall",e.Winter="winter"}(f||(f={})),function(e){e.None="none",e.LeapYear="leap-year",e.XYears="x-years"}(y||(y={})),function(e){e.Midnight="midnight",e.Sunrise="sunrise",e.Midday="midday",e.Sunset="sunset"}(C||(C={})),function(e){e.DateTimeChange="simple-calendar-date-time-change",e.ClockStartStop="simple-calendar-clock-start-stop",e.PrimaryGM="simple-calendar-primary-gm",e.Ready="simple-calendar-ready",e.Init="simple-calendar-init"}(b||(b={})),function(e){e.Started="started",e.Stopped="stopped",e.Paused="paused"}(S||(S={})),function(e){e.Full="full",e.QuickIncrement="quick-increment"}(w||(w={})),function(e){e.Month="Month",e.Year="year"}(v||(v={})),function(e){e.calendar="calendar",e.previous="previous",e.next="next",e.day="day",e.dayContext="datContext",e.year="year"}(D||(D={})),function(e){e.wheel="wheel",e.change="change",e.dropdownClick="dropdown-click"}(k||(k={})),function(e){e.seasonStartingDate="ssd",e.seasonSunriseSunsetTime="ssst",e.moonFirstNewMoonDate="mfnmd"}(T||(T={})),function(e){e.Auto="auto",e.LeftDown="left-down",e.LeftUp="left-up",e.RightDown="right-down",e.RightUp="right-up"}(M||(M={})),function(e){e.Day="day",e.Month="month",e.Year="year",e.Hour="hour",e.Minute="minute",e.Round="round",e.Second="seconds"}(I||(I={})),function(e){e.whisper="whisper",e.render="render"}(N||(N={})),function(e){e[e.Date=0]="Date",e[e.Time=1]="Time",e[e.DateTime=2]="DateTime",e[e.Year=3]="Year",e[e.Month=4]="Month",e[e.Day=5]="Day"}(L||(L={})),function(e){e[e.Equal=0]="Equal",e[e.Before=1]="Before",e[e.After=2]="After",e[e.Nth=3]="Nth"}(P||(P={}));class j{static on(e){const t=game.socket;t&&t.on(a,e)}static async emit(e){const t=game.socket;return!!t&&(await t.emit(a,e),!0)}}class O{static info(e){e&&console.info("%cSimple Calendar","color:blue;",` | ${e}`)}static warn(e){e&&console.warn("%cSimple Calendar","color:orange;",` | ${e}`)}static error(e){e instanceof Error?console.error("%cSimple Calendar","color:red;",` | Error "${e.message}"\n${e.stack}`):console.error("%cSimple Calendar","color:red;",` | ${e}`)}static debug(e){e&&O.debugMode&&console.debug("%cSimple Calendar","color:green;",` | ${e}`)}}O.debugMode=!1;class A{constructor(){}async initialize(){return!0}async process(e,t){return!1}}function x(e){return e&&"object"==typeof e&&!Array.isArray(e)}function E(e){return e&&0===Object.keys(e).length&&Object.getPrototypeOf(e)===Object.prototype}function F(e,...t){if(!t.length)return e;const s=t.shift();if(x(e)&&x(s))for(const t in s)x(s[t])?(e[t]||Object.assign(e,{[t]:{}}),F(e[t],s[t])):Object.assign(e,{[t]:s[t]});return F(e,...t)}let R,W,Y,$,q,G;class z{static IsGm(){const e=game.user;return!!e&&e.isGM}static UserName(){const e=game.user;return e&&e.name?e.name:""}static UserID(){const e=game.user;return e&&e.id?e.id:""}static GetUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))}static GetModuleVersion(){const e=game.modules.get(t);return e?e.version:""}static Localize(e){if(game.i18n)return game.i18n.localize(e);{const t=e.split(".");return t[t.length-1]}}static GetBooleanSettings(e){return game.settings.get(t,e)}static GetObjectSettings(e){return game.settings.get(t,e)}static GetStringSettings(e){return game.settings.get(t,e)}static GetNumericSettings(e){return game.settings.get(t,e)}static async SaveBooleanSetting(e,s,a=!0){let n=!1;return a?this.IsGm()&&(n=!0):n=!0,!!n&&await game.settings.set(t,e,s).then((()=>!0))}static async SaveStringSetting(e,s,a=!0){let n=!1;return a?this.IsGm()&&(n=!0):n=!0,!!n&&await game.settings.set(t,e,s).then((()=>!0))}static async SaveNumericSetting(e,s,a=!0){let n=!1;return a?this.IsGm()&&(n=!0):n=!0,!!n&&await game.settings.set(t,e,s).then((()=>!0))}static async SaveObjectSetting(e,s,a=!0){let n=!1;if(a?this.IsGm()&&(n=!0):n=!0,n){const a=z.GetObjectSettings(e);if(JSON.stringify(s)!==JSON.stringify(a))return await game.settings.set(t,e,s).then((()=>!0))}return!1}static UiNotification(e,t="info",s=!1){ui.notifications?"info"===t?ui.notifications.info(e,{permanent:s,console:!1,localize:!0}):"warn"===t?ui.notifications.warn(e,{permanent:s,console:!1,localize:!0}):"error"===t&&ui.notifications.error(e,{permanent:s,console:!1,localize:!0}):O.error("The UI class is not initialized.")}static GetSceneForCombatCheck(){let e=null;const t=game.scenes;return t&&(q.globalConfiguration.combatPauseRule===o.Active?e=t.active||null:q.globalConfiguration.combatPauseRule===o.Current&&(e=t.current||null)),e}}function H(){return window.crypto.getRandomValues(new Uint32Array(1))[0].toString(16)}function U(e){return[void 0,z.Localize("FSC.OrdinalSuffix.st"),z.Localize("FSC.OrdinalSuffix.nd"),z.Localize("FSC.OrdinalSuffix.rd")][e%100>>3^1&&e%10]||z.Localize("FSC.OrdinalSuffix.th")}function V(e,t){const s=e.split("."),a=t.split("."),n=Math.max(s.length,a.length);for(let e=0;e<n;e++){if(s[e]&&!a[e]&&parseInt(s[e])>0||parseInt(s[e])>parseInt(a[e]))return 1;if(a[e]&&!s[e]&&parseInt(a[e])>0||parseInt(s[e])<parseInt(a[e]))return-1}return 0}function _(e,t=1){if(e<Math.pow(10,t)){const s=t-(Math.log(e)*Math.LOG10E|0);return`${"0".repeat(s)}${e}`}return`${e}`}class B{static get worldId(){return game.world.id}static get systemID(){return game.system.id}static get systemVersion(){return game.system.version||game.system.data.version}}class Z{static updatePF2EVariables(e=!1){e&&(this.worldCreatedOn=Math.floor(game.pf2e.worldClock.worldCreatedOn/1e3),this.pf2eVersionCompare214=V(B.systemVersion,Z.pf2eVersion214),this.pf2eVersionCompare3=V(B.systemVersion,Z.pf2eVersion3)),this.dateTheme=game.pf2e.worldClock.dateTheme}static get isPF2E(){return"pf2e"===B.systemID}static getWorldCreateSeconds(e,t=!0){let s=0;if(game.hasOwnProperty("pf2e")){let a=this.worldCreatedOn;"AR"!==this.dateTheme&&"IC"!==this.dateTheme||(a+=62167219200),s+=a,!t&&this.pf2eVersionCompare214>0&&this.pf2eVersionCompare3<=0?s+=e.time.secondsPerDay:t&&(this.pf2eVersionCompare214<=0||this.pf2eVersionCompare3>=0)&&(s-=e.time.secondsPerDay)}return s}static newYearZero(){let e;return game.hasOwnProperty("pf2e")&&("AD"===this.dateTheme?e=this.pf2eVersionCompare214>0&&this.pf2eVersionCompare3<=0?1970:1875:"CE"===this.dateTheme?e=1970:"AR"===this.dateTheme&&(e=this.pf2eVersionCompare214>0&&this.pf2eVersionCompare3<=0?0:2700)),e}static checkLeapYearRules(e){"AD"!==this.dateTheme&&"CE"!==this.dateTheme&&"AR"!==this.dateTheme||(e.rule=h.Gregorian)}static weekdayAdjust(){let e;return"CE"===this.dateTheme||"AD"===this.dateTheme?e=4:"AR"===this.dateTheme&&(e=this.pf2eVersionCompare3>0?6:5),e}}function J(e,t,s,a={}){a=F({year:!1,month:!1},a);const n=/DO|d{1,4}|M{1,4}|YN|YA|YZ|YY(?:YY)?|([HhMmsD])\1?|[aA]/g,i={D:e=>String(s.months[e.month].days[e.day].numericRepresentation),DD:e=>_(s.months[e.month].days[e.day].numericRepresentation),DO:e=>`${String(s.months[e.month].days[e.day].numericRepresentation)}${U(s.months[e.month].days[e.day].numericRepresentation)}`,d:e=>String(s.weekdays[s.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),dd:e=>_(s.weekdays[s.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),ddd:e=>`${s.weekdays[s.dayOfTheWeek(e.year,e.month,e.day)].abbreviation}`,dddd:e=>`${s.weekdays[s.dayOfTheWeek(e.year,e.month,e.day)].name}`,M:e=>String(s.months[e.month].numericRepresentation),MM:e=>_(s.months[e.month].numericRepresentation),MMM:e=>s.months[e.month].abbreviation,MMMM:e=>s.months[e.month].name,YN:e=>s.year.getYearName(e.year),YA:e=>s.year.prefix,YZ:e=>s.year.postfix,YY:e=>a.year?`<input type="number" style="width:4ch;" value="${_(e.year,2).substring(2)}" />`:_(e.year,2).substring(2),YYYY:e=>a.year?`<input type="number" style="width:${String(e.year).length+2}ch;" value="${e.year}" />`:String(e.year),H:e=>String(e.hour),HH:e=>_(e.hour),h:e=>{const t=Math.floor(s.time.hoursInDay/2),a=e.hour%t||t;return String(a)},hh:e=>{const t=Math.floor(s.time.hoursInDay/2);return _(e.hour%t||t)},m:e=>String(e.minute),mm:e=>_(e.minute),s:e=>String(e.seconds),ss:e=>_(e.seconds),A:e=>{const t=Math.floor(s.time.hoursInDay/2);return e.hour>=t?"PM":"AM"},a:e=>{const t=Math.floor(s.time.hoursInDay/2);return e.hour>=t?"pm":"am"}},o=[];t=t.replace(/\[([^]*?)\]/gm,(function(e,t){return o.push(t),"@@@"}));try{return(t=t.replace(n,(t=>i[t](e)))).replace(/@@@/g,(()=>o.shift()))}catch(e){return O.error(e),""}}function K(e,t=null,s=null){const a=s?.getMonthAndDayIndex("current"),n=s?.time.getCurrentTime();return void 0===e.year&&(e.year=t?.year||s?.year.numericRepresentation||0),void 0===e.month&&(e.month=t?.month||a?.month||0),void 0===e.day&&(e.day=t?.day||a?.day||0),void 0===e.hour&&(e.hour=t?.hour||n?.hour||0),void 0===e.minute&&(e.minute=t?.minute||n?.minute||0),void 0===e.seconds&&(e.seconds=t?.seconds||n?.seconds||0),e}function X(e,t,s,a,n=!0){let i=e.dateToDays(t,s,a,!0,!0),o=e.time.getTotalSeconds(i,n);if(Z.isPF2E&&e.generalSettings.pf2eSync){const r=Z.newYearZero();void 0!==r&&(e.year.yearZero=r,i=e.dateToDays(t,s,a,!0,!0)),i++,o=e.time.getTotalSeconds(i,n)-Z.getWorldCreateSeconds(e,!1)}return o}function Q(e,t,s,a,n=!1,i=!0,o="-"){const r=e.generalSettings.dateFormat.time.replace(/:?[s]/g,"");let c=e.generalSettings.dateFormat.date;i||(c=c.replace(/[,.\/\\\s]*?(YN|YA|YZ|YY(?:YY)?)/g,""));let l="",d="";return ee(t,s)?n||(l=`${c}`):(l=`${c}`,d=`${c}`),a||(l+=` ${r}`),a||t.hour===s.hour&&t.minute===s.minute||(d+=` ${r}`),""!==d&&(d=` ${o} ${d}`),`${J(t,l,e)}${J(s,d,e)}`}function ee(e,t){return e.year===t.year&&e.month==t.month&&e.day===t.day}function te(e,t,s){const a=e.dateToDays(t.year,t.month,t.day);return e.dateToDays(s.year,s.month,s.day)-a}function se(e,t,s,a){let n=d.None,i=X(e,t.year,t.month,t.day,!1),o=X(e,s.year,s.month,s.day,!1),r=X(e,a.year,a.month,a.day,!1);return i===o&&i===r?n=d.Exact:i===o?n=d.Start:i===r?n=d.End:i<r&&i>o&&(n=d.Middle),n}function ae(e,t){const s={year:0,month:0,dayOffset:0,day:0,dayOfTheWeek:0,hour:0,minute:0,second:0,yearZero:0,sunrise:0,sunset:0,midday:0,weekdays:[],showWeekdayHeadings:!0,currentSeason:{id:"",name:"",description:"",color:"",icon:f.None,sunsetTime:0,sunriseTime:0,startingDay:0,startingMonth:0},isLeapYear:!1,display:{date:"",day:"",daySuffix:"",weekday:"",monthName:"",month:"",year:"",yearName:"",yearPrefix:"",yearPostfix:"",time:""}};Z.isPF2E&&t.generalSettings.pf2eSync&&(e+=Z.getWorldCreateSeconds(t));const a=t.secondsToDate(e);s.year=a.year,s.month=a.month,s.day=a.day,s.hour=a.hour,s.minute=a.minute,s.second=a.seconds;const n=t.months[a.month],i=n.days[a.day];return s.dayOffset=n.numericRepresentationOffset,s.yearZero=t.year.yearZero,s.dayOfTheWeek=t.dayOfTheWeek(s.year,s.month,s.day),s.currentSeason=t.getSeason(s.month,s.day+1),s.weekdays=t.weekdays.map((e=>e.name)),s.showWeekdayHeadings=t.year.showWeekdayHeadings,s.isLeapYear=t.year.leapYearRule.isLeapYear(s.year),s.sunrise=t.getSunriseSunsetTime(s.year,s.month,s.day,!0),s.sunset=t.getSunriseSunsetTime(s.year,s.month,s.day,!1),s.midday=ne({year:s.year,month:s.month,day:s.day,hour:0,minute:0,seconds:0},t)+Math.floor(t.time.secondsPerDay/2),s.display.year=a.year.toString(),s.display.yearName=t.year.getYearName(s.year),s.display.yearPrefix=t.year.prefix,s.display.yearPostfix=t.year.postfix,s.display.month=n.numericRepresentation.toString(),s.display.monthName=n.name,t.weekdays.length>s.dayOfTheWeek&&(s.display.weekday=t.weekdays[s.dayOfTheWeek].name),s.display.day=i.numericRepresentation.toString(),s.display.daySuffix=U(i.numericRepresentation),s.display.time=J({year:s.year,month:s.month,day:s.day,hour:s.hour,minute:s.minute,seconds:s.second},t.generalSettings.dateFormat.time,t),s.display.date=J({year:s.year,month:s.month,day:s.day,hour:s.hour,minute:s.minute,seconds:s.second},t.generalSettings.dateFormat.date,t),s}function ne(e,t){let s;const a=t.clone(!1),n=K(e,null,a);return a.updateMonth(n.month,"current",!0,n.day),a.year.numericRepresentation=n.year,a.time.setTime(n.hour,n.minute,n.seconds),s=a.toSeconds(),s}function ie(e,t,s){const a={hour:0,minute:0,seconds:0};let n=0;e===C.Midday?n=t.time.secondsPerDay/2:e!==C.Sunrise&&e!==C.Sunset||(n=t.getSunriseSunsetTime(s.year,s.month,s.day,e===C.Sunrise,!1));const i=t.secondsToDate(n);return a.hour=i.hour,a.minute=i.minute,a.seconds=i.seconds,a}async function oe(e,t){if(t){let s=0,a=0;if(e===C.Sunrise||e===C.Sunset){let n=t.getMonthAndDayIndex();s=t.getSunriseSunsetTime(t.year.numericRepresentation,n.month||0,n.day||0,e===C.Sunrise,!1),a=s-t.time.seconds}else e===C.Midday?a=Math.floor(t.time.secondsPerDay/2)-t.time.seconds:e===C.Midnight&&(a=t.time.secondsPerDay-t.time.seconds);if(a<=0&&(a+=t.time.secondsPerDay),t.changeDateTime({seconds:a},{updateApp:!1,showWarning:!0}),e===C.Sunrise||e===C.Sunset){let n=t.getMonthAndDayIndex();s=t.getSunriseSunsetTime(t.year.numericRepresentation,n.month||0,n.day||0,e===C.Sunrise,!1),s!==t.time.seconds&&(a=s-t.time.seconds,t.changeDateTime({seconds:a},{updateApp:!1,showWarning:!0}))}}}Z.pf2eVersion214="2.14.4.8167",Z.pf2eVersion3="3.0.1",Z.pf2eVersionCompare214=0,Z.pf2eVersionCompare3=0,Z.worldCreatedOn=0,Z.dateTheme="AR";const re=parseInt(window.getComputedStyle(document.documentElement).getPropertyValue("font-size"));function ce(e){let t="#000000";if(0===e.indexOf("#")&&(e=e.slice(1)),3===e.length||6===e.length){3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);t=.299*parseInt(e.slice(0,2),16)+.587*parseInt(e.slice(2,4),16)+.114*parseInt(e.slice(4,6),16)>186?"#000000":"#FFFFFF"}return t}function le(e,t="#000000",s="#000000"){let a="",n=/fill="#000000"/g;switch(e){case f.Logo:a='<?xml version="1.0" encoding="utf-8"?>\n<svg viewBox="0 0 163.632 179.888" xmlns="http://www.w3.org/2000/svg" xmlns:bx="https://boxy-svg.com">\n  <g style="" transform="matrix(1.109639, 0, 0, 1.109639, -25.722576, 0.588635)">\n    <path style="paint-order: fill; stroke: rgb(0, 0, 0); stroke-width: 0.901194px; fill: rgb(26, 51, 68);" d="M 27.687 51.087 H 165.041 V 138.185 A 18.993 18.993 0 0 1 146.048 157.178 H 49.975 A 22.288 22.288 0 0 1 27.687 134.89 V 51.087 Z" bx:shape="rect 27.687 51.087 137.354 106.091 0 0 18.993 22.288 1@cbaa1f8b"/>\n    <path style="fill: rgb(60, 118, 158); stroke: rgb(0, 0, 0); stroke-width: 0.901194px;" d="M 38.13 15.855 H 154.421 A 10.683 10.683 0 0 1 165.104 26.538 V 51.06 H 27.721 V 26.264 A 10.409 10.409 0 0 1 38.13 15.855 Z" bx:shape="rect 27.721 15.855 137.383 35.205 10.409 10.683 0 0 1@30307c42"/>\n    <ellipse style="fill: rgb(26, 70, 112);" cx="53.467" cy="33.021" rx="6.84" ry="6.498"/>\n    <ellipse style="fill: rgb(26, 70, 112);" cx="139.291" cy="33.007" rx="6.84" ry="6.498"/>\n    <rect x="49.037" y="3.983" width="9.076" height="31.905" style="fill: rgb(216, 216, 216); stroke-width: 0.930572px; stroke: rgb(0, 0, 0);" rx="3.013" ry="3.013"/>\n    <rect x="134.781" y="3.975" width="9.076" height="31.905" style="fill: rgb(216, 216, 216); stroke-width: 0.930572px; stroke: rgb(0, 0, 0);" rx="3.013" ry="3.013"/>\n    <g transform="matrix(0.006346, 0, 0, -0.006346, 72.998573, 44.807747)" fill="#000000" stroke="none" style="">\n      <path d="M 2062 3457.803 C 2046 3441.803 2045 1808.803 2060 1762.803 C 2074 1722.803 2113 1702.803 2305 1634.803 C 2393 1603.803 2502 1558.803 2548 1533.803 L 2630 1489.803 L 4945 1488.803 L 5030 1530.803 C 5083 1555.803 5162 1582.803 5240 1600.803 C 5309 1616.803 5377 1634.803 5391 1640.803 C 5427 1654.803 5465 1697.803 5479 1738.803 C 5495 1788.803 5495 3440.803 5478 3457.803 C 5469 3466.803 5355 3469.803 5028 3469.803 L 4590 3469.803 L 4430 3469.803 L 3785 3469.803 L 3140 3469.803 L 2990 3469.803 L 2532 3469.803 C 2189 3469.803 2071 3466.803 2062 3457.803 Z" style=""/>\n      <path d="M 440 3270.803 C 392 3265.803 384 3260.803 367 3231.803 C 348 3198.803 348 3194.803 364 3066.803 C 382 2927.803 496 2346.803 511 2317.803 C 534 2274.803 629 2241.803 1140 2104.803 C 1412 2030.803 1950 1899.803 1979 1899.803 C 1990 1899.803 2000 1908.803 2004 1922.803 C 2007 1934.803 2010 2237.803 2010 2596.803 C 2010 3175.803 2008 3249.803 1994 3263.803 C 1980 3277.803 1899 3279.803 1237 3277.803 C 829 3276.803 470 3273.803 440 3270.803 Z" style=""/>\n      <path d="M 5572 3257.803 C 5556 3241.803 5554 1858.803 5571 1827.803 C 5585 1801.803 5582 1801.803 5927 1899.803 C 6490 2058.803 6711 2137.803 7060 2305.803 C 7378 2457.803 7619 2604.803 7840 2782.803 C 8106 2996.803 8216 3187.803 8107 3246.803 C 8077 3263.803 7999 3264.803 6830 3267.803 C 5861 3269.803 5582 3267.803 5572 3257.803 Z" style=""/>\n      <path d="M 2740 1352 C 2629 1135 2469 950 2268 810 C 2209 769 2158 727 2155 717 C 2137 668 2055 670 3789 670 C 5450 670 5430 670 5430 707 C 5430 713 5352 781 5258 857 C 4985 1075 4902 1166 4810 1350 C 4792 1386 4777 1416 4775 1418 C 4774 1419 2795 1440 2791 1440 C 2788 1440 2765 1401 2740 1352 Z" style=""/>\n      <path d="M1902 628 c-17 -17 -17 -529 0 -546 9 -9 447 -12 1909 -12 1735 0 1899 1 1914 16 14 14 16 48 13 276 -3 217 -5 260 -18 268 -24 15 -3803 13 -3818 -2z" style=""/>\n    </g>\n    <path d="M 76.481 119.745 C 76.481 117.167 75.57 115.183 73.753 113.807 C 71.935 112.429 68.656 110.971 63.928 109.443 C 59.194 107.905 55.449 106.397 52.691 104.911 C 45.171 100.847 41.411 95.378 41.411 88.491 C 41.411 84.913 42.415 81.725 44.436 78.917 C 46.454 76.114 49.346 73.918 53.123 72.34 C 56.9 70.767 61.136 69.975 65.838 69.975 C 70.568 69.975 74.783 70.833 78.483 72.547 C 82.18 74.26 85.055 76.679 87.101 79.804 C 89.148 82.927 90.173 86.472 90.173 90.446 L 76.527 90.446 C 76.527 87.415 75.57 85.056 73.663 83.373 C 71.752 81.692 69.064 80.85 65.61 80.85 C 62.275 80.85 59.681 81.554 57.833 82.963 C 55.982 84.377 55.058 86.233 55.058 88.534 C 55.058 90.69 56.14 92.495 58.311 93.95 C 60.476 95.404 63.67 96.766 67.885 98.046 C 75.649 100.377 81.304 103.275 84.85 106.728 C 88.402 110.188 90.173 114.5 90.173 119.648 C 90.173 125.383 88.005 129.874 83.673 133.136 C 79.33 136.398 73.493 138.029 66.151 138.029 C 61.06 138.029 56.424 137.098 52.237 135.23 C 48.05 133.367 44.855 130.812 42.659 127.568 C 40.462 124.324 39.361 120.559 39.361 116.284 L 53.055 116.284 C 53.055 123.593 57.422 127.249 66.151 127.249 C 69.401 127.249 71.935 126.587 73.753 125.267 C 75.57 123.953 76.481 122.11 76.481 119.745 Z M 151.384 115.057 C 150.87 122.184 148.235 127.794 143.49 131.888 C 138.748 135.982 132.493 138.029 124.724 138.029 C 116.234 138.029 109.553 135.171 104.69 129.454 C 99.822 123.736 97.391 115.886 97.391 105.914 L 97.391 101.865 C 97.391 95.497 98.512 89.886 100.753 85.032 C 103 80.18 106.209 76.459 110.378 73.866 C 114.546 71.277 119.39 69.975 124.909 69.975 C 132.547 69.975 138.709 72.024 143.376 76.116 C 148.048 80.213 150.746 85.956 151.476 93.357 L 137.826 93.357 C 137.493 89.084 136.305 85.979 134.258 84.055 C 132.209 82.128 129.095 81.169 124.909 81.169 C 120.359 81.169 116.959 82.795 114.699 86.054 C 112.435 89.317 111.277 94.372 111.218 101.228 L 111.218 106.236 C 111.218 113.389 112.304 118.619 114.469 121.924 C 116.634 125.231 120.056 126.881 124.724 126.881 C 128.94 126.881 132.088 125.921 134.165 123.996 C 136.241 122.069 137.434 119.091 137.738 115.057 Z" style="fill: rgb(225, 180, 56); line-height: 25.051px; stroke: rgb(0, 0, 0); white-space: pre;"/>\n  </g>\n</svg>';break;case f.Clock:a='<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">\n    <path fill="#000000" d="M50 92.5C26.6 92.5 7.5 73.4 7.5 50S26.6 7.5 50 7.5 92.5 26.6 92.5 50 73.4 92.5 50 92.5zm0-79.3c-20.3 0-36.8 16.5-36.8 36.8S29.7 86.8 50 86.8 86.8 70.3 86.8 50 70.3 13.2 50 13.2z"/>\n    <path id="c_arm_s" fill="#000000" d="M65.7 26.4c.5-.9.2-2-.7-2.5s-2-.2-2.5.6l-15 24c0 .1-.1.1-.1.2-.4.7-.4 1.6-.1 2.3.2.6.7 1.1 1.2 1.4.2.1.3.2.5.2 1.3.4 2.8-.2 3.5-1.5l13.2-24.7z"/>\n    <path id="c_arm_m" fill="#000000" d="M60.02350382678833,34.42733963723822 C60.37102334373321,33.801804506737426 60.16251163356629,33.03726156945868 59.53697650306549,32.68974205251379 S58.14689843528595,32.55073424573584 57.79937891834106,33.106765472847655 L47.373793409994505,49.78770228620215 C47.373793409994505,49.857206189591125 47.30428950660553,49.857206189591125 47.30428950660553,49.9267100929801 C47.02627389304962,50.41323741670294 47.02627389304962,51.038772547203735 47.23478560321655,51.525299870926574 C47.373793409994505,51.942323291260436 47.72131292693939,52.28984280820532 48.068832443884276,52.49835451837225 C48.20784025066223,52.56785842176123 48.27734415405121,52.63736232515021 48.41635196082916,52.63736232515021 C49.31990270488586,52.915377938706115 50.36246125572052,52.49835451837225 50.84898857944336,51.59480377431555 L60.02350382678833,34.42733963723822 z"/>\n</svg>';break;case f.Midday:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <circle cx="24.534" cy="24.483" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n    <path d="M 24.5 8.21 L 24.5 2 M 24.5 47 L 24.5 40.79 M 36.02 12.98 L 40.41 8.59 M 8.59 40.41 L 12.98 36.02 M 12.98 13.02 L 8.59 8.63 M 40.41 40.41 L 36.02 36.02 M 8.21 24.5 L 2 24.5 M 47 24.5 L 40.79 24.5" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n</svg>';break;case f.Midnight:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <path d="M 38.767 28.7 C 29.562 28.767 22.048 21.355 21.987 12.15 C 21.991 10.749 22.176 9.354 22.537 8 C 9.887 9.573 3.682 24.25 11.369 34.42 C 19.057 44.589 34.87 42.624 39.833 30.882 C 40.146 30.141 40.405 29.379 40.607 28.6 C 39.997 28.66 39.387 28.7 38.767 28.7 Z" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.5" fill="#000000"/>\n</svg>';break;case f.Sunrise:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <defs>\n        <clipPath id="a">\n            <rect y="7.5" width="64" height="32" fill="none"/>\n        </clipPath>\n    </defs>\n    <g clip-path="url(#a)" transform="matrix(1, 0, 0, 1, -7.5, -12.5)">\n        <circle cx="32" cy="39" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n        <path d="M32,22.71V16.5m0,45V55.29M43.52,27.48l4.39-4.39M16.09,54.91l4.39-4.39m0-23-4.39-4.39M47.91,54.91l-4.39-4.39M15.71,39H9.5m45,0H48.29" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n    </g>\n    <line x1="8.33" y1="30.091" x2="40.692" y2="30.091" fill="none" stroke="#000000" stroke-linecap="round" stroke-width="2"/>\n    <path d="M 18.308 40.395 L 22.673 40.395 L 22.673 45.795 L 30.632 38.595 L 22.673 31.396 L 22.673 36.793 L 18.308 36.793 L 18.308 40.395 Z" fill="#000000" stroke="#000000" style="" transform="matrix(0, -1, 1, 0, -14.125499, 63.065498)"/>\n</svg>';break;case f.Sunset:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 49 49">\n    <defs>\n        <clipPath id="a">\n            <rect y="7.5" width="64" height="32" fill="none"/>\n        </clipPath>\n    </defs>\n    <g clip-path="url(#a)" transform="matrix(1, 0, 0, 1, -7.5, -12.5)">\n        <circle cx="32" cy="39" r="10.5" stroke="#000000" stroke-miterlimit="10" stroke-width="0.5" fill="#000000"/>\n        <path d="M32,22.71V16.5m0,45V55.29M43.52,27.48l4.39-4.39M16.09,54.91l4.39-4.39m0-23-4.39-4.39M47.91,54.91l-4.39-4.39M15.71,39H9.5m45,0H48.29" fill="none" stroke="#000000" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3"/>\n    </g>\n    <line x1="8.33" y1="30.091" x2="40.692" y2="30.091" fill="none" stroke="#000000" stroke-linecap="round" stroke-width="2"/>\n    <path d="M 18.308 40.395 L 22.673 40.395 L 22.673 45.795 L 30.632 38.595 L 22.673 31.396 L 22.673 36.793 L 18.308 36.793 L 18.308 40.395 Z" fill="#000000" stroke="#000000" style="" transform="matrix(0, 1, -1, 0, 63.065498, 14.125499)"/>\n</svg>';break;case f.FirstQuarter:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="16.218" cy="42.249" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, -0.000001, 0.000001, 1, 3.281975, -22.748966)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 19 2.001 C 19.041 36.978 19.02 29.71 19.041 36.978 C 28.782 37.057 36.752 29.24 36.862 19.499 C 36.762 9.734 28.765 1.9 19 2.001 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.Full:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="19.5" cy="19.5" r="17.5" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.LastQuarter:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="-16.218" cy="-42.249" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, -0.000001, 0.000001, 1, 35.718063, 61.749001)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 19.861 36.978 C 19.821 2.001 19.842 9.269 19.821 2.001 C 10.08 1.922 2.11 9.739 2 19.48 C 2.1 29.245 10.097 37.079 19.861 36.978 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.NewMoon:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="19.5" cy="19.5" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.WaningCrescent:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="42.249" cy="16.218" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, 0.000001, -0.000001, 1, -22.748966, 3.281975)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 21.962 36.805 C 6.511 30.451 6.506 8.556 21.966 2.205 L 22.063 2.183 C 21.227 2.064 20.384 2.003 19.539 2 C 6.061 1.996 -2.367 16.584 4.369 28.258 C 7.496 33.678 13.279 37.018 19.537 37.017 C 20.38 37.015 21.223 36.955 22.058 36.837 L 21.962 36.805 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.WaningGibbous:a='<svg viewBox="0 0 39 39" xmlns="http://www.w3.org/2000/svg">\n    <circle cx="42.249" cy="16.218" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, 0.000001, -0.000001, 1, -22.748966, 3.281975)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 25.68 31.849 C 18.455 25.516 18.025 16.023 24.098 8.578 C 26.607 6.154 27.463 5.954 28.652 5.111 C 21.501 0.02 11.634 1.301 6.02 8.05 C -0.076 15.514 0.863 26.472 8.141 32.791 C 13.994 37.998 22.666 38.479 29.058 33.949 L 25.68 31.849 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.WaxingCrescent:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="-42.249" cy="-16.218" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, 0.000001, -0.000001, 1, 61.749001, 35.718063)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 17.1 2.212 C 32.552 8.566 32.557 30.461 17.097 36.812 L 17 36.834 C 17.836 36.953 18.679 37.014 19.524 37.017 C 33.001 37.021 41.429 22.433 34.694 10.759 C 31.567 5.338 25.784 1.999 19.526 2 C 18.683 2.002 17.84 2.062 17.005 2.18 L 17.1 2.212 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.WaxingGibbous:a='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 39 39">\n    <circle cx="-42.249" cy="-16.218" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="matrix(1, 0.000001, -0.000001, 1, 61.749001, 35.718063)"/>\n    <path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 13.378 7.199 C 20.603 13.531 21.034 23.025 14.96 30.469 C 12.452 32.894 11.596 33.093 10.406 33.937 C 17.557 39.028 27.424 37.746 33.038 30.998 C 39.134 23.533 38.195 12.575 30.918 6.256 C 25.064 1.049 16.392 0.569 10 5.098 L 13.378 7.199 Z"/>\n</svg>\n',n=/fill="#ffffff"/g;break;case f.Spring:a=`<span class="fa fa-seedling" style="color:${t};"></span>`;break;case f.Summer:a=`<span class="fa fa-sun" style="color:${t};"></span>`;break;case f.Fall:a=`<span class="fa fa-leaf" style="color:${t};"></span>`;break;case f.Winter:a=`<span class="fa fa-snowflake" style="color:${t};"></span>`}return a=a.replace(/stroke="#000000"/g,`stroke="${t}"`),a=a.replace(n,`fill="${s}"`),a}function de(){let e=z.GetStringSettings(`${B.worldId}.${n.Theme}`);if(!e){e=z.GetStringSettings(n.Theme);const t=i.find((t=>t.key===e));if(t)if(t.system&&B.systemID!==t.key)e=i[0].key;else if(t.module){const s=game.modules.get(t.key);s&&s.active||(e=i[0].key)}}return e}function he(){const e={};for(let t=0;t<i.length;t++)if(!i[t].system&&!i[t].module||i[t].system&&B.systemID===i[t].key)e[i[t].key]=i[t].name;else if(i[t].module){const s=game.modules.get(i[t].key);s&&s.active&&(e[i[t].key]=i[t].name)}return e}function me(e){return e*(re/16)}function ue(e,t,s=!1){let a=!1;return e&&!e.classList.contains("fsc-a")&&(e.classList.contains("fsc-b")||s?(e.classList.add("fsc-a"),e.classList.remove("fsc-b"),a=!1,setTimeout(pe.bind(null,e,!0,"fsc-c"),t)):(e.classList.add("fsc-a","fsc-b"),e.classList.remove("fsc-c"),a=!0),setTimeout(pe.bind(null,e,!1,"fsc-a"),t)),a}function pe(e,t,s){t?e.classList.add(s):e.classList.remove(s)}function ge(e,t,s=document){const a=s.querySelector(e)?.closest(".form-group");a&&(a.classList.contains("fsc-c")&&t||a.classList.contains("fsc-b")&&!t?ue(a,200):t?(a.classList.remove("fsc-c"),a.classList.add("fsc-b")):(a.classList.add("fsc-c"),a.classList.remove("fsc-b")))}class fe{static GenerateNoteIconTitle(e,t){let s=`${e} ${z.Localize("FSC.Configuration.General.Notes")}`;if(t.length<3){s=z.Localize("FSC.Configuration.General.Notes")+":\n";for(let e=0;e<t.length;e++){0!==e&&(s+="\n");s+=`${t[e].title.replace(/"/g,"&quot;")}`}}return s}}function ye(e,t){return null!==e&&!!(e.isGM||t.player&&e.hasRole(1)||t.trustedPlayer&&e.hasRole(2)||t.assistantGameMaster&&e.hasRole(3)||t.users&&t.users.includes(e.id?e.id:""))}class Ce{static Render(e,t={id:""}){let s="";if((t=F({},this.defaultOptions,t)).view===v.Month)s=this.Build(e,t);else if(t.view===v.Year){const a=t.date?t.date.year:e.year.visibleYear;s=`<div class="fsc-d" id="${t.id}"><div class="fsc-e">`,t.allowChangeMonth&&(s+=`<a class="fa fa-chevron-left" data-tooltip="${z.Localize("FSC.ChangePreviousMonth")}"></a>`),s+=`<span>${a}</span>`,t.allowChangeMonth&&(s+=`<a class="fa fa-chevron-right" data-tooltip="${z.Localize("FSC.ChangeNextMonth")}"></a>`),s+="</div>",s+='<div  class="fsc-f">',t.showYear=!1,t.allowChangeMonth=!1;const n=t.id;for(let i=0;i<e.months.length;i++)t.date={year:a,month:i,day:0},t.id=`${n}-${i}`,s+=this.Build(e,t);s+="</div>",s+="</div>"}if("none"!==t.theme){s=`<div class="simple-calendar ${"auto"===t.theme?q.clientSettings.theme:t.theme}">${s}</div>`}return s}static Build(e,t){let s=e.generalSettings.dateFormat.monthYear;t.showYear||(s=s.replace(/YN|YA|YZ|YY(?:YY)?/g,""));let a,n,i,o,r,c,l,h=0,m=[],u="",p="",g="",f="",y=[];if(t.date?(t.date.month>=0&&t.date.month<e.months.length&&(h=t.date.month),a=t.date.year):(a=e.year.visibleYear,h=e.getMonthIndex("visible")),m=e.daysIntoWeeks(h,a,e.weekdays.length),t.selectedDates?(n=t.selectedDates.start.year,r=t.selectedDates.end.year,i=t.selectedDates.start.month>0&&t.selectedDates.start.month<e.months.length?t.selectedDates.start.month:0,c=t.selectedDates.end.month>0&&t.selectedDates.end.month<e.months.length?t.selectedDates.end.month:0,o=t.selectedDates.start.day||0,l=t.selectedDates.end.day||0):(n=r=e.year.selectedYear,i=c=e.getMonthIndex("selected"),i>-1&&(o=l=e.months[i].getDayIndex("selected"))),t.showSeasonName||t.colorToMatchSeason){const t=e.getSeason(h,o||0);g=t.name,f=t.description,p=le(t.icon,t.color,t.color),u=`border-color: ${t.color};`}const C=e.months[h].description,b=C&&t.showDescriptions,S=f&&t.showDescriptions;let w=`<div id="${t.id}" class="fsc-g" data-calendar="${e.id}">`;w+=`<div  class="fsc-h ${t.cssClasses}" style="${t.colorToMatchSeason?u:""}" >`,w+=`<input class="fsc-i" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/>`,w+='<div class="fsc-j">',w+='<div class="fsc-k">',t.allowChangeMonth?w+=`<a class="fa fa-chevron-left" data-tooltip="${z.Localize("FSC.ChangePreviousMonth")}"></a>`:w+="<span></span>",w+=`<span class="fsc-l ${b?"fsc-m":""}" data-visible="${h}/${a}">${J({year:a,month:h,day:0,hour:0,minute:0,seconds:0},s,e,{year:t.editYear})}</span>`,t.allowChangeMonth?w+=`<a class="fa fa-chevron-right" data-tooltip="${z.Localize("FSC.ChangeNextMonth")}"></a>`:w+="<span></span>",w+="</div>",t.showSeasonName&&(w+=`<div class="fsc-n">${p}<span class="fsc-o ${S?"fsc-m":""}">${g}</span></div>`),e.year.showWeekdayHeadings&&(w+=`<div class="fsc-p">${e.weekdays.map((e=>`<div class="fsc-q ${e.restday?"fsc-r":""} ${e.description&&t.showDescriptions?"fsc-m":""}" data-tooltip="${e.name}">${e.abbreviation}</div>`)).join("")}</div>`,y=e.weekdays.map((e=>e.description))),w+="</div>",w+='<div class="fsc-s">';for(let s=0;s<m.length;s++)if(m[s]){w+=`<div class="fsc-t ${e.year.showWeekdayHeadings?"":"fsc-u"}">`;for(let u=0;u<m[s].length;u++){if(w+=`<div class="fsc-v ${e.weekdays[u].restday?"fsc-r":""}">`,m[s][u]){let p="fsc-w";const g=e.months[h].days.findIndex((e=>e.numericRepresentation===m[s][u].numericRepresentation));if(void 0!==i&&void 0!==o&&void 0!==c&&void 0!==l){switch(se(e,{year:t.showYear?a:0,month:h,day:g,hour:0,minute:0,seconds:0},{year:n,month:i,day:o,hour:0,minute:0,seconds:0},{year:r,month:c,day:l,hour:0,minute:0,seconds:0})){case d.Exact:p+=" fsc-x",m[s][u].selected=!0;break;case d.Start:p+=" fsc-x fsc-y";break;case d.Middle:p+=" fsc-x fsc-z";break;case d.End:p+=" fsc-x fsc-_"}}t.showCurrentDate&&a===e.year.numericRepresentation&&m[s][u].current&&(p+=" fsc-aa"),w+=`<div class="${p}" data-day="${g}">`,t.showNoteCount&&(w+=`<div class="fsc-ba">${Ce.NoteIndicator(e,a,h,g)}</div>`),w+=m[s][u].name,t.showMoonPhases&&(w+=`<div class="fsc-ca">${Ce.MoonPhaseIcons(e,a,h,g,0!==u&&u===m[s].length-1,s===m.length-1)}</div>`),w+="</div>"}else w+='<div class="fsc-da"></div>';w+="</div>"}w+="</div>"}if(w+="</div>",w+="</div>",t.showDescriptions||t.showDayDetails){if(w+='<div class="fsc-ea">',t.showDescriptions){if(C&&(w+=`<div class="fsc-ga fsc-ha" data-type="month"><div class="fsc-ia">${C}</div></div>`),y.length)for(let e=0;e<y.length;e++)y[e]&&(w+=`<div class="fsc-ga fsc-ha" data-type="week${e}"><div class="fsc-ia">${y[e]}</div></div>`);f&&(w+=`<div class="fsc-ga fsc-ha" data-type="season"><div class="fsc-ia">${f}</div></div>`)}if(t.showDayDetails){const e=ye(game.user,q.globalConfiguration.permissions.changeDateTime),t=ye(game.user,q.globalConfiguration.permissions.addNotes);w+='<div class="fsc-ga fsc-ha" data-type="day"><div class="fsc-ja" data-date=""><div class="fsc-ka"></div>',w+=`<div class="fsc-la fsc-ma"><span class="fa fa-sun"></span>${z.Localize("FSC.Configuration.Season.SunriseSunset")}<span class="fa fa-caret-right"></span><div class="fsc-na"><div class="fsc-oa"><strong>${z.Localize("FSC.Sunrise")}</strong>: <span class="fsc-pa"></span></div><div class="fsc-oa"><strong>${z.Localize("FSC.Sunset")}</strong>: <span class="fsc-qa"></span></div></div></div>`,(e||t)&&(w+='<div class="fsc-ra"></div>',e&&(w+=`<div class="fsc-sa" data-action="current"><span class="fa fa-calendar-check"></span>${z.Localize("FSC.SetCurrentDate")}</div>`),t&&(w+=`<div class="fsc-sa" data-action="note"><span class="fa fa-sticky-note"></span>${z.Localize("FSC.Notes.AddNew")}</div>`)),w+="</div></div>"}w+="</div>"}return w+="</div>",w}static ActivateListeners(e,t=null,s=null,a=null){const n=document.getElementById(e);if(n){const i=n.querySelector(".fsc-j .fsc-k .fa-chevron-left");i&&i.addEventListener("click",Ce.EventListener.bind(Ce,e,D.previous,{onMonthChange:t,onDayClick:s,onYearChange:a}));const o=n.querySelector(".fsc-j .fsc-k .fa-chevron-right");o&&o.addEventListener("click",Ce.EventListener.bind(Ce,e,D.next,{onMonthChange:t,onDayClick:s,onYearChange:a}));const r=n.querySelector(".fsc-j .fsc-k .fsc-l input[type=number]");r&&(r.addEventListener("click",(e=>e.stopPropagation())),r.addEventListener("change",Ce.EventListener.bind(Ce,e,D.year,{onMonthChange:t,onDayClick:s,onYearChange:a}))),n.querySelectorAll(".fsc-s .fsc-w").forEach((n=>{n.addEventListener("click",Ce.EventListener.bind(Ce,e,D.day,{onMonthChange:t,onDayClick:s,onYearChange:a})),n.addEventListener("contextmenu",Ce.ShowDescription.bind(Ce,"day"))})),n.addEventListener("click",Ce.EventListener.bind(Ce,e,D.calendar,{onMonthChange:t,onDayClick:s,onYearChange:a})),n.querySelectorAll(".fsc-sa").forEach((e=>{e.addEventListener("click",Ce.DayContextClick)})),n.querySelector(".fsc-l")?.addEventListener("click",Ce.ShowDescription.bind(Ce,"month")),n.querySelector(".fsc-o")?.addEventListener("click",Ce.ShowDescription.bind(Ce,"season")),n.querySelectorAll(".fsc-p .fsc-q").forEach(((e,t)=>{e.addEventListener("click",Ce.ShowDescription.bind(Ce,`week${t}`))}))}}static EventListener(e,t,s,a){a.preventDefault();const n=document.getElementById(e);if(n){const e=n.getAttribute("data-calendar")||"",i=R.getCalendar(e);if(i){let e={id:""};const o=n.querySelector(".fsc-i");o&&(e=JSON.parse(decodeURIComponent(o.value)));const r=n.querySelector(".fsc-l");if(r){const s=r.getAttribute("data-visible");if(s){const n=s.split("/");if(2===n.length){let s=parseInt(n[0]),o=parseInt(n[1]);if(!isNaN(o)&&!isNaN(s)){if(t===D.previous||t===D.next){let e=!0,a=0;for(;e&&a<i.months.length;){t===D.previous?0===s?(s=i.months.length-1,o--):s--:s===i.months.length-1?(s=0,o++):s++;const n=i.year.leapYearRule.isLeapYear(o);(n&&i.months[s].numberOfLeapYearDays>0||!n&&i.months[s].numberOfDays>0)&&(e=!1),a++}}else if(t===D.day||t===D.dayContext){let t=a.target;const n=t.closest(".fsc-w");n&&(t=n);const i=t.getAttribute("data-day");if(i){const t=parseInt(i);if(!isNaN(t)){const a={year:0,month:0,day:0},n={year:0,month:0,day:0};e.allowSelectDateRange?e.selectedDates&&null===e.selectedDates.end.year?(a.year=e.selectedDates.start.year,a.month=e.selectedDates.start.month,a.day=e.selectedDates.start.day||0,n.year=o,n.month=s,n.day=t,(a.day>t&&a.month===s&&a.year===o||a.month>s&&a.year===o||a.year>o)&&(n.year=e.selectedDates.start.year,n.month=e.selectedDates.start.month,n.day=e.selectedDates.start.day||0,a.year=o,a.month=s,a.day=t)):(a.year=o,a.month=s,a.day=t,n.year=NaN,n.month=NaN,n.day=NaN):(a.year=o,a.month=s,a.day=t,n.year=o,n.month=s,n.day=t),e.selectedDates={start:a,end:n}}}}else if(t===D.year){const e=r.querySelector("input[type=number]");if(e){const t=parseInt(e.value);isNaN(t)||(o=t)}}e.date={year:o,month:s,day:0}}}}}const c=Ce.Render(i,e),l=document.createElement("div");l.innerHTML=c,l.firstChild&&(n.replaceWith(l.firstChild),Ce.ActivateListeners(e.id,s.onMonthChange,s.onDayClick)),null===s.onMonthChange||t!==D.previous&&t!==D.next?null!==s.onDayClick&&t===D.day?s.onDayClick(e):null!==s.onYearChange&&t===D.year&&s.onYearChange(e):s.onMonthChange(t,e)}}return!1}static DayContextClick(e){const t=e.target;if(t){const e=t.getAttribute("data-action"),s=t.closest(".fsc-ja")?.getAttribute("data-date");if(e&&s){const a=s.split("/");if(3===a.length){const s=parseInt(a[0]),n=parseInt(a[1]),i=parseInt(a[2]);if(!isNaN(s)&&!isNaN(n)&&!isNaN(i))if("current"===e)W.setCurrentDate(s,n,i);else if("note"===e){const e=t.closest(".fsc-g")?.getAttribute("data-calendar");if(e){const t=R.getCalendar(e);t&&G.createNote("New Note","",{calendarId:e,startDate:{year:s,month:n,day:i,hour:0,minute:0,seconds:0},endDate:{year:s,month:n,day:i,hour:0,minute:0,seconds:0},allDay:!0,repeats:l.Never,order:0,categories:[],remindUsers:[]},t).catch((e=>console.error(e)))}}}}}}static ShowDescription(e,t){t.preventDefault(),t.stopPropagation();const s=t.target;if(s){const t=s.closest(".fsc-g"),a=t?.querySelector(".fsc-ea");if(t&&a){a.querySelectorAll("div[data-type]").forEach((e=>e.classList.add("fsc-ha")));const n=a.querySelector(`div[data-type="${e}"]`);if(n&&(n.classList.remove("fsc-ha"),a.style.top=`${s.offsetTop+s.offsetHeight}px`,a.style.left=`${s.offsetLeft}px`,"day"===e)){const e=t.getAttribute("data-calendar"),a=s.closest(".fsc-w")?.getAttribute("data-day"),n=s.closest(".fsc-h")?.querySelector(".fsc-j .fsc-l")?.getAttribute("data-visible")?.split("/"),i=t.querySelector(".fsc-ja");if(e&&a&&n&&n.length>=2&&i){const t=R.getCalendar(e),s=parseInt(a),o=parseInt(n[0]),r=parseInt(n[1]);if(t&&!isNaN(s)&&!isNaN(o)&&!isNaN(r)){i.setAttribute("data-date",`${r}/${o}/${s}`);const e=i.querySelector(".fsc-ka");e&&(e.textContent=J({year:r,month:o,day:s,hour:0,minute:0,seconds:0},t.generalSettings.dateFormat.date,t));const a=i.querySelector(".fsc-ma .fsc-pa"),n=i.querySelector(".fsc-ma .fsc-qa");a&&n&&(a.textContent=J({year:0,month:0,day:0,...ie(C.Sunrise,t,{year:r,month:o,day:s})},t.generalSettings.dateFormat.time,t),n.textContent=J({year:0,month:0,day:0,...ie(C.Sunset,t,{year:r,month:o,day:s})},t.generalSettings.dateFormat.time,t))}}}}}return!1}static HideDescription(){const e=document.querySelector(".simple-calendar .fsc-g .fsc-ea");e&&e.querySelectorAll("div[data-type]").forEach((e=>e.classList.add("fsc-ha")))}static NoteIndicator(e,t,s,a){let n="";const i=G.getNotesForDay(e.id,t,s,a);if(i.length){const e=i.filter((e=>!e.userReminderRegistered)),t=i.filter((e=>e.userReminderRegistered));if(e.length){const t=e.length<100?e.length:99;n=`<span class="fsc-ta" data-tooltip="${fe.GenerateNoteIconTitle(t,e)}">${t}</span>`}if(t.length){const e=t.length<100?t.length:99;n+=`<span class="fsc-ta fsc-ua" data-tooltip="${fe.GenerateNoteIconTitle(e,t)}">${e}</span>`}}return n}static MoonPhaseIcons(e,t,s,a,n=!1,i=!1){let o;const r=[];for(let n=0;n<e.moons.length;n++){const i=e.moons[n].getDateMoonPhase(e,t,s,a),o=e.months[s].days[a];if(i&&(i.singleDay||o.selected||o.current)){let t=le(i.icon,"#000000",e.moons[n].color);r.push(`<span class="fsc-va ${i.icon}" data-tooltip="${e.moons[n].name} - ${i.name}">${t}</span>`)}}return o=r.length<3?r.join(""):`<div class="fsc-wa">${r[0]}<span class="fsc-va fa fa-caret-down"></span><div class="fsc-xa ${n?"fsc-ya":"fsc-za"} ${i?"fsc-_a":"fsc-ab"}">${r.join("")}</div></div>`,o}}Ce.defaultOptions={id:"",allowChangeMonth:!0,allowSelectDateRange:!1,colorToMatchSeason:!0,cssClasses:"",editYear:!1,showCurrentDate:!0,showSeasonName:!0,showNoteCount:!0,showMoonPhases:!0,showYear:!0,showDescriptions:!0,showDayDetails:!0,theme:"auto",view:v.Month};class be{static Render(e,t={id:""}){let s=`<div id="${(t=F({},this.defaultOptions,t)).id}" class="fsc-bb" data-calendar="${R.getAllCalendars(t.useCalendarClones).findIndex((t=>t.id===e.id))}">`;return s+=`<input class="fsc-i" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/><span class="far fa-clock"></span>`,t.allowTimeRange?(s+=this.RenderTimeInputGroup(e,"fsc-cb",t.selectedTime?.start),s+=`<span class="fsc-db">${t.timeDelimiter}</span>`,s+=this.RenderTimeInputGroup(e,"fsc-eb",t.selectedTime?.end)):s+=this.RenderTimeInputGroup(e,"",t.selectedTime?.start),s+="</div>",s}static RenderTimeInputGroup(e,t="",s={hour:0,minute:0}){let a=`<div class="fsc-fb ${t}">`;a+=`<input class="fsc-gb" data-list="fsc-hb" type="number" value="${_(s.hour)}" /><ul class="fsc-ib fsc-ha fsc-hb">`;for(let t=0;t<e.time.hoursInDay;t++)a+=`<li>${_(t)}</li>`;a+="</ul>",a+=`<span class="fsc-db">:</span><input class="fsc-jb" data-list="fsc-kb" type="number" value="${_(s.minute)}" /><ul class="fsc-ib fsc-ha fsc-kb">`;for(let t=0;t<e.time.minutesInHour;t+=5)a+=`<li>${_(t)}</li>`;return a+="</ul>",a+="</div>",a}static ActivateListeners(e,t=null){const s=document.getElementById(e);s&&(s.parentElement&&s.parentElement.addEventListener("click",be.HideTimeDropdown.bind(be,e)),s.querySelectorAll(".fsc-fb .fsc-gb").forEach((s=>{s.addEventListener("change",be.ChangeEventListener.bind(be,e,k.change,t)),s.addEventListener("click",be.InputClickEventListener.bind(be,e)),s.addEventListener("wheel",be.ChangeEventListener.bind(be,e,k.wheel,t))})),s.querySelectorAll(".fsc-fb .fsc-jb").forEach((s=>{s.addEventListener("change",be.ChangeEventListener.bind(be,e,k.change,t)),s.addEventListener("click",be.InputClickEventListener.bind(be,e)),s.addEventListener("wheel",be.ChangeEventListener.bind(be,e,k.wheel,t))})),s.querySelectorAll(".fsc-fb .fsc-ib").forEach((s=>{s.addEventListener("click",be.ChangeEventListener.bind(be,e,k.dropdownClick,t))})))}static HideTimeDropdown(e){const t=document.getElementById(e);t&&t.querySelectorAll(".fsc-ib").forEach((e=>{e.classList.add("fsc-ha")}))}static ChangeEventListener(e,t,s,a){a.stopPropagation(),a.preventDefault();const n=document.getElementById(e);if(n){let e={id:""};const i=n.querySelector(".fsc-i");i&&(e=JSON.parse(decodeURIComponent(i.value)));const o=parseInt(n.getAttribute("data-calendar")||""),r=R.getAllCalendars(e.useCalendarClones);if(!isNaN(o)&&o>=0&&o<r.length){const i=r[o];e.selectedTime||(e.selectedTime={start:{hour:0,minute:0,seconds:0},end:{hour:0,minute:0,seconds:0}});let c=a.target,l=0,d=!0,h=!0;if(t===k.change||t===k.wheel?(l=parseInt(c.value),isNaN(l)?l=0:(d=c.classList.contains("fsc-gb"),c.parentElement&&(h=c.parentElement.classList.contains("fsc-cb"))),t===k.wheel&&(l+=a.deltaY<0?1:-1)):t===k.dropdownClick&&(l=parseInt(c.innerText),!isNaN(l)&&c.parentElement&&(d=c.parentElement.classList.contains("fsc-hb"),c.parentElement.parentElement&&(h=c.parentElement.parentElement.classList.contains("fsc-cb")))),e.allowTimeRange?h?d?e.selectedTime.start.hour=l:e.selectedTime.start.minute=l:d?e.selectedTime.end.hour=l:e.selectedTime.end.minute=l:d?(e.selectedTime.start.hour=l,e.selectedTime.end.hour=l):(e.selectedTime.start.minute=l,e.selectedTime.end.minute=l),e.selectedTime.start.hour<0&&(e.selectedTime.start.hour=0),e.selectedTime.start.minute<0&&(e.selectedTime.start.minute=0),e.selectedTime.end.hour<0&&(e.selectedTime.end.hour=0),e.selectedTime.end.minute<0&&(e.selectedTime.end.minute=0),e.selectedTime.start.hour>=i.time.hoursInDay&&(e.selectedTime.start.hour=i.time.hoursInDay-1),e.selectedTime.start.minute>=i.time.minutesInHour&&(e.selectedTime.start.minute=i.time.minutesInHour-1),e.selectedTime.end.hour>=i.time.hoursInDay&&(e.selectedTime.end.hour=i.time.hoursInDay-1),e.selectedTime.end.minute>=i.time.minutesInHour&&(e.selectedTime.end.minute=i.time.minutesInHour-1),!e.disableSelfUpdate){const t=be.Render(i,e),a=document.createElement("div");a.innerHTML=t,a.firstChild&&(n.replaceWith(a.firstChild),be.ActivateListeners(e.id,s))}s&&s(e)}}}static InputClickEventListener(e,t){t.stopPropagation(),be.HideTimeDropdown(e);let s=t.target;if(s&&s.parentElement){const e=s.getAttribute("data-list");e&&s.parentElement.querySelector(`.${e}`)?.classList.remove("fsc-ha")}}}be.defaultOptions={id:"",allowTimeRange:!0,disableSelfUpdate:!1,timeDelimiter:"-",useCalendarClones:!1};class Se{static Render(e,t={id:""}){t=F({},this.defaultOptions,t);const s=e.timeKeeper.getStatus();t.cssClasses+=` ${s}`;let a=`<div id="${t.id}" class="fsc-lb ${t.cssClasses} ${s===S.Started?"fsc-a":""}" data-calendar="${e.id}">`;if(a+=`<input class="fsc-i" type="hidden" value="${encodeURIComponent(JSON.stringify(t))}"/>`,a+=`<div class="fsc-mb">${le(f.Clock)}</div>`,a+=this.RenderTime(e,t),a+="</div>","none"!==t.theme){a=`<div class="simple-calendar ${"auto"===t.theme?q.clientSettings.theme:t.theme}">${a}</div>`}return a}static RenderTime(e,t){return`<div class="fsc-nb">${e.time.toString()}</div>`}static ActivateListeners(e){const t=document.getElementById(e);if(t){const s=t.getAttribute("data-calendar")||"",a=R.getCalendar(s);a&&a.timeKeeper.registerUpdateListener(e,Se.UpdateListener.bind(Se,e))}}static UpdateListener(e,t){const s=document.getElementById(e);if(s){const e=s.getAttribute("data-calendar")||"",a=R.getCalendar(e);if(a){let e={id:""};const n=s.querySelector(".fsc-i");n&&(e=JSON.parse(decodeURIComponent(n.value)));const i=Se.RenderTime(a,e),o=document.createElement("div");if(o.innerHTML=i,o.firstChild){const e=s.querySelector(".fsc-nb");e&&(e.replaceWith(o.firstChild),s.classList.contains(t)||(s.classList.remove(S.Started,S.Stopped,S.Paused,"fsc-a"),s.classList.add(t),t===S.Started&&s.classList.add("fsc-a")))}}}}}Se.defaultOptions={id:"",cssClasses:"",theme:"auto"};class we{static Render(e={id:"",options:[]},t=!1){const s=(e=F({},this.defaultOptions,e)).options.filter((e=>e.selected)).map((e=>e.value)).join("|"),a=e.options.filter((e=>e.selected)).map((e=>e.text)).join(", ")||"None Selected";let n=`<div class="fsc-ob"><input class="fsc-pb" id="${e.id}" value="${s}" type="hidden" />`;n+=`<input class="fsc-i" type="hidden" value="${encodeURIComponent(JSON.stringify(e))}"/>`,n+=`<button><div class="fsc-qb">${a}</div><i class="fa fa-chevron-down"></i></button><ul class="fsc-rb ${t?"fsc-sb":""}">`;for(let t=0;t<e.options.length;t++)n+=`<li class="${e.options[t].disabled?"fsc-tb":""} ${e.options[t].selected?"fsc-x":""}" data-value="${e.options[t].value}"><span class="fa-solid ${e.options[t].selected?"fa-square-check":"fa-square"}"></span>${e.options[t].text}</li>`;return n+="</ul></div>",n}static ActivateListeners(e,t){const s=document.getElementById(e)?.parentElement;s&&(s.querySelector("button")?.addEventListener("click",we.EventListener.bind(we,e,"button",t)),s.querySelectorAll("li").forEach((s=>{s.addEventListener("click",we.EventListener.bind(we,e,"option",t))})))}static EventListener(e,t,s,a){const n=document.getElementById(e)?.parentElement;if(n)if("button"===t){we.clickedElement=e;const t=n.querySelector(".fsc-rb");t&&(t.classList.contains("fsc-sb")?t.classList.remove("fsc-sb"):t.classList.add("fsc-sb"))}else if("option"===t){a.stopPropagation();const t=a.target?.closest("li");let i={id:"",options:[]};const o=n.querySelector(".fsc-i")?.value;if(t&&!t.classList.contains("fsc-tb")&&o){i=JSON.parse(decodeURIComponent(o));const a=t.getAttribute("data-value"),r=!t.classList.contains("fsc-x"),c=i.options.findIndex((e=>e.value===a));c>-1&&(i.options[c].selected=r,i.options[c].makeOthersMatch&&i.options.forEach(((e,t)=>{e.static||t===c||(e.selected=r,e.disabled=r)})));const l=we.Render(i,!0),d=document.createElement("div");d.innerHTML=l,d.firstChild&&(n.replaceWith(d.firstChild),we.ActivateListeners(e,s)),s&&s(e,a,r)}}}static BodyEventListener(){document.querySelectorAll(".fsc-ob").forEach((e=>{const t=e.querySelector(".fsc-pb")?.id;if(t)if(t!==we.clickedElement){const t=e.querySelector(".fsc-rb");t&&t.classList.remove("fsc-sb")}else we.clickedElement=""}))}}we.defaultOptions={id:"",options:[]},we.clickedElement="";class ve{static Render(e={}){let t='<div class="fsc-ub fsc-vb">';if((e=F({},this.defaultOptions,e)).displayType===w.Full)t+=`<div class="fsc-wb">\n                        <button class="fsc-xb fsc-yb" data-tooltip="${z.Localize("FSC.MoveBackwardFive")}" data-type="${e.fullDisplay?.unit}" data-amount="-5"><span class="fa fa-angle-double-left"></span></button>\n                        <button class="fsc-xb fsc-yb" data-tooltip="${z.Localize("FSC.MoveBackwardOne")}" data-type="${e.fullDisplay?.unit}" data-amount="-1"><span class="fa fa-angle-left"></span></button>\n                        <button class="fsc-xb fsc-yb fsc-zb" data-unit="time">${z.Localize(e.fullDisplay?.unitText||"")}&nbsp;</button>\n                        <button class="fsc-xb fsc-yb" data-tooltip="${z.Localize("FSC.MoveForwardOne")}" data-type="${e.fullDisplay?.unit}" data-amount="1"><span class="fa fa-angle-right"></span></button>\n                        <button class="fsc-xb fsc-yb" data-tooltip="${z.Localize("FSC.MoveForwardFive")}" data-type="${e.fullDisplay?.unit}" data-amount="5"><span class="fa fa-angle-double-right"></span></button>\n                        <ul class="fsc-_b fsc-ac fsc-yb ${e.fullDisplay?.dateTimeUnitOpen?"fsc-b":"fsc-c"}">`,e.showTimeControls&&(t+=`<li class="${"seconds"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="seconds">${z.Localize("FSC.Second")}</li>\n                        <li class="${"round"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="round">${z.Localize("FSC.Round")}</li>\n                        <li class="${"minute"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="minute">${z.Localize("FSC.Minute")}</li>\n                        <li class="${"hour"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="hour">${z.Localize("FSC.Hour")}</li>`),e.showDateControls&&(t+=`<li class="${"day"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="day">${z.Localize("FSC.Day")}</li>\n                        <li class="${"month"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="month">${z.Localize("FSC.Month")}</li>\n                        <li class="${"year"===e.fullDisplay?.unit?"fsc-x":""}" data-unit="year">${z.Localize("FSC.Year")}</li>`),t+="</ul></div>";else if(e.showTimeControls&&e.displayType===w.QuickIncrement){const s=[{type:"round",amount:(e.largerSteps?5:1)*(e.reverseTime?-1:1),tooltip:z.Localize("FSC.Round"),text:z.Localize("FSC.RoundShorthand")},{type:"minute",amount:(e.largerSteps?5:1)*(e.reverseTime?-1:1),tooltip:z.Localize("FSC.Minute"),text:z.Localize("FSC.MinuteShorthand")},{type:"minute",amount:(e.largerSteps?20:5)*(e.reverseTime?-1:1),tooltip:z.Localize("FSC.Minute"),text:z.Localize("FSC.MinuteShorthand")},{type:"minute",amount:(e.largerSteps?45:15)*(e.reverseTime?-1:1),tooltip:z.Localize("FSC.Minute"),text:z.Localize("FSC.MinuteShorthand")},{type:"hour",amount:(e.largerSteps?5:1)*(e.reverseTime?-1:1),tooltip:z.Localize("FSC.Hour"),text:z.Localize("FSC.HourShorthand")}];t+='<div class="fsc-wb">';for(let e=0;e<s.length;e++)t+=`<button class="fsc-xb fsc-yb" data-tooltip="${s[e].amount} ${s[e].tooltip}" data-type="${s[e].type}" data-amount="${s[e].amount}">${s[e].amount}&nbsp;${s[e].text}</button>`;t+="</div>"}return e.showTimeControls&&e.showPresetTimeOfDay&&(t+=`<div class="fsc-wb">\n                            <button class="fsc-xb fsc-bc" data-type="sunrise" data-tooltip="${z.Localize("FSC.Dawn")}">${le(f.Sunrise)}</button>\n                            <button class="fsc-xb fsc-bc" data-type="midday" data-tooltip="${z.Localize("FSC.Midday")}">${le(f.Midday)}</button>\n                            <button class="fsc-xb fsc-bc" data-type="sunset" data-tooltip="${z.Localize("FSC.Dusk")}">${le(f.Sunset)}</button>\n                            <button class="fsc-xb fsc-bc" data-type="midnight" data-tooltip="${z.Localize("FSC.Midnight")}">${le(f.Midnight)}</button>\n                        </div>`),t+="</div>",t}}ve.defaultOptions={showDateControls:!0,showTimeControls:!0,showPresetTimeOfDay:!0,displayType:w.Full,fullDisplay:{unit:"",unitText:"",dateTimeUnitOpen:!1},reverseTime:!1,largerSteps:!1};class De{}De.CalendarFull=Ce,De.Clock=Se,De.TimeSelector=be,De.MultiSelect=we,De.DateTimeControls=ve;class ke extends A{constructor(){super()}async process(e,t){return e.type===u.clock&&(t.timeKeeper.setStatus(e.data),W.clockClass=e.data,t.generalSettings.gameWorldTimeIntegration===g.None&&De.Clock.UpdateListener(`sc_${t.id}_clock`,e.data),!0)}}class Te extends A{constructor(){super()}async initialize(){return j.emit({type:u.checkClockRunning,data:{}})}async process(e,t){return!(e.type!==u.checkClockRunning||!z.IsGm()||!q.primary)&&j.emit({type:u.clock,data:t.timeKeeper.getStatus()})}}class Me extends A{constructor(){super()}async process(e,t){if(e.type===u.dateTimeChange&&z.IsGm()&&q.primary){const s=e.data;return s.type===p.setDate?W.setCurrentDate(s.interval.year||0,s.interval.month||0,s.interval.day||0):s.type===p.changeDateTime?t.changeDateTime(s.interval,{updateMonth:!1}):s.type===p.advanceTimeToPreset&&s.presetTimeOfDay&&await oe(s.presetTimeOfDay,t),!0}return!1}}class Ie{static emit(e,t,s){let a={};if(e===b.DateTimeChange){a.date=ae(t.toSeconds(),t),a.diff=s,a.moons=[];for(let e=0;e<t.moons.length;e++){const s=t.moons[e].getMoonPhase(t);a.moons.push({name:t.moons[e].name,color:t.moons[e].color,cycleLength:t.moons[e].cycleLength,cycleDayAdjust:t.moons[e].cycleDayAdjust,currentPhase:s})}}else if(e===b.ClockStartStop){const e=t.timeKeeper.getStatus();a={started:e===S.Started,stopped:e===S.Stopped,paused:e===S.Paused}}else e===b.PrimaryGM&&(a.isPrimaryGM=q.primary);Hooks.callAll(e,a)}}class Ne extends A{constructor(){super()}async process(e,t){if(e.type===u.emitHook){const s=e.data.hook;return s&&Ie.emit(s,t,e.data.param),!0}return!1}}class Le extends A{constructor(){super()}async process(e,s){if(e.type===u.noteUpdate){const s=e.data,a=game.journal?.get(s.journalId||"");if(a&&s.userId){const e=a.getFlag(t,"noteData");if(e){const n=e.remindUsers.indexOf(s.userId);-1===n?e.remindUsers.push(s.userId):e.remindUsers.splice(n,1);const i={};i[t]={noteData:e},await a.update({flags:i}),await j.emit({type:u.mainAppUpdate,data:{userId:s.userId}})}}else s.calendarId&&s.newOrder&&s.date&&(await G.orderNotesOnDay(s.calendarId,s.newOrder,s.date),await j.emit({type:u.mainAppUpdate,data:{}}),W.updateApp());return!0}return!1}}class Pe extends A{constructor(){super(),this.checkDuration=5e3,this.otherPrimaryFound=!1}async primaryCheckTimeoutCall(){const e=R.getActiveCalendar();q.primary=!0;const t={type:u.primary,data:{amPrimary:q.primary}};await j.emit(t);const s={type:u.clock,data:S.Stopped};await j.emit(s),await W.timeKeepingCheck(),Ie.emit(b.PrimaryGM,e)}async initialize(){if(z.IsGm()){const e=game.users;if((e?e.filter((e=>e.isGM)).length:0)>1){const e={type:u.primary,data:{primaryCheck:!0}};return j.emit(e).then((()=>new Promise((e=>{window.setTimeout((e=>{this.otherPrimaryFound||this.primaryCheckTimeoutCall(),W.uiElementStates.primaryCheckRunning=!1,e(!0)}).bind(this,e),this.checkDuration)}))))}return await this.primaryCheckTimeoutCall(),!0}return W.uiElementStates.primaryCheckRunning=!1,!0}async process(e,t){return e.type===u.primary&&(z.IsGm()&&(e.data.primaryCheck?await j.emit({type:u.primary,data:{amPrimary:q.primary}}):void 0!==e.data.amPrimary&&e.data.amPrimary&&(this.otherPrimaryFound=!0,q.primary=!1)),!0)}}class je extends A{constructor(){super()}async process(e,t){if(e.type===u.mainAppUpdate){const t=e.data;return t.userId?z.UserID()===t.userId&&W.updateApp():W.updateApp(),!0}return!1}}class Oe extends A{constructor(){super()}async process(e,t){return!(e.type!==u.setActiveCalendar||!z.IsGm()||!q.primary)&&(R.setActiveCalendar(e.data.calendarId),!0)}}class Ae{constructor(){this.sockets=[],this.sockets.push(new je),this.sockets.push(new Pe),this.sockets.push(new Te),this.sockets.push(new ke),this.sockets.push(new Me),this.sockets.push(new Ne),this.sockets.push(new Le),this.sockets.push(new Oe)}initialize(){j.on(this.process.bind(this)),Promise.all(this.sockets.map((e=>e.initialize()))).catch(O.error)}async process(e){const t=R.getActiveCalendar();for(let s=0;s<this.sockets.length&&!await this.sockets[s].process(e,t);s++);}}class xe{constructor(e="",t=NaN){this.showAdvanced=!1,this.id=H(),this.name=e,this.numericRepresentation=t,this.description="",this.abbreviation=""}clone(){const e=new xe(this.name,this.numericRepresentation);return e.id=this.id,e.description=this.description,e.abbreviation=this.abbreviation,e.showAdvanced=this.showAdvanced,e}toConfig(){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation,description:this.description,abbreviation:this.abbreviation}}toTemplate(e=null){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation,description:this.description,abbreviation:this.abbreviation,showAdvanced:this.showAdvanced}}loadFromSettings(e){e.hasOwnProperty("id")&&(this.id=e.id),e.hasOwnProperty("name")&&e.name&&(this.name=e.name),e.hasOwnProperty("numericRepresentation")&&e.numericRepresentation&&(this.numericRepresentation=e.numericRepresentation),e.hasOwnProperty("description")&&e.description&&(this.description=e.description),e.hasOwnProperty("abbreviation")&&e.abbreviation&&(this.abbreviation=e.abbreviation)}}class Ee extends xe{constructor(e,t=""){super(t,e),this.current=!1,this.selected=!1,""===this.name&&this.numericRepresentation&&(this.name=this.numericRepresentation.toString())}toConfig(){return{...super.toTemplate(),name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(){return{...super.toTemplate(),name:this.name,numericRepresentation:this.numericRepresentation,current:this.current,selected:this.selected}}clone(){const e=new Ee(this.numericRepresentation,this.name);return e.id=this.id,e.current=this.current,e.selected=this.selected,e}}class Fe extends xe{constructor(e="",t=NaN,s=0,a=0,n=null){super(e,t),this.days=[],this.numberOfDays=0,this.numberOfLeapYearDays=0,this.numericRepresentationOffset=0,this.intercalary=!1,this.intercalaryInclude=!1,this.current=!1,this.visible=!1,this.selected=!1,this.startingWeekday=null,this.numericRepresentationOffset=s,""===this.name&&(this.name=t.toString()),this.abbreviation=this.name.substring(0,3),this.numberOfLeapYearDays=null===n?a:n,this.numberOfDays=a,this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}populateDays(e,t=null){for(let s=1;s<=e;s++){const e=new Ee(s+this.numericRepresentationOffset);s===t&&(e.current=!0),this.days.push(e)}}toConfig(){return{id:this.id,name:this.name,description:this.description,abbreviation:this.abbreviation,numericRepresentation:this.numericRepresentation,numericRepresentationOffset:this.numericRepresentationOffset,numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,startingWeekday:this.startingWeekday}}toTemplate(e=null){let t=!1;return e&&(t=e.year.leapYearRule.isLeapYear(e.year.visibleYear)),{...super.toTemplate(),abbreviation:this.abbreviation,name:this.name,numericRepresentation:this.numericRepresentation,showAdvanced:this.showAdvanced,numericRepresentationOffset:this.numericRepresentationOffset,current:this.current,visible:this.visible,selected:this.selected,days:this.getDaysForTemplate(t),numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,startingWeekday:this.startingWeekday}}clone(){const e=new Fe(this.name,this.numericRepresentation,this.numericRepresentationOffset);return e.id=this.id,e.name=this.name,e.description=this.description,e.abbreviation=this.abbreviation,e.current=this.current,e.selected=this.selected,e.visible=this.visible,e.days=this.days.map((e=>e.clone())),e.numberOfDays=this.numberOfDays,e.numberOfLeapYearDays=this.numberOfLeapYearDays,e.intercalary=this.intercalary,e.intercalaryInclude=this.intercalaryInclude,e.showAdvanced=this.showAdvanced,e.startingWeekday=this.startingWeekday,e}loadFromSettings(e){if(e&&Object.keys(e).length){super.loadFromSettings(e),this.numericRepresentationOffset=e.numericRepresentationOffset;let t=parseInt(e.numberOfDays.toString()),s=void 0===e.numberOfLeapYearDays?0:parseInt(e.numberOfLeapYearDays.toString());isNaN(t)&&(t=1),isNaN(s)&&(s=1),this.numberOfDays=t,this.numberOfLeapYearDays=s,this.intercalary=e.intercalary,this.intercalaryInclude=e.intercalaryInclude,e.hasOwnProperty("startingWeekday")&&(this.startingWeekday=e.startingWeekday),e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,3),this.days=[],this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}}getDay(e="current"){const t=e.toLowerCase();return this.days.find((e=>e[t]))}getDayIndex(e="current"){const t=e.toLowerCase();return this.days.findIndex((e=>e[t]))}getDaysForTemplate(e=!1){let t=this.days.map((e=>e.toTemplate()));if(this.numberOfDays!==this.numberOfLeapYearDays){const s=this.numberOfLeapYearDays-this.numberOfDays;if(s>0&&!e)return t.slice(0,t.length-s);if(s<0&&e)return t.slice(0,t.length-Math.abs(s))}return t}changeDay(e,t=!1,s="current"){const a=this.getDayIndex(s);let n=0;const i=t?this.numberOfLeapYearDays:this.numberOfDays;if(a>-1){let o=a+e;e>0&&o>=i||e<0&&o<0||o<0?(this.resetDays(s),n=e>0?1:-1):this.updateDay(o,t,s)}return n}resetDays(e="current"){const t=e.toLowerCase();this.days.forEach((e=>{e[t]=!1}))}updateDay(e,t=!1,s="current"){const a=s.toLowerCase(),n=t?this.numberOfLeapYearDays:this.numberOfDays;this.resetDays(s),e<0||e>=n?this.days[n-1][a]=!0:this.days[e]&&(this.days[e][a]=!0)}}class Re extends xe{constructor(e=NaN,t=""){super(t,e),this.abbreviation=t.substring(0,2),this.restday=!1}toConfig(){return{abbreviation:this.abbreviation,id:this.id,name:this.name,description:this.description,numericRepresentation:this.numericRepresentation,restday:this.restday}}toTemplate(){return{...super.toTemplate(),abbreviation:this.abbreviation,name:this.name,numericRepresentation:this.numericRepresentation,showAdvanced:this.showAdvanced,restday:this.restday}}clone(){const e=new Re(this.numericRepresentation,this.name);return e.id=this.id,e.abbreviation=this.abbreviation,e.description=this.description,e.showAdvanced=this.showAdvanced,e.restday=this.restday,e}loadFromSettings(e){e&&Object.keys(e).length&&(super.loadFromSettings(e),e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,2),e.hasOwnProperty("restday")&&(this.restday=e.restday))}}class We extends xe{constructor(e="",t=0,s=0){super(e),this.color="#ffffff",this.startingMonth=-1,this.startingDay=-1,this.sunriseTime=0,this.sunsetTime=0,this.icon=f.None,this.startingMonth=t,this.startingDay=s}clone(){const e=new We(this.name,this.startingMonth,this.startingDay);return e.id=this.id,e.description=this.description,e.color=this.color,e.icon=this.icon,e.sunriseTime=this.sunriseTime,e.sunsetTime=this.sunsetTime,e}toConfig(){return{id:this.id,name:this.name,description:this.description,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,icon:this.icon,sunriseTime:this.sunriseTime,sunsetTime:this.sunsetTime}}toTemplate(){const e=`sc_season_start_date_${this.id}`,t=`sc_season_sunrise_time_${this.id}`;let s=0,a=0,n=0,i=0;const o=R.getActiveCalendar();return a=Math.floor(this.sunriseTime/o.time.secondsInMinute),i=Math.floor(this.sunsetTime/o.time.secondsInMinute),a>=o.time.minutesInHour&&(s=Math.floor(a/o.time.minutesInHour),a-=s*o.time.minutesInHour),i>=o.time.minutesInHour&&(n=Math.floor(i/o.time.minutesInHour),i-=n*o.time.minutesInHour),{...super.toTemplate(),name:this.name,description:this.description,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,icon:this.icon,startDateSelectorId:e,startDateSelectedDate:{year:0,month:this.startingMonth,day:this.startingDay,hour:0,minute:0,seconds:0},sunriseSelectorId:t,sunriseSelectorSelectedDates:{start:{year:0,month:0,day:0,hour:s,minute:a,seconds:0},end:{year:0,month:0,day:0,hour:n,minute:i,seconds:0}}}}loadFromSettings(e){if(e&&Object.keys(e).length){super.loadFromSettings(e),this.startingMonth=e.startingMonth,this.startingDay=e.startingDay;const t=e.customColor;this.color="custom"===e.color&&t?t:e.color,e.hasOwnProperty("sunriseTime")&&(this.sunriseTime=e.sunriseTime),e.hasOwnProperty("sunsetTime")&&(this.sunsetTime=e.sunsetTime),e.hasOwnProperty("icon")&&(this.icon=e.icon)}}}class Ye extends xe{constructor(e="",t=0){super(e),this.phases=[],this.firstNewMoon={yearReset:y.None,yearX:0,year:0,month:1,day:1},this.color="#ffffff",this.cycleDayAdjust=0,this.cycleLength=t,this.phases.push({name:z.Localize("FSC.Moon.Phase.New"),length:3.69,icon:f.NewMoon,singleDay:!0})}clone(){const e=new Ye(this.name,this.cycleLength);return e.id=this.id,e.phases=this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),e.firstNewMoon.yearReset=this.firstNewMoon.yearReset,e.firstNewMoon.yearX=this.firstNewMoon.yearX,e.firstNewMoon.year=this.firstNewMoon.year,e.firstNewMoon.month=this.firstNewMoon.month,e.firstNewMoon.day=this.firstNewMoon.day,e.color=this.color,e.cycleDayAdjust=this.cycleDayAdjust,e}toConfig(){return{id:this.id,name:this.name,cycleLength:this.cycleLength,firstNewMoon:{yearReset:this.firstNewMoon.yearReset,yearX:this.firstNewMoon.yearX,year:this.firstNewMoon.year,month:this.firstNewMoon.month,day:this.firstNewMoon.day},phases:this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),color:this.color,cycleDayAdjust:this.cycleDayAdjust}}toTemplate(e){return{...super.toTemplate(),name:this.name,cycleLength:this.cycleLength,firstNewMoon:this.firstNewMoon,phases:this.phases,color:this.color,cycleDayAdjust:this.cycleDayAdjust,firstNewMoonDateSelectorId:`sc_first_new_moon_date_${this.id}`,firstNewMoonSelectedDate:{year:0,month:this.firstNewMoon.month,day:this.firstNewMoon.day,hour:0,minute:0,seconds:0}}}loadFromSettings(e){e&&Object.keys(e).length&&(super.loadFromSettings(e),this.cycleLength=e.cycleLength,this.phases=e.phases,this.firstNewMoon={yearReset:e.firstNewMoon.yearReset,yearX:e.firstNewMoon.yearX,year:e.firstNewMoon.year,month:e.firstNewMoon.month,day:e.firstNewMoon.day},this.color=e.color,this.cycleDayAdjust=e.cycleDayAdjust)}updatePhaseLength(){let e=0,t=0;for(let s=0;s<this.phases.length;s++)this.phases[s].singleDay?t++:e++;const s=Number(((this.cycleLength-t)/e).toPrecision(6));this.phases.forEach((e=>{e.singleDay?e.length=1:e.length=s}))}getDateMoonPhase(e,t,s,a){let n=e.dateToDays(this.firstNewMoon.year,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),i=0;if(this.firstNewMoon.yearReset===y.LeapYear){let s=e.year.leapYearRule.previousLeapYear(t);null!==s&&(n=e.dateToDays(s,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),t!==s&&(i+=e.year.leapYearRule.fraction(t)))}else if(this.firstNewMoon.yearReset===y.XYears){const s=t%this.firstNewMoon.yearX;if(0!==s){let a=t-s;n=e.dateToDays(a,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),i+=s/this.firstNewMoon.yearX}}const o=(e.dateToDays(t,s,a,!0,!0)-n+i)/this.cycleLength;let r=(o-Math.floor(o))*this.cycleLength+this.cycleDayAdjust,c=0,l=null;for(let e=0;e<this.phases.length;e++){const t=c+this.phases[e].length;if(r>=c&&r<t){l=this.phases[e];break}c=t}return null!==l?l:this.phases[0]}getMoonPhase(e,t="current",s=0){let a="current"===(t=t.toLowerCase())?e.year.numericRepresentation:"selected"===t?e.year.selectedYear:e.year.visibleYear;const n=e.getMonthIndex(t);if(n>-1){const i="visible"!==t?e.months[n].getDayIndex(t):s;return this.getDateMoonPhase(e,a,n,i)}return this.phases[0]}}var $e=s(162);class qe{static async setToPredefined(e,s,a=!0){let n=!1,i=await fetch(getRoute(`modules/${t}/predefined-calendars/${s}.json`));const o=await i.json();if(o&&o.calendar){const i=e.id.replace("_temp","");if(delete o.calendar.name,s===c.Gregorian){const e=new Date;o.calendar.currentDate.year=e.getFullYear(),o.calendar.currentDate.month=e.getMonth(),o.calendar.currentDate.day=e.getDate()-1,o.calendar.year.numericRepresentation=e.getFullYear()}e.loadFromSettings(o.calendar);const r=G.getNotes(i);for(let e=0;e<r.length;e++)if(r[e].fromPredefined){const t=game.journal?.get(r[e].entryId);t&&(G.removeNoteStub(t),await t.delete())}if(a&&o.notes){const e={};game.users?.forEach((t=>e[t.id]=game.user?.id===t.id?3:2)),e.default=2;for(let s=0;s<o.notes.length;s++){const a=o.notes[s];a.flags[t].noteData.calendarId=i,a.flags[t].noteData.fromPredefined=!0,a.folder=G.noteDirectory?.id,a.permission=e,await JournalEntry.create(a,{keepId:!1})}}n=!0}return n}}class Ge{constructor(e,t){this.showCalendarYear=!0,this.addTime=!1,this.timeDelimiter="-",this.allowDateRangeSelection=!1,this.allowTimeRangeSelection=!0,this.secondDaySelect=!1,this.onDateSelect=null,this.position=M.Auto,this.calendar=R.getActiveCalendar(),this.editYear=!1,this.useCloneCalendars=!1,this.id=e,this.calendarId=`${this.id}_calendar`,this.timeSelectorId=`${this.id}_time_selector`,this.showDateSelector=!0,this.showTimeSelector=!1,this.selectedDate={visible:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},start:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},end:{year:0,month:1,day:1,hour:0,minute:0,seconds:0},allDay:!0},this.applyOptions(t),void 0===t.selectedEndDate&&(this.selectedDate.end={year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds}),this.selectedDate.allDay||(this.addTime=!0)}applyOptions(e){void 0!==e.calendar&&(this.calendar=e.calendar),void 0!==e.showDateSelector&&(this.showDateSelector=e.showDateSelector),void 0!==e.showTimeSelector&&(this.showTimeSelector=e.showTimeSelector),void 0!==e.showCalendarYear&&(this.showCalendarYear=e.showCalendarYear),e.onDateSelect&&(this.onDateSelect=e.onDateSelect),e.position&&(this.position=e.position),void 0!==e.allowDateRangeSelection&&(this.allowDateRangeSelection=e.allowDateRangeSelection),void 0!==e.allowTimeRangeSelection&&(this.allowTimeRangeSelection=e.allowTimeRangeSelection),void 0!==e.editYear&&(this.editYear=e.editYear),void 0!==e.timeDelimiter&&(this.timeDelimiter=e.timeDelimiter),void 0!==e.selectedStartDate&&(this.selectedDate.start={year:e.selectedStartDate.year,month:e.selectedStartDate.month,day:e.selectedStartDate.day,hour:e.selectedStartDate.hour,minute:e.selectedStartDate.minute,seconds:e.selectedStartDate.seconds},this.selectedDate.visible={year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds}),void 0!==e.selectedEndDate&&(this.selectedDate.end={year:e.selectedEndDate.year,month:e.selectedEndDate.month,day:e.selectedEndDate.day,hour:e.selectedEndDate.hour,minute:e.selectedEndDate.minute,seconds:e.selectedEndDate.seconds}),void 0!==e.timeSelected?this.selectedDate.allDay=!e.timeSelected:this.selectedDate.allDay=!this.showTimeSelector,e.useCloneCalendars&&(this.useCloneCalendars=e.useCloneCalendars)}build(e=!0,t=!0){let s,a=`<div id="${this.id}" class="fsc-cc">`,n="",i="";this.showDateSelector&&(n=De.CalendarFull.Render(this.calendar,{id:this.calendarId,allowChangeMonth:!0,allowSelectDateRange:this.allowDateRangeSelection,cssClasses:"fsc-dc",colorToMatchSeason:!1,editYear:this.editYear,showCurrentDate:!1,showDayDetails:!1,showDescriptions:!1,showMoonPhases:!1,showNoteCount:!1,showSeasonName:!1,showYear:this.showCalendarYear,date:{month:this.selectedDate.visible.month,year:this.selectedDate.visible.year,day:0},theme:"none",selectedDates:{start:{year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day},end:{year:this.selectedDate.end.year,month:this.selectedDate.end.month,day:this.selectedDate.end.day}}})),this.showTimeSelector&&(i='<div class="fsc-ec">',this.addTime?(i+=De.TimeSelector.Render(this.calendar,{id:this.timeSelectorId,allowTimeRange:this.allowTimeRangeSelection,disableSelfUpdate:!0,selectedTime:{start:{hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute,seconds:this.selectedDate.start.seconds},end:{hour:this.selectedDate.end.hour,minute:this.selectedDate.end.minute,seconds:this.selectedDate.end.seconds}},timeDelimiter:this.timeDelimiter,useCalendarClones:this.useCloneCalendars}),this.showDateSelector&&(i+=`<div class="fsc-fc"><button class="fsc-xb fsc-gc"><i class="fa fa-times"></i> ${z.Localize("FSC.RemoveTime")}</button></div>`)):i+=`<div class="fsc-hc"><button class="fsc-xb fsc-yb"><i class="fa fa-clock"></i> ${z.Localize("FSC.Notes.DateTime.AllDay")}</button></div>`,i+="</div>");return s=`<input class="fsc-ic" value="${Q(this.calendar,this.selectedDate.start,this.selectedDate.end,this.selectedDate.allDay,this.showTimeSelector&&!this.showDateSelector,this.showCalendarYear,this.timeDelimiter)}" tabindex="0" type="text" readonly="readonly"><div class="fsc-jc${this.showTimeSelector&&!this.showDateSelector?" fsc-kc":""}" style="display:${e?"none":"block"};">${n}${i}</div>`,t&&(s=`${a}${s}</div>`),s}setPosition(e){if(e){e.classList.remove(M.LeftUp),e.classList.remove(M.LeftDown),e.classList.remove(M.RightUp),e.classList.remove(M.RightDown);let t=this.position;if(this.position===M.Auto){const s=e.closest(".window-app");if(s){let a=e.getBoundingClientRect();const n=s.getBoundingClientRect();t=a.right>n.right?"right-":"left-",a.bottom>n.bottom&&a.top-a.height>n.top?t+="up":t+="down"}}e.classList.add(t)}}update(e=!1){const t=this.build(e,!1),s=document.querySelector(`#${this.id}`);s&&(s.innerHTML=t,this.activateListeners(s,!0,!0,!1),s.style.display="block",this.setPosition(s.querySelector(".fsc-jc")))}activateListeners(e=null,t=!0,s=!0,a=!0){if(e||(e=document.querySelector(`#${this.id}`)),e){if(a&&document.addEventListener("click",this.hideCalendar.bind(this,e)),t&&s){const t=e.querySelector(".fsc-ic");t&&t.addEventListener("click",this.toggleCalendar.bind(this,e))}if(t&&this.showDateSelector&&De.CalendarFull.ActivateListeners(this.calendarId,this.changeMonthClick.bind(this),this.dayClick.bind(this),this.changeYear.bind(this)),this.showDateSelector){const t=e.querySelector(".fsc-dc");t&&t.addEventListener("click",this.calendarClick.bind(this))}if(s&&this.showTimeSelector&&De.TimeSelector.ActivateListeners(this.timeSelectorId,this.timeChange.bind(this)),this.showTimeSelector){const t=e.querySelector(".fsc-hc button");t&&t.addEventListener("click",this.addTimeClick.bind(this));const s=e.querySelector(".fsc-fc button");s&&s.addEventListener("click",this.removeTimeClick.bind(this))}}}callOnDateSelect(){if(this.onDateSelect){const e={startDate:{year:this.selectedDate.start.year,month:this.selectedDate.start.month,day:this.selectedDate.start.day,hour:this.selectedDate.start.hour,minute:this.selectedDate.start.minute},endDate:{year:this.selectedDate.end.year,month:this.selectedDate.end.month,day:this.selectedDate.end.day,hour:this.selectedDate.end.hour,minute:this.selectedDate.end.minute},timeSelected:!this.selectedDate.allDay};this.onDateSelect(e)}}toggleCalendar(e,t){t.stopPropagation();const s=e.querySelector(".fsc-jc");s&&("none"===s.style.display?(s.style.display="block",this.setPosition(s)):s.style.display="none")}hideCalendar(e){this.secondDaySelect=!1;const t=e.querySelector(".fsc-jc");t&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&(t.style.display="none",this.callOnDateSelect())}calendarClick(e){e.stopPropagation(),De.TimeSelector.HideTimeDropdown(this.timeSelectorId);const t=document.getElementById(this.id);if(t){const e=t.getElementsByClassName("fsc-lc");for(let t=0;t<e.length;t++)e[t].classList.add("hide")}}dayClick(e){if(e.selectedDates){let t=!0;this.secondDaySelect?(this.selectedDate.start.year=e.selectedDates.start.year,this.selectedDate.start.month=e.selectedDates.start.month,this.selectedDate.start.day=e.selectedDates.start.day||0,this.selectedDate.end.year=e.selectedDates.end.year,this.selectedDate.end.month=e.selectedDates.end.month,this.selectedDate.end.day=e.selectedDates.end.day||0):(this.selectedDate.start.year=e.selectedDates.start.year,this.selectedDate.start.month=e.selectedDates.start.month,this.selectedDate.start.day=e.selectedDates.start.day||0,this.selectedDate.end.year=e.selectedDates.start.year,this.selectedDate.end.month=e.selectedDates.start.month,this.selectedDate.end.day=e.selectedDates.start.day||0,this.secondDaySelect=!0,t=!this.allowDateRangeSelection),t?(this.secondDaySelect=!1,this.update(t),this.callOnDateSelect()):this.showTimeSelector&&De.TimeSelector.HideTimeDropdown(this.timeSelectorId)}}changeMonthClick(e,t){t.date&&(this.selectedDate.visible.year=t.date.year,this.selectedDate.visible.month=t.date.month),this.activateListeners(null,!1,!1),this.showTimeSelector&&De.TimeSelector.HideTimeDropdown(this.timeSelectorId)}changeYear(e){e.date&&(this.selectedDate.visible.year=e.date.year),this.activateListeners(null,!1,!1),this.showTimeSelector&&De.TimeSelector.HideTimeDropdown(this.timeSelectorId)}addTimeClick(e){e.stopPropagation(),this.addTime=!0,this.selectedDate.allDay=!1,this.selectedDate.start.hour=0,this.selectedDate.start.minute=0,this.selectedDate.start.seconds=0,this.selectedDate.end.hour=0,this.selectedDate.end.minute=0,this.selectedDate.end.seconds=0,this.update()}removeTimeClick(e){e.stopPropagation(),this.addTime=!1,this.selectedDate.allDay=!0,this.selectedDate.start.hour=0,this.selectedDate.start.minute=0,this.selectedDate.start.seconds=0,this.selectedDate.end.hour=0,this.selectedDate.end.minute=0,this.selectedDate.end.seconds=0,this.update()}timeChange(e){e.selectedTime&&(ee(this.selectedDate.start,this.selectedDate.end)&&e.selectedTime.end.hour<=e.selectedTime.start.hour&&(e.selectedTime.end.hour=e.selectedTime.start.hour,e.selectedTime.end.minute<e.selectedTime.start.minute&&(e.selectedTime.end.minute=e.selectedTime.start.minute)),this.selectedDate.start.hour=e.selectedTime.start.hour,this.selectedDate.start.minute=e.selectedTime.start.minute,this.selectedDate.end.hour=e.selectedTime.end.hour,this.selectedDate.end.minute=e.selectedTime.end.minute,this.update(),this.showTimeSelector&&!this.showDateSelector&&this.callOnDateSelect())}}class ze{static GetSelector(e,t){if(this.Selectors.hasOwnProperty(e))return this.Selectors[e].applyOptions(t),this.Selectors[e];{const s=new Ge(e,t);return this.Selectors[e]=s,s}}static RemoveSelector(e){this.Selectors.hasOwnProperty(e)&&delete this.Selectors[e]}static ActivateSelector(e){this.Selectors.hasOwnProperty(e)&&this.Selectors[e].activateListeners()}}ze.Selectors={};class He extends xe{constructor(){super(),this.viewCalendar={player:!0,trustedPlayer:!0,assistantGameMaster:!0,users:void 0},this.addNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.reorderNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.changeDateTime={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.changeActiveCalendar={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0}}static clonePermissions(e){return{player:e.player,trustedPlayer:e.trustedPlayer,assistantGameMaster:e.assistantGameMaster,users:e.users}}clone(){const e=new He;return e.id=this.id,e.viewCalendar=He.clonePermissions(this.viewCalendar),e.addNotes=He.clonePermissions(this.addNotes),e.reorderNotes=He.clonePermissions(this.reorderNotes),e.changeDateTime=He.clonePermissions(this.changeDateTime),e.changeActiveCalendar=He.clonePermissions(this.changeActiveCalendar),e}toTemplate(){return{...super.toTemplate(),viewCalendar:this.viewCalendar,addNotes:this.addNotes,reorderNotes:this.reorderNotes,changeDateTime:this.changeDateTime,changeActiveCalendar:this.changeActiveCalendar}}toConfig(){return{id:this.id,addNotes:this.addNotes,changeDateTime:this.changeDateTime,reorderNotes:this.reorderNotes,viewCalendar:this.viewCalendar,changeActiveCalendar:this.changeActiveCalendar}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("viewCalendar")&&this.validateUserPermissionMatrix(e.viewCalendar)&&(this.viewCalendar=e.viewCalendar),e.hasOwnProperty("addNotes")&&this.validateUserPermissionMatrix(e.addNotes)&&(this.addNotes=e.addNotes),e.hasOwnProperty("changeDateTime")&&this.validateUserPermissionMatrix(e.changeDateTime)&&(this.changeDateTime=e.changeDateTime),e.hasOwnProperty("reorderNotes")&&this.validateUserPermissionMatrix(e.reorderNotes)&&(this.reorderNotes=e.reorderNotes),e.hasOwnProperty("changeActiveCalendar")&&this.validateUserPermissionMatrix(e.changeActiveCalendar)&&(this.changeActiveCalendar=e.changeActiveCalendar))}validateUserPermissionMatrix(e){return!!(e&&x(e)&&e.hasOwnProperty("player")&&e.hasOwnProperty("trustedPlayer")&&e.hasOwnProperty("assistantGameMaster"))}}function Ue(e,t,s=document){const a=s.querySelector(e);return a?a.value:t}function Ve(e,t,s=!1,a=document){const n=a.querySelector(e);if(n){const e=s?parseFloat(n.value):parseInt(n.value);if(!isNaN(e))return e}return t}function _e(e,t,s=document){const a=s.querySelector(e);return a?a.checked:t}class Be extends FormApplication{constructor(){super({}),this.appWindow=null,this.calendars=[],this.predefindCalendars=[],this.globalConfiguration={id:"",version:"",calendarsSameTimestamp:!1,combatPauseRule:o.Active,permissions:new He,secondsInCombatRound:6,syncCalendars:!1,showNotesFolder:!1},this.clientSettings={id:"",theme:i[0].key,openOnLoad:!0,openCompact:!1,rememberPosition:!0,rememberCompactPosition:!1,appPosition:{},noteReminderNotification:N.whisper,sideDrawerDirection:"sc-right",alwaysShowNoteList:!1,persistentOpen:!1,compactViewScale:100},this.uiElementStates={dateFormatExample:"",dateFormatTableExpanded:!1,monthYearFormatExample:"",qsNextClicked:!1,qsAddNotes:!0,selectedPredefinedCalendar:"",timeFormatExample:"",disabledControls:{pf2e:!1}}}render(e,t){return E(this.object)?void Y.initializeAndShowDialog().catch(O.error):((t=t||{}).classes=["simple-calendar","fsc-mc",de()],super.render(e,t))}async initializeAndShowDialog(){if(this.calendars=R.cloneCalendars(),this.object=this.calendars[0],q.load(),this.globalConfiguration.permissions=q.globalConfiguration.permissions.clone(),this.globalConfiguration.secondsInCombatRound=q.globalConfiguration.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=q.globalConfiguration.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=q.globalConfiguration.syncCalendars,this.globalConfiguration.showNotesFolder=q.globalConfiguration.showNotesFolder,this.globalConfiguration.combatPauseRule=q.globalConfiguration.combatPauseRule,this.clientSettings=F({},q.clientSettings),this._tabs[0].active="globalSettings",0===this.predefindCalendars.length)try{const e=await fetch(getRoute(`modules/${t}/predefined-calendars/calendar-list.json`));this.predefindCalendars=await e.json()}catch(e){O.error(e),this.predefindCalendars=[]}this.rendered?this.bringToTop():this.showApp()}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/configuration.html",e.title="FSC.Configuration.Title",e.id=this.appWindowId,e.classes=["simple-calendar","fsc-mc"],e.resizable=!0,e.tabs=[{navSelector:".tabs",contentSelector:"form",initial:"yearSettings"}],e.height=me(700),e.width=me(1005),e.scrollY=[".fsc-nc",".fsc-oc"],e}showApp(){this.render(!0)}closeApp(){this.close().catch(O.error)}close(e){return R.clearClones(),this.object.seasons.forEach((e=>{ze.RemoveSelector(`sc_season_start_date_${e.id}`),ze.RemoveSelector(`sc_season_sunrise_time_${e.id}`)})),this.appWindow=null,super.close(e)}updateApp(){this.render(!1)}getData(e){const t=this.object.getCurrentDate();this.uiElementStates.dateFormatExample=J({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.date,this.object),this.uiElementStates.timeFormatExample=J({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.time,this.object),this.uiElementStates.monthYearFormatExample=J({year:t.year,month:t.month,day:t.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.monthYear,this.object),this.uiElementStates.disabledControls.pf2e=Z.isPF2E&&this.object.generalSettings.pf2eSync;let s={...super.getData(e),activeCalendarId:this.object.id,calendars:this.calendars,clientSettings:{openOnLoad:this.clientSettings.openOnLoad,openInCompact:this.clientSettings.openCompact,rememberPos:this.clientSettings.rememberPosition,rememberCompactPos:this.clientSettings.rememberCompactPosition,theme:this.clientSettings.theme,themes:he(),noteReminderNotification:this.clientSettings.noteReminderNotification,noteReminderNotifications:{whisper:"FSC.Configuration.Client.NoteReminderNotification.Whisper",render:"FSC.Configuration.Client.NoteReminderNotification.Render"},sideDrawerDirection:this.clientSettings.sideDrawerDirection,sideDrawerDirections:{"sc-right":"FSC.Right","sc-left":"FSC.Left","sc-down":"FSC.Down"},alwaysShowNoteList:this.clientSettings.alwaysShowNoteList,persistentOpen:this.clientSettings.persistentOpen,compactViewScale:this.clientSettings.compactViewScale},combatPauseRules:{active:"FSC.Configuration.CombatPauseRule.Active",current:"FSC.Configuration.CombatPauseRule.Current"},currentYear:this.object.year,gameSystem:B.systemID,generalSettings:this.object.generalSettings,globalConfiguration:this.globalConfiguration,isGM:z.IsGm(),leapYearRule:this.object.year.leapYearRule,leapYearRules:{none:"FSC.Configuration.LeapYear.Rules.None",gregorian:"FSC.Configuration.LeapYear.Rules.Gregorian",custom:"FSC.Configuration.LeapYear.Rules.Custom"},months:this.object.months.map((e=>e.toTemplate())),monthStartingWeekdays:{},moons:this.object.moons.map((e=>e.toTemplate(this.object))),moonIcons:{},moonYearReset:{none:"FSC.Configuration.Moon.YearResetNo","leap-year":"FSC.Configuration.Moon.YearResetLeap","x-years":"FSC.Configuration.Moon.YearResetX"},noteCategories:[],predefined:this.predefindCalendars,qsCalDate:{year:1,month:0,day:0,hour:0,minute:0,allDay:!0},seasonColors:[{value:"#ffffff",display:z.Localize("FSC.Configuration.Season.ColorWhite")},{value:"#46B946",display:z.Localize("FSC.Configuration.Season.ColorSpring")},{value:"#E0C40B",display:z.Localize("FSC.Configuration.Season.ColorSummer")},{value:"#FF8E47",display:z.Localize("FSC.Configuration.Season.ColorFall")},{value:"#479DFF",display:z.Localize("FSC.Configuration.Season.ColorWinter")}],seasonIcons:{},seasons:this.object.seasons.map((e=>e.toTemplate())),showLeapYearCustomMod:this.object.year.leapYearRule.rule===h.Custom,showLeapYearMonths:this.object.year.leapYearRule.rule!==h.None,time:this.object.time,timeTrackers:{none:"FSC.Configuration.General.None",self:"FSC.Configuration.General.Self","third-party":"FSC.Configuration.General.ThirdParty",mixed:"FSC.Configuration.General.Mixed"},uiElementStates:this.uiElementStates,weekdays:this.object.weekdays.map((e=>e.toTemplate())),yearNameBehaviourOptions:{default:"Default",repeat:"PLAYLIST.SoundRepeat",random:"FSC.Random"}};s.seasonIcons[f.None]=z.Localize("FSC.Configuration.LeapYear.Rules.None"),s.seasonIcons[f.Spring]=z.Localize("FSC.Configuration.Season.ColorSpring"),s.seasonIcons[f.Summer]=z.Localize("FSC.Configuration.Season.ColorSummer"),s.seasonIcons[f.Fall]=z.Localize("FSC.Configuration.Season.ColorFall"),s.seasonIcons[f.Winter]=z.Localize("FSC.Configuration.Season.ColorWinter"),s.seasonIcons[f.Sunrise]=z.Localize("FSC.Dawn"),s.seasonIcons[f.Sunset]=z.Localize("FSC.Dusk"),s.moonIcons[f.NewMoon]=z.Localize("FSC.Moon.Phase.New"),s.moonIcons[f.WaxingCrescent]=z.Localize("FSC.Moon.Phase.WaxingCrescent"),s.moonIcons[f.FirstQuarter]=z.Localize("FSC.Moon.Phase.FirstQuarter"),s.moonIcons[f.WaxingGibbous]=z.Localize("FSC.Moon.Phase.WaxingGibbous"),s.moonIcons[f.Full]=z.Localize("FSC.Moon.Phase.Full"),s.moonIcons[f.WaningGibbous]=z.Localize("FSC.Moon.Phase.WaningGibbous"),s.moonIcons[f.LastQuarter]=z.Localize("FSC.Moon.Phase.LastQuarter"),s.moonIcons[f.WaningCrescent]=z.Localize("FSC.Moon.Phase.WaningCrescent"),s.monthStartingWeekdays.null=z.Localize("Default");for(let e=0;e<this.object.weekdays.length;e++)s.monthStartingWeekdays[this.object.weekdays[e].numericRepresentation.toString()]=this.object.weekdays[e].name;return s.qsCalDate.year=t.year,s.qsCalDate.month=t.month,s.qsCalDate.day=t.day,s.noteCategories=this.object.noteCategories,s}_updateObject(e,t){return Promise.resolve(void 0)}activateListeners(e){super.activateListeners(e),this.object.seasons.forEach((e=>{ze.GetSelector(`sc_season_start_date_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,T.seasonStartingDate)}).activateListeners(),ze.GetSelector(`sc_season_sunrise_time_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,T.seasonSunriseSunsetTime)}).activateListeners()})),this.object.moons.forEach((e=>{ze.GetSelector(`sc_first_new_moon_date_${e.id}`,{onDateSelect:this.dateSelectorChange.bind(this,e.id,T.moonFirstNewMoonDate)}).activateListeners()})),this.appWindow=document.getElementById(Be.appWindowId),this.appWindow&&(ze.ActivateSelector("quick-setup-predefined-calendar"),this.appWindow.addEventListener("click",this.toggleCalendarSelector.bind(this,!0)),this.appWindow.querySelector(".tabs .fsc-pc .fsc-qc")?.addEventListener("click",this.toggleCalendarSelector.bind(this,!1)),this.appWindow.querySelectorAll(".tabs .fsc-pc ul li[data-calendar]").forEach((e=>{e.addEventListener("click",this.calendarClick.bind(this))})),this.appWindow.querySelectorAll(".tabs .fsc-pc ul li[data-calendar] .fsc-xb").forEach((e=>{e.addEventListener("click",this.removeCalendarClick.bind(this))})),this.appWindow.querySelector(".fsc-nc .fsc-rc .fsc-sc")?.addEventListener("click",this.addNewCalendar.bind(this)),this.appWindow.querySelectorAll(".fsc-tc .fsc-uc .fsc-vc").forEach((e=>{e.addEventListener("click",this.predefinedCalendarClick.bind(this))})),this.appWindow.querySelector(".fsc-tc .fsc-wc .fsc-xc")?.addEventListener("click",this.quickSetupNextClick.bind(this)),this.appWindow.querySelector(".fsc-tc .fsc-wc .fsc-yc")?.addEventListener("click",this.quickSetupBackClick.bind(this)),this.appWindow.querySelector(".fsc-tc .fsc-wc .fsc-zc")?.addEventListener("click",this.quickSetupSaveClick.bind(this)),this.appWindow.querySelectorAll(".fsc-_c").forEach((e=>{e.addEventListener("click",this.toggleShowAdvanced.bind(this))})),this.appWindow.querySelectorAll("input, select, textarea").forEach((e=>{e.addEventListener("change",this.inputChange.bind(this)),e.addEventListener("keyup",this.inputChange.bind(this))})),this.appWindow.querySelector(".fsc-ad")?.addEventListener("click",this.dateFormatTableClick.bind(this)),this.appWindow.querySelectorAll(".fsc-bd .fsc-sc").forEach((e=>{e.addEventListener("click",this.addToTable.bind(this))})),this.appWindow.querySelectorAll(".fsc-xb.fsc-gc").forEach((e=>{e.addEventListener("click",this.removeFromTable.bind(this))})),this.appWindow.querySelector("#exportCalendar")?.addEventListener("click",this.exportCalendar.bind(this)),this.appWindow.querySelector("#scImportCalendarPicker")?.addEventListener("change",this.importCalendarFileChange.bind(this)),this.appWindow.querySelector("#scSave")?.addEventListener("click",this.saveClick.bind(this,!0)))}inputChange(){this.writeInputValuesToObjects(),this.updateUIFromObject()}toggleCalendarSelector(e=!1){if(this.appWindow){const t=this.appWindow.querySelector(".tabs .fsc-pc ul");t&&ue(t,500,e)}}calendarClick(e){const t=e.currentTarget;if(t){const e=t.getAttribute("data-calendar");if(e&&e!==this.object.id){const t=this.calendars.find((t=>t.id===e));t&&(this.object=t,this._tabs[0].active="generalSettings",this.updateApp())}}}removeCalendarClick(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;if(t){const e=t.getAttribute("data-calendar");if(e){const t=this.calendars.find((t=>t.id===e));t&&this.confirmationDialog("remove-calendar","remove-calendar",{id:t.id,name:t.name})}}}removeCalendarConfirm(e){e.id&&(R.removeCalendar(e.id),this.calendars=R.getAllCalendars(!0),this.object=this.calendars[0],this.updateApp())}async addNewCalendar(e){e.preventDefault();const t=document.getElementById("scAddCalendarName");if(t&&t.value){const e=R.addTempCalendar(t.value);await qe.setToPredefined(e,c.Gregorian),this.calendars.push(e),this.object=e,this._tabs[0].active="quickSetup",this.updateApp()}}predefinedCalendarClick(e){const t=e.target?.closest(".fsc-vc");if(t&&this.appWindow){const e=t.classList.contains("fsc-x");this.appWindow.querySelectorAll(".fsc-tc .fsc-uc .fsc-vc").forEach((e=>{e.classList.remove("fsc-x")}));const s=this.appWindow.querySelector(".fsc-tc .fsc-wc .fsc-xc");if(e)this.uiElementStates.selectedPredefinedCalendar="",s&&(s.style.display="none");else{t.classList.add("fsc-x");const e=t.getAttribute("data-calendar");e&&(this.uiElementStates.selectedPredefinedCalendar=e,s&&(s.style.display="block"))}}}quickSetupNextClick(e){e.preventDefault(),this.confirmationDialog("overwrite","predefined",{name:this.object.name})}async quickSetupNextConfirm(){this.uiElementStates.qsNextClicked=!this.uiElementStates.qsNextClicked,await qe.setToPredefined(this.object,this.uiElementStates.selectedPredefinedCalendar,this.uiElementStates.qsAddNotes),this.updateApp()}quickSetupBackClick(e){if(e.preventDefault(),this.uiElementStates.qsNextClicked=!this.uiElementStates.qsNextClicked,this.appWindow){const e=this.appWindow.querySelector(".fsc-tc .fsc-cd"),t=this.appWindow.querySelector(".fsc-tc .fsc-dd");e&&t&&(ue(e,500),ue(t,500))}}quickSetupSaveClick(e){e.preventDefault(),this.uiElementStates.selectedPredefinedCalendar="",this.uiElementStates.qsNextClicked=!1,this.uiElementStates.qsAddNotes=!0;const t=ze.GetSelector("quick-setup-predefined-calendar",{});this.object.year.numericRepresentation=t.selectedDate.start.year,this.object.year.visibleYear=t.selectedDate.start.year,this.object.year.selectedYear=t.selectedDate.start.year,this.object.updateMonth(t.selectedDate.start.month,"current",!0,t.selectedDate.start.day),this._tabs[0].active="generalSettings",this.save(!1,!1).catch(O.error)}toggleShowAdvanced(e){e.preventDefault();const t=e.currentTarget;if(t){const e=t.closest(".fsc-ed");if(e){const t=parseInt(e.getAttribute("data-index")||""),s=e.getAttribute("data-type");!isNaN(t)&&t>=0&&("month"===s&&t<this.object.months.length?this.object.months[t].showAdvanced=!this.object.months[t].showAdvanced:"weekday"===s&&t<this.object.weekdays.length?this.object.weekdays[t].showAdvanced=!this.object.weekdays[t].showAdvanced:"season"===s&&t<this.object.seasons.length&&(this.object.seasons[t].showAdvanced=!this.object.seasons[t].showAdvanced),this.updateUIFromObject())}}}writeInputValuesToObjects(){this.appWindow&&(this.globalConfiguration.secondsInCombatRound=Ve("#scSecondsInCombatRound",6,!1,this.appWindow),this.globalConfiguration.combatPauseRule=Ue("#scCombatPauseClockRule",o.Active,this.appWindow),this.globalConfiguration.calendarsSameTimestamp=_e("#scCalendarsSameTimestamp",!1,this.appWindow),this.globalConfiguration.syncCalendars=_e("#scSyncCalendars",!1,this.appWindow),this.globalConfiguration.showNotesFolder=_e("#scShowNoteFolder",!1,this.appWindow),this.clientSettings.theme=Ue("#scTheme",i[0].key,this.appWindow),this.clientSettings.openOnLoad=_e("#scOpenOnLoad",!0,this.appWindow),this.clientSettings.openCompact=_e("#scOpenInCompact",!1,this.appWindow),this.clientSettings.rememberPosition=_e("#scRememberPos",!0,this.appWindow),this.clientSettings.rememberCompactPosition=_e("#scRememberCompactPos",!0,this.appWindow),this.clientSettings.noteReminderNotification=Ue("#scNoteReminderNotification",N.whisper,this.appWindow),this.clientSettings.sideDrawerDirection=Ue("#scSideDrawerDirection","sc-right",this.appWindow),this.clientSettings.alwaysShowNoteList=_e("#scAlwaysOpenNoteList",!1,this.appWindow),this.clientSettings.persistentOpen=_e("#scPersistentOpen",!1,this.appWindow),this.clientSettings.compactViewScale=Ve('input[name="scCompactViewScale"]',100,!1,this.appWindow)||100,this.globalConfiguration.permissions.viewCalendar.player=_e("#scCalendarVisibleP",!0,this.appWindow),this.globalConfiguration.permissions.viewCalendar.trustedPlayer=_e("#scCalendarVisibleTP",!0,this.appWindow),this.globalConfiguration.permissions.viewCalendar.assistantGameMaster=_e("#scCalendarVisibleAGM",!0,this.appWindow),this.globalConfiguration.permissions.addNotes.player=_e("#scAddNotesP",!1,this.appWindow),this.globalConfiguration.permissions.addNotes.trustedPlayer=_e("#scAddNotesTP",!1,this.appWindow),this.globalConfiguration.permissions.addNotes.assistantGameMaster=_e("#scAddNotesAGM",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.player=_e("#scChangeDateTimeP",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.trustedPlayer=_e("#scChangeDateTimeTP",!1,this.appWindow),this.globalConfiguration.permissions.changeDateTime.assistantGameMaster=_e("#scChangeDateTimeAGM",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.player=_e("#scReorderNotesP",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.trustedPlayer=_e("#scReorderNotesTP",!1,this.appWindow),this.globalConfiguration.permissions.reorderNotes.assistantGameMaster=_e("#scReorderNotesAGM",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.player=_e("#scChangeActiveCalP",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.trustedPlayer=_e("#scChangeActiveCalTP",!1,this.appWindow),this.globalConfiguration.permissions.changeActiveCalendar.assistantGameMaster=_e("#scChangeActiveCalAGM",!1,this.appWindow),this.uiElementStates.qsAddNotes=_e("#scQSAddNotes",!0,this.appWindow),this.object.name=Ue("#scCalendarName","New Calendar",this.appWindow),this.object.generalSettings.gameWorldTimeIntegration=Ue("#scGameWorldTime",g.Mixed,this.appWindow),this.object.generalSettings.pf2eSync=_e("#scPF2ESync",!0,this.appWindow),this.object.generalSettings.dateFormat.date=Ue("#scDateFormatsDate","MMMM DD, YYYY",this.appWindow),this.object.generalSettings.dateFormat.time=Ue("#scDateFormatsTime","HH:mm:ss",this.appWindow),this.object.generalSettings.dateFormat.monthYear=Ue("#scDateFormatsMonthYear","MMMM YAYYYYYZ",this.appWindow),this.object.generalSettings.compactViewOptions.controlLayout=function(e,t=document){return Array.from(t.querySelectorAll(`input[name=${e}]:checked`)).map((e=>e.value))}("scCompactControlLayout",this.appWindow)[0]||"full",this.object.year.numericRepresentation=Ve("#scCurrentYear",0,!1,this.appWindow),this.object.year.prefix=Ue("#scYearPreFix","",this.appWindow),this.object.year.postfix=Ue("#scYearPostFix","",this.appWindow),this.object.year.yearZero=Ve("#scYearZero",0,!1,this.appWindow),this.object.year.yearNamingRule=Ue("#scYearNameBehaviour",m.Default,this.appWindow),this.object.year.yearNamesStart=Ve("#scYearNamesStart",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-fd .fsc-gd>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.year.yearNames.length&&(this.object.year.yearNames[t]=Ue(".fsc-id","New Named Year",e))})),this.appWindow.querySelectorAll(".fsc-jd .fsc-kd>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.months.length){const s=Ue(".fsc-ld","New Month",e);s!==this.object.months[t].name?this.object.months[t].abbreviation=s.substring(0,3):this.object.months[t].abbreviation=Ue(".fsc-md","New Month",e),this.object.months[t].description=Ue(".fsc-nd","",e),this.object.months[t].name=s;const a=Ve(".fsc-od",1,!1,e);a!==this.object.months[t].numberOfDays&&(this.object.months[t].numberOfDays=a,this.object.year.leapYearRule.rule===h.None&&(this.object.months[t].numberOfLeapYearDays=a),this.updateMonthDays(this.object.months[t]));const n=_e(".fsc-pd",!1,e);n!==this.object.months[t].intercalary&&(this.object.months[t].intercalary=n,this.rebaseMonthNumbers());const i=_e(".fsc-qd",!1,e);i!==this.object.months[t].intercalaryInclude&&(this.object.months[t].intercalaryInclude=i,this.rebaseMonthNumbers()),this.object.months[t].numericRepresentationOffset=Ve(".fsc-rd",0,!1,e),this.object.months[t].startingWeekday=Ve(".fsc-sd",null,!1,e)}})),this.object.year.showWeekdayHeadings=_e("#scShowWeekdayHeaders",!0,this.appWindow),this.object.year.firstWeekday=Ve("#scWeekdayFirstDay",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-td .fsc-p>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.weekdays.length){const s=Ue(".fsc-ud","New Weekday",e);s!==this.object.weekdays[t].name?(this.object.weekdays[t].name=s,this.object.weekdays[t].abbreviation=s.substring(0,2)):this.object.weekdays[t].abbreviation=Ue(".fsc-vd","New",e),this.object.weekdays[t].description=Ue(".fsc-wd","",e),this.object.weekdays[t].restday=_e(".fsc-xd",!1,e)}})),this.object.year.leapYearRule.rule=Ue("#scLeapYearRule","none",this.appWindow),this.object.year.leapYearRule.customMod=Ve("#scLeapYearCustomMod",0,!1,this.appWindow),this.appWindow.querySelectorAll(".fsc-yd .fsc-kd>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");if(!isNaN(t)&&t>=0&&t<this.object.months.length){const s=Ve(".fsc-zd",0,!1,e);s!==this.object.months[t].numberOfLeapYearDays&&(this.object.months[t].numberOfLeapYearDays=s,this.updateMonthDays(this.object.months[t]))}})),this.appWindow.querySelectorAll(".fsc-_d .fsc-ae>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.seasons.length&&(this.object.seasons[t].name=Ue(".fsc-o","New Season",e),this.object.seasons[t].icon=Ue(".fsc-be",f.None,e),this.object.seasons[t].color=Ue(".fsc-ce","#FFFFFF",e),this.object.seasons[t].description=Ue(".fsc-de","",e))})),this.appWindow.querySelectorAll(".fsc-ee .fsc-ca>.fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.moons.length&&(this.object.moons[t].name=Ue(".fsc-fe","New Moon",e),this.object.moons[t].cycleLength=Ve(".fsc-ge",29.53059,!0,e),this.object.moons[t].cycleDayAdjust=Ve(".fsc-he",0,!0,e),this.object.moons[t].color=Ue(".fsc-ie","#FFFFFF",e),this.object.moons[t].firstNewMoon.yearReset=Ue(".fsc-je","none",e),this.object.moons[t].firstNewMoon.year=Ve(".fsc-ke",0,!1,e),this.object.moons[t].firstNewMoon.yearX=Ve(".fsc-le",0,!1,e),e.querySelectorAll(".fsc-me>.fsc-ed:not(.fsc-hd)").forEach((e=>{const s=parseInt(e.getAttribute("data-index")||"");!isNaN(s)&&s>=0&&s<this.object.moons[t].phases.length&&(this.object.moons[t].phases[s].name=Ue(".fsc-ne","New Phase",e),this.object.moons[t].phases[s].singleDay=_e(".fsc-oe",!1,e),this.object.moons[t].phases[s].icon=Ue(".fsc-pe","new",e))})),this.object.moons[t].updatePhaseLength())})),this.object.time.hoursInDay=Ve("#scHoursInDay",24,!1,this.appWindow),this.object.time.minutesInHour=Ve("#scMinutesInHour",60,!1,this.appWindow),this.object.time.secondsInMinute=Ve("#scSecondsInMinute",60,!1,this.appWindow),this.object.generalSettings.showClock=_e("#scShowClock",!0,this.appWindow),this.object.time.gameTimeRatio=Ve("#scGameTimeRatio",1,!0,this.appWindow),this.object.time.updateFrequency=Ve("#scTimeUpdateFrequency",1,!0,this.appWindow),this.object.time.unifyGameAndClockPause=_e("#scUnifyClockWithFoundryPause",!1,this.appWindow),this.object.time.hoursInDay<=0&&(this.object.time.hoursInDay=1),this.object.time.minutesInHour<=0&&(this.object.time.minutesInHour=1),this.object.time.secondsInMinute<=0&&(this.object.time.secondsInMinute=1),this.object.time.updateFrequency<=0&&(this.object.time.updateFrequency=1),this.object.generalSettings.noteDefaultVisibility=_e("#scDefaultPlayerVisibility",!0,this.appWindow),this.object.generalSettings.postNoteRemindersOnFoundryLoad=_e("#scPostNoteRemindersOnFoundryLoad",!0,this.appWindow),this.appWindow.querySelectorAll(".fsc-qe .fsc-re .fsc-ed:not(.fsc-hd)").forEach((e=>{const t=parseInt(e.getAttribute("data-index")||"");!isNaN(t)&&t>=0&&t<this.object.noteCategories.length&&(this.object.noteCategories[t].name=Ue(".fsc-se","New Category",e),this.object.noteCategories[t].color=Ue(".fsc-te","New Category",e),this.object.noteCategories[t].textColor=ce(this.object.noteCategories[t].color))})))}updateUIFromObject(){if(this.appWindow){const e=this.object.getCurrentDate();this.uiElementStates.dateFormatExample=J({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.date,this.object),this.uiElementStates.timeFormatExample=J({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.time,this.object),this.uiElementStates.monthYearFormatExample=J({year:e.year,month:e.month,day:e.day,hour:13,minute:36,seconds:42},this.object.generalSettings.dateFormat.monthYear,this.object);let t=this.appWindow.querySelector("#scDateFormatsDate")?.closest(".form-group")?.querySelector(".fsc-ue");t&&(t.innerHTML=`<strong>${z.Localize("FSC.Example")}</strong>: ${this.uiElementStates.dateFormatExample}`),t=this.appWindow.querySelector("#scDateFormatsTime")?.closest(".form-group")?.querySelector(".fsc-ue"),t&&(t.innerHTML=`<strong>${z.Localize("FSC.Example")}</strong>: ${this.uiElementStates.timeFormatExample}`),t=this.appWindow.querySelector("#scDateFormatsMonthYear")?.closest(".form-group")?.querySelector(".fsc-ue"),t&&(t.innerHTML=`<strong>${z.Localize("FSC.Example")}</strong>: ${this.uiElementStates.monthYearFormatExample}`),ge("#scYearNamesStart",this.object.year.yearNamingRule!==m.Random);for(let e=0;e<this.object.months.length;e++){const t=this.appWindow.querySelector(`.fsc-jd .fsc-kd>.fsc-ed[data-index="${e}"]`);if(t){this.showAdvancedSection(t,this.object.months[e].showAdvanced),ge(".fsc-qd",this.object.months[e].intercalary,t);const s=t.querySelector(".fsc-ve");s&&(s.innerText=this.object.months[e].numericRepresentation<0?"IC":this.object.months[e].numericRepresentation.toString())}}for(let e=0;e<this.object.weekdays.length;e++){const t=this.appWindow.querySelector(`.fsc-td .fsc-p>.fsc-ed[data-index="${e}"]`);t&&this.showAdvancedSection(t,this.object.weekdays[e].showAdvanced)}ge("#scLeapYearCustomMod",this.object.year.leapYearRule.rule===h.Custom);let s=this.appWindow.querySelector("#scLeapYearMonthList");s&&(s.classList.contains("fsc-c")&&this.object.year.leapYearRule.rule!==h.None||s.classList.contains("fsc-b")&&this.object.year.leapYearRule.rule===h.None?ue(s,400):this.object.year.leapYearRule.rule!==h.None?(s.classList.remove("fsc-c"),s.classList.add("fsc-b")):(s.classList.add("fsc-c"),s.classList.remove("fsc-b")));for(let e=0;e<this.object.seasons.length;e++){const t=this.appWindow.querySelector(`.fsc-_d .fsc-ae>.fsc-ed[data-index="${e}"]`);t&&this.showAdvancedSection(t,this.object.seasons[e].showAdvanced)}for(let e=0;e<this.object.moons.length;e++){const t=this.appWindow.querySelector(`.fsc-ee .fsc-ca>.fsc-ed[data-index="${e}"]`);if(t){ge(".fsc-ke",this.object.moons[e].firstNewMoon.yearReset===y.None,t),ge(".fsc-le",this.object.moons[e].firstNewMoon.yearReset===y.XYears,t);for(let s=0;s<this.object.moons[e].phases.length;s++){const a=t.querySelector(`.fsc-me>.fsc-ed[data-index="${s}"] .fsc-we`);a&&(a.innerText=`${this.object.moons[e].phases[s].length} ${z.Localize("FSC.Days")}`)}}}}}showAdvancedSection(e,t){const s=e.querySelector(".fsc-_c"),a=e.querySelector(".fsc-xe");s&&a&&((a.classList.contains("fsc-c")&&t||a.classList.contains("fsc-b")&&!t)&&ue(a,400),s.innerHTML=t?`<i class="fa fa-chevron-up"></i><span>${z.Localize("FSC.HideAdvanced")}</span>`:`<i class="fa fa-chevron-down"></i><span>${z.Localize("FSC.ShowAdvanced")}</span>`)}dateFormatTableClick(){if(this.uiElementStates.dateFormatTableExpanded=!this.uiElementStates.dateFormatTableExpanded,this.appWindow){const e=this.appWindow.querySelector(".fsc-ye .fsc-ze .fsc-_e");e&&(e.style.display=this.uiElementStates.dateFormatTableExpanded?"block":"none");const t=this.appWindow.querySelector(".fsc-ye .fsc-ze .fsc-ad .fa");t&&(t.className="fa "+(this.uiElementStates.dateFormatTableExpanded?"fa-chevron-up":"fa-chevron-down"))}}rebaseMonthNumbers(){let e=0,t=0;for(let s=0;s<this.object.months.length;s++){const a=this.object.months[s];a.intercalary?(t++,a.numericRepresentation=-1*t):(a.numericRepresentation=e+1,e=a.numericRepresentation)}}addToTable(e){e.preventDefault();const t=e.currentTarget;if(t){switch(t.getAttribute("data-type")){case"month":const t=this.object.months.length+1;this.object.months.push(new Fe("New Month",t,0,30)),this.rebaseMonthNumbers();break;case"weekday":const s=this.object.weekdays.length+1;this.object.weekdays.push(new Re(s,"New Weekday"));break;case"season":this.object.seasons.push(new We("New Season",1,1));break;case"moon":const a=new Ye("Moon",29.53059);a.firstNewMoon={yearReset:y.None,yearX:0,year:0,month:1,day:1};const n=Number(((a.cycleLength-4)/4).toPrecision(5));a.phases=[{name:z.Localize("FSC.Moon.Phase.New"),length:1,icon:f.NewMoon,singleDay:!0},{name:z.Localize("FSC.Moon.Phase.WaxingCrescent"),length:n,icon:f.WaxingCrescent,singleDay:!1},{name:z.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:f.FirstQuarter,singleDay:!0},{name:z.Localize("FSC.Moon.Phase.WaxingGibbous"),length:n,icon:f.WaxingGibbous,singleDay:!1},{name:z.Localize("FSC.Moon.Phase.Full"),length:1,icon:f.Full,singleDay:!0},{name:z.Localize("FSC.Moon.Phase.WaningGibbous"),length:n,icon:f.WaningGibbous,singleDay:!1},{name:z.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:f.LastQuarter,singleDay:!0},{name:z.Localize("FSC.Moon.Phase.WaningCrescent"),length:n,icon:f.WaningCrescent,singleDay:!1}],this.object.moons.push(a);break;case"moon-phase":const i=e.currentTarget.getAttribute("data-moon-index");if(i){const e=parseInt(i);!isNaN(e)&&e<this.object.moons.length&&(this.object.moons[e].phases.push({name:"Phase",length:1,icon:f.NewMoon,singleDay:!1}),this.object.moons[e].updatePhaseLength())}break;case"year-name":this.object.year.yearNames.push("New Named Year");break;case"note-category":this.object.noteCategories.push({id:H(),name:"New Category",color:"#b13737 ",textColor:"#ffffff"})}this.updateApp()}}removeFromTable(e){e.preventDefault();const t=e.currentTarget;if(t){const s=t.getAttribute("data-type"),a=t.closest(".fsc-ed"),n=t.getAttribute("data-index");if(a&&!n){const e=a.getAttribute("data-index");if(e){const a=parseInt(e);if(!isNaN(a)){switch(s){case"month":if(a<this.object.months.length){this.object.months.splice(a,1),0===this.object.months.length&&this.object.months.push(new Fe("New Month",1,0,30));for(let e=0;e<this.object.months.length;e++)this.object.months[e].numericRepresentation=e+1;this.rebaseMonthNumbers()}break;case"weekday":if(a<this.object.weekdays.length){this.object.weekdays.splice(a,1);for(let e=0;e<this.object.weekdays.length;e++)this.object.weekdays[e].numericRepresentation=e+1}break;case"season":a<this.object.seasons.length&&this.object.seasons.splice(a,1);break;case"moon":a<this.object.moons.length&&this.object.moons.splice(a,1);break;case"moon-phase":const e=t.getAttribute("data-moon-index");if(e){const t=parseInt(e);!isNaN(t)&&t<this.object.moons.length&&a<this.object.moons[t].phases.length&&(this.object.moons[t].phases.splice(a,1),this.object.moons[t].updatePhaseLength())}break;case"year-name":a<this.object.year.yearNames.length&&this.object.year.yearNames.splice(a,1);break;case"note-category":a<this.object.noteCategories.length&&this.object.noteCategories.splice(a,1)}this.updateApp()}}}else if(n&&"all"===n){switch(s){case"month":this.object.months=[new Fe("New Month",1,0,30)];break;case"weekday":this.object.weekdays=[];break;case"season":this.object.seasons=[];break;case"moon":this.object.moons=[];break;case"moon-phase":const t=e.currentTarget.getAttribute("data-moon-index");if(t){const e=parseInt(t);!isNaN(e)&&e<this.object.moons.length&&(this.object.moons[e].phases=[])}break;case"year-name":this.object.year.yearNames=[];break;case"note-category":this.object.noteCategories=[]}this.updateApp()}}}dateSelectorChange(e,t,s){if(t===T.seasonStartingDate){const t=this.object.seasons.find((t=>t.id===e));if(t){const e=!s.startDate.month||s.startDate.month<0?0:s.startDate.month,a=!s.startDate.day||s.startDate.day<0?0:s.startDate.day;t.startingMonth=e,t.startingDay=a}}else if(t===T.seasonSunriseSunsetTime){const t=this.object.seasons.find((t=>t.id===e));if(t){const e=R.getActiveCalendar();t.sunriseTime=(s.startDate.hour||0)*e.time.minutesInHour*e.time.secondsInMinute+(s.startDate.minute||0)*e.time.secondsInMinute,t.sunsetTime=(s.endDate.hour||0)*e.time.minutesInHour*e.time.secondsInMinute+(s.endDate.minute||0)*e.time.secondsInMinute}}else if(t===T.moonFirstNewMoonDate){const t=this.object.moons.find((t=>t.id===e));t&&(t.firstNewMoon.month=!s.startDate.month||s.startDate.month<0?0:s.startDate.month,t.firstNewMoon.day=!s.startDate.day||s.startDate.day<0?0:s.startDate.day)}}updateMonthDays(e){e.numberOfDays<0&&(e.numberOfDays=0),e.numberOfLeapYearDays<0&&(e.numberOfLeapYearDays=e.numberOfDays);const t=e.numberOfLeapYearDays>e.numberOfDays?e.numberOfLeapYearDays:e.numberOfDays,s=e.getDay();let a=null;s&&(a=s.numericRepresentation>=e.numberOfDays?1:s.numericRepresentation),e.days=[],e.populateDays(t,a)}confirmationDialog(e,t,s){let a="",n="";"overwrite"===e?(a=z.Localize("FSC.ApplyPredefined"),n=z.Localize("FSC.ApplyPredefinedText").replace("${CAL_NAME}",s.name)):"remove-calendar"===e&&(a=z.Localize("FSC.RemoveCalendar"),n=z.Localize("FSC.RemoveCalendarConfirmText").replace("${CAL_NAME}",s.name));new Dialog({title:a,content:n,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:z.Localize("FSC.Confirm"),callback:this.confirmationDialogYes.bind(this,t,s)},no:{icon:'<i class="fas fa-times"></i>',label:z.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async confirmationDialogYes(e,t){"predefined"===e?this.quickSetupNextConfirm():"remove-calendar"===e&&this.removeCalendarConfirm(t)}async saveClick(e,t){t.preventDefault(),await this.save(e)}async save(e,t=!0){t&&this.writeInputValuesToObjects(),R.mergeClonedCalendars(),q.save(this.globalConfiguration,this.clientSettings),await R.getActiveCalendar().syncTime(!0),e?this.closeApp():(this.calendars=R.cloneCalendars(),this.object=this.calendars[0],this.updateApp())}exportCalendar(e){e.preventDefault();const s={};this.appWindow?.querySelectorAll(".fsc-af .fsc-bf input").forEach((e=>{const t=e.getAttribute("data-id");t&&(s[t]=e.checked)}));const a={exportVersion:2,globalConfig:s.global?{secondsInCombatRound:this.globalConfiguration.secondsInCombatRound,calendarsSameTimestamp:this.globalConfiguration.calendarsSameTimestamp,syncCalendars:this.globalConfiguration.syncCalendars,showNotesFolder:this.globalConfiguration.showNotesFolder}:{},permissions:s.permissions?this.globalConfiguration.permissions.toConfig():{},calendars:[],notes:{}};for(let e=0;e<this.calendars.length;e++){const n=this.calendars[e].toConfig(),i=n.id.replace("_temp","");s[`${n.id}-notes`]&&(a.notes[i]=[],game.journal?.forEach((e=>{const s=e.getFlag(t,"noteData");s&&s.calendarId&&s.calendarId===i&&a.notes[i].push(e.toObject())}))),s[n.id]&&(n.id=i,a.calendars.push(n))}(0,$e.saveAs)(new Blob([JSON.stringify(a)],{type:"application/json"}),"simple-calendar-export.json")}importCalendarFileChange(e){const t=e.target;if(t&&t.files&&t.files.length&&"application/json"===t.files[0].type){this.appWindow?.querySelector(".fsc-af .fsc-cf")?.classList.remove("fsc-ha");const e=new FileReader;e.onprogress=this.importCalendarProgress.bind(this),e.onload=this.importCalendarRead.bind(this),e.readAsText(t.files[0])}}importCalendarProgress(e){const t=this.appWindow?.querySelector(".fsc-af .fsc-cf .fsc-df");t&&(t.style.width=e.loaded/e.total*100+"%")}importCalendarRead(e){this.importCalendarProgress(e),this.appWindow?.querySelector(".fsc-af .fsc-cf")?.classList.add("fsc-ha");const t=e.target;if(t&&t.result&&this.appWindow){const e=this.appWindow.querySelector(".fsc-af .fsc-ef .fsc-ff");if(e){let s=`<p>${z.Localize("FSC.Configuration.ImportExport.ImportDetailsText")}</p><ul class="fsc-bf">`;const a=JSON.parse(t.result.toString());if(!a.hasOwnProperty("exportVersion")){if(a.calendars=[{id:"default",name:"Default"}],a.globalConfig={},a.hasOwnProperty("generalSettings")&&(a.generalSettings.hasOwnProperty("permissions")&&(a.permissions=a.permissions||{},a.permissions.viewCalendar=a.generalSettings.permissions.viewCalendar,a.permissions.addNotes=a.generalSettings.permissions.addNotes,a.permissions.reorderNotes=a.generalSettings.permissions.reorderNotes,a.permissions.changeDateTime=a.generalSettings.permissions.changeDateTime,delete a.generalSettings.permissions),a.calendars[0].general=a.generalSettings,delete a.generalSettings),a.hasOwnProperty("currentDate")&&(a.currentDate.day--,a.currentDate.month--,a.calendars[0].currentDate=a.currentDate,delete a.currentDate),a.hasOwnProperty("leapYearSettings")&&(a.calendars[0].leapYear=a.leapYearSettings,delete a.leapYearSettings),a.hasOwnProperty("monthSettings")&&(a.calendars[0].months=a.monthSettings,delete a.monthSettings),a.hasOwnProperty("moonSettings")){for(let e=0;e<a.moonSettings.length;e++)a.moonSettings[e].firstNewMoon.month--,a.moonSettings[e].firstNewMoon.day--;a.calendars[0].moons=a.moonSettings,delete a.moonSettings}if(a.hasOwnProperty("noteCategories")&&(a.calendars[0].noteCategories=a.noteCategories,delete a.noteCategories),a.hasOwnProperty("seasonSettings")){for(let e=0;e<a.seasonSettings.length;e++)a.seasonSettings[e].startingMonth--,a.seasonSettings[e].startingDay--;a.calendars[0].seasons=a.seasonSettings,delete a.seasonSettings}a.hasOwnProperty("timeSettings")&&(a.globalConfig.secondsInCombatRound=a.timeSettings.secondsInCombatRound,delete a.timeSettings.secondsInCombatRound,a.calendars[0].time=a.timeSettings,delete a.timeSettings),a.hasOwnProperty("weekdaySettings")&&(a.calendars[0].weekdays=a.weekdaySettings,delete a.weekdaySettings),a.hasOwnProperty("yearSettings")&&(a.calendars[0].year=a.yearSettings,delete a.yearSettings)}if(a.hasOwnProperty("globalConfig")&&!E(a.globalConfig)&&(s+=`<li><label><input type="checkbox" data-id="global" checked /><span class="fa fa-cog"></span>&nbsp;${z.Localize("FSC.Configuration.Global.Title")}</label></li>`),a.hasOwnProperty("permissions")&&!E(a.permissions)&&(s+=`<li><label><input type="checkbox" data-id="permissions" checked /><span class="fa fa-key"></span>&nbsp;${z.Localize("Permissions")}</label></li>`),a.hasOwnProperty("calendars")&&a.calendars.length)for(let e=0;e<a.calendars.length;e++){s+=`<li><label><input type="checkbox" data-id="${a.calendars[e].id}" checked /><strong><span class="fa fa-calendar"></span> ${a.calendars[e].name}</strong>: ${z.Localize("FSC.CalendarConfiguration")}</label><label>${z.Localize("FSC.ImportInto")}:&nbsp;<select data-for-cal="${a.calendars[e].id}">`;const t=this.calendars.findIndex((t=>0===t.id.indexOf(a.calendars[e].id)));s+=`<option value="new" ${-1===t?"selected":""}>${z.Localize("FSC.NewCalendar")}</option>`;for(let e=0;e<this.calendars.length;e++)s+=`<option value="${this.calendars[e].id}" ${t===e?"selected":""}>${this.calendars[e].name}</option>`;s+="</select></label></li>",a.hasOwnProperty("notes")&&a.notes.hasOwnProperty(a.calendars[e].id)&&(s+=`<li><label><input type="checkbox" data-id="${a.calendars[e].id}-notes" checked /><strong><span class="fa fa-sticky-note"></span> ${a.calendars[e].name}</strong>: ${z.Localize("FSC.CalendarNotes")}</label></label></li>`)}s+=`</ul><button class="fsc-xb fsc-sc" id="importCalendar"><i class="fa fa-file-import"></i> ${z.Localize("FSC.Import")}</button>`,e.innerHTML=s,e.querySelector("#importCalendar")?.addEventListener("click",this.importCalendarSave.bind(this,a))}}}async importCalendarSave(e,s){if(s.preventDefault(),this.appWindow){if(e.hasOwnProperty("globalConfig")&&!E(e.globalConfig)&&_e('.fsc-af .fsc-ef .fsc-ff input[data-id="global"]',!0,this.appWindow)&&(this.globalConfiguration.secondsInCombatRound=e.globalConfig.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=e.globalConfig.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=e.globalConfig.syncCalendars,this.globalConfiguration.showNotesFolder=e.globalConfig.showNotesFolder),e.hasOwnProperty("permissions")&&!E(e.permissions)&&_e('.fsc-af .fsc-ef .fsc-ff input[data-id="permissions"]',!0,this.appWindow)&&this.globalConfiguration.permissions.loadFromSettings(e.permissions),e.hasOwnProperty("calendars")&&e.calendars.length){await G.createJournalDirectory();for(let s=0;s<e.calendars.length;s++){const a=e.calendars[s].id;let n="";if(_e(`.fsc-af .fsc-ef .fsc-ff input[data-id="${e.calendars[s].id}"]`,!0,this.appWindow)){const t=Ue(`.fsc-af .fsc-ef .fsc-ff select[data-for-cal="${e.calendars[s].id}"]`,"new",this.appWindow),a=this.calendars.find((e=>e.id===t));if(delete e.calendars[s].id,a)a.loadFromSettings(e.calendars[s]);else{const t=R.addTempCalendar(e.calendars[s].name);t.loadFromSettings(e.calendars[s]),n=t.id}}if(e.hasOwnProperty("notes")&&e.notes.hasOwnProperty(a)&&_e(`.fsc-af .fsc-ef .fsc-ff input[data-id="${a}-notes"]`,!0,this.appWindow)){const s=Ue(`.fsc-af .fsc-ef .fsc-ff select[data-for-cal="${a}"]`,"new",this.appWindow),i=this.calendars.find((e=>e.id===s)),o=(n||i?.id||a).replace("_temp","");for(let s=0;s<e.notes[a].length;s++){const n=e.notes[a][s];let i=!(n.flags[t].noteData.calendarId===o);if(n.flags[t].noteData.calendarId=o,n.folder=G.noteDirectory?.id,i||!game.journal?.has(n._id)){const e=await JournalEntry.create(n,{keepId:!i});e&&G.addNoteStub(e,o)}else game.journal?.get(n._id)?.update(n)}}}}this._tabs[0].active="generalSettings",this.save(!1,!1).catch(O.error)}}}Be.appWindowId="fsc-gf";class MainApp extends FormApplication{get activeCalendar(){return R.getActiveCalendar()}get visibleCalendar(){return R.getVisibleCalendar()}constructor(){super({}),this.clockClass="stopped",this.opening=!0,this.uiElementStates={"fsc-bf":!1,"fsc-hf":!1,"fsc-if":!1,compactView:!1,dateTimeUnitOpen:!1,dateTimeUnit:I.Day,dateTimeUnitText:"FSC.Day",searchOptionsOpen:!1,calendarListOpen:!1,primaryCheckRunning:!0,cvReverseTime:!1,cvLargerSteps:!1},this.search={term:"",results:[],options:{fields:{date:!0,title:!0,details:!0,author:!0,categories:!0}}},this.addonButtons=[]}initialize(){this.uiElementStates["fsc-hf"]=z.GetBooleanSettings(n.AlwaysShowNoteList),document.addEventListener("keydown",this.keyClick.bind(this)),document.addEventListener("keyup",this.keyClick.bind(this))}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/main.html",e.title="FSC.Title",e.classes=["simple-calendar"],e.id=this.appWindowId,e.resizable=!1,e}getData(e){let t={...super.getData(),compactViewDisplay:{currentSeasonName:"",currentSeasonIcon:"",selectedDayMoons:[],dateTimeControlDisplay:this.activeCalendar.generalSettings.compactViewOptions.controlLayout},mainViewDisplay:{calendarList:[],search:this.search,showChangeCalendarControls:!1,addonButtons:"",addonButtonSidePanels:""},addNotes:ye(game.user,q.globalConfiguration.permissions.addNotes),activeCalendarId:this.activeCalendar.id,calendar:this.visibleCalendar.toTemplate(),changeDateTime:ye(game.user,q.globalConfiguration.permissions.changeDateTime),clockClass:this.clockClass,isGM:z.IsGm(),isPrimary:q.primary,message:"",uiElementStates:this.uiElementStates,reorderNotes:ye(game.user,q.globalConfiguration.permissions.reorderNotes),showClock:this.visibleCalendar.generalSettings.showClock,showDateControls:!1,showSetCurrentDate:!1,showTimeControls:!1,dateTimeFullDisplay:{unit:this.uiElementStates.dateTimeUnit,unitText:this.uiElementStates.dateTimeUnitText,dateTimeUnitOpen:this.uiElementStates.dateTimeUnitOpen},sideDrawerDirection:z.GetStringSettings(n.NoteListOpenDirection)};if(this.activeCalendar.id===this.visibleCalendar.id){t.showDateControls=this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.ThirdParty,t.showTimeControls=this.activeCalendar.generalSettings.showClock&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.ThirdParty;const e=this.visibleCalendar.getMonthAndDayIndex("selected");void 0!==e.month&&void 0!==e.day&&(this.visibleCalendar.months[e.month].days[e.day].current||(t.showSetCurrentDate=ye(game.user,q.globalConfiguration.permissions.changeDateTime)))}else t.changeDateTime&&(t.message=z.Localize("FSC.ViewingDifferentCalendar"));if(this.uiElementStates.compactView){const e=this.visibleCalendar.getCurrentSeason();if(t.compactViewDisplay.currentSeasonName=e.name,t.compactViewDisplay.currentSeasonIcon=le(e.icon,e.color,e.color),""===t.compactViewDisplay.currentSeasonIcon&&(t.compactViewDisplay.currentSeasonIcon=`<span style="color:${e.color};">${e.name.slice(0,2)}</span>`),this.visibleCalendar.moons.length)for(let e=0;e<this.visibleCalendar.moons.length;e++){const s=this.visibleCalendar.moons[e].getMoonPhase(this.visibleCalendar,"current");t.compactViewDisplay.selectedDayMoons.push({name:this.visibleCalendar.moons[e].name,color:this.visibleCalendar.moons[e].color,phase:s,iconSVG:le(s.icon,"#000000",this.visibleCalendar.moons[e].color)})}}else{for(let e=0;e<this.addonButtons.length;e++)t.mainViewDisplay.addonButtons+=`<button class="fsc-xb fsc-jf fsc-kf ${this.addonButtons[e].customClass}" data-sc-abi="${e}" data-tooltip="${this.addonButtons[e].title}"><span class="fa ${this.addonButtons[e].iconClass}"></span></button>`,this.addonButtons[e].showSidePanel&&(void 0===this.uiElementStates[`fsc-lf${e}`]&&(this.uiElementStates[`fsc-lf${e}`]=!1),t.mainViewDisplay.addonButtonSidePanels+=`<div class="fsc-mf fsc-nf fsc-lf${e} ${t.sideDrawerDirection} ${this.uiElementStates[`fsc-lf${e}`]?"fsc-b":"fsc-c"}" data-sc-abi="${e}"></div>`);t.mainViewDisplay.showChangeCalendarControls=ye(game.user,q.globalConfiguration.permissions.changeActiveCalendar),t.mainViewDisplay.calendarList=R.getAllCalendars().map((e=>{const t=e.getCurrentDate(),s=e.time.getCurrentTime();return{id:e.id,name:e.name,date:J({year:t.year,month:t.month,day:t.day,hour:0,minute:0,seconds:0},e.generalSettings.dateFormat.date,e),time:e.generalSettings.showClock?J({year:0,month:1,day:1,hour:s.hour,minute:s.minute,seconds:s.seconds},e.generalSettings.dateFormat.time,e):"",clockRunning:e.timeKeeper.getStatus()===S.Started}}))}return t}render(e,t){if(ye(game.user,q.globalConfiguration.permissions.viewCalendar)){this.visibleCalendar.timeKeeper.getStatus(),S.Started;const e={};this.opening&&(this.uiElementStates.compactView=z.GetBooleanSettings(n.OpenCompact),this.opening=!1);const t=q.clientSettings.persistentOpen?"fsc-of":"";let s="";return this.uiElementStates.compactView&&(s=`sc-scale-${q.clientSettings.compactViewScale}`),e.classes=["simple-calendar",de(),t,s],super.render(!0,e)}}sceneControlButtonClick(){q.clientSettings.persistentOpen&&this.rendered?super.close().catch(O.error):this.render()}close(e){return q.clientSettings.persistentOpen?Promise.resolve():(this.opening=!0,super.close(e))}async minimize(){this.uiElementStates.compactView=!this.uiElementStates.compactView,this.visibleCalendar.resetMonths("selected"),this.hideDrawers(),this.render(!0)}async maximize(){this.uiElementStates.compactView=!1,this.hideDrawers(),this.render(!0)}static setWidthHeight(e){let t=0,s=0;const a=document.querySelector(`#${MainApp.appWindowId}`);if(a){const i=a.querySelector(".window-header");i&&(s+=i.offsetHeight);const o=a.querySelector(".fsc-pf");if(o){if(e.uiElementStates.compactView){o.querySelectorAll(".fsc-qf").forEach((e=>{s+=e.offsetHeight}));const e=225,a=o.querySelector(".fsc-rf .fsc-sf"),n=o.querySelectorAll(".fsc-vb .fsc-wb");let i=0,r=0;a&&(i=a.offsetWidth),n.length&&n.forEach((e=>{r+=e.offsetWidth})),t=Math.max(e,i,r)}else{o.querySelectorAll(".fsc-qf").forEach((e=>{s+=e.offsetHeight}));const e=200,a=o.querySelector(".fsc-h .fsc-j .fsc-k"),n=o.querySelector(".fsc-h .fsc-s .fsc-t"),i=o.querySelector(".fsc-tf .fsc-lb"),r=o.querySelector(".fsc-f");let c=0,l=0,d=0;r&&(d=r.offsetWidth,d+=16),n?(c=n.offsetWidth<e?e:n.offsetWidth,a&&(a.style.maxWidth=`${c}px`)):a&&(Array.from(a.children).forEach((e=>{c+=e.offsetWidth})),c+=20),i&&(Array.from(i.children).forEach((e=>{l+=e.offsetWidth})),l+=8),t=Math.max(c,l,d),t+=10,t+=70}const n=parseInt(window.getComputedStyle(a).borderWidth);isNaN(n)||(s+=2*n,t+=2*n);const i=window.getComputedStyle(o),r=parseInt(i.paddingTop),c=parseInt(i.paddingBottom),l=parseInt(i.paddingLeft),d=parseInt(i.paddingRight);s+=(r||0)+(c||0),t+=(l||0)+(d||0);const h=a.querySelector(".window-content");if(h){const e=window.getComputedStyle(h),a=parseInt(e.paddingTop),n=parseInt(e.paddingBottom),i=parseInt(e.paddingLeft),o=parseInt(e.paddingRight),r=parseInt(e.borderTop),c=parseInt(e.borderBottom),l=parseInt(e.borderLeft),d=parseInt(e.borderRight);s+=(a||0)+(n||0)+(r||0)+(c||0),t+=(i||0)+(o||0)+(l||0)+(d||0)}}const r={};if(e.uiElementStates.compactView&&z.GetBooleanSettings(n.RememberCompactPosition)){const e=z.GetObjectSettings(n.AppCompactPosition);void 0!==e.top&&e.top>=0&&(r.top=e.top),void 0!==e.left&&e.left>=0&&(r.left=e.left)}else if(z.GetBooleanSettings(n.RememberPosition)){const e=z.GetObjectSettings(n.AppPosition);void 0!==e.top&&e.top>=0&&(r.top=e.top),void 0!==e.left&&e.left>=0&&(r.left=e.left)}e.uiElementStates.compactView?(e.setPosition({height:s,width:t}),z.GetBooleanSettings(n.RememberCompactPosition)&&e.setPosition(r)):(z.GetBooleanSettings(n.RememberPosition)&&e.setPosition(r),e.setPosition({height:s,width:t}),e.addonButtonSidePanelContentRender(a))}}ensureCurrentDateIsVisible(){const e=document.querySelector(`#${this.id} .fsc-h`),t=e?.offsetHeight;if(e&&t&&t>=500){const s=e.querySelector(".fsc-w.fsc-aa"),a=e.querySelector(".fsc-w.fsc-x");let n=null;if(a?n=a:s&&(n=s),null!==n){const s=e.getBoundingClientRect(),a=n.getBoundingClientRect();a.top>=s.top&&a.left>=s.left&&a.bottom<=s.bottom&&a.right<=s.right||(e.scrollTop=a.top-s.top-t/2)}}}appDragMove(e){this._onDragMouseMove(e)}appDragEnd(e){this._onDragMouseUp(e);const t=document.getElementById(MainApp.appWindowId);if(t){const e={};t.classList.contains("fsc-uf")?(e.top=parseFloat(t.style.top),e.left=parseFloat(t.style.left),z.SaveObjectSetting(n.AppCompactPosition,e,!1).catch(O.error)):(e.top=parseFloat(t.style.top),e.left=parseFloat(t.style.left),z.SaveObjectSetting(n.AppPosition,e,!1).catch(O.error))}}activateListeners(){this.ensureCurrentDateIsVisible();const e=document.getElementById(MainApp.appWindowId);if(e){const t=e.querySelector("header");if(t){const s=new Draggable(this,jQuery(e),t,this.options.resizable);s.handlers.dragMove=["mousemove",this.appDragMove.bind(s),!1],s.handlers.dragUp=["mouseup",this.appDragEnd.bind(s),!1]}e.addEventListener("click",this.toggleUnitSelector.bind(this,!0)),this.uiElementStates.compactView?e.classList.add("fsc-uf"):(e.classList.remove("fsc-uf"),De.CalendarFull.ActivateListeners(`sc_${this.visibleCalendar.id}_calendar`,this.changeMonth.bind(this),this.dayClick.bind(this))),De.Clock.ActivateListeners(`sc_${this.visibleCalendar.id}_clock`),e.querySelector(".fsc-vf .fsc-wf")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-bf")),e.querySelector(".fsc-vf .fsc-xf")?.addEventListener("click",this.configurationClick.bind(this)),e.querySelector(".fsc-vf .fsc-yf")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-if")),e.querySelector(".fsc-zf")?.addEventListener("click",this.addNote.bind(this)),e.querySelector(".fsc-_f")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-hf")),e.querySelector(".fsc-ag")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-hf")),e.querySelector(".fsc-vf .fsc-bg")?.addEventListener("click",this.todayClick.bind(this)),e.querySelector(".fsc-vf .fsc-cg")?.addEventListener("click",this.dateControlApply.bind(this)),e.querySelector(".fsc-dg")?.addEventListener("click",this.startTime.bind(this)),e.querySelector(".fsc-eg")?.addEventListener("click",this.stopTime.bind(this));const s=e.querySelectorAll(".fsc-bf .fsc-fg .fsc-gg .fsc-sc");s.length&&s.forEach((e=>{e.addEventListener("click",this.changeCalendar.bind(this,!1))})),e.querySelectorAll(".fsc-bf .fsc-fg").forEach((e=>{e.addEventListener("click",this.changeCalendar.bind(this,!0))})),e.querySelectorAll(".fsc-hf .fsc-hg").forEach((e=>{e.addEventListener("click",this.viewNote.bind(this)),e.addEventListener("drag",this.noteDrag.bind(this)),e.addEventListener("dragend",this.noteDragEnd.bind(this)),e.addEventListener("contextmenu",this.noteContext.bind(this))})),e.querySelectorAll(".fsc-if .fsc-hf .fsc-hg").forEach((e=>{e.addEventListener("click",this.viewNote.bind(this))})),e.querySelector(".fsc-if .fsc-ig .fa-search")?.addEventListener("click",this.searchClick.bind(this)),e.querySelector(".fsc-if .fsc-ig .fa-times")?.addEventListener("click",this.searchClearClick.bind(this)),e.querySelector(".fsc-if .fsc-ig input")?.addEventListener("keyup",this.searchBoxChange.bind(this)),e.querySelector(".fsc-if .fsc-jg")?.addEventListener("click",this.searchOptionsToggle.bind(this,!1)),e.querySelectorAll(".fsc-if .fsc-kg input").forEach((e=>{e.addEventListener("change",this.searchOptionsFieldsChange.bind(this))})),e.querySelectorAll(".fsc-qf > .fsc-ga .fsc-sa").forEach((e=>{e.addEventListener("click",this.noteContextClick.bind(this))})),e.querySelectorAll(".fsc-vb .fsc-zb").forEach((e=>{e.addEventListener("click",this.toggleUnitSelector.bind(this,!1))})),e.querySelectorAll(".fsc-vb .fsc-_b li").forEach((e=>{e.addEventListener("click",this.changeUnit.bind(this))})),e.querySelectorAll(".fsc-ub .fsc-xb").forEach((e=>{e.addEventListener("click",this.timeUnitClick.bind(this))})),e.querySelectorAll(".fsc-kf").forEach((e=>{e.addEventListener("click",this.addonButtonClick.bind(this))}))}}async addonButtonClick(e){const t=e.target?.closest("button")?.attributes.getNamedItem("data-sc-abi");if(t&&t.value){const s=parseInt(t.value);if(!isNaN(s)&&s>=0&&s<this.addonButtons.length){const t=this.addonButtons[s];if(t.showSidePanel)this.toggleDrawer(`fsc-lf${s}`);else try{await t.onRender(e,null)}catch(e){O.error(`Button Click Render Error: ${e}`)}}}}addonButtonSidePanelContentRender(e){e.querySelectorAll(".fsc-nf").forEach((async e=>{const t=e.attributes.getNamedItem("data-sc-abi");if(t&&t.value){const s=parseInt(t.value);if(!isNaN(s)&&s>=0&&s<this.addonButtons.length){const t=this.addonButtons[s];if(t.showSidePanel)try{await t.onRender(null,e)}catch(e){O.error(`Side Panel Render Error: ${e}`)}}}}))}toggleDrawer(e){const t=z.GetBooleanSettings(n.AlwaysShowNoteList),s=[e];t&&!this.uiElementStates["fsc-hf"]&&s.push("fsc-hf"),this.hideDrawers(s),this.searchOptionsToggle(!0);const a=document.querySelector(`#${MainApp.appWindowId} .${e}`);if(a){const s=e.toLowerCase();if(t)if("fsc-hf"!==s||this.uiElementStates["fsc-hf"]){if("fsc-hf"!==s&&(this.uiElementStates[s]=ue(a,500,!1),!this.uiElementStates[s]&&!this.uiElementStates["fsc-hf"])){const e=document.querySelector(`#${MainApp.appWindowId} .fsc-hf`);e&&(this.uiElementStates["fsc-hf"]=ue(e,500,!1))}}else this.uiElementStates[s]=ue(a,500,!1);else this.uiElementStates[s]=ue(a,500,!1)}}hideDrawers(e=[]){document.querySelectorAll(".fsc-mf").forEach((t=>{let s=!0;for(let a=0;a<e.length;a++)t.classList.contains(e[a])&&(s=!1);if(s){ue(t,500,!0);const e=t.classList[1].toLowerCase();this.uiElementStates[e]=!1}}))}toggleUnitSelector(e=!1,t=null){t?.stopPropagation();let s=document.querySelector(".fsc-pf .fsc-_b");if(s&&(this.uiElementStates.dateTimeUnitOpen=ue(s,500,e),this.uiElementStates.compactView)){s.getBoundingClientRect().top<window.innerHeight/2?s.classList.add("fsc-lg"):s.classList.remove("fsc-lg")}}changeUnit(e){const t=e.currentTarget.getAttribute("data-unit");if(t){let e=!1;"year"===t?(this.uiElementStates.dateTimeUnit=I.Year,this.uiElementStates.dateTimeUnitText="FSC.Year",e=!0):"month"===t?(this.uiElementStates.dateTimeUnit=I.Month,this.uiElementStates.dateTimeUnitText="FSC.Month",e=!0):"day"===t?(this.uiElementStates.dateTimeUnit=I.Day,this.uiElementStates.dateTimeUnitText="FSC.Day",e=!0):"hour"===t?(this.uiElementStates.dateTimeUnit=I.Hour,this.uiElementStates.dateTimeUnitText="FSC.Hour",e=!0):"minute"===t?(this.uiElementStates.dateTimeUnit=I.Minute,this.uiElementStates.dateTimeUnitText="FSC.Minute",e=!0):"round"===t?(this.uiElementStates.dateTimeUnit=I.Round,this.uiElementStates.dateTimeUnitText="FSC.Round",e=!0):"seconds"===t&&(this.uiElementStates.dateTimeUnit=I.Second,this.uiElementStates.dateTimeUnitText="FSC.Second",e=!0),e&&this.updateApp()}}changeCalendar(e,t){const s=t.currentTarget;if(s){const t=s.closest(".fsc-fg");if(t){const s=t.getAttribute("data-calid");if(s)if(e||this.activeCalendar.id===s)e&&this.visibleCalendar.id!==s&&R.setVisibleCalendar(s);else if(z.IsGm()&&q.primary)R.setActiveCalendar(s);else if(game.users?.find((e=>e.isGM&&e.active))){const e={calendarId:s};j.emit({type:u.setActiveCalendar,data:e}).catch(O.error)}else z.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}}changeMonth(e,t){this.toggleUnitSelector(!0),this.visibleCalendar.changeMonth(e===D.previous?-1:1),MainApp.setWidthHeight(this)}dayClick(e){if(this.toggleUnitSelector(!0),e.selectedDates&&e.selectedDates.start.day>=0&&e.selectedDates.start.month>=0&&e.selectedDates.start.month<this.visibleCalendar.months.length){const t=e.selectedDates.start.day;let s=!1;const a=this.visibleCalendar.getMonth("selected");if(a){s=a.getDayIndex("selected")===t&&this.visibleCalendar.year.selectedYear===e.selectedDates.start.year}if(this.visibleCalendar.resetMonths("selected"),!s){const s=this.visibleCalendar.months[e.selectedDates.start.month];t>-1&&(s.selected=!0,s.days[t].selected=!0,this.visibleCalendar.year.selectedYear=this.visibleCalendar.year.visibleYear)}this.updateApp()}}todayClick(e){this.visibleCalendar.resetMonths("selected"),this.visibleCalendar.resetMonths("visible");const t=this.visibleCalendar.getMonth();if(t){const e=t.getDay();e&&(this.visibleCalendar.year.selectedYear=this.visibleCalendar.year.numericRepresentation,this.visibleCalendar.year.visibleYear=this.visibleCalendar.year.numericRepresentation,t.visible=!0,t.selected=!0,e.selected=!0,this.updateApp())}}timeUnitClick(e){const t=e.currentTarget,s=t.getAttribute("data-type"),a=t.getAttribute("data-amount");if(s&&a){const e=parseInt(a);if(!isNaN(e)){const t={};if("round"===s?t.seconds=e*q.globalConfiguration.secondsInCombatRound:"seconds"!==s&&"minute"!==s&&"hour"!==s&&"day"!==s&&"month"!==s&&"year"!==s||(t[s]=e),z.IsGm()&&q.primary)this.activeCalendar.changeDateTime(t,{updateMonth:!1,showWarning:!0});else if(game.users?.find((e=>e.isGM&&e.active))){const e={type:p.changeDateTime,interval:t};j.emit({type:u.dateTimeChange,data:e}).catch(O.error)}else z.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}else if(s&&("sunrise"===s||"midday"===s||"sunset"===s||"midnight"===s))if(z.IsGm()&&q.primary)oe(s,this.activeCalendar).catch(O.error);else if(game.users?.find((e=>e.isGM&&e.active))){const e={type:p.advanceTimeToPreset,interval:{},presetTimeOfDay:s};j.emit({type:u.dateTimeChange,data:e}).catch(O.error)}else z.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}dateControlApply(e){if(ye(game.user,q.globalConfiguration.permissions.changeDateTime)){const e=this.activeCalendar.year.selectedYear,t=this.activeCalendar.getMonthAndDayIndex("selected"),s=this.activeCalendar.getMonth("selected");if(s)if(e===this.activeCalendar.year.visibleYear&&s.visible)this.setCurrentDate(e,t.month||0,t.day||0);else{new Dialog({title:z.Localize("FSC.SetCurrentDateDialog.Title"),content:z.Localize("FSC.SetCurrentDateDialog.Content").replace("{DATE}",J({year:e,month:t.month||0,day:t.day||0,hour:0,minute:0,seconds:0},"MMMM DD, YYYY",this.activeCalendar)),buttons:{yes:{label:z.Localize("Yes"),callback:this.setCurrentDate.bind(this,e,t.month||0,t.day||0)},no:{label:z.Localize("No")}},default:"no"}).render(!0)}}else z.UiNotification(z.Localize("FSC.Error.Calendar.GMCurrent"),"warn")}setCurrentDate(e,t,s){if(z.IsGm()&&q.primary)this.activeCalendar.setDateTime({year:e,month:t,day:s},{updateApp:!1,showWarning:!0});else if(game.users?.find((e=>e.isGM&&e.active))){const a={type:p.setDate,interval:{year:e,month:t,day:s}};j.emit({type:u.dateTimeChange,data:a}).catch(O.error)}else z.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}searchClick(){const e=document.getElementById("simpleCalendarSearchBox");e&&(this.search.term=e.value,this.search.results=[],this.search.term&&(this.search.results=G.searchNotes(this.visibleCalendar.id,this.search.term,this.search.options.fields)),this.updateApp())}searchClearClick(){this.search.term="",this.search.results=[],this.updateApp()}searchBoxChange(e){"Enter"===e.key?this.searchClick():this.search.term=e.target.value}searchOptionsToggle(e=!1){let t=document.querySelector(".fsc-if .fsc-mg");t&&(this.uiElementStates.searchOptionsOpen=ue(t,500,e))}searchOptionsFieldsChange(e){const t=e.target;if(t){const e=t.getAttribute("data-field");e&&this.search.options.fields.hasOwnProperty(e)&&(this.search.options.fields[e]=t.checked)}}configurationClick(e){Y.initializeAndShowDialog().catch(O.error)}addNote(e){G.addNewNote(this.visibleCalendar,"New Note").catch(O.error)}viewNote(e){const t=e.currentTarget.getAttribute("data-index");t?G.showNote(t):O.error("No Data index on note element found.")}noteContext(e){const t=e.target?.closest(".fsc-hg"),s=t?.getAttribute("data-index");if(t&&s){const a=game.journal?.get(s);if(a){const n=t.closest(".fsc-qf")?.querySelector(":scope > .fsc-ga"),i=document.getElementById(MainApp.appWindowId);if(i&&n){n.classList.remove("fsc-ha");const t=e.y-i.offsetTop;n.style.top=`${t}px`;const o=G.getNoteStub(a);if(n.setAttribute("data-id",s),o){n.querySelectorAll('div[data-action="edit"], div[data-action="delete"], .fsc-ra').forEach((e=>{o.canEdit?e.classList.remove("fsc-ha"):e.classList.add("fsc-ha")}));const e=n.querySelectorAll(".fsc-ja div:not(.fsc-ha)");e.length&&(e.forEach((e=>e.style.marginBottom="")),e[e.length-1].style.marginBottom="0");const t=n.querySelector('.fsc-sa[data-action="remind"]');t&&(t.innerHTML=`<span class="fa ${o.userReminderRegistered?"fa-bell-slash":"fa-bell"}"></span>${o.userReminderRegistered?z.Localize("FSC.Notes.ReminderCancel"):z.Localize("FSC.Notes.Reminder")}`)}}}}return!1}noteContextClick(e){const t=e.target,s=t?.getAttribute("data-action");if(t&&s){const a=t.closest(".fsc-ga")?.getAttribute("data-id");if(a){const t=game.journal?.get(a);t&&("showPlayers"===s?Journal.showDialog(t).catch((e=>console.error(e))):"delete"===s?t.sheet?.delete(e):"edit"===s?t.sheet?.render(!0,{},!0):"remind"===s&&t.sheet?.reminderChange(!1).catch((e=>console.error(e))))}}}updateApp(){this.rendered&&this.render(!0,{})}startTime(){const e=z.GetSceneForCombatCheck(),t=game.combats;t&&t.size>0&&t.find((t=>t.started&&(null!==e&&t.scene&&t.scene.id===e.id||null===e)))?z.UiNotification(game.i18n.localize("FSC.Warn.Time.ActiveCombats"),"warn"):this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.None&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.Self&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.Mixed||(this.activeCalendar.timeKeeper.start(),this.clockClass=this.activeCalendar.timeKeeper.getStatus(),this.updateApp())}stopTime(){this.activeCalendar.timeKeeper.stop(),this.clockClass=this.activeCalendar.timeKeeper.getStatus(),this.updateApp()}async timeKeepingCheck(){this.activeCalendar.generalSettings.gameWorldTimeIntegration!==g.None&&z.IsGm()&&await this.activeCalendar.syncTime()}noteDrag(e){const t=e.target,s=t.parentNode,a=e.clientX,n=e.clientY;t.classList.add("drag-active");let i=null===document.elementFromPoint(a,n)?t:document.elementFromPoint(a,n);null!==s&&null!==i&&s===i.parentNode&&(i=i!==t.nextSibling?i:i.nextSibling,s.insertBefore(t,i))}noteDragEnd(e){const t=e.target,s=t.parentNode,a=t.getAttribute("data-index");if(t.classList.remove("drag-active"),a&&s){const e=[];for(let t=0;t<s.children.length;t++){const a=s.children[t].getAttribute("data-index");a&&e.push(a)}if(z.IsGm()&&q.primary)G.orderNotesOnDay(this.visibleCalendar.id,e,this.visibleCalendar.getDateTime()).catch(O.error);else if(game.users?.find((e=>e.isGM&&e.active))){const t={calendarId:this.visibleCalendar.id,date:this.visibleCalendar.getDateTime(),newOrder:e};j.emit({type:u.noteUpdate,data:t}).catch(O.error)}else z.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}}_updateObject(e,t){return Promise.resolve(void 0)}keyClick(e){this.rendered&&this.uiElementStates.compactView&&!e.repeat&&(this.uiElementStates.cvLargerSteps=e.shiftKey,this.uiElementStates.cvReverseTime=e.ctrlKey,this.updateApp())}}MainApp.appWindowId="fsc-ng";class Ze{get activeCalendar(){return R.getActiveCalendar()}constructor(){this.primary=!1,this.sockets=new Ae,this.clientSettings={id:"",theme:i[0].key,openOnLoad:!0,openCompact:!1,rememberPosition:!0,rememberCompactPosition:!1,appPosition:{},noteReminderNotification:N.whisper,sideDrawerDirection:"sc-right",alwaysShowNoteList:!1,persistentOpen:!1,compactViewScale:100},this.globalConfiguration={id:"",version:"",calendarsSameTimestamp:!1,combatPauseRule:o.Active,permissions:new He,secondsInCombatRound:6,syncCalendars:!1,showNotesFolder:!1}}static ThemeChange(){this.LoadThemeCSS();const e=de(),t=i.map((e=>e.key)),s=document.getElementById(MainApp.appWindowId);s&&(s.classList.remove(...t),s.classList.add(e));const a=document.getElementById(Be.appWindowId);a&&(a.classList.remove(...t),a.classList.add(e)),document.querySelectorAll(".journal-sheet.simple-calendar").forEach((s=>{s.classList.remove(...t),s.classList.add(e)}))}static LoadThemeCSS(e=""){const s=e||de();if(null===document.head.querySelector(`#theme-${s}`)){const e=document.createElement("link");e.setAttribute("id",`theme-${s}`),e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",getRoute(`modules/${t}/styles/themes/${s}.css`)),document.head.append(e)}}PersistenceChange(){this.clientSettings.persistentOpen=z.GetBooleanSettings(n.PersistentOpen);const e=document.getElementById(MainApp.appWindowId);e&&(this.clientSettings.persistentOpen?e.classList.add("fsc-of"):e.classList.remove("fsc-of"))}CompactScaleChange(){this.clientSettings.compactViewScale=z.GetNumericSettings(n.CompactViewScale);const e=document.getElementById(MainApp.appWindowId);if(e){for(let t=e.classList.length-1;t>=0;t--)e.classList[t].startsWith("sc-scale")&&e.classList.remove(e.classList[t]);e.classList.add(`sc-scale-${q.clientSettings.compactViewScale}`)}}static SideDrawerDirectionChange(){W.updateApp()}static AlwaysShowNoteListChange(){W.initialize(),W.updateApp()}initialize(){this.sockets.initialize(),G.checkNoteTriggers(this.activeCalendar.id,!0),document.body.addEventListener("click",we.BodyEventListener),this.checkCombatActive(),Ie.emit(b.Init,R.getActiveCalendar())}load(){Ze.LoadThemeCSS();const e=z.GetObjectSettings(n.GlobalConfiguration);this.globalConfiguration.permissions.loadFromSettings(e.permissions),this.globalConfiguration.secondsInCombatRound=e.secondsInCombatRound,this.globalConfiguration.calendarsSameTimestamp=e.calendarsSameTimestamp,this.globalConfiguration.syncCalendars=e.syncCalendars,this.globalConfiguration.showNotesFolder=e.showNotesFolder,e.hasOwnProperty("combatPauseRule")&&(this.globalConfiguration.combatPauseRule=e.combatPauseRule),this.clientSettings.theme=de(),this.clientSettings.openOnLoad=z.GetBooleanSettings(n.OpenOnLoad),this.clientSettings.openCompact=z.GetBooleanSettings(n.OpenCompact),this.clientSettings.rememberPosition=z.GetBooleanSettings(n.RememberPosition),this.clientSettings.rememberCompactPosition=z.GetBooleanSettings(n.RememberCompactPosition),this.clientSettings.appPosition=z.GetObjectSettings(n.AppPosition),this.clientSettings.noteReminderNotification=z.GetStringSettings(n.NoteReminderNotification),this.clientSettings.sideDrawerDirection=z.GetStringSettings(n.NoteListOpenDirection),this.clientSettings.alwaysShowNoteList=z.GetBooleanSettings(n.AlwaysShowNoteList),this.clientSettings.persistentOpen=z.GetBooleanSettings(n.PersistentOpen),this.clientSettings.compactViewScale=z.GetNumericSettings(n.CompactViewScale)}reload(){Ze.LoadThemeCSS(),this.clientSettings.theme=de()}save(e=null,t=null){if(R.saveCalendars().catch(O.error),e&&t){const s={id:"",version:z.GetModuleVersion(),permissions:e.permissions,secondsInCombatRound:e.secondsInCombatRound,calendarsSameTimestamp:e.calendarsSameTimestamp,syncCalendars:e.syncCalendars,showNotesFolder:e.showNotesFolder,combatPauseRule:e.combatPauseRule};z.SaveStringSetting(`${B.worldId}.${n.Theme}`,t.theme,!1).then(this.reload.bind(this)).catch(O.error),z.SaveBooleanSetting(n.OpenOnLoad,t.openOnLoad,!1).catch(O.error),z.SaveBooleanSetting(n.OpenCompact,t.openCompact,!1).catch(O.error),z.SaveBooleanSetting(n.RememberPosition,t.rememberPosition,!1).catch(O.error),z.SaveBooleanSetting(n.RememberCompactPosition,t.rememberCompactPosition,!1).catch(O.error),z.SaveObjectSetting(n.AppPosition,t.appPosition,!1).catch(O.error),z.SaveStringSetting(n.NoteReminderNotification,t.noteReminderNotification,!1).catch(O.error),z.SaveStringSetting(n.NoteListOpenDirection,t.sideDrawerDirection,!1).catch(O.error),z.SaveBooleanSetting(n.AlwaysShowNoteList,t.alwaysShowNoteList,!1).catch(O.error),z.SaveBooleanSetting(n.PersistentOpen,t.persistentOpen,!1).catch(O.error),z.SaveNumericSetting(n.CompactViewScale,t.compactViewScale,!1).catch(O.error),z.SaveObjectSetting(n.GlobalConfiguration,s).then((()=>j.emit({type:u.mainAppUpdate,data:{}}))).catch(O.error)}}static HideContextMenus(){document.querySelectorAll(".fsc-ga").forEach((e=>{e.classList.add("fsc-ha")}))}checkCombatActive(){const e=z.GetSceneForCombatCheck(),t=game.combats?.find((t=>!(!t.scene||!e)&&t.scene.id===e.id));t&&t.started&&(this.activeCalendar.time.combatRunning=!0)}getSceneControlButtons(e){if(ye(game.user,this.globalConfiguration.permissions.viewCalendar)){let t=e.find((e=>"notes"===e.name));t&&t.hasOwnProperty("tools")&&t.tools.push({name:"calendar",title:"FSC.Title",icon:"fas fa-calendar simple-calendar-icon",button:!0,onClick:W.sceneControlButtonClick.bind(W)})}}async renderJournalDirectory(e,t){if(await G.createJournalDirectory(),!this.globalConfiguration.showNotesFolder&&G.noteDirectory){const e=t.find(`.folder[data-folder-id='${G.noteDirectory.id}']`);e&&e.remove()}}renderJournalSheet(e,t){if(!this.globalConfiguration.showNotesFolder&&G.noteDirectory){const e=t.find(`option[value='${G.noteDirectory.id}']`);e&&e.remove()}}renderSceneConfig(e,s,a){if(!this.globalConfiguration.showNotesFolder&&a.journals)for(let e=0;e<a.journals.length;e++){const n=game.journal?.get(a.journals[e].id);if(n){if(n.getFlag(t,"noteData")){const t=s.find(`option[value='${a.journals[e].id}']`);t&&t.remove()}}}}gamePaused(e){this.activeCalendar.time.unifyGameAndClockPause&&(game.paused?this.activeCalendar.timeKeeper.setStatus(S.Paused):this.activeCalendar.timeKeeper.start(!0))}worldTimeUpdate(e,t){this.activeCalendar.setFromTime(e,t)}createCombatant(e,t,s){const a=game.combats;if(!this.activeCalendar.time.combatRunning&&a){const t=a.find((t=>t.id===e.parent?.id)),s=z.GetSceneForCombatCheck();t&&t.started&&(null!==s&&t.scene&&t.scene.id===s.id||null===s)&&(this.activeCalendar.time.combatRunning=!0)}}combatUpdate(e,t,s){const a=z.GetSceneForCombatCheck();e.started&&(null!==a&&e.scene&&e.scene.id===a.id||null===a)&&(this.activeCalendar.time.combatRunning=!0,s&&s.hasOwnProperty("advanceTime")&&(0!==s.advanceTime?this.activeCalendar.combatChangeTriggered=!0:this.activeCalendar.processOwnCombatRoundTime(e)))}combatDelete(e){const t=z.GetSceneForCombatCheck();null!==t&&e.scene&&e.scene.id===t.id&&(this.activeCalendar.time.combatRunning=!1)}canvasInit(e){if(z.IsGm()&&this.primary&&this.globalConfiguration.combatPauseRule===o.Current){const t=e.scene?e.scene.id:null,s=game.combats?.filter((e=>e.started&&e.scene?.id===t));this.activeCalendar.time.combatRunning=!(!s||!s.length)}}}const Je={Activate:ze.ActivateSelector.bind(ze),Get:ze.GetSelector.bind(ze),Remove:ze.RemoveSelector.bind(ze)};function Ke(e,t=null,s=null){De.CalendarFull.ActivateListeners(e,t,s)}async function Xe(e,t,s,a,n,i=l.Never,o=[],r="active",c=null,d=[],h=[]){const m="active"===r?R.getActiveCalendar():R.getCalendar(r);if(m){const r=await G.createNote(e,t,{calendarId:m.id,startDate:K(s,null,m),endDate:K(a,null,m),allDay:n,order:0,categories:o,repeats:i,remindUsers:Array.isArray(h)?h:[],macro:c||"none"},m,!1);if(r&&Array.isArray(d)&&d.length){const e={};d.indexOf("default")>-1?(game.users?.forEach((t=>e[t.id]=game.user?.id===t.id?3:2)),e.default=2):d.forEach((t=>e[t]=game.user?.id===t?3:2)),await r.update({ownership:e},{render:!1,renderSheet:!1})}return r}return null}function Qe(e,t,s,a,n){W.addonButtons.push({title:e,iconClass:t,customClass:s,showSidePanel:a,onRender:n}),W.updateApp()}function et(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);if(s){if(ye(game.user,q.globalConfiguration.permissions.changeDateTime))return oe(e,s).catch(O.error),!0}else O.error(`SimpleCalendar.api.advanceTimeToPreset - Unable to find a calendar with the passed in ID of "${t}"`);return!1}function tt(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);return s?s.changeDateTime(e,{updateMonth:!1,showWarning:!0}):(O.error(`SimpleCalendar.api.changeDate - Unable to find a calendar with the passed in ID of "${t}"`),!1)}function st(e={},t={},s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);let n=0,i=0,o=0,r=0,c=0,l=0;if(a){n=void 0!==e.year&&void 0!==t.year?e.year===t.year?e.year:Math.floor(Math.random()*(t.year-e.year+1))+e.year:Math.floor(1e4*Math.random()),i=void 0!==e.month&&void 0!==t.month?e.month===t.month?e.month:Math.floor(Math.random()*(t.month-e.month+1))+e.month:Math.floor(Math.random()*a.months.length),(i<0||i>=a.months.length)&&(i=a.months.length-1);let s=a.months[i];o=void 0!==e.day&&void 0!==t.day?e.day===t.day?e.day:Math.floor(Math.random()*(t.day-e.day+1))+e.day:Math.floor(Math.random()*s.days.length),(o<0||o>=s.days.length)&&(o=s.days.length-1),r=void 0!==e.hour&&void 0!==t.hour?e.hour===t.hour?e.hour:Math.floor(Math.random()*(t.hour-e.hour+1))+e.hour:Math.floor(Math.random()*a.time.hoursInDay),c=void 0!==e.minute&&void 0!==t.minute?e.minute===t.minute?e.minute:Math.floor(Math.random()*(t.minute-e.minute+1))+e.minute:Math.floor(Math.random()*a.time.minutesInHour),l=void 0!==e.seconds&&void 0!==t.seconds?e.seconds===t.seconds?e.seconds:Math.floor(Math.random()*(t.seconds-e.seconds+1))+e.seconds:Math.floor(Math.random()*a.time.secondsInMinute)}else O.error(`SimpleCalendar.api.chooseRandomDate - Unable to find a calendar with the passed in ID of "${s}"`);return{year:n,month:i,day:o,hour:r,minute:c,seconds:l}}function at(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.timeKeeper.getStatus();return{started:e===S.Started,stopped:e===S.Stopped,paused:e===S.Paused}}return O.error(`SimpleCalendar.api.clockStatus - Unable to find a calendar with the passed in ID of "${e}"`),{started:!1,stopped:!1,paused:!1}}async function nt(e,t="active"){let s=!1;if(z.IsGm()){const a="active"===t?R.getActiveCalendar():R.getCalendar(t);a?("string"==typeof e?s=await qe.setToPredefined(a,e):Object.keys(e).length&&(a.loadFromSettings(e),s=!0),R.saveCalendars().catch(O.error)):O.error(`SimpleCalendar.api.configureCalendar - Unable to find a calendar with the passed in ID of "${t}"`)}return s}function it(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonthAndDayIndex(),s=t.time.getCurrentTime();return{year:t.year.numericRepresentation,month:e.month||0,day:e.day||0,hour:s.hour,minute:s.minute,seconds:s.seconds}}return null}function ot(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonthAndDayIndex(),s=t.months[e.month||0],a=s.days[e.day||0],n=t.dayOfTheWeek(t.year.numericRepresentation,e.month||0,e.day||0),i=t.time.getCurrentTime();return{date:J({year:t.year.numericRepresentation,month:e.month||0,day:e.day||0,hour:i.hour,minute:i.minute,seconds:i.seconds},t.generalSettings.dateFormat.date,t),day:a.numericRepresentation.toString(),daySuffix:U(a.numericRepresentation),weekday:t.weekdays.length>n?t.weekdays[n].name:"",monthName:s.name,month:s.numericRepresentation.toString(),year:t.year.numericRepresentation.toString(),yearName:t.year.getYearName(t.year.numericRepresentation),yearPrefix:t.year.prefix,yearPostfix:t.year.postfix,time:J({year:t.year.numericRepresentation,month:e.month||0,day:e.day||0,hour:i.hour,minute:i.minute,seconds:i.seconds},t.generalSettings.dateFormat.time,t)}}return null}function rt(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);return s?ne(e,s):(O.error(`SimpleCalendar.api.dateToTimestamp - Unable to find a calendar with the passed in ID of "${t}"`),0)}function ct(e,t="",s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);if(a){const s=e.year?e.year:0;let n=e.month&&e.month>=0?e.month:0;n>=a.months.length&&(n=a.months.length-1);const i=a.months[n];let o=e.day&&e.day>=0?e.day:0;o>=i.days.length&&(o=i.days.length-1);let r=e.hour&&e.hour>=0?e.hour:0;r>=a.time.hoursInDay&&(r=a.time.hoursInDay-1);let c=e.minute&&e.minute>=0?e.minute:0;c>=a.time.minutesInHour&&(c=a.time.minutesInHour-1);let l=e.seconds&&e.seconds>=0?e.seconds:0;return l>=a.time.secondsInMinute&&(l=a.time.secondsInMinute-1),t?J({year:s,month:n,day:o,hour:r,minute:c,seconds:l},t,a):{date:J({year:s,month:n,day:o,hour:0,minute:0,seconds:0},a.generalSettings.dateFormat.date,a),time:J({year:0,month:0,day:0,hour:r,minute:c,seconds:l},a.generalSettings.dateFormat.time,a)}}return O.error(`SimpleCalendar.api.formatDateTime - Unable to find a calendar with the passed in ID of "${s}"`),""}function lt(e,t="",s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);if(a){Z.isPF2E&&a.generalSettings.pf2eSync&&(e+=Z.getWorldCreateSeconds(a));const s=a.secondsToDate(e);return t?J(s,t,a):{date:J(s,a.generalSettings.dateFormat.date,a),time:J(s,a.generalSettings.dateFormat.time,a)}}return O.error(`SimpleCalendar.api.formatTimestamp - Unable to find a calendar with the passed in ID of "${s}"`),""}function dt(){const e=R.getAllCalendars(),t=[];for(let s=0;s<e.length;s++)t.push(e[s].toConfig());return t}function ht(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.months.map((e=>e.toConfig())):(O.error(`SimpleCalendar.api.getAllMonths - Unable to find a calendar with the passed in ID of "${e}"`),[])}function mt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.moons.map((e=>{const s=e.toConfig();return s.currentPhase=e.getMoonPhase(t),s})):(O.error(`SimpleCalendar.api.getAllMoons - Unable to find a calendar with the passed in ID of "${e}"`),[])}function ut(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.seasons.map((e=>e.toConfig())):(O.error(`SimpleCalendar.api.getAllSeasons - Unable to find a calendar with the passed in ID of "${e}"`),[])}function pt(){const e=he();for(let t in e)e[t]=z.Localize(e[t]);return e}function gt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.weekdays.map((e=>e.toConfig())):(O.error(`SimpleCalendar.api.getAllWeekdays - Unable to find a calendar with the passed in ID of "${e}"`),[])}function ft(){return R.getActiveCalendar().toConfig()}function yt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonth();if(e){const t=e.getDay();if(t)return t.toConfig()}}else O.error(`SimpleCalendar.api.getCurrentDay - Unable to find a calendar with the passed in ID of "${e}"`);return null}function Ct(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonth();if(e)return e.toConfig()}else O.error(`SimpleCalendar.api.getCurrentMonth - Unable to find a calendar with the passed in ID of "${e}"`);return null}function bt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonthAndDayIndex();return t.getSeason(e.month||0,e.day||0).toConfig()}return O.error(`SimpleCalendar.api.getCurrentSeason - Unable to find a calendar with the passed in ID of "${e}"`),{id:"",name:"",description:"",icon:f.None,color:"",startingMonth:0,startingDay:0,sunriseTime:0,sunsetTime:0}}function St(){return de()}function wt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.getMonthAndDayIndex(),s=t.dayOfTheWeek(t.year.numericRepresentation,e.month||0,e.day||0);return t.weekdays[s].toConfig()}return O.error(`SimpleCalendar.api.getCurrentWeekday - Unable to find a calendar with the passed in ID of "${e}"`),null}function vt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.year.toConfig():(O.error(`SimpleCalendar.api.getCurrentYear - Unable to find a calendar with the passed in ID of "${e}"`),null)}function Dt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.year.leapYearRule.toConfig():(O.error(`SimpleCalendar.api.getLeapYearConfiguration - Unable to find a calendar with the passed in ID of "${e}"`),null)}function kt(e="active"){return e="active"===e?R.getActiveCalendar().id:e,G.getNotes(e).map((e=>game.journal?.get(e.entryId)))}function Tt(e,t,s,a="active"){return a="active"===a?R.getActiveCalendar().id:a,G.getNotesForDay(a,e,t,s).map((e=>game.journal?.get(e.entryId)))}function Mt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.time.toConfig():(O.error(`SimpleCalendar.api.getTimeConfiguration - Unable to find a calendar with the passed in ID of "${e}"`),null)}function It(){return W.rendered}function Nt(){return q.primary}function Lt(e="active"){if(q.primary){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t){const e=t.timeKeeper.getStatus();if(e===S.Started)return t.timeKeeper.start(),t.timeKeeper.getStatus()===S.Paused;if(e===S.Paused)return!0}else O.error(`SimpleCalendar.api.pauseClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}async function Pt(e){const t=game.journal?.get(e);if(t){if(G.getNoteStub(t)?.isVisible)return G.removeNoteStub(t),W.updateApp(),await t.delete(),await j.emit({type:u.mainAppUpdate,data:{}}),!0}else O.error(`SimpleCalendar.api.removeNote - Unable to find a journal entry with the passed in ID of "${e}"`);return!1}function jt(){if(z.IsGm()&&q.primary){new Dialog({title:z.Localize("FSC.Migration.APIDialog.Title"),content:z.Localize("FSC.Migration.APIDialog.Content"),buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:z.Localize("FSC.Confirm"),callback:$.run.bind($,!0)},no:{icon:'<i class="fas fa-times"></i>',label:z.Localize("FSC.Cancel")}},default:"no"}).render(!0)}}function Ot(e,t={date:!0,title:!0,details:!0,categories:!0,author:!0},s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);let n=[];return a?n=G.searchNotes(a.id,e,t).map((e=>game.journal?.get(e.entryId))):O.error(`SimpleCalendar.api.searchNotes - Unable to find a calendar with the passed in ID of "${s}"`),n}function At(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);return s?s.secondsToInterval(e):(O.error(`SimpleCalendar.api.secondsToInterval - Unable to find a calendar with the passed in ID of "${t}"`),{})}function xt(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);return s?s.setDateTime(e,{showWarning:!0}):(O.error(`SimpleCalendar.api.setDate - Unable to find a calendar with the passed in ID of "${t}"`),!1)}async function Et(e){e=e.toLowerCase();const t=he();return void 0!==t[e]?(e!==de()&&(await z.SaveStringSetting(`${game.world.id}.${n.Theme}`,e,!1),z.UiNotification(z.Localize("FSC.Info.ThemeChange").replace("{THEME}",z.Localize(t[e])),"info",!0)),!0):(console.error(`SimpleCalendar.api.setTheme - Unable to find a theme with the ID of "${e}"`),!1)}function Ft(e=null,t=!1,s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);if(a){if(R.setVisibleCalendar(a.id),null!==e){const t=K(e,null,a);if(Number.isInteger(t.year)&&Number.isInteger(t.month)&&Number.isInteger(t.day)){const e=a.year.leapYearRule.isLeapYear(t.year);a.year.visibleYear=t.year,(-1===t.month||t.month>a.months.length)&&(t.month=a.months.length-1),a.resetMonths("visible"),a.months[t.month].visible=!0;const s=e?a.months[t.month].numberOfLeapYearDays:a.months[t.month].numberOfDays;(-1==t.day||t.day>s)&&(t.day=s-1),a.resetMonths("selected"),a.months[t.month].days[t.day].selected=!0,a.months[t.month].selected=!0,a.year.selectedYear=a.year.visibleYear}else O.error("Main.api.showCalendar: Invalid date passed in.")}}else O.error(`SimpleCalendar.api.showCalendar - Unable to find a calendar with the passed in ID of "${s}"`);W.uiElementStates.compactView=t,W.rendered?W.updateApp():W.render()}function Rt(e="active"){if(q.primary){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t)return t.timeKeeper.start(),!0;O.error(`SimpleCalendar.api.startClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}function Wt(e="active"){if(q.primary){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);if(t)return t.timeKeeper.stop(),!0;O.error(`SimpleCalendar.api.stopClock - Unable to find a calendar with the passed in ID of "${e}"`)}return!1}function Yt(e="active"){const t="active"===e?R.getActiveCalendar():R.getCalendar(e);return t?t.toSeconds():(O.error(`SimpleCalendar.api.timestamp - Unable to find a calendar with the passed in ID of "${e}"`),NaN)}function $t(e,t,s="active"){const a="active"===s?R.getActiveCalendar():R.getCalendar(s);if(a){const s=a.clone(!1);Z.isPF2E&&a.generalSettings.pf2eSync&&(e+=Z.getWorldCreateSeconds(a));const n=s.secondsToDate(e);if(s.updateTime(n),t.year&&s.changeYear(t.year,!1,"current"),t.month){if(t.month>s.months.length){let e=Math.floor(t.month/s.months.length);t.month=t.month-e*s.months.length,s.changeYear(e,!1,"current")}s.changeMonth(t.month,"current")}if(t.day&&s.changeDayBulk(t.day),t.hour&&t.hour>s.time.hoursInDay){const e=Math.floor(t.hour/s.time.hoursInDay);t.hour=t.hour-e*s.time.hoursInDay,s.changeDayBulk(e)}if(t.minute&&t.minute>s.time.hoursInDay*s.time.minutesInHour){const e=Math.floor(t.minute/(s.time.hoursInDay*s.time.minutesInHour));t.minute=t.minute-e*(s.time.hoursInDay*s.time.minutesInHour),s.changeDayBulk(e)}if(t.seconds&&t.seconds>s.time.secondsPerDay){const e=Math.floor(t.seconds/s.time.secondsPerDay);t.seconds=t.seconds-e*s.time.secondsPerDay,s.changeDayBulk(e)}const i=s.time.changeTime(t.hour,t.minute,t.seconds);return 0!==i&&s.changeDay(i),s.toSeconds()}return O.error(`SimpleCalendar.api.timestampPlusInterval - Unable to find a calendar with the passed in ID of "${s}"`),NaN}function qt(e,t="active"){const s="active"===t?R.getActiveCalendar():R.getCalendar(t);return s?ae(e,s):(O.error(`SimpleCalendar.api.stopClock - Unable to find a calendar with the passed in ID of "${t}"`),null)}class Gt{static Register(){Handlebars.registerHelper("sc-date-selector",Gt.DateSelector),Handlebars.registerHelper("sc-full-calendar",Gt.FullCalendar),Handlebars.registerHelper("sc-clock",Gt.Clock),Handlebars.registerHelper("sc-icon",Gt.Icon),Handlebars.registerHelper("sc-multi-select",Gt.MultiSelect),Handlebars.registerHelper("sc-date-time-controls",Gt.DateTimeControls)}static DateSelector(e){if(e.hash.hasOwnProperty("id")){const t={};e.hash.hasOwnProperty("allowDateRangeSelection")&&(t.allowDateRangeSelection=e.hash.allowDateRangeSelection),e.hash.hasOwnProperty("allowTimeRangeSelection")&&(t.allowTimeRangeSelection=e.hash.allowTimeRangeSelection),e.hash.hasOwnProperty("calendar")?t.calendar=R.getCalendar(e.hash.calendar)||R.getActiveCalendar():t.calendar=R.getActiveCalendar(),e.hash.hasOwnProperty("editYear")&&(t.editYear=e.hash.editYear),e.hash.hasOwnProperty("onDateSelect")&&(t.onDateSelect=e.hash.onDateSelect),e.hash.hasOwnProperty("position")&&(t.position=e.hash.position),e.hash.hasOwnProperty("showCalendarYear")&&(t.showCalendarYear=e.hash.showCalendarYear),e.hash.hasOwnProperty("showDateSelector")&&(t.showDateSelector=e.hash.showDateSelector),e.hash.hasOwnProperty("selectedEndDate")&&(t.selectedEndDate=e.hash.selectedEndDate),e.hash.hasOwnProperty("timeSelected")&&(t.timeSelected=e.hash.timeSelected),e.hash.hasOwnProperty("selectedStartDate")&&(t.selectedStartDate=e.hash.selectedStartDate),e.hash.hasOwnProperty("showTimeSelector")&&(t.showTimeSelector=e.hash.showTimeSelector),e.hash.hasOwnProperty("timeDelimiter")&&(t.timeDelimiter=e.hash.timeDelimiter),e.hash.hasOwnProperty("useCloneCalendars")&&(t.useCloneCalendars=e.hash.useCloneCalendars);const s=e.hash.id,a=ze.GetSelector(s,t);return new Handlebars.SafeString(a.build())}return""}static FullCalendar(e){const t={id:""};let s="";e.hash.hasOwnProperty("allowChangeMonth")&&(t.allowChangeMonth=e.hash.allowChangeMonth),e.hash.hasOwnProperty("colorToMatchSeason")&&(t.colorToMatchSeason=e.hash.colorToMatchSeason),e.hash.hasOwnProperty("cssClasses")&&(t.cssClasses=e.hash.cssClasses),e.hash.hasOwnProperty("date")&&(t.date=Object.assign({},e.hash.date)),e.hash.hasOwnProperty("editYear")&&(t.editYear=e.hash.editYear),e.hash.hasOwnProperty("id")&&(t.id=e.hash.id),e.hash.hasOwnProperty("calendarId")&&(s=e.hash.calendarId),e.hash.hasOwnProperty("showCurrentDate")&&(t.showCurrentDate=e.hash.showCurrentDate),e.hash.hasOwnProperty("showDayDetails")&&(t.showDayDetails=e.hash.showDayDetails),e.hash.hasOwnProperty("showDescriptions")&&(t.showDescriptions=e.hash.showDescriptions),e.hash.hasOwnProperty("showSeasonName")&&(t.showSeasonName=e.hash.showSeasonName),e.hash.hasOwnProperty("showNoteCount")&&(t.showNoteCount=e.hash.showNoteCount),e.hash.hasOwnProperty("showMoonPhases")&&(t.showMoonPhases=e.hash.showMoonPhases),e.hash.hasOwnProperty("showYear")&&(t.showYear=e.hash.showYear),e.hash.hasOwnProperty("theme")&&(t.theme=e.hash.theme,"none"!==t.theme&&"auto"!==t.theme&&Ze.LoadThemeCSS(t.theme));let a=R.getCalendar(s);return a||(a=R.getActiveCalendar()),new Handlebars.SafeString(De.CalendarFull.Render(a,t))}static Clock(e){const t={id:""};let s="";e.hash.hasOwnProperty("id")&&(t.id=e.hash.id),e.hash.hasOwnProperty("calendarId")&&(s=e.hash.calendarId),e.hash.hasOwnProperty("theme")&&(t.theme=e.hash.theme,"none"!==t.theme&&"auto"!==t.theme&&Ze.LoadThemeCSS(t.theme));let a=R.getCalendar(s);return a||(a=R.getActiveCalendar()),new Handlebars.SafeString(De.Clock.Render(a,t))}static Icon(e){if(e.hash.hasOwnProperty("name")){let t="#000000",s="#000000";return e.hash.hasOwnProperty("stroke")&&(t=e.hash.stroke),e.hash.hasOwnProperty("fill")&&(s=e.hash.fill),new Handlebars.SafeString(le(e.hash.name,t,s))}return""}static MultiSelect(e){const t={id:"",options:[]};return e.hash.hasOwnProperty("id")&&(t.id=e.hash.id),e.hash.hasOwnProperty("options")&&(t.options=e.hash.options),new Handlebars.SafeString(De.MultiSelect.Render(t))}static DateTimeControls(e){const t={};return e.hash.hasOwnProperty("showDateControls")&&(t.showDateControls=e.hash.showDateControls),e.hash.hasOwnProperty("showTimeControls")&&(t.showTimeControls=e.hash.showTimeControls),e.hash.hasOwnProperty("showPresetTimeOfDay")&&(t.showPresetTimeOfDay=e.hash.showPresetTimeOfDay),e.hash.hasOwnProperty("displayType")&&(t.displayType=e.hash.displayType),e.hash.hasOwnProperty("fullDisplay")&&(t.fullDisplay=e.hash.fullDisplay),e.hash.hasOwnProperty("largeSteps")&&(t.largerSteps=e.hash.largeSteps),e.hash.hasOwnProperty("reverseTime")&&(t.reverseTime=e.hash.reverseTime),new Handlebars.SafeString(De.DateTimeControls.Render(t))}}class zt extends xe{constructor(){super(),this.rule=h.None,this.customMod=1}clone(){const e=new zt;return e.id=this.id,e.rule=this.rule,e.customMod=this.customMod,e}toConfig(){return{id:this.id,rule:this.rule,customMod:this.customMod}}toTemplate(){return{...super.toTemplate(),rule:this.rule,customMod:this.customMod}}loadFromSettings(e){e&&Object.keys(e).length&&(super.loadFromSettings(e),e.hasOwnProperty("rule")&&(this.rule=e.rule),e.hasOwnProperty("customMod")&&(this.customMod=e.customMod),this.rule===h.Custom&&this.customMod<=0&&(this.rule=h.None))}isLeapYear(e){const t=R.getActiveCalendar();return Z.isPF2E&&t.generalSettings.pf2eSync&&Z.checkLeapYearRules(this),this.rule===h.Gregorian?e%4==0&&(e%100!=0||e%100==0&&e%400==0):this.rule===h.Custom&&e%this.customMod==0}howManyLeapYears(e){let t=0;return this.rule===h.Gregorian?t=Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400):this.rule===h.Custom&&0!==this.customMod&&(t=Math.floor(e/this.customMod)),this.isLeapYear(e)&&t>0&&(t-=1),t}previousLeapYear(e){if(this.rule===h.Gregorian||this.rule===h.Custom&&0!==this.customMod){let t=e;for(;Number.isInteger(t)&&!this.isLeapYear(t);)t--;return t}return null}fraction(e){const t=this.previousLeapYear(e);if(null!==t&&0!==t){const s=e%t;return this.rule===h.Gregorian?s/4:s/this.customMod}return 0}}class Ht extends xe{constructor(e){super("",e),this.prefix="",this.postfix="",this.showWeekdayHeadings=!0,this.firstWeekday=0,this.yearZero=0,this.yearNames=[],this.yearNamesStart=0,this.yearNamingRule=m.Default,this.selectedYear=e,this.visibleYear=e,this.leapYearRule=new zt}toConfig(){return{id:this.id,numericRepresentation:this.numericRepresentation,prefix:this.prefix,postfix:this.postfix,showWeekdayHeadings:this.showWeekdayHeadings,firstWeekday:this.firstWeekday,yearZero:this.yearZero,yearNames:this.yearNames,yearNamingRule:this.yearNamingRule,yearNamesStart:this.yearNamesStart}}toTemplate(){return{...super.toTemplate(),firstWeekday:this.firstWeekday,numericRepresentation:this.numericRepresentation,yearZero:this.yearZero,yearNames:this.yearNames,yearNamesStart:this.yearNamesStart,yearNamingRule:this.yearNamingRule}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.numericRepresentation=e.numericRepresentation,this.prefix=e.prefix,this.postfix=e.postfix,e.hasOwnProperty("showWeekdayHeadings")&&(this.showWeekdayHeadings=e.showWeekdayHeadings),e.hasOwnProperty("firstWeekday")&&(this.firstWeekday=e.firstWeekday),e.hasOwnProperty("yearZero")&&(this.yearZero=e.yearZero),e.hasOwnProperty("yearNames")&&(this.yearNames=e.yearNames),e.hasOwnProperty("yearNamingRule")&&(this.yearNamingRule=e.yearNamingRule),e.hasOwnProperty("yearNamesStart")&&(this.yearNamesStart=e.yearNamesStart))}clone(){const e=new Ht(this.numericRepresentation);return e.id=this.id,e.postfix=this.postfix,e.prefix=this.prefix,e.yearZero=this.yearZero,e.selectedYear=this.selectedYear,e.visibleYear=this.visibleYear,e.leapYearRule=this.leapYearRule.clone(),e.showWeekdayHeadings=this.showWeekdayHeadings,e.firstWeekday=this.firstWeekday,e.yearNames=this.yearNames.map((e=>e)),e.yearNamesStart=this.yearNamesStart,e.yearNamingRule=this.yearNamingRule,e}getDisplayName(e=!1){let t;const s=this.getYearName(e?this.selectedYear:this.visibleYear);return t=s?`${this.prefix} ${s} (${e?this.selectedYear.toString():this.visibleYear.toString()}) ${this.postfix}`:`${""!==this.prefix?this.prefix+" ":""}${e?this.selectedYear.toString():this.visibleYear.toString()}${""!==this.postfix?" "+this.postfix:""}`,t}getYearName(e){let t="";if(this.yearNames.length){let s=0;if(this.yearNamingRule===m.Repeat)s=((e-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length;else if(this.yearNamingRule===m.Random){s=((function(e){let t=0;if(0==e.length)return t;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t&=t;return t}(`${e}-AbCxYz`)-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length}else s=Math.abs(this.yearNamesStart-e),s>=this.yearNames.length&&(s=this.yearNames.length-1);t=this.yearNames[s]}return t}}class Ut extends xe{constructor(){super(),this.gameWorldTimeIntegration=g.Mixed,this.showClock=!0,this.noteDefaultVisibility=!0,this.postNoteRemindersOnFoundryLoad=!0,this.pf2eSync=!0,this.dateFormat={date:"MMMM DD, YYYY",time:"HH:mm:ss",monthYear:"MMMM YAYYYYYZ"},this.compactViewOptions={controlLayout:w.Full}}clone(){const e=new Ut;return e.id=this.id,e.gameWorldTimeIntegration=this.gameWorldTimeIntegration,e.showClock=this.showClock,e.noteDefaultVisibility=this.noteDefaultVisibility,e.postNoteRemindersOnFoundryLoad=this.postNoteRemindersOnFoundryLoad,e.pf2eSync=this.pf2eSync,e.dateFormat.date=this.dateFormat.date,e.dateFormat.time=this.dateFormat.time,e.dateFormat.monthYear=this.dateFormat.monthYear,e.compactViewOptions.controlLayout=this.compactViewOptions.controlLayout,e}toTemplate(){return{...super.toTemplate(),gameWorldTimeIntegration:this.gameWorldTimeIntegration,showClock:this.showClock,noteDefaultVisibility:this.noteDefaultVisibility,postNoteRemindersOnFoundryLoad:this.postNoteRemindersOnFoundryLoad,pf2eSync:this.pf2eSync,dateFormat:this.dateFormat,compactViewOptions:this.compactViewOptions}}toConfig(){return{id:this.id,gameWorldTimeIntegration:this.gameWorldTimeIntegration,showClock:this.showClock,noteDefaultVisibility:this.noteDefaultVisibility,postNoteRemindersOnFoundryLoad:this.postNoteRemindersOnFoundryLoad,pf2eSync:this.pf2eSync,dateFormat:this.dateFormat,compactViewOptions:this.compactViewOptions}}loadFromSettings(e){e&&Object.keys(e).length&&(this.id=e.id,this.gameWorldTimeIntegration=e.gameWorldTimeIntegration,this.showClock=e.showClock,this.noteDefaultVisibility=e.noteDefaultVisibility,e.hasOwnProperty("pf2eSync")&&(this.pf2eSync=e.pf2eSync),e.hasOwnProperty("dateFormat")&&(this.dateFormat=e.dateFormat),e.hasOwnProperty("compactViewOptions")&&(this.compactViewOptions=e.compactViewOptions),e.hasOwnProperty("postNoteRemindersOnFoundryLoad")&&(this.postNoteRemindersOnFoundryLoad=e.postNoteRemindersOnFoundryLoad))}}class Vt{constructor(e,t){this.status=S.Stopped,this.pauseClicked=!1,this.updateListeners=[],this.calendarId=e,this.uf=t}get updateFrequency(){return this.uf}set updateFrequency(e){this.uf=e,void 0!==this.intervalNumber&&(window.clearInterval(this.intervalNumber),this.intervalNumber=window.setInterval(this.interval.bind(this),1e3*this.updateFrequency))}start(e=!1){this.pauseClicked=!1;const t=R.getCalendar(this.calendarId);t&&(this.status!==S.Started?(this.pauseClicked=!1,t.time.unifyGameAndClockPause&&!e&&game.togglePause(!1,!0),void 0===this.intervalNumber?(this.intervalNumber=window.setInterval(this.interval.bind(this),1e3*this.updateFrequency),this.updateStatus(),z.IsGm()&&q.primary&&(this.saveInterval(),this.saveIntervalNumber=window.setInterval(this.saveInterval.bind(this),1e4))):this.updateStatus()):(this.pauseClicked=!0,this.updateStatus(S.Paused),t.time.unifyGameAndClockPause&&game.togglePause(!0,!0)))}stop(){if(this.pauseClicked=!1,void 0!==this.intervalNumber){window.clearInterval(this.intervalNumber),window.clearInterval(this.saveIntervalNumber);const e=R.getCalendar(this.calendarId);e&&e.time.unifyGameAndClockPause&&game.togglePause(!0,!0),z.IsGm()&&q.primary&&this.saveInterval(!0),this.intervalNumber=void 0,this.saveIntervalNumber=void 0,this.updateStatus()}}pause(){this.status===S.Started&&(this.pauseClicked=!0,this.status=S.Paused)}getStatus(){return this.status}setStatus(e){this.updateStatus(e)}interval(){if(this.updateStatus(),this.status===S.Started){const e=R.getCalendar(this.calendarId);if(e){const t=e.time.gameTimeRatio*this.updateFrequency;e.changeDateTime({seconds:t},{updateApp:!1,save:!1}),z.IsGm()&&q.primary&&e.generalSettings.gameWorldTimeIntegration===g.None&&j.emit({type:u.clock,data:this.status}).catch(O.error),this.callListeners()}}}saveInterval(e=!1){if(this.status===S.Started){const e=R.getCalendar(this.calendarId);e&&z.IsGm()&&q.primary&&(e.generalSettings.gameWorldTimeIntegration===g.None?j.emit({type:u.clock,data:this.status}).catch(O.error):e.syncTime().catch(O.error),R.saveCalendars().catch(O.error))}}updateStatus(e=null){const t=R.getCalendar(this.calendarId);if(t){const s=this.status;null!==e?this.status=e:void 0!==this.intervalNumber?this.pauseClicked||game.paused||t.time.combatRunning?this.status=S.Paused:this.status=S.Started:this.status=S.Stopped,s!==this.status&&(Ie.emit(b.ClockStartStop,t),this.callListeners(),this.emitSocket())}}emitSocket(){if(z.IsGm()&&q.primary){const e={type:u.clock,data:this.status};j.emit(e).catch(O.error)}}registerUpdateListener(e,t){const s=this.updateListeners.findIndex((t=>t.key===e));-1===s?this.updateListeners.push({key:e,func:t}):this.updateListeners[s].func=t}callListeners(){for(let e=0;e<this.updateListeners.length;e++)this.updateListeners[e].func(this.status)}}class _t extends xe{constructor(e=24,t=60,s=60){super(),this.seconds=0,this.combatRunning=!1,this.unifyGameAndClockPause=!1,this.updateFrequency=1,this.hoursInDay=e,this.minutesInHour=t,this.secondsInMinute=s,this.gameTimeRatio=1,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute}toConfig(){return{id:this.id,hoursInDay:this.hoursInDay,minutesInHour:this.minutesInHour,secondsInMinute:this.secondsInMinute,gameTimeRatio:this.gameTimeRatio,unifyGameAndClockPause:this.unifyGameAndClockPause,updateFrequency:this.updateFrequency}}clone(){const e=new _t(this.hoursInDay,this.minutesInHour,this.secondsInMinute);return e.id=this.id,e.seconds=this.seconds,e.gameTimeRatio=this.gameTimeRatio,e.combatRunning=this.combatRunning,e.unifyGameAndClockPause=this.unifyGameAndClockPause,e.updateFrequency=this.updateFrequency,e}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.hoursInDay=e.hoursInDay,this.minutesInHour=e.minutesInHour,this.secondsInMinute=e.secondsInMinute,this.gameTimeRatio=e.gameTimeRatio,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute,e.hasOwnProperty("unifyGameAndClockPause")&&(this.unifyGameAndClockPause=e.unifyGameAndClockPause),e.hasOwnProperty("updateFrequency")&&(this.updateFrequency=e.updateFrequency))}getCurrentTime(){let e=this.seconds,t=0,s=0;return e>=this.secondsInMinute&&(t=Math.floor(e/this.secondsInMinute),e-=t*this.secondsInMinute),t>=this.minutesInHour&&(s=Math.floor(t/this.minutesInHour),t-=s*this.minutesInHour),e=Math.floor(e),{hour:s,minute:t,seconds:e}}toString(){const e=this.getCurrentTime(),t=R.getActiveCalendar();let s=t.getMonthAndDayIndex();return J({year:t.year.numericRepresentation,month:s.month||0,day:s.day||0,...e},t.generalSettings.dateFormat.time,t)}setTime(e=0,t=0,s=0){this.seconds=e*this.minutesInHour*this.secondsInMinute+t*this.secondsInMinute+s}changeTime(e=0,t=0,s=0){s=+s.toFixed(3);const a=e*this.minutesInHour*this.secondsInMinute+t*this.secondsInMinute+s,n=this.seconds+a;if(n>=this.secondsPerDay){this.seconds=0;return this.changeTime(0,0,n-this.secondsPerDay)+1}if(n<0){this.seconds=this.secondsPerDay;return this.changeTime(0,0,n)+-1}return this.seconds=n,0}getTotalSeconds(e,t=!0){return e*this.hoursInDay*this.minutesInHour*this.secondsInMinute+(t?this.seconds:0)}async setWorldTime(e){let t=e-game.time.worldTime;await game.time.advance(t)}}class Bt extends xe{constructor(e,t,s={id:""}){super(t),this.generalSettings=new Ut,this.months=[],this.weekdays=[],this.seasons=[],this.moons=[],this.notes=[],this.noteCategories=[],this.timeChangeTriggered=!1,this.combatChangeTriggered=!1,this.id=e||H(),this.time=new _t,this.year=new Ht(0),this.timeKeeper=new Vt(this.id,this.time.updateFrequency),Object.keys(s).length>1&&this.loadFromSettings(s)}clone(e=!0){const t=new Bt(this.id,this.name);return t.id=this.id,t.name=this.name,t.generalSettings=this.generalSettings.clone(),t.year=this.year.clone(),t.months=this.months.map((e=>e.clone())),t.weekdays=this.weekdays.map((e=>e.clone())),t.seasons=this.seasons.map((e=>e.clone())),t.moons=this.moons.map((e=>e.clone())),t.time=this.time.clone(),e&&(t.noteCategories=this.noteCategories.map((e=>({id:e.id,name:e.name,textColor:e.textColor,color:e.color})))),t}toTemplate(){let e,t,s=this.year.selectedYear;const a=this.getMonthAndDayIndex(),n=this.getMonthAndDayIndex("selected"),i=this.getMonthAndDayIndex("visible");void 0!==n.month?(e=n.month,t=n.day||0):(s=this.year.numericRepresentation,e=a.month||0,t=a.day||0);const o=G.getNoteCountsForDay(this.id,s,e,t);return{...super.toTemplate(),calendarDisplayId:`sc_${this.id}_calendar`,clockDisplayId:`sc_${this.id}_clock`,currentYear:this.year.toTemplate(),id:this.id,name:this.name,selectedDay:{dateDisplay:J({year:s,month:e,day:t,hour:0,minute:0,seconds:0},this.generalSettings.dateFormat.date,this),noteCount:o.count,noteReminderCount:o.reminderCount,notes:G.getNotesForDay(this.id,s,e,t)},visibleDate:{year:this.year.visibleYear,month:i.month||0}}}toConfig(){return{id:this.id,name:this.name,currentDate:this.getCurrentDate(),general:this.generalSettings.toConfig(),leapYear:this.year.leapYearRule.toConfig(),months:this.months.map((e=>e.toConfig())),moons:this.moons.map((e=>e.toConfig())),noteCategories:this.noteCategories,seasons:this.seasons.map((e=>e.toConfig())),time:this.time.toConfig(),weekdays:this.weekdays.map((e=>e.toConfig())),year:this.year.toConfig()}}loadFromSettings(e){e.id&&(this.id=e.id,this.timeKeeper.calendarId=this.id),e.name&&(this.name=e.name),e.year?this.year.loadFromSettings(e.year):e.yearSettings?this.year.loadFromSettings(e.yearSettings):(O.warn(`Invalid year configuration found when loading calendar "${this.name}", setting year to default configuration`),this.year=new Ht(0));const t=e.months||e.monthSettings;if(Array.isArray(t)){this.months=[];for(let e=0;e<t.length;e++){const s=new Fe;s.loadFromSettings(t[e]),this.months.push(s)}}const s=e.weekdays||e.weekdaySettings;if(Array.isArray(s)){this.weekdays=[];for(let e=0;e<s.length;e++){const t=new Re;t.loadFromSettings(s[e]),this.weekdays.push(t)}}e.leapYear?this.year.leapYearRule.loadFromSettings(e.leapYear):e.leapYearSettings&&this.year.leapYearRule.loadFromSettings(e.leapYearSettings),e.time?(this.time.loadFromSettings(e.time),this.timeKeeper.updateFrequency=this.time.updateFrequency):e.timeSettings&&(this.time.loadFromSettings(e.timeSettings),this.timeKeeper.updateFrequency=this.time.updateFrequency);const a=e.seasons||e.seasonSettings;if(Array.isArray(a)){this.seasons=[];for(let e=0;e<a.length;e++){const t=new We;t.loadFromSettings(a[e]),this.seasons.push(t)}}const n=e.moons||e.moonSettings;if(Array.isArray(n)){this.moons=[];for(let e=0;e<n.length;e++){const t=new Ye;t.loadFromSettings(n[e]),this.moons.push(t)}}e.general?this.generalSettings.loadFromSettings(e.general):e.generalSettings&&this.generalSettings.loadFromSettings(e.generalSettings),e.noteCategories&&(this.noteCategories=e.noteCategories),e.currentDate?(this.year.numericRepresentation=e.currentDate.year,this.year.selectedYear=e.currentDate.year,this.year.visibleYear=e.currentDate.year,this.resetMonths("current"),this.resetMonths("visible"),e.currentDate.month>-1&&e.currentDate.month<this.months.length?(this.months[e.currentDate.month].current=!0,this.months[e.currentDate.month].visible=!0,e.currentDate.day>-1&&e.currentDate.day<this.months[e.currentDate.month].days.length?this.months[e.currentDate.month].days[e.currentDate.day].current=!0:(O.warn("Saved current day could not be found in this month, perhaps number of days has changed. Setting current day to first day of month"),this.months[e.currentDate.month].days[0].current=!0)):this.months.length&&(O.warn("Saved current month could not be found, perhaps months have changed. Setting current month to the first month"),this.months[0].current=!0,this.months[0].visible=!0,this.months[0].days[0].current=!0),this.time.seconds=e.currentDate.seconds,void 0===this.time.seconds&&(this.time.seconds=0)):this.months.length?(O.warn("No current date setting found, setting default current date."),this.months[0].current=!0,this.months[0].visible=!0,this.months[0].days[0].current=!0):O.error("Error setting the current date.")}getCurrentDate(){const e=this.getMonthAndDayIndex();return{year:this.year.numericRepresentation,month:e.month||0,day:e.day||0,seconds:this.time.seconds}}getDateTime(){const e={year:0,month:0,day:0,hour:0,minute:0,seconds:0},t=this.getMonthAndDayIndex("selected"),s=this.getMonthAndDayIndex();if(void 0!==t.month)e.year=this.year.selectedYear,e.month=t.month,e.day=t.day||0;else{e.year=this.year.numericRepresentation,e.month=s.month||0,e.day=s.day||0;const t=this.time.getCurrentTime();e.hour=t.hour,e.minute=t.minute,e.seconds=t.seconds}return e}getCurrentSeason(){let e=this.getMonthIndex("visible");-1===e&&(e=0);let t=this.months[e].getDayIndex("selected");-1===t&&(t=this.months[e].getDayIndex(),-1===t&&(t=0));const s=this.getSeason(e,t);return{name:s.name,color:s.color,icon:s.icon}}getMonth(e="current"){const t=e.toLowerCase();return this.months.find((e=>e[t]))}getMonthIndex(e="current"){const t=e.toLowerCase();return this.months.findIndex((e=>e[t]))}getMonthAndDayIndex(e="current"){const t=e.toLowerCase(),s={month:0,day:0},a=this.months.findIndex((e=>e[t]));if(a>-1){s.month=a;const e=this.months[a].getDayIndex(t);e>-1&&(s.day=e)}else s.month=void 0;return s}getSeason(e,t){let s=new We("",0,0);if(t>=0&&e>=0){let a=null;const n=this.seasons.sort(((e,t)=>e.startingMonth-t.startingMonth||e.startingDay-t.startingDay));for(let s=0;s<n.length;s++)(n[s].startingMonth===e&&n[s].startingDay<=t||n[s].startingMonth<e)&&(a=n[s]);null===a&&(a=n[n.length-1]),a&&(s=a.clone())}return s}getSunriseSunsetTime(e,t,s,a=!0,n=!0){const i=R.getActiveCalendar(),o=this.seasons.sort(((e,t)=>e.startingMonth-t.startingMonth||e.startingDay-t.startingDay));let r=o.length-1;for(let e=0;e<o.length;e++)(o[e].startingMonth===t&&o[e].startingDay<=s||o[e].startingMonth<t)&&(r=e);const c=(r+1)%this.seasons.length;if(r<o.length&&c<o.length){let l=o[r];const d=o[c];let h=e,m=h;r===o.length-1&&((t<o[r].startingMonth||o[r].startingMonth===t&&s<o[r].startingDay)&&(h=e-1),m=h+1);const u=te(i,{year:h,month:l.startingMonth,day:l.startingDay,hour:0,minute:0,seconds:0},{year:e,month:t,day:s,hour:0,minute:0,seconds:0}),p=te(i,{year:h,month:l.startingMonth,day:l.startingDay,hour:0,minute:0,seconds:0},{year:m,month:d.startingMonth,day:d.startingDay,hour:0,minute:0,seconds:0}),g=u*((a?d.sunriseTime-l.sunriseTime:d.sunsetTime-l.sunsetTime)/p),f=Math.round((a?l.sunriseTime:l.sunsetTime)+g);return n?ne({year:e,month:t,day:s,hour:0,minute:0,seconds:0},i)+f:f}return 0}daysIntoWeeks(e,t,s){const a=[],n=this.monthStartingDayOfWeek(e,t),i=this.year.leapYearRule.isLeapYear(t),o=this.months[e].getDaysForTemplate(i);if(o.length&&s>0){const e=[];let t=0;for(let a=0;a<s;a++)if(a<n)e.push(!1);else{const s=a-n;s<o.length?(e.push(o[s]),t++):e.push(!1)}a.push(e);const i=Math.ceil((o.length-t)/s);for(let e=0;e<i;e++){const n=[];for(let a=0;a<s;a++){const i=t+e*s+a;i<o.length?n.push(o[i]):n.push(!1)}a.push(n)}}return a}dayOfTheWeek(e,t,s){if(this.weekdays.length){const a=R.getActiveCalendar();if(Z.isPF2E&&a.generalSettings.pf2eSync){const e=Z.weekdayAdjust();void 0!==e&&(this.year.firstWeekday=e)}const n=this.months[t];let i;return i=n&&null!==n.startingWeekday?s+n.startingWeekday-1:this.dateToDays(e,t,s)+this.year.firstWeekday,(i%this.weekdays.length+this.weekdays.length)%this.weekdays.length}return 0}monthStartingDayOfWeek(e,t){return e>-1&&e<this.months.length&&(!this.months[e].intercalary||this.months[e].intercalaryInclude)?this.dayOfTheWeek(t,e,0):0}resetMonths(e="current"){const t=e.toLowerCase();this.months.forEach((s=>{"visible"!==e&&s.resetDays(e),s[t]=!1}))}setCurrentToVisible(){this.year.visibleYear=this.year.numericRepresentation,this.resetMonths("visible");const e=this.getMonth();e&&(e.visible=!0)}updateMonth(e,t,s,a=null){const n=t.toLowerCase(),i="current"===n?this.year.numericRepresentation:"visible"===n?this.year.visibleYear:this.year.selectedYear,o=this.year.leapYearRule.isLeapYear(i);let r;if((-1===e||e>=this.months.length)&&(e=this.months.length-1),null!==a)r=a;else{r=this.getMonthAndDayIndex().day||0}if(this.resetMonths(t),o&&0===this.months[e].numberOfLeapYearDays||!o&&0===this.months[e].numberOfDays)return this.months[e][n]=!0,this.changeMonth(s?1:-1,t,a);this.months[e][n]=!0,"current"===n&&this.months[e].updateDay(r,o)}changeYear(e,t=!0,s="visible",a=null){const n=s.toLowerCase();if("visible"===n?this.year.visibleYear=this.year.visibleYear+e:"selected"===n?this.year.selectedYear=this.year.selectedYear+e:this.year.numericRepresentation=this.year.numericRepresentation+e,this.months.length&&t){let t=0;-1===e&&(t=this.months.length-1),this.updateMonth(t,s,e>0,a)}}changeMonth(e,t="visible",s=null){const a=t.toLowerCase(),n=e>0;for(let i=0;i<this.months.length;i++){if(this.months[i][a]){if(n&&i+e>=this.months.length){this.changeYear(1,!0,a,s);const t=e-(this.months.length-i);t>0&&this.changeMonth(t,a,s)}else if(!n&&i+e<0){this.changeYear(-1,!0,a,s);const t=e+i+1;t<0&&this.changeMonth(t,a,s)}else this.updateMonth(i+e,t,n,s);break}}}changeDay(e,t="current"){const s=t.toLowerCase(),a="current"===s?this.year.numericRepresentation:this.year.selectedYear,n=this.year.leapYearRule.isLeapYear(a),i=this.getMonth(s);if(i){const t=e>0;let a=i.getDayIndex(s);const o=n?i.numberOfLeapYearDays:i.numberOfDays;t&&a+e>=o?(this.changeMonth(1,s,0),this.changeDay(e-(o-a),s)):!t&&a+e<0?(this.changeMonth(-1,s,-1),this.changeDay(e+a+1,s)):i.changeDay(e,n,s)}}changeDayBulk(e,t="current"){let s=this.year.leapYearRule.isLeapYear(this.year.numericRepresentation),a=this.totalNumberOfDays(s,!0);for(;e>a;)this.changeYear(1,!1,t),e-=a,s=this.year.leapYearRule.isLeapYear(this.year.numericRepresentation),a=this.totalNumberOfDays(s,!0);this.changeDay(e,t)}totalNumberOfDays(e=!1,t=!1){let s=0;return this.months.forEach((a=>{(a.intercalary&&a.intercalaryInclude||!a.intercalary||t)&&(s+=e?a.numberOfLeapYearDays:a.numberOfDays)})),s}dateToDays(e,t,s,a=!1,n=!1){const i=e<this.year.yearZero,o=this.totalNumberOfDays(!1,n),r=this.totalNumberOfDays(!0,n)-o,c=this.year.leapYearRule.isLeapYear(e),l=this.year.leapYearRule.howManyLeapYears(e),d=this.year.leapYearRule.howManyLeapYears(this.year.yearZero);let m,u=Math.abs(e-this.year.yearZero);t<0?t=0:t>=this.months.length&&(t=this.months.length-1),i&&(u-=1);let p=s+1,g=o*u;if(p<1&&(p=1),i){m=c?(d-(l+1))*r:(d-l)*r,g+=m;for(let e=this.months.length-1;e>=0;e--)e>t&&(n||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(g+=c?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);g+=(c?this.months[t].numberOfLeapYearDays:this.months[t].numberOfDays)-p}else{m=Math.abs(l-d)*r,g+=m;for(let e=0;e<this.months.length;e++)e<t&&(n||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(g+=c?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);g+=p}return i?(g+=1,e<=0&&this.year.leapYearRule.rule!==h.None&&(0!==this.year.yearZero||c?0!==this.year.yearZero&&c&&(g+=r):g-=r)):g-=1,e>0&&0===this.year.yearZero&&this.year.leapYearRule.rule!==h.None&&(g+=r),i?-1*g:g}secondsToDate(e){const t=e<0;let s,a,n,i,o,r,c;e=Math.abs(e),o=Math.floor(e/this.time.secondsPerDay),e-=o*this.time.secondsPerDay;let l=t?this.time.secondsPerDay-e:e;if(n=Math.floor(l/(this.time.secondsInMinute*this.time.minutesInHour))%this.time.hoursInDay,l-=n*(this.time.secondsInMinute*this.time.minutesInHour),a=Math.floor(l/this.time.secondsInMinute)%this.time.secondsInMinute,l-=a*this.time.secondsInMinute,s=l%60,t){c=this.year.yearZero-1;let e=this.year.leapYearRule.isLeapYear(c);for(r=this.months.length-1,i=e?this.months[r].numberOfLeapYearDays-1:this.months[r].numberOfDays-1,0===s&&0===a&&0===n&&o--;o>0;){const t=this.totalNumberOfDays(e,!0);let s=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays;if(o>=t)c-=1,e=this.year.leapYearRule.isLeapYear(c),s=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,o-=t;else if(o>=s){r-=1;let t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,a=0;for(;0===t&&a<=this.months.length;)r--,t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,a++;i=e?this.months[r].numberOfLeapYearDays-1:this.months[r].numberOfDays-1,o-=s}else i-=1,o-=1}}else{c=this.year.yearZero;let e=this.year.leapYearRule.isLeapYear(c);for(r=0,i=0;o>0;){const t=this.totalNumberOfDays(e,!0),s=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays;if(o>=t)c+=1,e=this.year.leapYearRule.isLeapYear(c),o-=t;else if(o>=s){r+=1;let t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,a=0;for(;0===t&&a<=this.months.length;)r++,t=e?this.months[r].numberOfLeapYearDays:this.months[r].numberOfDays,a++;o-=s}else i+=1,o-=1}c<0&&i++}return{year:c,month:r,day:i,hour:n,minute:a,seconds:s}}secondsToInterval(e){let t,s,a,n=e,i=0,o=0;n>=this.time.secondsInMinute&&(i=Math.floor(n/this.time.secondsInMinute),n-=i*this.time.secondsInMinute),i>=this.time.minutesInHour&&(o=Math.floor(i/this.time.minutesInHour),i-=o*this.time.minutesInHour);let r=0;o>=this.time.hoursInDay&&(r=Math.floor(o/this.time.hoursInDay),o-=r*this.time.hoursInDay);const c=this.totalNumberOfDays(!1,!1)/this.months.map((e=>!e.intercalary)).length;return s=Math.floor(r/c),t=r-Math.round(s*c),a=Math.floor(s/this.months.length),s-=Math.round(a*this.months.length),{seconds:n,minute:i,hour:o,day:t,month:s,year:a}}toSeconds(){const e=this.getMonthAndDayIndex();return X(this,this.year.numericRepresentation,e.month||0,e.day||0,!0)}changeDateTime(e,t={}){if(t=F({},{updateMonth:!0,updateApp:!0,save:!0,sync:!0,showWarning:!1},t),ye(game.user,q.globalConfiguration.permissions.changeDateTime)){let s=this.toSeconds(),a=!1;if(e.year&&(this.changeYear(e.year,t.updateMonth,"current"),a=!0),e.month&&(this.changeMonth(e.month,"current"),a=!0),e.day&&(this.changeDay(e.day),a=!0),e.hour||e.minute||e.seconds){const t=this.time.changeTime(e.hour,e.minute,e.seconds);0!==t&&this.changeDay(t),a=!0}if(a){let e=this.toSeconds()-s;Ie.emit(b.DateTimeChange,this,e),t.fromCalSync||!R.syncWithAllCalendars||isNaN(s)||R.syncWithCalendars({seconds:e}),t.save&&R.saveCalendars().catch(O.error),t.sync&&this.syncTime().catch(O.error),t.updateApp&&W.updateApp()}return!0}return t.showWarning&&z.UiNotification(z.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}setDateTime(e,t={}){if(t=F({},{updateMonth:!0,updateApp:!0,save:!0,sync:!0,showWarning:!1,bypassPermissionCheck:!1},t),ye(game.user,q.globalConfiguration.permissions.changeDateTime)||t.bypassPermissionCheck){let s=this.toSeconds();const a={year:e.year||0,month:e.month||0,day:e.day||0,hour:e.hour||0,minute:e.minute||0,seconds:e.seconds||0},n=this.getMonthAndDayIndex(),i=this.time.getCurrentTime();void 0===e.seconds&&(a.seconds=i.seconds),void 0===e.minute&&(a.minute=i.minute),void 0===e.hour&&(a.hour=i.hour),void 0===e.year&&(a.year=this.year.numericRepresentation),void 0===e.month&&(a.month=n.month||0),void 0===e.day&&(a.day=n.day||0),this.updateTime(a);let o=this.toSeconds()-s;return Ie.emit(b.DateTimeChange,this,o),t.fromCalSync||!R.syncWithAllCalendars||isNaN(s)||R.syncWithCalendars({seconds:o}),t.save&&R.saveCalendars().catch(O.error),t.sync&&this.syncTime().catch(O.error),t.updateApp&&W.updateApp(),!0}return t.showWarning&&z.UiNotification(z.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}async syncTime(e=!1){let t=NaN;!ye(game.user,q.globalConfiguration.permissions.changeDateTime)||this.generalSettings.gameWorldTimeIntegration!==g.Self&&this.generalSettings.gameWorldTimeIntegration!==g.Mixed||(t=this.toSeconds(),(t!==game.time.worldTime||e)&&(this.timeChangeTriggered=!0,z.IsGm()&&await this.time.setWorldTime(t)))}setFromTime(e,t){if(Z.isPF2E&&this.generalSettings.pf2eSync&&(e+=Z.getWorldCreateSeconds(this)),0!==t)if(this.generalSettings.gameWorldTimeIntegration!==g.Self&&this.generalSettings.gameWorldTimeIntegration!==g.Mixed||this.timeKeeper.getStatus()!==S.Started){if(this.generalSettings.gameWorldTimeIntegration!==g.Self&&this.generalSettings.gameWorldTimeIntegration!==g.Mixed||!this.timeChangeTriggered&&!this.combatChangeTriggered){if((this.generalSettings.gameWorldTimeIntegration===g.ThirdParty||this.generalSettings.gameWorldTimeIntegration===g.Mixed)&&!this.timeChangeTriggered){const t=this.secondsToDate(e);this.setDateTime(t,{updateApp:!1,sync:!1,save:z.IsGm()&&q.primary})}}else if(!this.timeChangeTriggered){const t=this.secondsToDate(e);this.setDateTime(t,{updateApp:!1,sync:!1,save:z.IsGm()&&q.primary})}}else if(!this.timeChangeTriggered){const s=this.secondsToDate(e);this.setDateTime(s,{updateApp:this.time.updateFrequency*this.time.gameTimeRatio!==t,sync:!1,save:!1,bypassPermissionCheck:!0}),De.Clock.UpdateListener(`sc_${this.id}_clock`,this.timeKeeper.getStatus())}this.timeChangeTriggered=!1,this.combatChangeTriggered=!1}processOwnCombatRoundTime(e){let t=q.globalConfiguration.secondsInCombatRound,s=1;e.hasOwnProperty("previous")&&e.previous.round&&(s=e.round-e.previous.round),0!==t&&0!==s&&(console.log("processOwnCombatRoundTime"),this.changeDateTime({seconds:t*s},{updateApp:!1,sync:!0,save:z.IsGm()&&q.primary}))}updateTime(e){let t=this.year.leapYearRule.isLeapYear(e.year);this.year.numericRepresentation=e.year,this.updateMonth(e.month,"current",!0),this.months[e.month].updateDay(e.day,t),this.time.setTime(e.hour,e.minute,e.seconds)}}class Zt{constructor(){this.calendars={},this.activeId="",this.visibleId=""}get syncWithAllCalendars(){return q.globalConfiguration.syncCalendars&&Object.keys(this.calendars).length>1}async initialize(){if(this.loadCalendars())this.loadActiveCalendar();else{const e=await this.getDefaultCalendar();this.activeId=e.id,this.visibleId=e.id}}async saveCalendars(){const e=[];for(const[t,s]of Object.entries(this.calendars))e.push(s.toConfig());await z.SaveStringSetting(n.ActiveCalendar,this.calendars[this.activeId].id),await z.SaveObjectSetting(n.CalendarConfiguration,e)}loadCalendars(){const e=z.GetObjectSettings(n.CalendarConfiguration);if(1!==e.length||e[0]||e.shift(),e.length)for(let t=0;t<e.length;t++)if(e[t].id){let s=this.getCalendar(e[t].id);s?s.loadFromSettings(e[t]):s=this.addCalendar(e[t].id,e[t].name||`Calendar ${t}`,e[t]),0===t&&""===this.activeId&&(this.activeId=e[t].id,this.visibleId=e[t].id)}G.checkNoteTriggers(this.activeId);const t=this.getVisibleCalendar();return t&&t.timeKeeper.getStatus()!==S.Started&&W.updateApp(),Object.keys(this.calendars).length}loadActiveCalendar(){const e=z.GetStringSettings(n.ActiveCalendar),t=this.getCalendar(e);t&&(this.activeId=t.id,this.visibleId=t.id),W.updateApp()}addCalendar(e,t,s){const a=new Bt(e,t,s);return this.calendars[a.id]=a,this.calendars[a.id]}addTempCalendar(e){const t=new Bt("",e);return t.id+="_temp",this.calendars[t.id]=t,this.calendars[t.id]}async getDefaultCalendar(){let e=this.getCalendar("default");return e||(e=this.addCalendar("default","Default",{id:""}),await qe.setToPredefined(e,c.Gregorian)),e}getCalendar(e){return this.calendars.hasOwnProperty(e)?this.calendars[e]:null}static sortCalendars(e,t){return"default"===e.id||"default_temp"===e.id?-1:"default"===t.id||"default_temp"===t.id?1:0}getAllCalendars(e=!1){const t=[];for(const[s,a]of Object.entries(this.calendars))(!e&&!s.endsWith("_temp")||e&&s.endsWith("_temp"))&&t.push(a);return t.sort(Zt.sortCalendars)}getActiveCalendar(){return this.calendars[this.activeId]}getVisibleCalendar(){return this.calendars[this.visibleId]}setCalendars(e){if(e.length){for(const[t,s]of Object.entries(this.calendars)){e.findIndex((e=>e.id===t))>-1||delete this.calendars[t]}for(let t=0;t<e.length;t++)this.calendars[e[t].id]?this.calendars[e[t].id].loadFromSettings(e[t].toConfig()):this.calendars[e[t].id]=e[t];this.setActiveCalendar(e[0].id),this.setVisibleCalendar(e[0].id)}}setActiveCalendar(e){const t=this.getCalendar(e);if(t){for(const[e,t]of Object.entries(this.calendars))t.timeKeeper.pause();this.activeId=t.id,this.visibleId=t.id,t.timeKeeper.getStatus()===S.Paused&&t.timeKeeper.start(!0),game.socket?.emit(u.clock),W.clockClass=t.timeKeeper.getStatus(),z.SaveStringSetting(n.ActiveCalendar,t.id).catch(O.error),t.syncTime(!0).catch(O.error),Ie.emit(b.DateTimeChange,t)}}setVisibleCalendar(e){const t=this.getCalendar(e);t&&(this.visibleId=t.id,W.clockClass=t.timeKeeper.getStatus(),W.updateApp())}removeCalendar(e){this.calendars.hasOwnProperty(e)&&(this.calendars[e].timeKeeper.stop(),delete this.calendars[e])}cloneCalendars(){const e=[];for(const[t,s]of Object.entries(this.calendars))if(s.id.endsWith("_temp"))e.push(s);else{const t=s.clone();t.id+="_temp",this.calendars[t.id]=t,e.push(t)}return e.sort(Zt.sortCalendars)}mergeClonedCalendars(){const e=[];for(const[t,s]of Object.entries(this.calendars))t.endsWith("_temp")&&(s.id=s.id.replace("_temp",""),e.push({key:t.replace("_temp",""),value:s}));for(let t=0;t<e.length;t++){const s=this.getCalendar(e[t].key);s?s.loadFromSettings(e[t].value.toConfig()):this.calendars[e[t].key]=e[t].value}for(const[t,s]of Object.entries(this.calendars)){e.findIndex((e=>e.value.id===t))>-1||delete this.calendars[t]}this.getActiveCalendar()||this.setActiveCalendar(e[0].key),this.getVisibleCalendar()||this.setVisibleCalendar(e[0].key)}clearClones(){for(const[e,t]of Object.entries(this.calendars))t.id.endsWith("_temp")&&delete this.calendars[e]}syncWithCalendars(e){const t=this.getActiveCalendar();for(const[s,a]of Object.entries(this.calendars))s!==t.id&&a.changeDateTime(e,{sync:!1,save:!1,updateApp:!1,fromCalSync:!0})}}class Jt{static runCalendarMigration(){const e={id:"default",name:"Default",currentDate:z.GetObjectSettings(n.CurrentDate),general:z.GetObjectSettings(n.GeneralConfiguration),leapYear:z.GetObjectSettings(n.LeapYearRule),months:z.GetObjectSettings(n.MonthConfiguration),moons:z.GetObjectSettings(n.MoonConfiguration),noteCategories:z.GetObjectSettings(n.NoteCategories),seasons:z.GetObjectSettings(n.SeasonConfiguration),time:z.GetObjectSettings(n.TimeConfiguration),weekdays:z.GetObjectSettings(n.WeekdayConfiguration),year:z.GetObjectSettings(n.YearConfiguration)};if(e.months){if(e.currentDate&&!foundry.utils.isEmpty(e.currentDate)&&(e.currentDate.month=e.months.findIndex((t=>t.numericRepresentation===e.currentDate?.month)),e.currentDate.month<0&&(e.currentDate.month=0),e.currentDate.day--),e.seasons)for(let t=0;t<e.seasons.length;t++){const s=e.seasons[t].startingMonth;switch(e.seasons[t].startingMonth=e.months.findIndex((e=>e.numericRepresentation===s)),e.seasons[t].startingMonth<0&&(e.seasons[t].startingMonth=0),e.seasons[t].startingDay--,e.seasons[t].color){case"#fffce8":e.seasons[t].color="#46B946";break;case"#f3fff3":e.seasons[t].color="#E0C40B";break;case"#fff7f2":e.seasons[t].color="#FF8E47";break;case"#f2f8ff":e.seasons[t].color="#479DFF"}}if(e.moons)for(let t=0;t<e.moons.length;t++){const s=e.moons[t].firstNewMoon.month;e.moons[t].firstNewMoon.month=e.months.findIndex((e=>e.numericRepresentation===s)),e.moons[t].firstNewMoon.month<0&&(e.moons[t].firstNewMoon.month=0),e.moons[t].firstNewMoon.day--}}const t=new Bt("default","Default",e);let s=!1;return t.year&&t.months.length&&(s=!0),s?t:null}static runGlobalConfigurationMigration(){const e=z.GetObjectSettings(n.GeneralConfiguration),t=z.GetObjectSettings(n.TimeConfiguration);if(e.hasOwnProperty("permissions")&&e.permissions){const t=new He;t.loadFromSettings(e.permissions),t.changeActiveCalendar={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},q.globalConfiguration.permissions=t}else O.info("No old permissions found, using default permission values!");if(t.hasOwnProperty("secondsInCombatRound")&&Number.isInteger(t.secondsInCombatRound)){const e=parseInt(t.secondsInCombatRound.toString());isNaN(e)||(q.globalConfiguration.secondsInCombatRound=e)}else O.info("No old seconds in combat round setting found, using default value!");return!0}static async runNoteMigration(){const e=z.GetObjectSettings(n.Notes),t=R.getActiveCalendar();for(let s=0;s<e.length;s++){const a=e[s],n={year:a.year||t.year.numericRepresentation,month:t.months.findIndex((e=>e.numericRepresentation===a.month)),day:(a.day||1)-1,hour:a.hour||0,minute:a.minute||0,seconds:0},i={allDay:void 0===a.allDay||a.allDay,calendarId:t.id,repeats:a.repeats||0,order:a.order||0,categories:a.categories||[],remindUsers:a.remindUsers||[],startDate:n,endDate:n};a.hasOwnProperty("endDate")&&(i.endDate={year:a.endDate.year||n.year,month:t.months.findIndex((e=>e.numericRepresentation===a.endDate.month)),day:(a.endDate.day||1)-1,hour:a.endDate.hour||0,minute:a.endDate.minute||0,seconds:0}),i.startDate.month<0&&(i.startDate.month=0),i.endDate.month<0&&(i.endDate.month=0);const o=await G.createNote(a.title,a.content,i,t,!1,!1);if(o){const e={};Object.keys(o.data.permission).forEach((t=>{e[t]=t===a.author?3:a.playerVisible?2:0})),await o.update({permission:e})}}return!0}static async cleanUpOldData(){const e=await z.SaveObjectSetting(n.GeneralConfiguration,{}),t=await z.SaveObjectSetting(n.YearConfiguration,{}),s=await z.SaveObjectSetting(n.WeekdayConfiguration,[]),a=await z.SaveObjectSetting(n.MonthConfiguration,[]),i=await z.SaveObjectSetting(n.CurrentDate,{}),o=await z.SaveObjectSetting(n.LeapYearRule,{}),r=await z.SaveObjectSetting(n.TimeConfiguration,{}),c=await z.SaveObjectSetting(n.SeasonConfiguration,[]),l=await z.SaveObjectSetting(n.MoonConfiguration,[]),d=await z.SaveObjectSetting(n.Notes,[]),h=await z.SaveObjectSetting(n.NoteCategories,[]);return e&&t&&s&&a&&i&&o&&r&&c&&l&&d&&h}}class Kt extends Application{constructor(){super(),this.MigrationType=r.none,this.displayData={calendarMigrationStatusIcon:"fa-sync fa-spin fsc-og",globalConfigMigrationStatusIcon:"fa-sync fa-spin fsc-og",notesMigrationStatusIcon:"fa-sync fa-spin fsc-og",enableCleanUp:!1,migrationDone:!1}}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/migration.html",e.title="FSC.Migration.Title",e.classes=["simple-calendar"],e.id=this.appWindowId,e.resizable=!1,e.width=500,e}showApp(){this.render(!0,{classes:["simple-calendar",de()]})}getData(e){return{...super.getData(e),display:this.displayData,headingTitle:this.headingTitle,description:this.description}}get headingTitle(){let e="";if(this.MigrationType===r.v1To2)e="FSC.Migration.v1v2.Title";return e}get description(){let e="";if(this.MigrationType===r.v1To2)e="FSC.Migration.v1v2.Help";return e}initialize(){z.IsGm()&&this.determineMigrationType()}activateListeners(e){const t=document.getElementById(Kt.appWindowId);t&&t.querySelector(".fsc-pg")?.addEventListener("click",this.runCleanData.bind(this))}determineMigrationType(){const e=z.GetObjectSettings(n.GlobalConfiguration),t=z.GetObjectSettings(n.YearConfiguration);E(t)&&E(e)?this.MigrationType=r.none:E(t)||e.hasOwnProperty("version")||(O.info("Migration required from Simple Calendar v1 to Version 2"),this.MigrationType=r.v1To2)}get showMigration(){return this.MigrationType!==r.none}async run(e=!1){e&&(this.MigrationType=r.v1To2),O.info("Running Migration!"),this.showApp();const t=this.runCalendarMigration();this.showApp();const s=await this.runNoteMigration();this.showApp(),t&&s&&(this.displayData.enableCleanUp=!0,this.displayData.migrationDone=!0,W.render(),this.showApp())}runCalendarMigration(){if(O.info("Migrating Calendar Configuration..."),this.MigrationType==r.v1To2){let e=!1,t=!1;const s=Jt.runCalendarMigration();return null!==s?(R.setCalendars([s]),this.displayData.calendarMigrationStatusIcon="fa-check-circle fsc-qg",O.info("Calendar Configuration successfully migrated!"),O.info("Migrating Permissions and General Settings..."),e=!0):(O.error("There was an error converting the existing calendar configuration to the new calendar data model."),this.displayData.calendarMigrationStatusIcon="fa-times-circle fsc-rg",this.displayData.globalConfigMigrationStatusIcon="fa-ban fsc-sg"),Jt.runGlobalConfigurationMigration()?(O.info("Permissions and General Settings successfully migrated!"),this.displayData.globalConfigMigrationStatusIcon="fa-check-circle fsc-qg",this.saveMigratedData(),t=!0):(O.error("There was an error converting the existing permissions and general settings to the new permissions and general settings data model."),this.displayData.globalConfigMigrationStatusIcon="fa-times-circle fsc-rg"),e&&t}return!1}saveMigratedData(){q.save(q.globalConfiguration,{id:"",theme:i[0].key,openOnLoad:!0,openCompact:!1,rememberPosition:!0,rememberCompactPosition:!1,appPosition:{},noteReminderNotification:N.whisper,sideDrawerDirection:"sc-right",alwaysShowNoteList:!1,persistentOpen:!1,compactViewScale:100})}async runNoteMigration(){if(O.info("Migrating Calendar Notes..."),this.MigrationType==r.v1To2){if(await Jt.runNoteMigration())return O.info("Calendar Notes successfully migrated!"),this.displayData.notesMigrationStatusIcon="fa-check-circle fsc-qg",!0;O.error("There was an error converting the existing notes to journal entries."),this.displayData.notesMigrationStatusIcon="fa-times-circle fsc-rg"}return!1}runCleanData(){O.info("Clearing all old data..."),this.MigrationType==r.v1To2&&(Jt.cleanUpOldData().then((e=>{z.UiNotification(z.Localize("FSC.Migration.v1v2.CleanupSuccess"),"info")})).catch((e=>{console.log(e),z.UiNotification(z.Localize("FSC.Migration.v1v2.CleanupFail"),"warning")})),O.info("All old data has been cleared."))}}Kt.appWindowId="fsc-tg";class NoteSheet extends JournalSheet{static SetHeight(e){if(e.appWindow){const t=window.getComputedStyle(e.appWindow,":after");if(!e.resized){const s=e.appWindow.getElementsByTagName("form");if(s&&s.length){let a=0;const n=e.appWindow.getElementsByTagName("header");n&&n.length&&(a+=n[0].offsetHeight);const i=e.appWindow.querySelector(".window-content");if(i){const e=window.getComputedStyle(i);a+=(parseInt(e.borderTop)||0)+(parseInt(e.borderBottom)||0)}if(e.editMode)a+=s[0].scrollHeight;else{const t=window.getComputedStyle(s[0]);t&&(a+=(parseInt(t.paddingTop)||0)+(parseInt(t.paddingBottom)||0));const n=e.appWindow.querySelector(".fsc-ug"),i=e.appWindow.querySelector(".fsc-vg"),o=e.appWindow.querySelector(".fsc-wg");if(n){const e=window.getComputedStyle(n);a+=n.offsetHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)}if(i){const e=window.getComputedStyle(i);a+=i.scrollHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)+(parseInt(e.borderTop)||0)+(parseInt(e.borderBottom)||0)}if(o){const e=window.getComputedStyle(o);a+=o.offsetHeight+parseInt(e.marginTop)+parseInt(e.marginBottom)}}t&&(a+=parseInt(t.height)||0),e.editMode&&a<740&&(a=740);const o=.95*window.outerHeight;a>o&&(a=o),e.setPosition({height:me(a),width:me(720)})}}const s=e.appWindow.querySelector(".fsc-xg"),a=e.appWindow.querySelector(".fsc-yg, .fsc-ug");s&&a&&(s.style.top=a.offsetTop+"px",s.style.height=`calc(100% - ${a.offsetTop}px - ${t.height})`)}}constructor(e,t={}){super(e,t),this.dirty=!1,this.resized=!1,this.editMode=!1,this.journalData={_id:"",name:"",flags:{},ownership:{}},this.journalPages=[],this.appWindow=null,this.uiElementStates={"fsc-xg":!1,selectedPageIndex:0,search:{term:""}},this.inputChangeRedrawNames=["src","image.caption","video.width","video.height"],this.dateSelectorId=`scNoteDate_${this.object.id}`,this.categoryMultiSelectId=`scNoteCategories_${this.object.id}`,this.playerMultiSelectId=`scUserPermissions_${this.object.id}`,this.copyData()}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/note-sheet.html",e.title="Simple Calendar Note",e.id=this.appWindowId,e.classes=["sheet","journal-sheet","simple-calendar"],e.resizable=!0,e.closeOnSubmit=!1,game.settings&&e.classes.push(de()),e}static get defaultObject(){return{}}get template(){return this.options.template||""}get type(){return"simplecalendarnote"}copyData(){this.journalData._id=this.object.id||"",this.journalData.name=this.object.name||"",this.journalData.flags=mergeObject({},this.object.flags),this.journalData.ownership=mergeObject({},this.object.ownership),this.journalPages=[];for(let e=0;e<this.object.pages.contents.length;e++)this.journalPages.push({show:!0,_id:this.object.pages.contents[e]._id,name:this.object.pages.contents[e].name,type:this.object.pages.contents[e].type,text:{content:this.object.pages.contents[e].text.content},src:this.object.pages.contents[e].src,image:{caption:this.object.pages.contents[e].image.caption},video:this.object.pages.contents[e].video})}get title(){return this.object.name||"Note"}close(e){if(this.dirty){return new Dialog({title:z.Localize("FSC.NoteDirty"),content:z.Localize("FSC.NoteDirtyText"),buttons:{yes:{icon:'<i class="fas fa-trash"></i>',label:z.Localize("FSC.DiscardChanges"),callback:this.isDirtyDialogClose.bind(this,!1)},save:{icon:'<i class="fas fa-save"></i>',label:z.Localize("FSC.Save"),callback:this.isDirtyDialogClose.bind(this,!0)}},default:"save"}).render(!0),Promise.resolve()}return this.dirty=!1,this.editMode=!1,this.resized=!1,this.uiElementStates["fsc-xg"]=!1,this.uiElementStates.selectedPageIndex=0,this.cleanUpProsemirror(),super.close({submit:!1})}cleanUpProsemirror(){Object.values(this.editors).forEach((e=>{e.instance&&e.instance.destroy()}))}async isDirtyDialogClose(e){return this.dirty=!1,e?await this.save(new Event("click")):this.copyData(),this.close()}render(e,t,s){return void 0!==s&&(this.editMode=s),super.render(e,t)}async getData(e){let t={...super.getData(),pages:this.journalPages,editMode:this.editMode,uiElementStates:this.uiElementStates,name:"",enrichedContent:"",display:{date:"",reminder:!1,repeats:0,repeatsDisplay:"",author:{colorText:"",color:"",name:""},categories:[],macro:""},edit:{dateDisplay:"",repeats:l.Never,noteData:{},users:[],timeSelected:!1,dateSelectorId:this.dateSelectorId,dateSelectorSelect:this.dateSelectorSelect.bind(this),repeatOptions:{0:"FSC.Notes.Repeat.Never",1:"FSC.Notes.Repeat.Weekly",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"},allCategories:[],macroList:{none:"No Macro"},selectedMacro:"",categoryMultiSelectId:this.categoryMultiSelectId,playerMultiSelectId:this.playerMultiSelectId,pageTypes:{text:"JOURNALENTRYPAGE.TypeText",image:"JOURNALENTRYPAGE.TypeImage",pdf:"JOURNALENTRYPAGE.TypePDF",video:"JOURNALENTRYPAGE.TypeVideo"},page:{name:"",type:"",src:"",image:{caption:""},video:{width:void 0,height:void 0,controls:!1,autoplay:!1,loop:!1,volume:.5,volumeDisplay:"50%",timestamp:0,timestampParts:{}}}}};const s=G.getNoteStub(this.object);if(s)if(t.name=this.journalData.name,"text"===this.journalPages[this.uiElementStates.selectedPageIndex].type?t.enrichedContent=`<section>${await TextEditor.enrichHTML(this.journalPages[this.uiElementStates.selectedPageIndex].text?.content||"",{async:!0})}</section>`:"image"===this.journalPages[this.uiElementStates.selectedPageIndex].type?t.enrichedContent=this.generateImageHTML():"pdf"===this.journalPages[this.uiElementStates.selectedPageIndex].type?t.enrichedContent=await this.generatePDFHTML(void 0,this.editMode):"video"===this.journalPages[this.uiElementStates.selectedPageIndex].type&&(t.enrichedContent=this.generateVideoHTML()),this.editMode){t.edit.page.name=this.journalPages[this.uiElementStates.selectedPageIndex].name,t.edit.page.type=this.journalPages[this.uiElementStates.selectedPageIndex].type,t.edit.page.src=this.journalPages[this.uiElementStates.selectedPageIndex].src||"",t.edit.page.image.caption=this.journalPages[this.uiElementStates.selectedPageIndex].image?.caption||"",t.edit.page.video.width=this.journalPages[this.uiElementStates.selectedPageIndex].video?.width,t.edit.page.video.height=this.journalPages[this.uiElementStates.selectedPageIndex].video?.height,t.edit.page.video.controls=this.journalPages[this.uiElementStates.selectedPageIndex].video?.controls||!1,t.edit.page.video.autoplay=this.journalPages[this.uiElementStates.selectedPageIndex].video?.autoplay||!1,t.edit.page.video.loop=this.journalPages[this.uiElementStates.selectedPageIndex].video?.loop||!1,t.edit.page.video.volume=this.journalPages[this.uiElementStates.selectedPageIndex].video?.volume||.5,t.edit.page.video.volumeDisplay=`${Math.round(100*t.edit.page.video.volume)}%`,t.edit.page.video.timestamp=this.journalPages[this.uiElementStates.selectedPageIndex].video?.timestamp||0;let e=0,a=0,n=0;t.edit.page.video.timestamp&&(e=Math.floor(t.edit.page.video.timestamp/3600),a=Math.floor(t.edit.page.video.timestamp%3600/60),n=t.edit.page.video.timestamp-3600*e-60*a),t.edit.page.video.timestampParts={h:e,m:a,s:n},t.edit.noteData=s.noteData||{},t.edit.timeSelected=!s.allDay,t.edit.repeats=s.repeats;const i=game.users;i&&(t.edit.users=i.map((e=>({text:e.name||"",value:e.id,selected:0!==s.ownership[e.id]&&this.object.testUserPermission(e,2),static:e.id===game.user?.id,disabled:e.id===game.user?.id||s.ownership.default>=2}))),t.edit.users.unshift({text:z.Localize("FSC.Notes.Permissions.AllPlayers"),value:"default",makeOthersMatch:!0,selected:void 0!==s.ownership.default&&0!==s.ownership.default,disabled:!1}));const o=s.noteData;if(o){const e=R.getCalendar(o.calendarId);e&&(t.edit.dateDisplay=J(o.startDate,"MMMM DD, YYYY",e),ee(o.startDate,o.endDate)||(t.edit.dateDisplay+=` - ${J(o.endDate,"MMMM DD, YYYY",e)}`),t.edit.allCategories=e.noteCategories.map((e=>({text:e.name,value:e.name,selected:void 0!==o.categories.find((t=>t===e.name))}))))}game.macros?.forEach((e=>{e.canExecute&&e.name&&(t.edit.macroList[e.id]=e.name)})),t.edit.selectedMacro=s.macro}else t.display.date=s.fullDisplayDate,t.display.reminder=s.userReminderRegistered,t.display.repeats=s.repeats,t.display.repeatsDisplay=z.Localize(t.edit.repeatOptions[s.repeats]||""),t.display.author=s.authorDisplay||{colorText:"",color:"",name:""},t.display.categories=s.categories,this.isEditable&&(t.display.macro=game.macros?.get(s.macro)?.name||"");return t}_getYouTubeVars(){const e={playsinline:1,modestbranding:1};return this.editMode||(e.controls=this.journalPages[this.uiElementStates.selectedPageIndex].video?.controls?1:0,e.autoplay=this.journalPages[this.uiElementStates.selectedPageIndex].video?.autoplay?1:0,e.loop=this.journalPages[this.uiElementStates.selectedPageIndex].video?.loop?1:0,this.journalPages[this.uiElementStates.selectedPageIndex].video?.timestamp&&(e.start=this.journalPages[this.uiElementStates.selectedPageIndex].video?.timestamp)),e}_activateVideo(){if(this.appWindow){const e=this.journalPages[this.uiElementStates.selectedPageIndex].video?.volume||0,t=this.journalPages[this.uiElementStates.selectedPageIndex].video?.timestamp||0,s=this.appWindow.querySelector("iframe");s&&game.video.getYouTubePlayer(s.id,{events:{onStateChange:this.youtubeOnStateChange.bind(this,e)}}).then((e=>{t&&e.seekTo(t,!0)}));const a=this.appWindow.querySelector("video");a&&(a.addEventListener("loadeddata",NoteSheet.SetHeight.bind(null,this)),a.addEventListener("loadedmetadata",this.videoLoadMetadata.bind(this,a,e,t)))}}youtubeOnStateChange(e,t){t.data===YT.PlayerState.PLAYING&&t.target?.setVolume(100*e)}videoLoadMetadata(e,t,s){e.volume=t,s&&(e.currentTime=s)}activateListeners(e){if(this.appWindow=document.getElementById(`${this.id}`),this.appWindow){const e=i.map((e=>e.key));if(this.appWindow.classList.remove(...e),this.appWindow.classList.add(q.clientSettings.theme),this.editMode){if("text"===this.journalPages[this.uiElementStates.selectedPageIndex].type){const e=this.appWindow.querySelector(".editor-content[data-edit]");e&&(this.cleanUpProsemirror(),this.object.content=this.journalPages[this.uiElementStates.selectedPageIndex].text?.content||"",this._activateEditor(e))}else this.object.content="";this.appWindow.querySelectorAll("button.file-picker").forEach((e=>{e.onclick=this._activateFilePicker.bind(this)})),ze.ActivateSelector(this.dateSelectorId),we.ActivateListeners(this.categoryMultiSelectId,this.multiSelectOptionChange.bind(this)),we.ActivateListeners(this.playerMultiSelectId,this.multiSelectOptionChange.bind(this)),this.updateNoteRepeatDropdown(),this.appWindow.querySelectorAll("input, select").forEach((e=>{e.addEventListener("change",this.inputChange.bind(this))})),this.appWindow.querySelector(".fsc-zg")?.addEventListener("click",this.addPage.bind(this)),this.appWindow.querySelectorAll(".fsc-_g .fsc-gc").forEach((e=>{e.addEventListener("click",this.removePage.bind(this))}))}else this._activateVideo(),this.appWindow.querySelector("img")?.addEventListener("load",NoteSheet.SetHeight.bind(null,this)),this.appWindow.querySelector(".fsc-ah")?.removeAttribute("disabled"),this.appWindow.querySelector(".fsc-ah")?.addEventListener("click",this.reminderChange.bind(this,!0)),this.appWindow.querySelector(".load-pdf button")?.removeAttribute("disabled"),this.appWindow.querySelector(".load-pdf button")?.addEventListener("click",this._loadPDF.bind(this));this.appWindow.querySelector(".fsc-sc")?.addEventListener("click",this.save.bind(this)),this.appWindow.querySelector(".fsc-bh")?.addEventListener("click",this.edit.bind(this)),this.appWindow.querySelector(".fsc-ch")?.addEventListener("click",this.delete.bind(this)),this.appWindow.querySelector(".fsc-dh")?.addEventListener("click",this.toggleDrawer.bind(this,"fsc-xg")),this.appWindow.querySelectorAll(".fsc-_g li").forEach((e=>{e.addEventListener("click",this.changePage.bind(this))})),this.appWindow.querySelector(".fsc-xg .fsc-ig input")?.addEventListener("input",this.searchUpdate.bind(this)),this.appWindow.querySelector(".fsc-xg .fsc-ig .fsc-xb")?.addEventListener("click",this.clearSearch.bind(this))}}_updateObject(e,t){return"text"===this.journalPages[this.uiElementStates.selectedPageIndex].type&&(this.journalPages[this.uiElementStates.selectedPageIndex].text={content:t.content},this.dirty=!0),Promise.resolve()}toggleDrawer(e,t){if(this.appWindow){const t=this.appWindow.querySelector(`.${e}`);if(t){const s=e.toLowerCase();this.uiElementStates[s]=ue(t,500,!1);const a=t.querySelector(".fsc-dh");if(a){a.setAttribute("data-tooltip",this.uiElementStates[s]?z.Localize("JOURNAL.ViewCollapse"):z.Localize("JOURNAL.ViewExpand"));const e=a.querySelector(".fa-solid");e&&(e.classList.remove("fa-caret-left","fa-caret-right"),e.classList.add(this.uiElementStates[s]?"fa-caret-right":"fa-caret-left"))}}}}async inputChange(e){await this.writeInputValuesToObjects();const t=e.target,s=t?.closest(".fsc-eh")?.querySelector("figure, .fsc-fh");if(t&&s&&this.inputChangeRedrawNames.indexOf(t.name)>-1){const e=document.createElement("div"),a="src"===t.name?t.value:void 0;"image"===this.journalPages[this.uiElementStates.selectedPageIndex].type?e.innerHTML=this.generateImageHTML(a):"pdf"===this.journalPages[this.uiElementStates.selectedPageIndex].type?e.innerHTML=await this.generatePDFHTML(a,this.editMode):"video"===this.journalPages[this.uiElementStates.selectedPageIndex].type&&(e.innerHTML=this.generateVideoHTML(a)),e.innerHTML&&s.replaceWith(e.childNodes[0])}else if(t&&"video.volume"===t.name){const e=this.appWindow?.querySelector(`label[for="scPageVideoVolume_${this.object.id}"] span`);e&&(e.innerHTML=`${Math.round(100*parseFloat(t.value))}%`)}}_loadPDF(e){const t=e.currentTarget?.parentElement;if(t){const e=document.createElement("iframe");e.src=`scripts/pdfjs/web/viewer.html?file=${foundry.utils.getRoute(this.journalPages[this.uiElementStates.selectedPageIndex].src||"")}`,e.classList.add("fsc-gh"),t.replaceWith(e),NoteSheet.SetHeight(this)}}_onResize(e){this.resized=!0,super._onResize(e)}generateImageHTML(e){const t=e||this.journalPages[this.uiElementStates.selectedPageIndex].src;let s;return s=t?`<figure><img src="${t}" alt="${this.journalPages[this.uiElementStates.selectedPageIndex].image?.caption||""}" /><figcaption>${this.journalPages[this.uiElementStates.selectedPageIndex].image?.caption||""}</figcaption></figure><div class="fsc-hh"></div>`:'<div class="fsc-fh flex-ratio"><i class="fa-solid fa-image"></i></div>',s}async generatePDFHTML(e,t=!1){const s=e||this.journalPages[this.uiElementStates.selectedPageIndex].src;let a;if(s)if(t)a=`<iframe class="fsc-gh" src="scripts/pdfjs/web/viewer.html?file=${foundry.utils.getRoute(s)}"></iframe>`;else{const e=await fetch(s,{method:"HEAD"}),t=Number(e?.headers.get("content-length"));let n="";isNaN(t)||(n=` (${(t/1024/1024).toFixed(2)} MB)`),a=`<div class="load-pdf"><button type="button" class="fsc-xb fsc-bc">${z.Localize("JOURNALENTRYPAGE.PDFLoad")}${n}</button></div>`}else a='<div class="fsc-fh flex-ratio"><i class="fa-solid fa-file-pdf"></i></div>';return a}generateVideoHTML(e){const t=e||this.journalPages[this.uiElementStates.selectedPageIndex].src;let s;return t?(s=`<figure class="${this.journalPages[this.uiElementStates.selectedPageIndex].video?.width||this.journalPages[this.uiElementStates.selectedPageIndex].video?.height?"":"flex-ratio"}">`,game.video.isYouTubeURL(t)?s+=`<iframe id="youtube-${foundry.utils.randomID()}" src="${game.video.getYouTubeEmbedURL(t,this._getYouTubeVars())}" ${this.journalPages[this.uiElementStates.selectedPageIndex].video?.width?`width="${this.journalPages[this.uiElementStates.selectedPageIndex].video?.width}"`:""} ${this.journalPages[this.uiElementStates.selectedPageIndex].video?.height?`height="${this.journalPages[this.uiElementStates.selectedPageIndex].video?.height}"`:""}></iframe>`:s+=`<video src="${t}" controls ${this.journalPages[this.uiElementStates.selectedPageIndex].video?.width?`width="${this.journalPages[this.uiElementStates.selectedPageIndex].video?.width}"`:""} ${this.journalPages[this.uiElementStates.selectedPageIndex].video?.height?`height="${this.journalPages[this.uiElementStates.selectedPageIndex].video?.height}"`:""}></video>`,s+="</figure>"):s='<div class="fsc-fh flex-ratio"><i class="fa-solid fa-video"></i></div>',s}async dateSelectorSelect(e){if(R.getCalendar(this.journalData.flags[t].noteData.calendarId)){const s=!e.startDate.month||e.startDate.month<0?0:e.startDate.month,a=!e.startDate.day||e.startDate.day<0?0:e.startDate.day,n=!e.endDate.month||e.endDate.month<0?0:e.endDate.month,i=!e.endDate.day||e.endDate.day<0?0:e.endDate.day;this.journalData.flags[t].noteData.allDay=!e.timeSelected,this.journalData.flags[t].noteData.startDate={year:e.startDate.year||0,month:s,day:a,hour:e.startDate.hour||0,minute:e.startDate.minute||0,seconds:e.startDate.seconds||0},this.journalData.flags[t].noteData.endDate={year:e.endDate.year||0,month:n,day:i,hour:e.endDate.hour||0,minute:e.endDate.minute||0,seconds:e.endDate.seconds||0},this.updateNoteRepeatDropdown()}}multiSelectOptionChange(e,s,a){if(e===this.categoryMultiSelectId){const e=this.journalData.flags[t].noteData.categories.indexOf(s);a?this.journalData.flags[t].noteData.categories.push(s):e>-1&&this.journalData.flags[t].noteData.categories.splice(e,1),this.dirty=!0}else if(e===this.playerMultiSelectId){if(a){const e=this.journalData.ownership[s];void 0===e||e<2?this.journalData.ownership[s]=2:3===e&&(this.journalData.ownership[s]=3),"default"===s&&game.users?.forEach((e=>{const t=this.journalData.ownership[e.id];(void 0===t||t<2)&&(this.journalData.ownership[e.id]=2)}))}else this.journalData.ownership[s]=0,"default"===s&&game.users?.forEach((e=>{2===this.journalData.ownership[e.id]&&(this.journalData.ownership[e.id]=0)}));this.dirty=!0}}updateNoteRepeatDropdown(){if(this.appWindow){const e=this.appWindow.querySelector(`#scNoteRepeats_${this.object.id}`),s=this.journalData.flags[t].noteData;if(e&&s){const t=R.getCalendar(s.calendarId);if(t){const a=te(t,s.startDate,s.endDate);let n={0:"FSC.Notes.Repeat.Never",1:"FSC.Notes.Repeat.Weekly",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"};a>=t.totalNumberOfDays(!1,!0)?(delete n[1],delete n[2],delete n[3]):a>=t.months[s.startDate.month].days.length?(delete n[1],delete n[2]):a>=t.weekdays.length&&delete n[1];let i="";for(let e in n){i+=`<option value="${e}" ${s.repeats.toString()===e?"selected":""}>${z.Localize(n[e])}</option>`}e.innerHTML=i}}}}async writeInputValuesToObjects(){let e=!1;if(this.appWindow){this.journalData.name=Ue(".fsc-ih","New Note",this.appWindow),this.journalData.flags[t].noteData.repeats=Ve(`#scNoteRepeats_${this.object.id}`,l.Never,!1,this.appWindow),this.journalData.flags[t].noteData.macro=Ue(`#scNoteMacro_${this.object.id}`,"none",this.appWindow),this.journalPages[this.uiElementStates.selectedPageIndex].name=Ue(`#scPageName_${this.object.id}`,"New Page",this.appWindow);const s=Ue(`#scPageType_${this.object.id}`,"text",this.appWindow);switch(this.journalPages[this.uiElementStates.selectedPageIndex].type!==s&&(this.journalPages[this.uiElementStates.selectedPageIndex].type=s,e=!0),s){case"text":this.editors.content&&await this.saveEditor("content");break;case"image":this.journalPages[this.uiElementStates.selectedPageIndex].src=Ue(`#scPageImageSrc_${this.object.id}`,"",this.appWindow),this.journalPages[this.uiElementStates.selectedPageIndex].image={caption:Ue(`#scPageImageCaption_${this.object.id}`,"",this.appWindow)};break;case"pdf":this.journalPages[this.uiElementStates.selectedPageIndex].src=Ue(`#scPagePDFSrc_${this.object.id}`,"",this.appWindow);break;case"video":let e=3600*(Ve(`#scPageVideoHours_${this.object.id}`,null,!1,this.appWindow)||null||0)+60*(Ve(`#scPageVideoMinutes_${this.object.id}`,null,!1,this.appWindow)||null||0)+(Ve(`#scPageVideoSeconds_${this.object.id}`,null,!1,this.appWindow)||null||0);this.journalPages[this.uiElementStates.selectedPageIndex].src=Ue(`#scPageVideoSrc_${this.object.id}`,"",this.appWindow),this.journalPages[this.uiElementStates.selectedPageIndex].video={controls:_e(`#scPageVideoControls_${this.object.id}`,!1,this.appWindow),autoplay:_e(`#scPageVideoAutoplay_${this.object.id}`,!1,this.appWindow),loop:_e(`#scPageVideoLoop_${this.object.id}`,!1,this.appWindow),volume:Ve(`#scPageVideoVolume_${this.object.id}`,.5,!0,this.appWindow)||0,height:Ve(`#scPageVideoHeight_${this.object.id}`,null,!1,this.appWindow),width:Ve(`#scPageVideoWidth_${this.object.id}`,null,!1,this.appWindow),timestamp:e}}this.dirty=!0,e&&this.render(!0)}}async reminderChange(e=!0){const s=game.user;if(s){const a=s.id;if(this.object.testUserPermission(s,3)){const e=this.journalData.flags[t].noteData.remindUsers.indexOf(a);""!==a&&-1===e?this.journalData.flags[t].noteData.remindUsers.push(a):""!==a&&-1!==e&&this.journalData.flags[t].noteData.remindUsers.splice(e,1),await this.object.update(this.journalData)}else{const e={type:u.noteUpdate,data:{userId:a,journalId:this.object.id}};await j.emit(e)}e&&this.render(!0),W.updateApp()}}searchUpdate(e){const t=e.target;t&&(this.uiElementStates.search.term=t.value,this.searchPages())}clearSearch(){if(this.uiElementStates.search.term="",this.appWindow){const e=this.appWindow.querySelector(".fsc-xg .fsc-ig input");e&&(e.value="")}this.searchPages()}searchPages(){const e=this.journalPages.filter((e=>-1===e.name.indexOf(this.uiElementStates.search.term)));if(this.journalPages.forEach((e=>{e.show=!0})),this.appWindow?.querySelectorAll(".fsc-_g li").forEach((e=>e.classList.remove("fsc-ha"))),e.length){for(let t=0;t<e.length;t++)e[t].show=!1,this.appWindow?.querySelector(`.fsc-_g li[data-index="${e[t]._id}"]`)?.classList.add("fsc-ha");this.appWindow?.querySelector(".fsc-jh .fsc-ig .fsc-xb")?.classList.remove("fsc-ha")}else this.appWindow?.querySelector(".fsc-jh .fsc-ig .fsc-xb")?.classList.add("fsc-ha")}async edit(e){e.preventDefault(),this.resized=!1,this.editMode=!0,this.uiElementStates["fsc-xg"]=!0,this.render(!0)}changePage(e){const t=e.target?.closest("li");if(t){const e=t.getAttribute("data-index");if(e){const t=this.journalPages.findIndex((t=>t._id===e));t>-1&&(this.uiElementStates.selectedPageIndex=t,this.render(!0))}}}async addPage(){this.journalPages.push({_id:foundry.utils.randomID(),show:!0,name:"New Page",type:"text",text:{content:""}}),this.uiElementStates.selectedPageIndex=this.journalPages.length-1,this.dirty=!0,this.render(!0)}async removePage(e){const t=e.target?.closest("li");if(t){const e=t.getAttribute("data-index");if(e){const t=this.journalPages.findIndex((t=>t._id===e));t>-1&&(this.journalPages.splice(t,1),this.uiElementStates.selectedPageIndex>=this.journalPages.length&&(this.uiElementStates.selectedPageIndex=this.journalPages.length-1)),this.dirty=!0,this.render(!0)}}}async save(e){e.preventDefault(),await this.writeInputValuesToObjects(),this.journalData.flags[t].noteData.fromPredefined=!1,await this.object.update(this.journalData,{render:!1,renderSheet:!1});const s=this.object.getEmbeddedCollection("JournalEntryPage").contents;for(let e=0;e<s.length;e++){-1===this.journalPages.findIndex((t=>t._id===s[e].id))&&await s[e].delete({render:!1,renderSheet:!1})}for(let e=0;e<this.journalPages.length;e++){s.find((t=>t.id===this.journalPages[e]._id))?await this.object.updateEmbeddedDocuments("JournalEntryPage",[{_id:this.journalPages[e]._id,name:this.journalPages[e].name,type:this.journalPages[e].type,text:{content:this.journalPages[e].text?.content||"",format:1,markdown:void 0},src:this.journalPages[e].src||"",image:{caption:this.journalPages[e].image?.caption||""},video:this.journalPages[e].video}],{render:!1,renderSheet:!1}):await this.object.createEmbeddedDocuments("JournalEntryPage",[{text:{content:this.journalPages[e].text?.content||"",format:1,markdown:void 0},name:this.journalPages[e].name,type:this.journalPages[e].type,src:this.journalPages[e].src||"",image:{caption:this.journalPages[e].image?.caption||""},video:{autoplay:this.journalPages[e].video?.autoplay||!1,controls:this.journalPages[e].video?.controls||!1,height:this.journalPages[e].video?.height||null,loop:this.journalPages[e].video?.loop||!1,timestamp:this.journalPages[e].video?.timestamp||0,volume:this.journalPages[e].video?.volume||.5,width:this.journalPages[e].video?.width||null}}],{render:!1,renderSheet:!1})}W.updateApp(),await j.emit({type:u.mainAppUpdate,data:{}}),this.resized=!1,this.editMode=!1,this.dirty=!1,this.render(!0)}delete(e){e.preventDefault();new Dialog({title:z.Localize("FSC.DeleteConfirm"),content:z.Localize("FSC.DeleteConfirmText"),buttons:{yes:{icon:'<i class="fas fa-trash"></i>',label:z.Localize("FSC.Delete"),callback:this.deleteConfirm.bind(this)},no:{icon:'<i class="fas fa-times"></i>',label:z.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async deleteConfirm(){this.dirty=!1,G.removeNoteStub(this.object),W.updateApp(),await this.object.delete(),await j.emit({type:u.mainAppUpdate,data:{}}),await this.close()}}NoteSheet.appWindowId="fsc-kh";class Xt{constructor(e,t){this.fireOnce=!0,this.fired=!1,this.fireOnce=t,this.onFire=e}fire(e,t=!1){(!this.fireOnce||this.fireOnce&&!this.fired)&&(this.fired=this.onFire(e,t))}}class Qt{static reminderNoteTrigger(e,t){const s=e.noteData;if(s&&e.userReminderRegistered){const a=R.getCalendar(s.calendarId);if(a&&(!t||t&&a.generalSettings.postNoteRemindersOnFoundryLoad))return q.clientSettings.noteReminderNotification===N.whisper?ChatMessage.create({speaker:{alias:"Simple Calendar Reminder"},whisper:[z.UserID()],content:`<h2>${e.title}</h2><div style="display: flex;margin-bottom: 0.5rem;"><div class="note-category"><span class="fa fa-calendar"></span> ${e.fullDisplayDate}</div></div>${e.link}`}).catch(O.error):q.clientSettings.noteReminderNotification===N.render&&e.render(),!0}return!1}static macroNoteTrigger(e,t){const s=e.macro;if(!t&&s&&"none"!==s){const e=game.macros?.get(s);if(e&&e.canExecute)return e.execute(),!0}return!1}constructor(e){this.triggers=[],this.entryId=e,this.triggers.push(new Xt(Qt.reminderNoteTrigger,!0)),this.triggers.push(new Xt(Qt.macroNoteTrigger,!0))}get noteData(){const e=game.journal?.get(this.entryId);return e?e.getFlag(t,"noteData"):null}get ownership(){const e=game.journal?.get(this.entryId);return e?e.ownership:{}}get allDay(){const e=this.noteData;return!e||e.allDay}get link(){const e=game.journal?.get(this.entryId);return e?e.link:""}get title(){const e=game.journal?.get(this.entryId);return e?.name||""}get pages(){const e=game.journal?.get(this.entryId);return e?e.pages.contents:[]}get repeats(){const e=this.noteData;return e?e.repeats:l.Never}get order(){const e=this.noteData;return e?e.order:0}async setOrder(e){const s=game.journal?.get(this.entryId);if(s){const a=s.getFlag(t,"noteData");a&&(a.order=e,await s.setFlag(t,"noteData",a))}}get authorDisplay(){const e=game.journal?.get(this.entryId);if(e){const s=e.getFlag(t,"noteData");if(s&&s.fromPredefined)return{name:"System",color:"",colorText:""};{const e=this.ownership;for(let t in e)if(3===e[t]){const e=game.users?.get(t);if(e)return{name:e.name||"",color:e.color||"",colorText:ce(e.color||"")}}}}return null}get canEdit(){let e=z.IsGm();if(!e){const t=game.journal?.get(this.entryId);if(t){const t=this.ownership;for(let s in t)if(3===t[s]&&s===z.UserID()){e=!0;break}}}return e}get categories(){const e=this.noteData;if(e){const t=R.getCalendar(e.calendarId);if(t)return t.noteCategories.filter((t=>e.categories.indexOf(t.name)>-1))}return[]}get displayDate(){return this.getDisplayDate(!1)}get fullDisplayDate(){return this.getDisplayDate(!0)}get playerVisible(){const e=game.journal?.get(this.entryId),t={icon:"fa-eye-slash",color:"fsc-lh",players:""};if(e){const e=this.ownership,s=game.users?.filter((t=>void 0!==e[t.id]&&e[t.id]>=2));s&&(s.length===game.users?.contents.length?(t.icon="fa-eye",t.color="fsc-mh"):s.length>1&&(t.icon="fa-eye-low-vision",t.color="fsc-bc"),t.players=`${z.Localize("FSC.Notes.UserPermissionTitle")}:<ul style="text-align: left;padding: 0;margin-bottom:0;list-style: none;"><li>${s.map((e=>e.name||"")).join("</li><li>")}</li></ul>`)}return t}get userReminderRegistered(){let e=!1;if(this.canUserView()){const t=this.noteData,s=game.user;t&&s&&(e=t.remindUsers.indexOf(s.id)>-1)}return e}get fromPredefined(){const e=this.noteData;return!(!e||void 0===e.fromPredefined)&&e.fromPredefined}get macro(){const e=this.noteData;return e&&void 0!==e.macro?e.macro:"none"}render(){G.showNote(this.entryId)}canUserView(){const e=game.journal?.get(this.entryId),t=game.user;return!(!e||!t)&&!(0===this.ownership[t.id]||!e.testUserPermission(t,2))}getDisplayDate(e){const t=this.noteData;if(t){const s=R.getCalendar(t.calendarId);if(s){let a,n=s.year.selectedYear||s.year.visibleYear,i=s.getMonthAndDayIndex("selected");void 0===i.month&&(i=s.getMonthAndDayIndex());let o=t.startDate.year,r=t.startDate.month,c=t.startDate.day,d=t.endDate.year,h=t.endDate.month,m=t.endDate.day;if(t.repeats===l.Weekly){o=n,d=n;let e=s.dayOfTheWeek(t.startDate.year,r,c),a=s.dayOfTheWeek(t.endDate.year,h,m),l=s.dayOfTheWeek(n,i.month||0,i.day||0),u=a-e;u<0&&(u=s.weekdays.length+u),u++,r=i.month||0,h=i.month||0;let p=l-e,g=a-l;if(p<0&&(p=s.weekdays.length+p),g<0&&(g=s.weekdays.length+g),p+g<u){c=(i.day||0)-p,m=(i.day||0)+g;let e=0;for(;c<0&&e<s.months.length;){r--,r<0&&(o--,r=s.months.length-1);const t=s.year.leapYearRule.isLeapYear(o);c=s.months[r][t?"numberOfLeapYearDays":"numberOfDays"]+c,e++}let t=s.year.leapYearRule.isLeapYear(d);for(e=0;m>=s.months[h][t?"numberOfLeapYearDays":"numberOfDays"]&&e<s.months.length;)m-=s.months[h][t?"numberOfLeapYearDays":"numberOfDays"],h++,h>=s.months.length&&(d++,h=0,t=s.year.leapYearRule.isLeapYear(d)),e++}}else if(t.repeats===l.Monthly){if(o=n,d=n,r=i.month||0,h=i.month||0,t.startDate.month!==t.endDate.month&&(t.startDate.day<=(i.day||0)?(h=(i.month||0)+1,h>=s.months.length&&(h=0,d=n+1)):t.endDate.day>=(i.day||0)&&(r=(i.month||0)-1,r<0&&(r=s.months.length-1,o=n-1))),t.startDate.day>=s.months[r].days.length){c=(s.year.leapYearRule.isLeapYear(o)?s.months[r].numberOfLeapYearDays:s.months[r].numberOfDays)-1}if(t.endDate.day>=s.months[h].days.length){m=(s.year.leapYearRule.isLeapYear(d)?s.months[h].numberOfLeapYearDays:s.months[h].numberOfDays)-1}}else if(t.repeats===l.Yearly)if(t.startDate.year!==t.endDate.year){const e=t.endDate.year-t.startDate.year;t.startDate.month===(i.month||0)&&t.startDate.day<=(i.day||0)?(o=n,d=n+e):t.endDate.month===(i.month||0)&&t.endDate.day>=(i.day||0)&&(o=n-e,d=n)}else o=n,d=n;return a=Q(s,{year:o,month:r,day:c,hour:t.startDate.hour,minute:t.startDate.minute,seconds:0},{year:d,month:h,day:m,hour:t.endDate.hour,minute:t.endDate.minute,seconds:0},t.allDay,!e),a}}return""}isVisible(e,t,s,a){const n=R.getCalendar(e),i=this.noteData;let o=!1;if(i&&n&&this.canUserView()){let e=d.None;if(i.repeats===l.Weekly){let o,r,c;o=n.dayOfTheWeek(i.startDate.year,i.startDate.month,i.startDate.day),c=n.dayOfTheWeek(t,s,a),r=n.dayOfTheWeek(i.endDate.year,i.endDate.month,i.endDate.day),o===c?e=d.Start:r===c?e=d.End:(o<r&&o<c&&r>c||o>r&&(o<c&&r<c||o>c&&r>c))&&(e=d.Middle)}else if(i.repeats===l.Monthly)if(i.startDate.month!==i.endDate.month){let o=s-1,r=s+1,c=t,l=t;o<0&&(o=n.months.length-1,c--),r>=n.months.length&&(r=0,l++);const h=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:c,month:o,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:s,day:i.endDate.day,hour:0,minute:0,seconds:0}),m=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:t,month:s,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:l,month:r,day:i.endDate.day,hour:0,minute:0,seconds:0});h===d.None&&m===d.None||(e=d.Middle)}else e=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:t,month:s,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:s,day:i.endDate.day,hour:0,minute:0,seconds:0});else if(i.repeats===l.Yearly){let o=t,r=t;if(i.startDate.year!==i.endDate.year){const c=i.endDate.year-i.startDate.year;o=t-c,r=t+c;const l=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:t,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:r,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0}),h=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:o,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0});l===d.None&&h===d.None||(e=d.Middle)}else e=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:t,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:t,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0})}else e=se(n,{year:t,month:s,day:a,hour:0,minute:0,seconds:0},{year:i.startDate.year,month:i.startDate.month,day:i.startDate.day,hour:0,minute:0,seconds:0},{year:i.endDate.year,month:i.endDate.month,day:i.endDate.day,hour:0,minute:0,seconds:0});o=e!==d.None}return o}}class es{constructor(e,t={}){this.k1=1.3,this.b=.75,this.totalDocumentTermCount=0,this.averageDocumentTermCount=0,this.documents={},this.terms={},this.stopWords=["a","about","above","after","again","against","all","am","an","and","any","are","aren't","as","at","be","because","been","before","being","below","between","both","but","by","can't","cannot","could","couldn't","did","didn't","do","does","doesn't","doing","don't","down","during","each","few","for","from","further","had","hadn't","has","hasn't","have","haven't","having","he","he'd","he'll","he's","her","here","here's","hers","herself","him","himself","his","how","how's","i","i'd","i'll","i'm","i've","if","in","into","is","isn't","it","it's","its","itself","let's","me","more","most","mustn't","my","myself","no","nor","not","of","off","on","once","only","or","other","ought","our","ours","ourselves","out","over","own","same","shan't","she","she'd","she'll","she's","should","shouldn't","so","some","such","than","that","that's","the","their","theirs","them","themselves","then","there","there's","these","they","they'd","they'll","they're","they've","this","those","through","to","too","under","until","up","very","was","wasn't","we","we'd","we'll","we're","we've","were","weren't","what","what's","when","when's","where","where's","which","while","who","who's","whom","why","why's","with","won't","would","wouldn't","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves"],e.forEach((e=>this.addDocument(e))),this.calculateIdf()}addDocument(e){let t=Array.isArray(e.content)?e.content.join(" "):e.content;const s=this.tokenize(t),a={id:e.id,content:t.toLowerCase(),score:0,terms:{},tokens:s,termCount:s.length};this.totalDocumentTermCount+=s.length;for(let e=0;e<s.length;e++){const t=s[e];a.terms[t]||(a.terms[t]={count:0,freq:0}),a.terms[t].count++}for(let e in a.terms)a.terms[e].freq=a.terms[e].count/a.termCount,this.terms[e]||(this.terms[e]={n:0,idf:0}),this.terms[e].n++;this.documents[a.id]=a,this.averageDocumentTermCount=this.totalDocumentTermCount/Object.keys(this.documents).length}calculateIdf(){const e=Object.keys(this.documents).length;for(let t in this.terms)this.terms[t].idf=Math.max(Math.log10((e-this.terms[t].n+.5)/(this.terms[t].n+.5)),.01)}static _min(e,t,s,a,n){return e<t||s<t?e>s?s+1:e+1:a===n?t:t+1}static levenshteinDistance(e,t){if(e.length>t.length){const s=e;e=t,t=s}let s=e.length,a=t.length;for(;s>0&&e.charCodeAt(s-1)===t.charCodeAt(a-1);)s--,a--;let n=0;for(;n<s&&e.charCodeAt(n)===t.charCodeAt(n);)n++;if(s-=n,a-=n,0===s||a<3)return a;let i,o,r,c,l,d,h,m,u,p,g,f=0,y=1e3;const C=[];for(i=0;i<s;i++)C.push(i+1),C.push(e.charCodeAt(n+i));let b=C.length-1;for(;f<a-3;)for(m=t.charCodeAt(n+(o=f)),u=t.charCodeAt(n+(r=f+1)),p=t.charCodeAt(n+(c=f+2)),g=t.charCodeAt(n+(l=f+3)),y=f+=4,i=0;i<b;i+=2)d=C[i],h=C[i+1],o=es._min(d,o,r,m,h),r=es._min(o,r,c,u,h),c=es._min(r,c,l,p,h),y=es._min(c,l,y,g,h),C[i]=y,l=c,c=r,r=o,o=d;for(;f<a;)for(m=t.charCodeAt(n+(o=f)),y=++f,i=0;i<b;i+=2)d=C[i],C[i]=y=es._min(d,o,y,m,C[i+1]),o=d;return y}tokenize(e){return e.toLowerCase().replace(/\r?\n|\r/g," ").trim().split(" ").filter((e=>-1===this.stopWords.indexOf(e)))}search(e){const t=this.tokenize(e),s=[];for(let e in this.documents){this.documents[e].score=0;for(let s=0;s<t.length;s++){const a=t[s];if(this.terms[a]&&this.documents[e].terms[a]){const t=this.documents[e].terms[a].count+this.k1*(1-this.b+this.b*this.documents[e].termCount/this.averageDocumentTermCount);this.documents[e].score+=this.terms[a].idf*(this.documents[e].terms[a].count*(this.k1+1))/t}else{const t=Object.keys(this.documents[e].terms).filter((e=>-1!==e.indexOf(a))).length,s=Object.keys(this.documents[e].terms).map((e=>es.levenshteinDistance(e,a)/3)).filter((e=>e<1)).reduce(((e,t)=>e+(1-t)),0);this.documents[e].score+=.00125*t+.0025*s}}!isNaN(this.documents[e].score)&&this.documents[e].score>0&&s.push(this.documents[e])}return s.sort((function(e,t){return t.score-e.score})),s.map((e=>e.id))}}class ts{constructor(){this.notes={}}async initialize(){this.registerNoteSheets(),await this.createJournalDirectory(),await this.loadNotes()}registerNoteSheets(){Journal.registerSheet(t,NoteSheet,{types:["base"],makeDefault:!1,label:"Simple Calendar: Note Sheet"})}async createJournalDirectory(){const e=game.journal?.directory;e&&(this.noteDirectory=e.folders.find((e=>e.getFlag(t,"root"))),!this.noteDirectory&&z.IsGm()&&(await Folder.create({name:"_simple_calendar_notes_directory",type:"JournalEntry",parent:null,flags:{[t]:{root:!0}}}),this.noteDirectory=e.folders.find((e=>e.getFlag(t,"root")))))}async addNewNote(e,t){const s=e.getDateTime(),a={calendarId:e.id,startDate:s,endDate:s,allDay:!0,repeats:l.Never,order:0,categories:[],remindUsers:[]};await this.createNote(t,"",a,e)}async createNote(e,s,a,n,i=!0,o=!0){const r={};game.users?.forEach((e=>r[e.id]=game.user?.id===e.id?3:n.generalSettings.noteDefaultVisibility?2:0));const c=await JournalEntry.create({name:e,folder:this.noteDirectory?.id,flags:{core:{sheetClass:`${t}.${NoteSheet.name}`},[t]:{noteData:a}},ownership:r});if(c){if(await c.createEmbeddedDocuments("JournalEntryPage",[{text:{content:s},name:"Details"}]),i){new NoteSheet(c).render(!0,{},!0)}return o&&(W.updateApp(),await j.emit({type:u.mainAppUpdate,data:{}})),c}return null}journalEntryUpdate(e,s){const a=s.getFlag(t,"noteData");a&&(0===e?this.addNoteStub(s,a.calendarId):2===e?this.removeNoteStub(s):1==e&&W.updateApp())}addNoteStub(e,t){this.notes.hasOwnProperty(t)||(this.notes[t]=[]),this.notes[t].push(new Qt(e.id||""))}removeNoteStub(e){const s=e.getFlag(t,"noteData");if(s&&this.notes.hasOwnProperty(s.calendarId)){const t=this.notes[s.calendarId].findIndex((t=>t.entryId===e.id));t>=0&&this.notes[s.calendarId].splice(t,1)}}async loadNotes(){if(this.noteDirectory){this.notes={},await this.loadNotesFromFolder(this.noteDirectory);const e=game.journal?.directory;if(e)for(let t=0;t<e.folders.length;t++){const s=e.folders[t];s.folder&&s.folder.id===this.noteDirectory.id&&await this.loadNotesFromFolder(s)}}}async loadNotesFromFolder(e){for(let s=0;s<e.contents.length;s++){const a=e.contents[s];0===a.pages.contents.length&&await a.createEmbeddedDocuments("JournalEntryPage",[{text:{content:""},name:"Details"}]);const n=a.getFlag(t,"noteData");n&&this.addNoteStub(a,n.calendarId)}}showNote(e){const t=game.journal?.get(e);t&&t.sheet&&(t.sheet.rendered?t.sheet.bringToTop():t.sheet.render(!0))}getNoteStub(e){const s=e.getFlag(t,"noteData");if(s&&this.notes.hasOwnProperty(s.calendarId))return this.notes[s.calendarId].find((t=>t.entryId===e.id))}getNotes(e){return(this.notes[e]||[]).filter((e=>e.canUserView()))}getNotesForDay(e,t,s,a){const n=(this.notes[e]||[]).filter((n=>n.isVisible(e,t,s,a)));return n.sort(ts.dayNoteSort),n}getNoteCountsForDay(e,t,s,a){const n=G.getNotesForDay(e,t,s,a),i={count:0,reminderCount:0};for(let e=0;e<n.length;e++)n[e].userReminderRegistered?i.reminderCount++:i.count++;return i}async orderNotesOnDay(e,t,s){const a=this.getNotesForDay(e,s.year,s.month,s.day);for(let e=0;e<t.length;e++){const s=a.find((s=>s.entryId===t[e]));s&&await s.setOrder(e)}await j.emit({type:u.mainAppUpdate,data:{}})}static dayNoteSort(e,t){const s=e.noteData,a=t.noteData;return s&&a?s.order-a.order||s.startDate.hour-a.startDate.hour||s.startDate.minute-a.startDate.minute:0}noteTriggered(e,t){let s=!1;const a=e.noteData,n=t.getCurrentDate();if(a&&e.isVisible(t.id,n.year,n.month,n.day))if(a.allDay)s=!0;else{const e=se(t,{year:n.year,month:n.month,day:n.day,hour:0,minute:0,seconds:0},a.startDate,a.endDate);if(e===d.Start){const e=a.startDate.hour*t.time.minutesInHour*t.time.secondsInMinute+a.startDate.minute*t.time.secondsInMinute+a.startDate.seconds;s=n.seconds>=e}else if(e===d.Middle)s=!0;else if(e===d.End){const e=a.endDate.hour*t.time.minutesInHour*t.time.secondsInMinute+a.endDate.minute*t.time.secondsInMinute+a.endDate.seconds;s=n.seconds<=e}else if(e===d.Exact){const e=a.startDate.hour*t.time.minutesInHour*t.time.secondsInMinute+a.startDate.minute*t.time.secondsInMinute+a.startDate.seconds,i=a.endDate.hour*t.time.minutesInHour*t.time.secondsInMinute+a.endDate.minute*t.time.secondsInMinute+a.endDate.seconds;s=n.seconds>=e&&n.seconds<=i}}return s}checkNoteTriggers(e,t=!1){const s=R.getCalendar(e);if(s&&this.notes[e]){const a=this.notes[e];for(let e=0;e<a.length;e++)this.noteTriggered(a[e],s)&&a[e].triggers.forEach((s=>s.fire(a[e],t)))}}searchNotes(e,t,s){const a=this.notes[e];let n=[];if(a){const e=[];for(let t=0;t<a.length;t++)if(a[t].canUserView()){const n=[];if(s.title&&n.push(a[t].title),s.details){const e=a[t].pages;for(let t=0;t<e.length;t++){let s=e[t].name||"";if("text"===e[t].type){let a=document.createElement("DIV");a.innerHTML=e[t].text.content,s+=` ${(a.textContent||a.innerText||"").replace(/\r?\n|\r/g," ")}`}n.push(s)}}s.date&&n.push(a[t].fullDisplayDate),s.author&&n.push(a[t].authorDisplay?.name||""),s.categories&&n.push(a[t].categories.map((e=>e.name)).join(", ")),e.push({id:a[t].entryId,content:n})}const i=new es(e).search(t);n=a.filter((e=>-1!==i.indexOf(e.entryId)))}return n}}var ss,as,ns;ss=new Zt,R=ss,as=new Ze,q=as,ns=new MainApp,W=ns,function(e){Y=e}(new Be),function(e){$=e}(new Kt),function(e){G=e}(new ts),document.body.addEventListener("click",Ze.HideContextMenus),window.SimpleCalendar={api:e,Hooks:b},16!==re&&document.body.classList.add(`sc-scale-${re}`),Hooks.on("init",(async()=>{Gt.Register(),class{static Register(){game.settings.register(t,`${game.world.id}.${n.Theme}`,{name:"FSC.Configuration.Theme.Title",hint:"FSC.Configuration.Theme.Description",scope:"client",config:!0,type:String,choices:he(),default:"",onChange:Ze.ThemeChange.bind(Ze)}),game.settings.register(t,n.Theme,{name:"FSC.Configuration.Theme.Title",hint:"FSC.Configuration.Theme.Description",scope:"client",config:!1,type:String,default:"dark"}),game.settings.register(t,n.OpenOnLoad,{name:"FSC.Configuration.Client.OpenOnLoad.Title",hint:"FSC.Configuration.Client.OpenOnLoad.Description",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(t,n.OpenCompact,{name:"FSC.Configuration.Client.OpenCompact.Title",hint:"FSC.Configuration.Client.OpenCompact.Description",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(t,n.RememberPosition,{name:"FSC.Configuration.Client.RememberPosition.Title",hint:"FSC.Configuration.Client.RememberPosition.Description",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(t,n.RememberCompactPosition,{name:"FSC.Configuration.Client.RememberCompactPosition.Title",hint:"FSC.Configuration.Client.RememberCompactPosition.Description",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(t,n.AppPosition,{name:"Application Position",hint:"",scope:"client",config:!1,type:Object,default:{}}),game.settings.register(t,n.AppCompactPosition,{name:"Application Compact Position",hint:"",scope:"client",config:!1,type:Object,default:{}}),game.settings.register(t,n.NoteReminderNotification,{name:"FSC.Configuration.Client.NoteReminderNotification.Title",hint:"FSC.Configuration.Client.NoteReminderNotification.Description",scope:"client",config:!0,type:String,choices:{whisper:z.Localize("FSC.Configuration.Client.NoteReminderNotification.Whisper"),render:z.Localize("FSC.Configuration.Client.NoteReminderNotification.Render")},default:"whisper"}),game.settings.register(t,n.NoteListOpenDirection,{name:"FSC.Configuration.Client.NoteListOpenDirection.Title",hint:"FSC.Configuration.Client.NoteListOpenDirection.Description",scope:"client",config:!0,type:String,choices:{"sc-right":z.Localize("FSC.Right"),"sc-left":z.Localize("FSC.Left"),"sc-down":z.Localize("FSC.Down")},default:"sc-right",onChange:Ze.SideDrawerDirectionChange.bind(Ze)}),game.settings.register(t,n.AlwaysShowNoteList,{name:"FSC.Configuration.Client.AlwaysShowNoteList.Title",hint:"FSC.Configuration.Client.AlwaysShowNoteList.Description",scope:"client",config:!0,type:Boolean,default:!1,onChange:Ze.AlwaysShowNoteListChange.bind(Ze)}),game.settings.register(t,n.PersistentOpen,{name:"FSC.Configuration.Client.PersistentOpen.Title",hint:"FSC.Configuration.Client.PersistentOpen.Description",scope:"client",config:!0,type:Boolean,default:!1,onChange:q.PersistenceChange.bind(q)}),game.settings.register(t,n.CompactViewScale,{name:"FSC.Configuration.Client.CompactViewScale.Title",hint:"FSC.Configuration.Client.CompactViewScale.Description",scope:"client",config:!0,type:Number,range:{min:70,max:200,step:10},default:100,onChange:q.CompactScaleChange.bind(q)}),game.settings.registerMenu(t,n.CalendarMainApp,{name:"",label:"FSC.Title",hint:"",icon:"fa fa-calendar",type:MainApp}),game.settings.registerMenu(t,n.CalendarConfigurationMenu,{name:"",label:"FSC.Configuration.Title",hint:"",icon:"fa fa-cog",type:Be}),game.settings.register(t,n.CalendarConfiguration,{name:"Calendar Configuration",scope:"world",config:!1,type:Array,default:[],onChange:R.loadCalendars.bind(R)}),game.settings.register(t,n.ActiveCalendar,{name:"Active Calendar",scope:"world",config:!1,type:String,default:"default",onChange:R.loadActiveCalendar.bind(R)}),game.settings.register(t,n.GlobalConfiguration,{name:"Global Configuration",scope:"world",config:!1,type:Object,default:{},onChange:q.load.bind(q)}),game.settings.register(t,n.GeneralConfiguration,{name:"General Configuration",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.YearConfiguration,{name:"Year Configuration",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.WeekdayConfiguration,{name:"Weekday Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.MonthConfiguration,{name:"Month Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.CurrentDate,{name:"Current Date",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.LeapYearRule,{name:"Leap Year Rule",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.DefaultNoteVisibility,{name:"FSC.Configuration.DefaultNoteVisibility",hint:"FSC.Configuration.DefaultNoteVisibilityHint",scope:"world",type:Boolean,default:!1}),game.settings.register(t,n.Notes,{name:"Notes",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.TimeConfiguration,{name:"Time",scope:"world",config:!1,type:Object,default:{}}),game.settings.register(t,n.SeasonConfiguration,{name:"Season Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.MoonConfiguration,{name:"Moon Configuration",scope:"world",config:!1,type:Array,default:[]}),game.settings.register(t,n.NoteCategories,{name:"Note Categories",scope:"world",config:!1,type:Array,default:[{name:"Holiday",color:"#148e94",textColor:"#FFFFFF"}]})}}.Register(),await R.initialize(),q.load(),W.initialize()})),Hooks.on("ready",(async()=>{Z.isPF2E&&Z.updatePF2EVariables(!0),$.initialize(),$.showMigration?(await $.run(),await G.initialize(),q.initialize()):(await G.initialize(),q.initialize(),q.clientSettings.openOnLoad&&W.render()),Ie.emit(b.Ready,R.getActiveCalendar())})),Hooks.on("canvasInit",q.canvasInit.bind(q)),Hooks.on("getSceneControlButtons",q.getSceneControlButtons.bind(q)),Hooks.on("renderJournalDirectory",q.renderJournalDirectory.bind(q)),Hooks.on("renderJournalSheet",q.renderJournalSheet.bind(q)),Hooks.on("updateWorldTime",q.worldTimeUpdate.bind(q)),Hooks.on("createCombatant",q.createCombatant.bind(q)),Hooks.on("updateCombat",q.combatUpdate.bind(q)),Hooks.on("deleteCombat",q.combatDelete.bind(q)),Hooks.on("pauseGame",q.gamePaused.bind(q)),Hooks.on("renderMainApp",MainApp.setWidthHeight),Hooks.on("renderNoteSheet",NoteSheet.SetHeight),Hooks.on("createJournalEntry",G.journalEntryUpdate.bind(G,0)),Hooks.on("updateJournalEntry",G.journalEntryUpdate.bind(G,1)),Hooks.on("deleteJournalEntry",G.journalEntryUpdate.bind(G,2)),Hooks.on("renderSceneConfig",q.renderSceneConfig.bind(q)),Hooks.on("closeWorldClockSettings",Z.updatePF2EVariables.bind(Z)),O.debugMode=!1})()})();