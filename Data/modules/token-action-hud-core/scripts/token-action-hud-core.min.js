const t={ID:"token-action-hud-core",NAME:"Token Action HUD"},e="|",i={UTILITY:"utility"},n=["JournalEntry","Macro","RollTable","Playlist"],s=["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"],o={CATEGORY:"category",SUBCATEGORY:"subcategory",ACTION:"action"},a={COMPENDIUM:"compendium",CUSTOM:"custom",SYSTEM:"system",SYSTEM_DERIVED:"system-derived"};class Logger{static info(t,e=!1){e?ui.notifications.info(`Token Action HUD | ${t}`):console.log(`Token Action HUD Info | ${t}`)}static error(t,e=!1){e?ui.notifications.error(`Token Action HUD | ${t}`):console.error(`Token Action HUD Error | ${t}`)}static debug(t,e){if(game.tokenActionHud?game.tokenActionHud.isDebug:Utils.getSetting("debug")){if(!e)return void console.log(`Token Action HUD Debug | ${t}`);const i=Utils.deepClone(e);console.log(`Token Action HUD Debug | ${t}`,i)}}}class Timer{contructor(t){this.milliseconds=t,this.timer=null}async start(){return this.timer&&this.abort(),new Promise((t=>{this.timer=setTimeout(t,this.milliseconds)}))}async abort(){clearTimeout(this.timer),this.timer=null}}class Utils{static checkAllow(t){return t>=this.getSetting("allow")}static deepClone(t,e){return deepClone(t,e)}static getActor(t,e){let i=null;return e&&(i=canvas.tokens.placeables.find((t=>t.id===e))),i?i.actor:game.actors.get(t)}static getImage(t,e=[]){e.push("icons/svg/mystery-man.svg");let i="";return game.tokenActionHud.isDisplayIcons&&(i=t?.img??t?.icon??""),e.includes(i)?"":i}static getItem(t,e){return t.items.get(e)}static getToken(t){return canvas.tokens.placeables.find((e=>e.id===t))}static getControlledTokens(){return game.canvas.tokens.controlled}static getFirstControlledToken(){return game.canvas.tokens.controlled[0]}static getSetting(e,i=null){let n=i??null;try{n=game.settings.get(t.ID,e)}catch{Logger.debug(`Setting '${e}' not found`)}return n}static async setSetting(e,i){game.settings.settings.get(`${t.ID}.${e}`)?(await game.settings.set(t.ID,e,i),Logger.debug(`Setting '${e}' set to '${i}'`)):Logger.debug(`Setting '${e}' not found`)}static getUserFlag(e){return game.user.getFlag(t.ID,e)}static async setUserFlag(e,i){await game.user.setFlag(t.ID,e,i)}static async unsetUserFlag(e){await game.user.unsetFlag(t.ID,e)}static i18n(t){return game.i18n.localize(t)}static isModuleActive(t){const e=game.modules.get(t);return e&&e.active}static getModuleTitle(t){return game.modules.get(t)?.title??""}static switchCSS(e){const i=[{setting:"compact",file:"tah-compact"},{setting:"foundryVTT",file:"tah-foundry-vtt"},{setting:"dorakoUI",file:"tah-dorako"},{setting:"pathfinder",file:"tah-pathfinder"}];for(const n of i){const i=[`modules/${t.ID}/`,`styles/${n.file}`];n.setting===e?Object.values(document.styleSheets).find((t=>t.href?.includes(i[0])&&t.href?.includes(i[1]))).disabled=!1:Object.values(document.styleSheets).find((t=>t.href?.includes(i[0])&&t.href?.includes(i[1]))).disabled=!0}}static registerHandlebars(){Handlebars.registerHelper("cap",(function(t){return!t||t.length<1?"":t[0].toUpperCase()+t.slice(1)}));const reduceOp=function(t,e){(t=Array.from(t)).pop();const i=t.shift();return t.reduce(e,i)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((t,e)=>t===e))},ne:function(){return reduceOp(arguments,((t,e)=>t!==e))},lt:function(){return reduceOp(arguments,((t,e)=>t<e))},gt:function(){return reduceOp(arguments,((t,e)=>t>e))},lte:function(){return reduceOp(arguments,((t,e)=>t<=e))},gte:function(){return reduceOp(arguments,((t,e)=>t>=e))},and:function(){return reduceOp(arguments,((t,e)=>t&&e))},or:function(){return reduceOp(arguments,((t,e)=>t||e))},tf:function(){return reduceOp(arguments,(t=>t))}}),Handlebars.registerHelper("activeText",(function(t){return Utils.getSetting("activeCssAsText")?t.fn(this):t.inverse(this)}))}static getModuleVersionParts(t){if(!t)return void Logger.debug("Module version not retrieved",{trigger:"getModuleVersionParts"});const e=t.split(".");return{major:e[0],minor:e[1],patch:e[2]}}static async checkModuleCompatibility(e){const i=this.getModuleVersionParts(e),n=this.getModuleVersionParts(game.modules.get(t.ID).version);return!(n.major!==i.major||n.minor!==i.minor||i.patch&&n.patch!==i.patch)||(ui.notifications.error(`The installed Token Action Hud system module requires Token Action Hud core module version ${e}.`),!1)}static getSubcategories(t,e={}){if(!t)return;const i=e?.id,n=e?.type;t=Array.isArray(t)?t:Object.values(t);let s=[];for(const o of t)if(i&&o.id!==i||n&&o.type!==n||s.push(o),o.subcategories.length>0){const t=this.getSubcategories(o.subcategories,e);t&&(s=s.concat(t.filter((t=>void 0!==t))))}return s.length>0?s:null}static async getSubcategoryByNestId(t,e={}){const i="string"==typeof e?e:e?.nestId,n=e?.type??"system";if(!i)return;const s=i.split("_");return await async function findSubcategory(t,e){t=Array.isArray(t)?t:Object.values(t);for(const i of t)if(i.id===e[0]){if(1===e.length)return i.type&&i.type!==n?void 0:i;if(0===i.subcategories.length)return;e.shift();const t=await findSubcategory(i.subcategories,e);if(t)return t}}(t,s)}}class MigrationManager{constructor(t){this.systemModuleId=t}async init(){await this._migrateUserFlags()}async _migrateUserFlags(){if("token-action-hud-dnd5e"===!this.systemModuleId)return;const t=Utils.getUserFlag("categories");if(t&&!Array.isArray(t))try{const e=`../../${this.systemModuleId}/scripts/defaults.js`,i=await import(e).then((t=>t.DEFAULTS.subcategories)),n=new Map;i.forEach((t=>{n.set(t.id,t)}));const s=await Utils.deepClone(t);function convertCategories(t){const e=[];for(const i in t){const n={...t[i],nestId:i};n.name=n.title.startsWith("DND5E")?Utils.i18n(n.title.replace("DND5E.Item","ITEM.")):n.title,convertSubcategories(n),e.push(n)}return e;function convertSubcategories(t){if(!t.subcategories)return;if(Array.isArray(t.subcategories))return;const e=[];for(const i in t.subcategories){let s=t.subcategories[i];if(n.has(s.id)?s=n.get(s.id):s.name=s.title,s.nestId=i,convertSubcategories(s),"spells"===s.id){const t=s.nestId.substring(0,s.nestId.lastIndexOf("spells")),i=[{...n.get("at-will-spells"),nestId:`${t}at-will-spells`},{...n.get("innate-spells"),nestId:`${t}innate-spells`},{...n.get("pact-spells"),nestId:`${t}pact-spells`},{...n.get("cantrips"),nestId:`${t}cantrips`},{...n.get("1st-level-spells"),nestId:`${t}1st-level-spells`},{...n.get("2nd-level-spells"),nestId:`${t}2nd-level-spells`},{...n.get("3rd-level-spells"),nestId:`${t}3rd-level-spells`},{...n.get("4th-level-spells"),nestId:`${t}4th-level-spells`},{...n.get("5th-level-spells"),nestId:`${t}5th-level-spells`},{...n.get("6th-level-spells"),nestId:`${t}6th-level-spells`},{...n.get("7th-level-spells"),nestId:`${t}7th-level-spells`},{...n.get("8th-level-spells"),nestId:`${t}8th-level-spells`},{...n.get("9th-level-spells"),nestId:`${t}9th-level-spells`}];e.push(...i)}else if("features"===s.id){const t=s.nestId.substring(0,s.nestId.lastIndexOf("features")),i=[{...n.get("active-features"),nestId:`${t}active-features`},{...n.get("passive-features"),nestId:`${t}passive-features`}];e.push(...i)}else e.push(s)}t.subcategories=e}}Logger.info("Migrating user configuration...",!0);const o=convertCategories(s);await Utils.setUserFlag("categories",o),Logger.info("Successfully migrated user configuration",!0)}catch{await Utils.unsetUserFlag("categories"),Logger.error("Failed to migrate user configuration, reverting to default configuration",!0)}}}class TagDialog extends FormApplication{tagify=null;dragSort=null;constructor(t){super(t,{title:t.title}),this.content=t.content,this.submit=t.submit,this.categoryId=null,this.subcategoryId=null}static get defaultOptions(){const e=super.defaultOptions,i={closeOnSubmit:!0,id:"token-action-hud-dialog",template:`modules/${t.ID}/templates/tagdialog.hbs`,width:500};return foundry.utils.mergeObject(e,i)}getData(t){return this.content}activateListeners(t){super.activateListeners(t);t.find("#tah-dialog-cancel").on("click",this.close.bind(this))}static showDialog(t,e,i,n){this.nestId=t,TagDialog._prepareHook(e);new TagDialog({title:i.title,content:i.content,submit:n}).render(!0)}static _prepareHook(t){Hooks.once("renderTagDialog",((e,i,n)=>{i.css("height","auto");const s=i.find('select[id="token-action-hud-index"]');s.length>0&&(s.css("background","#fff"),s.css("color","#000"));const o=i.find('input[class="token-action-hud-taginput"]');if(o.length>0){const a={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:50,classname:"tags-look",enabled:0,closeOnSelect:!1}};function onDragEnd(t){TagDialog.tagify.updateValueByDOMTags()}t.available&&(a.whitelist=t.available),TagDialog.tagify=new Tagify(o[0],a),TagDialog.dragSort=new DragSort(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}});const r=$(document).find(".tagify");r.css("background","#fff"),r.css("color","#000"),t.selected&&TagDialog.tagify.addTags(t.selected);i.find("#tah-dialog-clear-tags").on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify))}}))}_onKeyDown(t){if("Escape"===t.key&&!t.target.className.includes("tagify"))return t.preventDefault(),t.stopPropagation(),this.close();if("Enter"===t.key&&this.data.default&&!t.target.className.includes("tagify")){t.preventDefault(),t.stopPropagation();const e=this.data.buttons[this.data.default];return this.submit(e)}}async _updateObject(t,e){const i=TagDialog.tagify.value.map((t=>(t.id=t.id??t.value.slugify({replacement:"-",strict:!0}),{id:t.id,name:t.value,type:t.type,level:t.level,hasDerivedSubcategories:t.hasDerivedSubcategories})));await this.submit(i,e)}}class TagDialogHelper{static async showCategoryDialog(t){const e={available:[]};e.selected=await t.getSelectedCategoriesAsTagifyEntries();const i={title:Utils.i18n("tokenActionHud.tagDialog.categoryDialogTitle"),content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.categoryDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.pushLabelExplanation")}};TagDialog.showDialog(null,e,i,(async(e,i)=>{await t.saveCategories(e),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showSubcategoryDialog(t,e){const{nestId:i,name:n}=e,s={};s.available=await t.getAvailableSubcategoriesAsTagifyEntries(e),s.selected=await t.getSelectedSubcategoriesAsTagifyEntries(e);const o={title:Utils.i18n("tokenActionHud.tagDialog.subcategoryDialogTitle")+` (${n})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.subcategoryDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),advancedCategoryOptions:await t.getAdvancedCategoryOptions(e),level:"category"}};TagDialog.showDialog(i,s,o,(async(i,n)=>{i=i.map((t=>(t.id=t.id??t.name.slugify({replacement:"-",strict:!0}),t.type=t.type??"custom",t.hasDerivedSubcategories=t.hasDerivedSubcategories??"false",{id:t.id,name:t.name,type:t.type,hasDerivedSubcategories:t.hasDerivedSubcategories})));const s=n?.characterCount,o=n?.customWidth,a=n?.grid,r=n?.image,c=n?.showTitle;e.advancedCategoryOptions={characterCount:s,customWidth:o,grid:a,image:r,showTitle:c},await t.saveSubcategories(i,e),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showActionDialog(t,e,i){const{nestId:n,name:s}=i,o={},a=await e.getAvailableActionsAsTagifyEntries(i),r=await t.getAvailableSubcategoriesAsTagifyEntries(i);o.available=[...a,...r];const c=await e.getSelectedActionsAsTagifyEntries(i),l=await t.getSelectedSubcategoriesAsTagifyEntries(i);o.selected=[...c,...l];const d={title:`${Utils.i18n("tokenActionHud.tagDialog.actionDialogTitle")} (${s})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.actionDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.blockListLabel"),advancedCategoryOptions:await t.getAdvancedCategoryOptions(i),level:"subcategory"}};TagDialog.showDialog(n,o,d,(async(n,s)=>{const o=[],a=[];for(const t of n)switch(t.level){case"subcategory":o.push(t);break;case"action":a.push(t)}const r=s?.characterCount,c=s?.image,l=s?.showTitle;i.advancedCategoryOptions={characterCount:r,image:c,showTitle:l},await t.saveSubcategories(o,i),await e.saveActions(a,i),Hooks.callAll("forceUpdateTokenActionHud")}))}}class CategoryResizer{category=null;actionGroups=null;content=null;contentPadding=null;contentRect=null;direction=null;spacing=10;availableHeight=null;availableWidth=null;isCustomWidth=!1;advancedCategoryOptions=null;async resizeCategory(t,e,i,n){if(!e)return;if(this.category=e,this.actionGroups=e.querySelectorAll(".tah-actions"),0===this.actionGroups.length)return;this.direction=i;const s=this.category.id.replace("tah-category-","");this.advancedCategoryOptions=await t.getAdvancedCategoryOptions(s),await this.getContent(),this.availableHeight=await this.getAvailableHeight(),this.availableWidth=await this.getAvailableWidth(),(n=n||this.advancedCategoryOptions?.grid)?this.resizeGrid():this.resizeContent()}async resizeGrid(){const t=parseInt(getComputedStyle(this.actionGroups[0]).gap??5);await this.resetCSS(this.actionGroups,{display:"",gridTemplateColumns:"",width:""});let e=0,i=0;for(const t of this.actionGroups){const n=t.querySelectorAll(".tah-action:not(.shrink)");e+=n.length;for(const t of n){const e=t.getBoundingClientRect();i+=Math.round(parseFloat(e.width)+1||0)}}const n=Math.ceil(i/e);let s=0;for(const e of this.actionGroups){const i=e.querySelectorAll(".tah-action"),o=Math.ceil(Math.sqrt(i.length)),a=Math.floor(this.availableWidth/n),r=o>a?a:o,c=r*n+(r-1)*t+this.contentPadding;s=c>s?c:s;const l={display:"grid",gridTemplateColumns:`repeat(${r}, ${n}px)`,width:`${c}px`};await this.assignCSS(e,l)}const o={maxHeight:`${this.availableHeight}px`,width:`${s+40}px`};await this.assignCSS(this.content,o)}async resizeContent(){let t=500;if(this.isCustomWidth)t=this.availableWidth;else{let e=0,i=0;for(const t of this.actionGroups){const n=t.querySelectorAll(".tah-action");if(n.length>0){let t=0;n.forEach(((e,i)=>{const n=e.getBoundingClientRect(),s=0===i?n.left-this.contentRect.left:0,o=Math.ceil(parseFloat(n.width)+1||0);t+=o+s})),t>i&&(i=t,e=n.length)}}i+=5*e-5,i+=this.contentPadding;const n=i/e,s=5;let o=e<s?e:s;const a=Math.floor(this.availableWidth/n),r=Math.ceil(Math.sqrt(e));r>o&&r<=a&&(o=r),t=n*o,t>this.availableWidth&&(t=this.availableWidth),t<200&&(t=200)}const e={maxHeight:`${this.availableHeight}px`,width:`${t}px`};await this.assignCSS(this.content,e)}async getAvailableWidth(){const t=this.advancedCategoryOptions?.customWidth;if(t)return this.isCustomWidth=!0,t;const e=canvas.screenDimensions[0],i=this.contentRect.left,n=document.querySelector("#ui-right").clientWidth;return Math.floor((n>0?e-n:e)-this.spacing-i)}async getAvailableHeight(){const t=canvas.screenDimensions[1],e=this.contentRect.height,i=this.contentRect.top,n=("down"===this.direction?document.querySelector("#ui-bottom"):document.querySelector("#ui-top")).offsetHeight,s="down"===this.direction?t-i-n-this.spacing:e+i-n-this.spacing;return Math.floor(s<100?100:s)}async getContent(){this.content=this.category.querySelector(".tah-subcategories"),this.contentRect=this.content.getBoundingClientRect(),this.contentComputed=getComputedStyle(this.content),this.contentPadding=Math.ceil(parseFloat(this.contentComputed.paddingLeft)||0)+Math.ceil(parseFloat(this.contentComputed.paddingRight)||0)}async assignCSS(t,e){requestAnimationFrame((()=>{Object.assign(t.style,e)}))}async resetCSS(t,e){for(const i of t)Object.assign(i.style,e)}}class TokenActionHud extends Application{hoveredCategoryId="";defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;topPos=this.defaultTopPos;defaultScale=1;refreshTimeout=null;rendering=!1;tokens=null;isUpdatePending=!1;isUpdating=!1;updateTimer=new Timer(20);constructor(t){super(),this.systemManager=t,this.direction="down",this.isAlwaysShow=!1,this.isClickOpen=!1,this.isCollapsed=!1,this.isDisplayIcons=!1,this.isDraggable=!1,this.isEnabled=!1,this.isGrid=!1,this.isUnlocked=!1}async init(){this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isCollapsed=Utils.getUserFlag("isCollapsed"),this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.isDraggable=Utils.getSetting("drag"),this.isEnabled=this.isHudEnabled(),this.isGrid=Utils.getSetting("grid"),this.isUnlocked=Utils.getUserFlag("isUnlocked"),await this.systemManager.registerDefaultFlags(),this.categoryManager=await this.systemManager.getCategoryManager(),this.categoryResizer=new CategoryResizer,this.actionHandler=await this.systemManager.getActionHandler(this.categoryManager),this.rollHandler=this.systemManager.getRollHandler()}updateSettings(){Logger.debug("Updating settings..."),this.updateRollHandler(),this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.isDraggable=Utils.getSetting("drag"),this.isEnabled=this.isHudEnabled(),this.isGrid=Utils.getSetting("grid"),this.actionHandler.displayIcons=Utils.getSetting("displayIcons"),Logger.debug("Settings updated");this.update({trigger:{type:"method",name:"TokenActionHud#updateSettings"}})}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(t){this.tokens=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`/modules/${t.ID}/templates/template.hbs`,id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const t=parseFloat(Utils.getSetting("scale"));return t<.5?.5:t>2?2:t}getData(t={}){const e=super.getData();return e.actions=this.actionList,e.id="token-action-hud",e.scale=this.getScale(),e.background=Utils.getSetting("background")??"#00000000",Logger.debug("Application data",{data:e}),e}activateListeners(t){const e={actions:t.find(".tah-action"),buttons:t.find("#tah-buttons"),categories:t.find(".tah-category"),categoriesSection:t.find("#tah-categories"),editCategoriesButton:t.find("#tah-edit-categories"),subcategories:t.find(".tah-subcategory"),subtitles:t.find(".tah-subtitle"),titleButtons:t.find(".tah-category-button"),collapseHudButton:t.find("#tah-collapse-hud"),expandHudButton:t.find("#tah-expand-hud"),unlockButton:t.find("#tah-unlock"),lockButton:t.find("#tah-lock")};this._bindCategoryEvents(e),this._bindActionEvents(e),this._bindEditCategoriesButton(e),this._bindLockUnlockButtons(e),this._bindCollapseExpandButtons(e)}_bindCategoryEvents(t){const closeCategory=t=>{if(game.tokenActionHud.rendering)return;const e=this.isClickOpen?t.currentTarget.parentElement:t.currentTarget;e.classList.remove("hover");const i=e.id;this.clearHoveredCategory(i)},openCategory=async t=>{const e=this.isClickOpen?t.currentTarget.parentElement:t.currentTarget;e.classList.add("hover"),this.categoryResizer.resizeCategory(this.categoryManager,e,this.direction,this.isGrid);const i=e.id;this.setHoveredCategory(i)},toggleCategory=e=>{if(e.currentTarget.parentElement.classList.contains("hover"))closeCategory(e);else{for(const e of t.categories)e.classList.remove("hover");openCategory(e)}e.currentTarget.blur()};if(""!==this.hoveredCategoryId){const t=`#${this.hoveredCategoryId}`,e=document.querySelector(t);this.categoryResizer.resizeCategory(this.categoryManager,e,this.direction,this.isGrid)}t.titleButtons.on("click",(t=>{this.bringToTop(),t.currentTarget.blur()})),this.isClickOpen?t.titleButtons.on("click",toggleCategory):(t.categories.get().forEach((t=>{t.addEventListener("touchstart",toggleCategory,{passive:!0})})),t.categories.hover(openCategory,closeCategory)),t.titleButtons.on("mousedown",(t=>this.dragEvent(t))),t.titleButtons.get().forEach((t=>{t.addEventListener("touchstart",(t=>this.dragEvent(t)),{passive:!0})}));const openSubcategoryDialog=t=>{const e=t.currentTarget;if(0===e.value.length)return;const i=e.value,n=e?.dataset?.name??e.innerText??e.outerText,s=e?.dataset?.type;TagDialogHelper.showSubcategoryDialog(this.categoryManager,{nestId:i,name:n,type:s})};t.titleButtons.on("contextmenu",(t=>{this.isUnlocked&&openSubcategoryDialog(t)}))}_bindActionEvents(t){const handleAction=t=>{let e=t.target;"BUTTON"!==e.tagName&&(e=t.currentTarget.children[0]);const i=e.value;try{this.rollHandler.handleActionEvent(t,i),e.blur()}catch(e){Logger.error(t)}},openActionDialog=t=>{const{id:e,innerText:i,outerText:n,dataset:s}=t.target;if(!e)return;const o=e,a=i||n,r=s?.type,c=s?.hasDerivedSubcategories;TagDialogHelper.showActionDialog(this.categoryManager,this.actionHandler,{nestId:o,name:a,type:r,hasDerivedSubcategories:c})};t.subtitles.on("click contextmenu",(t=>{this.isUnlocked&&openActionDialog(t)})),t.actions.on("click contextmenu",(t=>{t.preventDefault(),handleAction(t)}))}_bindEditCategoriesButton(t){t.editCategoriesButton.on("click",(t=>{t.preventDefault(),t=t||window.event,TagDialogHelper.showCategoryDialog(this.categoryManager)}))}_bindLockUnlockButtons(t){const unlockHud=async(e=null)=>{e&&(e.preventDefault(),e=e||window.event);const i=e?.target||t.unlockButton;$(i).addClass("tah-hidden"),t.lockButton.removeClass("tah-hidden"),t.editCategoriesButton.removeClass("tah-hidden"),t.categoriesSection.addClass("tah-unlocked"),t.categories.removeClass("tah-hidden"),t.subcategories.removeClass("tah-hidden"),t.subtitles.removeClass("disable-edit"),t.subtitles.removeClass("tah-hidden"),t.titleButtons.removeClass("disable-edit"),this.isUnlocked||(await Utils.setUserFlag("isUnlocked",!0),this.isUnlocked=!0)},lockHud=async(e=null)=>{e&&(e.preventDefault(),e=e||window.event);const i=e?.target||t.lockButton;$(i).addClass("tah-hidden"),t.unlockButton.removeClass("tah-hidden"),t.editCategoriesButton.addClass("tah-hidden"),t.categoriesSection.removeClass("tah-unlocked");for(const e of t.categories){e.getElementsByClassName("tah-action").length>0||e.classList.add("tah-hidden")}for(const e of t.subcategories){e.getElementsByClassName("tah-action").length>0||e.classList.add("tah-hidden")}for(const e of t.subtitles)"false"===e.parentElement.dataset.showTitle&&e.classList.add("tah-hidden");t.titleButtons.addClass("disable-edit"),t.subtitles.addClass("disable-edit"),this.isUnlocked&&(await Utils.setUserFlag("isUnlocked",!1),this.isUnlocked=!1)};this.isUnlocked?unlockHud():lockHud(),t.unlockButton.on("click",(t=>unlockHud(t))),t.lockButton.on("click",(t=>lockHud(t)))}_bindCollapseExpandButtons(t){const collapseHud=(e=null)=>{e&&(e.preventDefault(),e=e||window.event);const i=e?.target||t.collapseHudButton;$(i).addClass("tah-hidden"),t.expandHudButton.removeClass("tah-hidden"),t.categoriesSection.addClass("tah-hidden"),t.buttons.addClass("tah-hidden"),this.isCollapsed||(Utils.setUserFlag("isCollapsed",!0),this.isCollapsed=!0)},expandHud=e=>{e.preventDefault(),e=e||window.event,$(e.target).addClass("tah-hidden"),t.collapseHudButton.removeClass("tah-hidden"),t.categoriesSection.removeClass("tah-hidden"),t.buttons.removeClass("tah-hidden"),this.isCollapsed&&(Utils.setUserFlag("isCollapsed",!1),this.isCollapsed=!1)};this.isCollapsed&&collapseHud(),t.collapseHudButton.on("click",(t=>collapseHud(t))),t.expandHudButton.on("click",(t=>expandHud(t))),t.expandHudButton.on("mousedown",(t=>this.dragEvent(t))),t.expandHudButton.get(0).addEventListener("touchstart",(t=>this.dragEvent(t)),{passive:!0})}dragEvent(t){if(!this.isDraggable)return;const e=document.getElementById("token-action-hud"),i=t.clientX??t.changedTouches[0].clientX,n=t.clientY??t.changedTouches[0].clientY;let s=0,o=0,a=i,r=n;const c=e.offsetTop,l=e.offsetLeft;let d=c,g=l;const mouseMoveEvent=t=>{const i=t.clientX??t.changedTouches[0].clientX,n=t.clientY??t.changedTouches[0].clientY;s=a-i,o=r-n,a=i,r=n,s===a&&o===r||(d-=o,g-=s,requestAnimationFrame((()=>{Object.assign(e.style,{left:`${g}px`,position:"fixed",top:`${d}px`})})))},mouseUpEvent=()=>{document.onmousemove=null,e.ontouchmove=null,document.onmouseup=null,e.ontouchend=null,d===c&&g===l||(Utils.setUserFlag("position",{top:d,left:g}),Logger.debug(`Set position to x: ${d}px, y: ${g}px`))};document.onmousemove=mouseMoveEvent,e.ontouchmove=mouseMoveEvent,document.onmouseup=mouseUpEvent,e.ontouchend=mouseUpEvent}applySettings(){"up"===Utils.getSetting("direction")&&($(document).find(".tah-subcategories-wrapper").removeClass("expand-down"),$(document).find(".tah-subcategories-wrapper").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden"))}setPosition(){if(!this.actionList)return;const t=$(document).find("#tah-character-name");t.length>0&&t.css("top",-t[0].getBoundingClientRect().height),canvas?.tokens?.placeables.find((t=>t.id===this.actionList?.tokenId)),this.setPositionFromFlag(),this.restoreHoveredCategoryState(),this.rendering=!1}setPositionFromFlag(){const t=Utils.getUserFlag("position");if(!t)return;const e=this.defaultLeftPos,i=this.defaultTopPos;return new Promise((n=>{!function check(){const s=document.getElementById("token-action-hud");s?(s.style.bottom=null,s.style.top=t.top<5||t.top>window.innerHeight+5?i+"px":t.top+"px",s.style.left=t.left<5||t.left>window.innerWidth+5?e+"px":t.left+"px",s.style.position="fixed",n()):setTimeout(check,30)}()}))}setPositionFromToken(t){return new Promise((e=>{!function check(t){const i=$("#token-action-hud");i?(i.css("bottom",null),i.css("left",t.worldTransform.tx+(t.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),i.css("top",t.worldTransform.ty+0+"px"),i.css("position","fixed"),e()):setTimeout(check,30)}(t)}))}async resetPosition(){Logger.debug("Resetting position..."),await Utils.setUserFlag("position",{top:this.defaultTopPos,left:this.defaultLeftPos}),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}setHoveredCategory(t){this.hoveredCategoryId=t}clearHoveredCategory(t){this.hoveredCategoryId===t&&(this.hoveredCategoryId="")}restoreHoveredCategoryState(){if(""===this.hoveredCategoryId)return;const t=`#${this.hoveredCategoryId}`,e=$(t);if(e[0])if(this.isClickOpen){e.find(".tah-category-button")[0].click()}else e.mouseenter()}async copy(t,e){await this.categoryManager.copyUserFlags(t,e)?Logger.info("HUD copied",!0):Logger.info("Copy HUD failed",!0)}async reset(){await this.resetUserFlags(),this.resetPosition(),Logger.info("HUD reset",!0)}async resetActorFlags(){await this.categoryManager.resetActorFlags();this.update({trigger:{type:"method",name:"TokenActionHud.resetActorFlags"}})}async resetUserFlags(){await this.categoryManager.resetUserFlags(),this.categoryManager.resetCategoryManager(),this.actionHandler.resetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud.resetUserFlags"}})}update(t=null){this._updateHud(t)}async _updateHud(t){if(this.isUpdating)return;this.isUpdatePending&&await this.updateTimer.abort(),this.isUpdatePending=!0,await this.updateTimer.start(),this.isUpdatePending=!1,this.isUpdating=!0,Logger.debug("Updating hud...",t);const e=Utils.getControlledTokens(),i=this._getCharacter(e),n=e.length>1&&!i;return(i||n)&&this.isEnabled?(this.actionList=await this.actionHandler.buildActionList(i),0===this.actionList.length?(this.close(),this.hoveredCategoryId="",Logger.debug("Hud update aborted as action list empty"),void(this.isUpdating=!1)):(this.rendering=!0,this.render(!0),this.isUpdating=!1,void Logger.debug("Hud updated"))):(this.close(),this.hoveredCategoryId="",Logger.debug("Hud update aborted as no character(s) found or hud is disabled"),void(this.isUpdating=!1))}isValidTokenChange(t,e=null){return!e?.actorData?.flags&&(this.isAlwaysShow?this.isRelevantToken(t)||t.actorId===game.user.character?.id:this.isRelevantToken(t))}isRelevantToken(t){const e=Utils.getControlledTokens();return e?.some((e=>e.id===t.id))||0===e?.length&&canvas?.tokens?.placeables?.some((t=>t.id===this.actionList?.tokenId))}isValidActorOrItemUpdate(t,e){return e?.flags?(Logger.debug("Flags set, do not update hud",{actor:t,data:e}),!1):t?t?this.actionList&&t.id===this.actionList.actorId?(Logger.debug("Same actor, update hud",{actor:t,data:e}),!0):(Logger.debug("Different actor, do not update hud",{actor:t,data:e}),!1):(Logger.debug("No actor, update hud",{data:e}),!0):void 0}isHudEnabled(){const t=game.user.role,e=game.user.isGM;return!!Utils.getSetting("enable")&&(!!e||Utils.checkAllow(t))}isLinkedCompendium(t){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.categoryManager.isLinkedCompendium(t)}_getCharacter(t=[]){if(t.length>1)return null;const e={token:null,actor:null};if(1===t.length){const i=t[0],n=i.actor;if(!this._isValidCharacter(i))return null;e.token=i,e.actor=n}else 0===t.length&&game.user.character&&this.isAlwaysShow&&(e.actor=game.user.character,e.token=canvas.tokens.placeables.find((t=>t.actor?.id===e.actor.id)));return e.actor?(e.id=e.token?.id??e.actor.id,e.name=e.token?.name??e.actor.name,e):null}_isValidCharacter(t=""){const e=t.actor,i=game.user;return game.user.isGM||e?.testUserPermission(i,"OWNER")}}let r;Hooks.on("tokenActionHudSystemReady",(async e=>{if(!await Utils.checkModuleCompatibility(e.api.requiredCoreModuleVersion))return;r=new e.api.SystemManager(t.ID),r.registerSettings();const i=new MigrationManager(e.id);await i.init(),Utils.switchCSS(Utils.getSetting("style")),Utils.registerHandlebars(),loadTemplates([`modules/${t.ID}/templates/category.hbs`,`modules/${t.ID}/templates/subcategory.hbs`,`modules/${t.ID}/templates/action.hbs`,`modules/${t.ID}/templates/tagdialog.hbs`]),Hooks.callAll("tokenActionHudCoreReady")})),Hooks.on("canvasReady",(async()=>{Hooks.on("tokenActionHudCoreReady",(async()=>{if(game.user.isGM&&!game.modules.get("lib-themer")?.active&&!game.modules.get("color-picker")?.active&&!game.modules.get("colorsettings")?.active){!1===Utils.getSetting("startup")&&(ui.notifications.notify("Token Action Hud: To set colors within this module's settings, install and enable one of the following 'Color Picker', 'Color Settings' or 'libThemer' modules."),Utils.setSetting("startup",!0))}game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(r),await game.tokenActionHud.init()),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",(async(t,e)=>{const i={trigger:{type:"hook",name:"updateToken",data:[t,e]}};game.tokenActionHud.update(i)})),Hooks.on("updateToken",((t,e,i)=>{if(!Object.hasOwn(i,"y")&&!Object.hasOwn("diff","x")&&game.tokenActionHud.isValidTokenChange(t,e)){const n={trigger:{type:"hook",name:"updateToken",data:[t,e,i]}};game.tokenActionHud.update(n)}})),Hooks.on("deleteToken",((t,e,i,n)=>{if(game.tokenActionHud.isValidTokenChange(e)){const s={trigger:{type:"hook",name:"deleteToken",data:[t,e,i,n]}};game.tokenActionHud.update(s)}})),Hooks.on("updateActor",((t,e)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(t,e)){const i={trigger:{type:"hook",name:"updateActor",data:[t,e]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteActor",((t,e)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(t,e)){const i={trigger:{type:"hook",name:"deleteActor",data:[t,e]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={trigger:{type:"hook",name:"deleteItem",data:[t]}};game.tokenActionHud.update(e)}})),Hooks.on("createItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={trigger:{type:"hook",name:"createItem",data:[t]}};game.tokenActionHud.update(e)}})),Hooks.on("updateItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={trigger:{type:"hook",name:"updateItem",data:[t]}};game.tokenActionHud.update(e)}})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.applySettings()})),Hooks.on("renderCompendium",((t,e)=>{const i=t?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)){const i={trigger:{type:"hook",name:"renderCompendium",data:[t,e]}};game.tokenActionHud.update(i)}})),Hooks.on("deleteCompendium",((t,e)=>{const i=t?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${i?.package}.${i?.name}`)){const i={trigger:{type:"hook",name:"deleteCompendium",data:[t,e]}};game.tokenActionHud.update(i)}})),Hooks.on("createCombat",(t=>{const e={trigger:{type:"hook",name:"createCombat",data:[t]}};game.tokenActionHud.update(e)})),Hooks.on("deleteCombat",(t=>{const e={trigger:{type:"hook",name:"deleteCombat",data:[t]}};game.tokenActionHud.update(e)})),Hooks.on("updateCombat",(t=>{const e={trigger:{type:"hook",name:"updateCombat",data:[t]}};game.tokenActionHud.update(e)})),Hooks.on("updateCombatant",((t,e)=>{const i={trigger:{type:"hook",name:"updateCombatant",data:[t,e]}};game.tokenActionHud.update(i)})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"forceUpdateTokenActionHud"}})})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"createActiveEffect"}})})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHud.update({trigger:{type:"hook",name:"deleteActiveEffect"}})}));game.tokenActionHud.update({trigger:{type:"hook",name:"canvasReady"}})}))}));class CategoryManager{categories=[];constructor(){this.flattenedSubcategories=[],this.derivedSubcategories=new Map}async resetCategoryManager(){this.flattenedSubcategories=[],this.derivedSubcategories=new Map}async copyUserFlags(e,i){if(!e||!i.length)return!1;Logger.debug("Copying user flags...");const n=game.users.get(e).getFlag(t.ID,"categories");return"string"==typeof i?game.users.get(i).setFlag(t.ID,"categories",n):Array.isArray(i)&&i.forEach((e=>{game.users.get(e).setFlag(t.ID,"categories",n)})),Logger.debug("User flags copied"),!0}async resetActorFlags(){Logger.debug("Resetting actor flags...");const e=game.actors.filter((e=>e.getFlag(t.ID,"categories")));e&&e.forEach((e=>{Logger.debug(`Resetting flags for actor [${e.id}]`,{actor:e}),e.unsetFlag(t.ID,"categories")})),Logger.debug("Actor flags reset")}async resetUserFlags(){Logger.debug("Resetting user flags..."),await Utils.unsetUserFlag("categories"),this.resetCategoryManager(),await this._registerDefaultCategories(),Logger.debug("User flags reset")}async init(){const t=Utils.getUserFlag("categories");if(!t||!t.length)return this._registerDefaultCategories();Logger.debug("Retrieved saved categories",{savedCategories:t})}async _registerDefaultCategories(){const t=Utils.getUserFlag("default.categories");t&&(await Utils.setUserFlag("categories",t),Logger.debug("Registered default categories",{defaultCategories:t}))}createCategory(t){const e=Utils.deepClone(t);return e?.advancedCategoryOptions||(e.advancedCategoryOptions={}),void 0===e?.advancedCategoryOptions?.showTitle&&(e.advancedCategoryOptions.showTitle=!0),{id:e?.id,nestId:e?.nestId??this.id,name:e?.name,level:o.CATEGORY,advancedCategoryOptions:e?.advancedCategoryOptions??{},cssClass:"",subcategories:[]}}createSubcategory(t){const e=Utils.deepClone(t);return e?.advancedCategoryOptions||(e.advancedCategoryOptions={}),void 0===e?.advancedCategoryOptions?.showTitle&&(e.advancedCategoryOptions.showTitle=!0),e.subtitleClass=e?.advancedCategoryOptions?.showTitle?"":"tah-hidden",{id:e?.id,nestId:e?.nestId,name:e?.name,type:e?.type??a.CUSTOM,level:o.SUBCATEGORY,advancedCategoryOptions:e?.advancedCategoryOptions??{showTitle:!0},hasDerivedSubcategories:e?.hasDerivedSubcategories??!1,subtitleClass:e?.subtitleClass??"",isSelected:e?.isSelected??!0,info1:e?.info1??"",info2:e?.info2??"",info3:e?.info3??"",actions:[],subcategories:[]}}flattenSubcategories(t){this.flattenedSubcategories=Utils.getSubcategories(t.categories)}getFlattenedSubcategories(t={}){const e=t.id,i=t.nestId,n=t.type,s=t.level;return this.flattenedSubcategories?this.flattenedSubcategories.filter((t=>(!e||t.id===e)&&(!i||t?.nestId?.startsWith(i))&&(!n||t.type===n)&&(!s||t.level===s))):[]}addToFlattenedSubcategories(t){this.getFlattenedSubcategories(t).length>0||this.flattenedSubcategories.push(t)}async saveCategories(t){if(!t)return;const e=game.tokenActionHud.actionHandler.actionList.categories,i=[];for(const n of t){const t=n.id,s=e.find((e=>e.nestId===t));if(s){const t=Utils.deepClone(s);i.push({...t,name:n.name})}else{const t=this.createCategory(n);i.push(t)}}i&&await this.saveUserActionList(i)}async saveSubcategories(t,e,i=!0){Logger.debug("Saving subcategories...",{subcategories:t,parentSubcategoryData:e});const n=game.tokenActionHud.actionHandler.actionList.categories,s=Utils.deepClone(n),o=await Utils.getSubcategoryByNestId(s,e);if(!o)return;const a=e.nestId,r=[];for(const e of t)r.push(this.createSubcategory({...e,nestId:`${a}_${e.id}`,isSelected:e.isSelected??!0}));if(e.hasDerivedSubcategories)for(const e of o.subcategories){const n=Utils.deepClone(e),s=t.find((t=>t.id===n.id));i&&(n.isSelected=!1,n.actions=[]),s||r.push(n)}o.subcategories=r,e.advancedCategoryOptions&&(o.advancedCategoryOptions=e.advancedCategoryOptions),await this.saveUserActionList(s),Logger.debug("Subcategories saved",{actionList:s})}addToDerivedSubcategories(t,e){const i=t.nestId,n=Utils.deepClone(e,{strict:!0});this.derivedSubcategories.has(i)||this.derivedSubcategories.set(i,[]),this.derivedSubcategories.get(i).push(n)}async saveDerivedSubcategories(){for(const[t,e]of this.derivedSubcategories){const i=Utils.deepClone(e,{strict:!0}),n=!1;await this.saveSubcategories(i,{nestId:t,type:a.SYSTEM,hasDerivedSubcategories:!0},n)}}async saveUserActionList(t){Logger.debug("Saving user action list...");const e=Utils.deepClone(t);await Utils.setUserFlag("categories",e),Logger.debug("User action list saved",{actionList:e})}async getAdvancedCategoryOptions(t){const e=(await Utils.getSubcategoryByNestId(this.flattenedSubcategories,t))?.advancedCategoryOptions;return e??null}async getSelectedCategoriesAsTagifyEntries(){const t=Utils.getUserFlag("categories");if(t)return t.map((t=>this._toTagifyEntry(t)))}async getSelectedSubcategoriesAsTagifyEntries(t){const e=game.tokenActionHud.actionHandler.actionList.categories;if(!e)return[];const i=await Utils.getSubcategoryByNestId(e,t);if(!i)return[];if(!i.subcategories)return[];const n=i.subcategories.filter((t=>t.isSelected)).map((t=>this._toTagifyEntry(t)));return n||[]}async getAvailableSubcategoriesAsTagifyEntries(t){const e=t?.hasDerivedSubcategories;if("true"===e)return await this.getDerivedSubcategoriesAsTagifyEntries(t);const i=await this.getSystemSubcategoriesAsTagifyEntries(),n=await this.getCompendiumSubcategoriesAsTagifyEntries(),s=[];return s.push(...i,...n),s}async getDerivedSubcategoriesAsTagifyEntries(t){const e=t.nestId;return this.getFlattenedSubcategories({nestId:e,type:a.SYSTEM_DERIVED}).map((t=>this._toTagifyEntry(t)))}async getSystemSubcategoriesAsTagifyEntries(){return Utils.getUserFlag("default.subcategories").map((t=>this._toTagifyEntry(t)))}async getCompendiumSubcategoriesAsTagifyEntries(){return game.packs.filter((t=>n.includes(t.documentName))).filter((t=>game.user.isGM||!t.private)).map((t=>({id:t.metadata.id.replace(".","-"),value:t.metadata.label,type:a.COMPENDIUM,level:a.SUBCATEGORY})))}isLinkedCompendium(t){return this.categories.some((e=>e.subcategories?.some((e=>e.compendiumId===t))))}_toTagifyEntry(t){return{id:t.id,value:t.name,type:t.type,level:o.SUBCATEGORY,hasDerivedSubcategories:t.hasDerivedSubcategories??"false"}}}function onChangeFunction(t){game.tokenActionHud&&game.tokenActionHud.updateSettings()}const registerSettings=function(e,i){game.settings.register(t.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(t.ID,"rollHandler",{name:Utils.i18n("tokenActionHud.settings.rollHandler.name"),hint:Utils.i18n("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:i,default:"core",onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"style",{name:Utils.i18n("tokenActionHud.settings.style.name"),hint:Utils.i18n("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",foundryVTT:"Foundry VTT",dorakoUI:"Dorako UI",pathfinder:"Pathfinder"},onChange:t=>{Utils.switchCSS(t)}}),game.settings.register(t.ID,"direction",{name:Utils.i18n("tokenActionHud.settings.direction.name"),hint:Utils.i18n("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"down",choices:{up:Utils.i18n("tokenActionHud.settings.direction.choices.up"),down:Utils.i18n("tokenActionHud.settings.direction.choices.down")},onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"grid",{name:Utils.i18n("tokenActionHud.settings.grid.name"),hint:Utils.i18n("tokenActionHud.settings.grid.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"scale",{name:Utils.i18n("tokenActionHud.settings.scale.name"),hint:Utils.i18n("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"drag",{name:Utils.i18n("tokenActionHud.settings.drag.name"),hint:Utils.i18n("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),function initColorSettings(){let e=null;game.modules.get("lib-themer")?.active?e="lib-themer":game.modules.get("color-picker")?.active?e="color-picker":game.modules.get("colorsettings")?.active&&(e="colorsettings");switch(e){case"lib-themer":Hooks.once("lib-themer.Ready",(e=>{e.register({id:t.ID,title:game.modules.get(t.ID).title,"--tah-background":{name:"tokenActionHud.settings.background.name",hint:"tokenActionHud.settings.background.hint",type:"color",default:"#00000000"},"--tah-button-background":{name:"tokenActionHud.settings.buttonBackgroundColor.name",hint:"tokenActionHud.settings.buttonBackgroundColor.hint",type:"color",default:"#00000080",colors:{buttons:!0}}})}));break;case"color-picker":"object"==typeof ColorPicker?registerColorSettings(e):Hooks.once("colorPickerReady",(()=>{registerColorSettings(e)}));break;case"colorsettings":Hooks.once("ready",(()=>{try{window.Ardittristan.ColorSetting.tester,registerColorSettings(e)}catch{}}))}}(),game.settings.register(t.ID,"enable",{name:Utils.i18n("tokenActionHud.settings.enable.name"),hint:Utils.i18n("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"allow",{name:Utils.i18n("tokenActionHud.settings.allow.name"),hint:Utils.i18n("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:Utils.i18n("tokenActionHud.settings.allow.choices.4"),3:Utils.i18n("tokenActionHud.settings.allow.choices.3"),2:Utils.i18n("tokenActionHud.settings.allow.choices.2"),1:Utils.i18n("tokenActionHud.settings.allow.choices.1")},default:1,requiresReload:!0}),game.settings.register(t.ID,"alwaysShowHud",{name:Utils.i18n("tokenActionHud.settings.alwaysShowHud.name"),hint:Utils.i18n("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"displayCharacterName",{name:Utils.i18n("tokenActionHud.settings.displayCharacterName.name"),hint:Utils.i18n("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"displayIcons",{name:Utils.i18n("tokenActionHud.settings.displayIcons.name"),hint:Utils.i18n("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"clickOpenCategory",{name:Utils.i18n("tokenActionHud.settings.clickOpenCategory.name"),hint:Utils.i18n("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"renderItemOnRightClick",{name:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.name"),hint:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.modules.get("itemacro")?.active&&game.settings.register(t.ID,"itemMacro",{name:Utils.i18n("tokenActionHud.settings.itemMacro.name"),hint:Utils.i18n("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:Utils.i18n("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:Utils.i18n("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:Utils.i18n("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"activeCssAsText",{name:Utils.i18n("tokenActionHud.settings.activeCssAsText.name"),hint:Utils.i18n("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"debug",{name:Utils.i18n("tokenActionHud.settings.debug.name"),hint:Utils.i18n("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"reset",{name:Utils.i18n("tokenActionHud.settings.reset.name"),hint:Utils.i18n("tokenActionHud.settings.reset.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{t&&(Utils.setSetting("reset",!1),game.tokenActionHud.reset())}}),e.doRegisterSettings(onChangeFunction),Logger.debug("Available roll handlers",{rollHandlers:i})};function registerColorSettings(e){const i={key:"background",name:Utils.i18n("tokenActionHud.settings.background.name"),hint:Utils.i18n("tokenActionHud.settings.background.hint"),scope:"client",restricted:!1,default:"#00000000",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-background",t),onChangeFunction()}},n={key:"buttonBackgroundColor",name:Utils.i18n("tokenActionHud.settings.buttonBackgroundColor.name"),hint:Utils.i18n("tokenActionHud.settings.buttonBackgroundColor.hint"),scope:"client",restricted:!0,default:"#00000080",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-button-background",t),onChangeFunction()}},s={key:"buttonBorderColor",name:Utils.i18n("tokenActionHud.settings.buttonBorderColor.name"),hint:Utils.i18n("tokenActionHud.settings.buttonBorderColor.hint"),scope:"client",restricted:!0,default:"#000000ff",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-button-outline",t),onChangeFunction()}};if("color-picker"===e){const e={format:"hexa",alphaChannel:!0};ColorPicker.register(t.ID,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,default:i.default,onChange:i.onChange},e),ColorPicker.register(t.ID,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,default:n.default,onChange:n.onChange},e),ColorPicker.register(t.ID,s.key,{name:s.name,hint:s.hint,scope:s.scope,restricted:s.restricted,default:s.default,onChange:s.onChange},e)}else"colorsettings"===e&&(new window.Ardittristan.ColorSetting(t.ID,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,defaultColor:i.default,onChange:i.onChange,insertAfter:`${t.ID}.scale`}),new window.Ardittristan.ColorSetting(t.ID,n.key,{name:n.name,hint:n.hint,scope:n.scope,restricted:n.restricted,defaultColor:n.default,onChange:n.onChange,insertAfter:`${t.ID}.${i.key}`}),new window.Ardittristan.ColorSetting(t.ID,s.key,{name:s.name,hint:s.hint,scope:s.scope,restricted:s.restricted,defaultColor:s.default,onChange:s.onChange,insertAfter:`${t.ID}.${n.key}`}));document.querySelector(":root").style.setProperty("--tah-background",Utils.getSetting("background")??"#00000000"),document.querySelector(":root").style.setProperty("--tah-button-background",Utils.getSetting("buttonBackgroundColor")??"#000000b3"),document.querySelector(":root").style.setProperty("--tah-button-outline",Utils.getSetting("buttonBorderColor")??"#000000ff")}class GenericActionHandler{actionHandler;constructor(t){this.actionHandler=t}buildGenericActions(t){this._buildConditions(t),this._buildUtilities(t)}_buildConditions(t){}_buildUtilities(t){if(t)return this._buildSingleTokenUtilities(t);this._buildMultipleTokenUtilities()}_buildSingleTokenUtilities(t){const e=t.actor?.id,n=t.token?.id;if(!n)return;const s=[],o="toggleCombat",r=canvas.tokens.placeables.find((t=>t.id===n)).inCombat?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),c=[i.UTILITY,e,n,o].join("|"),l={id:o,name:r,encodedValue:c,selected:!0};if(s.push(l),game.user.isGM){const t="toggleVisibility",o=canvas.tokens.placeables.find((t=>t.id===n)).document.hidden?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),a=[i.UTILITY,e,n,t].join("|"),r={id:t,name:o,encodedValue:a,selected:!0};s.push(r)}const d={id:"token",type:a.SYSTEM};this.actionHandler.addActionsToActionList(s,d)}_buildMultipleTokenUtilities(){const t="multi",e="multi",n=Utils.getControlledTokens(),s=[],o="toggleCombat",r=n.every((t=>t.inCombat))?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),c=[i.UTILITY,t,e,o].join("|"),l={id:o,name:r,encodedValue:c};if(s.push(l),game.user.isGM){const o="toggleVisibility",a=n.every((t=>!t.document.hidden))?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),r=[i.UTILITY,t,e,o].join("|"),c={id:o,name:a,encodedValue:r};s.push(c)}const d={id:"token",type:a.SYSTEM};this.actionHandler.addActionsToActionList(s,d)}}class CompendiumActionHandler{actionHandler;constructor(t){this.actionHandler=t,this.categoryManager=t.categoryManager}async buildCompendiumActions(){const t="compendium",e=this.categoryManager.getFlattenedSubcategories({type:t}).flatMap((t=>t.id));if(!e)return;const i=game.packs.filter((t=>n.includes(t.documentName))).filter((t=>game.user.isGM||!t.private)).map((t=>t.metadata.id));for(const n of i){const i={id:n.replace(".","-"),type:t};if(e.includes(n.replace(".","-"))){const t=await this._getCompendiumActions(n);this.actionHandler.addActionsToActionList(t,i)}}}async _getCompendiumActions(t){const e=await this.getCompendiumEntries(t),i=this.getCompendiumActionType(t);return e.map((e=>({id:e._id,name:e.name,encodedValue:[i,t,e._id].join("|"),img:Utils.getImage(e),selected:!0})))}async getCompendiumEntries(t){const e=game.packs.get(t);if(!e)return[];const i=e.index.size>0?e.index:await e.getIndex();if("Playlist"===e.documentName){return await this._getPlaylistEntries(e)}return i}async _getPlaylistEntries(t){return(await t.getContent()).reduce(((t,e)=>(e.sounds.forEach((i=>{t.push({_id:`${e._id}>${i._id}`,name:i.name})})),t)),[])}getCompendiumActionType(t){const e=game?.packs?.get(t);if(!e)return"";switch(e.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{actionHandler;constructor(t){this.actionHandler=t,this.categoryManager=t.categoryManager}async buildMacroActions(){const t="custom",e=this.categoryManager.getFlattenedSubcategories({type:t}).flatMap((t=>t.id));if(!e)return;const i=await this._getActions();for(const n of e){const e={id:n,type:t};this.actionHandler.addActionsToActionList(i,e)}}async _getActions(){const t="macro";return game.macros.filter((t=>{const e=t.ownership;return e[game.userId]?e[game.userId]>0:e.default>0})).map((e=>({id:e.id,name:e.name,encodedValue:[t,e.id].join("|"),img:Utils.getImage(e),selected:!0})))}}class ActionHandler{furtherActionHandlers=[];delimiter="|";constructor(t){this.categoryManager=t,this.flattenedSubcategories=t.flattenedSubcategories,this.character=null,this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.userActionList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.displayIcons=Utils.getSetting("displayIcons")}resetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.actionList=[],this.userActionList=[],this.savedUserActionList=[],this.savedActorActionList=[],this.displayIcons=Utils.getSetting("displayIcons")}async buildActionList(t){return Logger.debug("Building action list...",{character:t}),await this.categoryManager.resetCategoryManager(),this.character=t,this.savedUserActionList=await this._getSavedUserActionList(t),this.character&&(this.savedActorActionList=await this._getSavedActorActionList(t)),this.actionList=await this._buildEmptyActionList(t),await this.categoryManager.flattenSubcategories(this.actionList),await Promise.all([this._buildSystemActions(t),this._buildGenericActions(t),this._buildCompendiumActions(),this._buildMacroActions()]),await this.buildFurtherActions(t),await this.categoryManager.saveDerivedSubcategories(),await this._setCharacterLimit(),this.character&&await this._saveActorActionList(t),Logger.debug("Action list built",{actionList:this.actionList,character:t}),this.actionList}_getSavedUserActionList(t){Logger.debug("Retrieving saved action list from user...",{character:t});const e=Utils.getUserFlag("categories");if(!e)return[];const i=Utils.deepClone(e);return Logger.debug("Action list from user retrieved",{savedUserActionList:i,character:t}),i}_getSavedActorActionList(e){Logger.debug("Retrieving saved action list from actor...",{character:e});const i=e?.actor;if(!i)return[];const n=i.getFlag(t.ID,"categories");if(!n)return[];const s=Utils.deepClone(n);return Logger.debug("Action list from actor retrieved",{savedActorActionList:s,character:e}),s}_buildEmptyActionList(t){Logger.debug("Building empty action list...",{character:t});let e="";Utils.getSetting("displayCharacterName")&&(e=t?.name??"Multiple");const i={hudTitle:e,tokenId:t?.token?.id??"multi",actorId:t?.actor?.id??"multi",categories:[]},n=this.savedUserActionList?.length?this.savedUserActionList:Utils.getUserFlag("default.categories");for(const t of n){i.categories.push(this.categoryManager.createCategory(t));const e=i.categories.length-1,n=i.categories[e],addSubcategories=(t,e)=>{if(e)for(const i of e)if(t.subcategories.push(this.categoryManager.createSubcategory(i)),i?.subcategories?.length){const e=t.subcategories.length-1,n=t.subcategories[e];addSubcategories(n,i.subcategories)}};addSubcategories(n,t.subcategories,t.nestId)}return Logger.debug("Empty action list built",{emptyActionList:i,character:t}),i}async _buildSystemActions(t){Logger.debug("Building system actions...",{character:t});const e=this.categoryManager.getFlattenedSubcategories({level:"subcategory"}).map((t=>t.id));await this.buildSystemActions(t,e),Logger.debug("System actions built",{actionList:this.actionList,character:t})}async buildSystemActions(t,e){}_buildGenericActions(t){Logger.debug("Building generic actions...",{character:t}),this.genericActionHandler.buildGenericActions(t),Logger.debug("Generic actions built",{actionList:this.actionList,character:t})}async _buildCompendiumActions(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{actionList:this.actionList})}async _buildMacroActions(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{actionList:this.actionList})}async buildFurtherActions(t){this.furtherActionHandlers.forEach((e=>e.extendActionList(t)))}async getAvailableActionsAsTagifyEntries(t){if(!this.actionList)return;return(await Utils.getSubcategoryByNestId(this.actionList.categories,t)).actions.map((t=>this._toTagifyEntry(t)))}async getSelectedActionsAsTagifyEntries(t){if(!this.actionList)return;return(await Utils.getSubcategoryByNestId(this.actionList.categories,t)).actions.filter((t=>!0===t.selected)).map((t=>this._toTagifyEntry(t)))}async registerDefaultCategories(){}addSubcategoryInfo(t){const e=t?.id,i=t?.info;if(!e||!i)return;this.categoryManager.getFlattenedSubcategories(t).forEach((t=>{t.info1=i.info1,t.info2=i.info2,t.info3=i.info3}))}async addSubcategoryToActionList(t,e){const i=t?.id;if(!i)return;const n=this.categoryManager.getFlattenedSubcategories({...t,level:o.SUBCATEGORY});if(n)for(const i of n){const n=`${i.nestId}_${e.id}`;if(this.categoryManager.getFlattenedSubcategories({...e,nestId:n}).length)continue;const s=this.categoryManager.createSubcategory({...e,nestId:n});i.subcategories.push(s),this.categoryManager.addToFlattenedSubcategories(s),this.categoryManager.addToDerivedSubcategories({...t,nestId:i.nestId},s)}}async addActionsToActionList(t,e){if(!t.length)return;if(!e?.id)return;const i=this.categoryManager.getFlattenedSubcategories(e);if(i)for(const e of i){const i=e.nestId,n=e.type,s=await Utils.getSubcategoryByNestId(this.savedActorActionList,{nestId:i,type:n}),o=e.actions??[],a=s?.actions??[],r=[];for(const e of a){const i=o.find((t=>t.id===e.id));if(i)continue;const n=t.find((t=>t.id===e.id));if(n){const t={...n,fullName:n.name,selected:e.selected??!0};r.push(t)}}for(const e of t){if(!a.find((t=>t.id===e.id))){const t={...e,fullName:e.name,selected:!0};r.push(t)}}e.actions.push(...r)}}async _setCharacterLimit(){const t=this.categoryManager.getFlattenedSubcategories({level:"category"});for(const e of t){const t=e?.advancedCategoryOptions?.characterCount,i=this.categoryManager.getFlattenedSubcategories({nestId:e.nestId,level:"subcategory"});for(const e of i){const i=e.actions;if(0===i.length)continue;const n=e?.advancedCategoryOptions?.characterCount,s=n>=0?n:t;if((s||0===s)&&s>=0)for(const t of i)t.name.length<=s||(t.name=0!==s?t.name.split(" ").map((t=>t.slice(0,s))).join(" "):"")}}}async _saveActorActionList(e){if(Logger.debug("Saving actor action list...",{character:e}),!e?.actor)return;const i=e.actor,n=Utils.deepClone(this.actionList.categories);await i.setFlag(t.ID,"categories",n),Logger.debug("Actor action list saved",{actionList:this.actionList,character:e})}async saveActions(t,e){const i=await Utils.getSubcategoryByNestId(this.actionList.categories,e),n=i.actions,s=[];for(const e of t){const t=n.find((t=>t.encodedValue===e.id));if(t){const e={...t,selected:!0};s.push(e)}}for(const e of n){if(!t.find((t=>t.id===e.encodedValue))){const t={...e,selected:!1};s.push(t)}}i.actions=s,await this._saveActorActionList(this.character)}addFurtherActionHandler(t){Logger.debug("Adding further action handler...",{handler:t}),this.furtherActionHandlers.push(t)}_toTagifyEntry(t){return{id:t.encodedValue,value:t.fullName,type:"action",level:"action"}}sortItems(t){return new Map([...t.entries()].sort(((t,e)=>t[1].sort.localeCompare(e[1].sort))))}sortItemsByName(t){return new Map([...t.entries()].sort(((t,e)=>t[1].name.localeCompare(e[1].name))))}}class ActionListExtender extends ActionHandler{constructor(t){super(t)}extendActionList(t){}}class ItemMacroActionListExtender extends ActionListExtender{constructor(t){super(t.categoryManager),this.actionHandler=t,this.categoryManager=t.categoryManager}extendActionList(t){if(!t)return;const e=t.token?.id,i=t.actor?.id;if(!i)return;const n=Utils.getActor(i,e).items.filter((t=>t.flags?.itemacro?.macro?.command));let s;if(s=Utils.isModuleActive("midi-qol")?n.filter(this._isUnsupportedByMidiQoL).map((t=>t.id)):n.map((t=>t.id)),!s)return;if(0===s.length)return;const o=Utils.getSetting("itemMacro");if("original"===o)return;const a="itemMacro"===o;this.categoryManager.flattenedSubcategories.forEach((t=>{this._addSubcategoryActions(s,t,a)}))}_addSubcategoryActions(t,e,i){if(!e?.actions?.length)return;const n=[];e.actions.forEach((e=>{if(!t.includes(e.id))return;const s=this._createItemMacroAction(e,i);i||n.push(s)})),this._addActionsToSubcategory(e,n)}_createItemMacroAction(t,e){const i=e?t:Utils.deepClone(t);return i.id=`itemMacro+${i.id}`,i.fullName=`(M) ${i.fullName}`,i.name=`(M) ${i.name}`,i.encodedValue=`itemMacro${i.encodedValue.substr(i.encodedValue.indexOf("|"))}`,i}_addActionsToSubcategory(t,e){e.forEach((e=>{const i=t.actions.findIndex((t=>t.id===e.id))+1;t.actions.splice(i,0,e)}))}_isUnsupportedByMidiQoL(t){return!t.getFlag("midi-qol","onUseMacroName")}}class RollHandler{preRollHandlers=[];throwInvalidValueErr(t){throw new Error(`Error handling button click: ${t}`)}async handleActionEvent(t,e){Logger.debug(`Handling event for action [${e}]`,{event:t}),this.registerKeyPresses(t);let i=!1;this.preRollHandlers.forEach((n=>{i||(i=n.prehandleActionEvent(t,e))})),i||(this._isMultiGenericAction(e)?await this._doMultiGenericAction(e):this.doHandleActionEvent(t,e))}doHandleActionEvent(t,e){}addPreRollHandler(t){Logger.debug(`Adding pre-roll handler ${t.constructor.name}`),this.preRollHandlers.push(t)}registerKeyPresses(t){this.rightClick=this.isRightClick(t),this.ctrl=this.isCtrl(t),this.alt=this.isAlt(t),this.shift=this.isShift(t)}doRenderItem(t,e,i){const n=Utils.getActor(t,e);Utils.getItem(n,i).sheet.render(!0)}isRenderItem(){return Utils.getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(t){return 2===t?.originalEvent?.button}isAlt(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);return t.altKey&&!e?(Logger.debug("Emulating LEFT ALT key press"),KeyboardManager.emulateKeypress(!1,"AltLeft",{altKey:!0,force:!0}),game.keyboard.downKeys.add("AltLeft"),!0):e}isCtrl(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL);return t.ctrlKey&&!e?(Logger.debug("Emulating LEFT CTRL key press"),KeyboardManager.emulateKeypress(!1,"ControlLeft",{ctrlKey:!0,force:!0}),game.keyboard.downKeys.add("ControlLeft"),!0):e}isShift(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);return t.shiftKey&&!e?(Logger.debug("Emulating LEFT SHIFT key press"),KeyboardManager.emulateKeypress(!1,"ShiftLeft",{shiftKey:!0,force:!0}),game.keyboard.downKeys.add("ShiftLeft"),!0):e}_isMultiGenericAction(t){const e=t.split("|"),i=e[0],n=e[3];return"utility"===i&&n.includes("toggle")}async _doMultiGenericAction(t){const e=t.split("|")[3],i=Utils.getFirstControlledToken();"toggleVisibility"===e&&i.toggleVisibility(),"toggleCombat"===e&&i.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(t,e){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(t,e){const i=e.split("|");if(i.length<2)return!1;let n=null,o=null,a=null;if(2===i.length&&(n=i[0],a=i[1]),3===i.length&&(n=i[0],o=i[1],a=i[2]),!s.includes(n))return!1;switch(n){case"compendiumEntry":this.handleCompendium(o,a);break;case"compendiumMacro":this.handleMacroCompendium(o,a);break;case"compendiumPlaylist":this.handlePlaylistCompendium(o,a);break;case"macro":this.handleMacro(a);break;default:return!1}return!0}handleCompendium(t,e){game.packs.get(t).getDocument(e).then((t=>t.sheet.render(!0)))}handleMacroCompendium(t,e){game.packs.get(t).getDocument(e).then((t=>t.execute()))}async handlePlaylistCompendium(t,e){const i=game.packs.get(t),n=e.split(">"),s=n[0],o=n[1],a=(await i.getDocument(s)).sounds.find((t=>t._id===o));AudioHelper.play({src:a.path},{})}handleMacro(t){game.macros.find((e=>e.id===t)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(t,e){const i=e.split("|");if(4!==i.length)return!1;const n=i[0],s=i[1],o=i[2],a=i[3];return"itemMacro"===n&&(this.isRenderItem()?(this.doRenderItem(s,o,a),!0):this._tryExecuteItemMacro(t,s,o,a))}_tryExecuteItemMacro(t,e,i,n){const s=Utils.getActor(e,i),o=Utils.getItem(s,n);try{o.executeMacro()}catch(t){return Logger.debug("ItemMacro Error",t),!1}return!0}}class SystemManager{constructor(){this.coreModuleId=t.ID}doGetCategoryManager(){}doGetActionHandler(){}doGetRollHandler(t){}getAvailableRollHandlers(){}doRegisterSettings(t){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){const t=await this.doRegisterDefaultFlags();t&&(await Utils.unsetUserFlag("default"),await Utils.setUserFlag("default",t))}async getActionHandler(t){const e=this.doGetActionHandler(t);return this.addActionExtenders(e),e}addActionExtenders(t){Utils.isModuleActive("itemacro")&&t.addFurtherActionHandler(new ItemMacroActionListExtender(t))}async getCategoryManager(){const t=this.doGetCategoryManager();return await t.init(),t}getRollHandler(){let t=Utils.getSetting("rollHandler");"core"===t||Utils.isModuleActive(t)||(Logger.error(t,Utils.i18n("tokenActionHud.handlerNotFound")),t="core",Utils.setSetting("rollHandler",t));const e=this.doGetRollHandler(t);return this.addPreHandlers(e),e}addPreHandlers(t){t.addPreRollHandler(new CompendiumMacroPreHandler),Utils.isModuleActive("itemacro")&&t.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const t=this.getAvailableRollHandlers();registerSettings(this,t)}static addHandler(t,e){if(Utils.isModuleActive(e)){const i=Utils.getModuleTitle(e);mergeObject(t,{[e]:i})}}}export{i as ACTION_TYPE,ActionHandler,ActionListExtender,s as COMPENDIUM_ACTION_TYPES,n as COMPENDIUM_PACK_TYPES,CategoryManager,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,e as DELIMITER,GenericActionHandler,ItemMacroActionListExtender,ItemMacroPreRollHandler,Logger,t as MODULE,MacroActionHandler,MigrationManager,PreRollHandler,RollHandler,o as SUBCATEGORY_LEVEL,a as SUBCATEGORY_TYPE,SystemManager,TagDialog,TagDialogHelper,Timer,TokenActionHud,Utils,registerSettings};
