"use strict";(()=>{var ye=Object.create;var Ut=Object.defineProperty,Te=Object.defineProperties,ve=Object.getOwnPropertyDescriptor,Ee=Object.getOwnPropertyDescriptors,Se=Object.getOwnPropertyNames,ae=Object.getOwnPropertySymbols,Ce=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var ne=(u,t,e)=>t in u?Ut(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e,re=(u,t)=>{for(var e in t||(t={}))ie.call(t,e)&&ne(u,e,t[e]);if(ae)for(var e of ae(t))be.call(t,e)&&ne(u,e,t[e]);return u},oe=(u,t)=>Te(u,Ee(t));var Ae=(u,t)=>()=>(t||u((t={exports:{}}).exports,t),t.exports);var De=(u,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Se(t))!ie.call(u,a)&&a!==e&&Ut(u,a,{get:()=>t[a],enumerable:!(n=ve(t,a))||n.enumerable});return u};var ke=(u,t,e)=>(e=u!=null?ye(Ce(u)):{},De(t||!u||!u.__esModule?Ut(e,"default",{value:u,enumerable:!0}):e,u));var d=(u,t,e)=>new Promise((n,a)=>{var i=c=>{try{o(e.next(c))}catch(m){a(m)}},r=c=>{try{o(e.throw(c))}catch(m){a(m)}},o=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,r);o((e=e.apply(u,t)).next())});var ce=Ae((Ft,Kt)=>{(function(u,t){typeof Ft=="object"&&typeof Kt!="undefined"?Kt.exports=t():typeof define=="function"&&define.amd?define(t):(u=typeof globalThis!="undefined"?globalThis:u||self).dayjs=t()})(Ft,function(){"use strict";var u=1e3,t=6e4,e=36e5,n="millisecond",a="second",i="minute",r="hour",o="day",c="week",m="month",l="quarter",s="year",h="date",R="Invalid Date",A=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,at=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,nt={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(y){var f=["th","st","nd","rd"],g=y%100;return"["+y+(f[(g-20)%10]||f[g]||f[0])+"]"}},B=function(y,f,g){var T=String(y);return!T||T.length>=f?y:""+Array(f+1-T.length).join(g)+y},V={s:B,z:function(y){var f=-y.utcOffset(),g=Math.abs(f),T=Math.floor(g/60),p=g%60;return(f<=0?"+":"-")+B(T,2,"0")+":"+B(p,2,"0")},m:function y(f,g){if(f.date()<g.date())return-y(g,f);var T=12*(g.year()-f.year())+(g.month()-f.month()),p=f.clone().add(T,m),E=g-p<0,v=f.clone().add(T+(E?-1:1),m);return+(-(T+(g-p)/(E?p-v:v-p))||0)},a:function(y){return y<0?Math.ceil(y)||0:Math.floor(y)},p:function(y){return{M:m,y:s,w:c,d:o,D:h,h:r,m:i,s:a,ms:n,Q:l}[y]||String(y||"").toLowerCase().replace(/s$/,"")},u:function(y){return y===void 0}},Y="en",w={};w[Y]=nt;var P=function(y){return y instanceof Rt},it=function y(f,g,T){var p;if(!f)return Y;if(typeof f=="string"){var E=f.toLowerCase();w[E]&&(p=E),g&&(w[E]=g,p=E);var v=f.split("-");if(!p&&v.length>1)return y(v[0])}else{var b=f.name;w[b]=f,p=b}return!T&&p&&(Y=p),p||!T&&Y},$=function(y,f){if(P(y))return y.clone();var g=typeof f=="object"?f:{};return g.date=y,g.args=arguments,new Rt(g)},D=V;D.l=it,D.i=P,D.w=function(y,f){return $(y,{locale:f.$L,utc:f.$u,x:f.$x,$offset:f.$offset})};var Rt=function(){function y(g){this.$L=it(g.locale,null,!0),this.parse(g)}var f=y.prototype;return f.parse=function(g){this.$d=function(T){var p=T.date,E=T.utc;if(p===null)return new Date(NaN);if(D.u(p))return new Date;if(p instanceof Date)return new Date(p);if(typeof p=="string"&&!/Z$/i.test(p)){var v=p.match(A);if(v){var b=v[2]-1||0,O=(v[7]||"0").substring(0,3);return E?new Date(Date.UTC(v[1],b,v[3]||1,v[4]||0,v[5]||0,v[6]||0,O)):new Date(v[1],b,v[3]||1,v[4]||0,v[5]||0,v[6]||0,O)}}return new Date(p)}(g),this.$x=g.x||{},this.init()},f.init=function(){var g=this.$d;this.$y=g.getFullYear(),this.$M=g.getMonth(),this.$D=g.getDate(),this.$W=g.getDay(),this.$H=g.getHours(),this.$m=g.getMinutes(),this.$s=g.getSeconds(),this.$ms=g.getMilliseconds()},f.$utils=function(){return D},f.isValid=function(){return this.$d.toString()!==R},f.isSame=function(g,T){var p=$(g);return this.startOf(T)<=p&&p<=this.endOf(T)},f.isAfter=function(g,T){return $(g)<this.startOf(T)},f.isBefore=function(g,T){return this.endOf(T)<$(g)},f.$g=function(g,T,p){return D.u(g)?this[T]:this.set(p,g)},f.unix=function(){return Math.floor(this.valueOf()/1e3)},f.valueOf=function(){return this.$d.getTime()},f.startOf=function(g,T){var p=this,E=!!D.u(T)||T,v=D.p(g),b=function(rt,x){var Q=D.w(p.$u?Date.UTC(p.$y,x,rt):new Date(p.$y,x,rt),p);return E?Q:Q.endOf(o)},O=function(rt,x){return D.w(p.toDate()[rt].apply(p.toDate("s"),(E?[0,0,0,0]:[23,59,59,999]).slice(x)),p)},_=this.$W,G=this.$M,q=this.$D,W="set"+(this.$u?"UTC":"");switch(v){case s:return E?b(1,0):b(31,11);case m:return E?b(1,G):b(0,G+1);case c:var yt=this.$locale().weekStart||0,Tt=(_<yt?_+7:_)-yt;return b(E?q-Tt:q+(6-Tt),G);case o:case h:return O(W+"Hours",0);case r:return O(W+"Minutes",1);case i:return O(W+"Seconds",2);case a:return O(W+"Milliseconds",3);default:return this.clone()}},f.endOf=function(g){return this.startOf(g,!1)},f.$set=function(g,T){var p,E=D.p(g),v="set"+(this.$u?"UTC":""),b=(p={},p[o]=v+"Date",p[h]=v+"Date",p[m]=v+"Month",p[s]=v+"FullYear",p[r]=v+"Hours",p[i]=v+"Minutes",p[a]=v+"Seconds",p[n]=v+"Milliseconds",p)[E],O=E===o?this.$D+(T-this.$W):T;if(E===m||E===s){var _=this.clone().set(h,1);_.$d[b](O),_.init(),this.$d=_.set(h,Math.min(this.$D,_.daysInMonth())).$d}else b&&this.$d[b](O);return this.init(),this},f.set=function(g,T){return this.clone().$set(g,T)},f.get=function(g){return this[D.p(g)]()},f.add=function(g,T){var p,E=this;g=Number(g);var v=D.p(T),b=function(G){var q=$(E);return D.w(q.date(q.date()+Math.round(G*g)),E)};if(v===m)return this.set(m,this.$M+g);if(v===s)return this.set(s,this.$y+g);if(v===o)return b(1);if(v===c)return b(7);var O=(p={},p[i]=t,p[r]=e,p[a]=u,p)[v]||1,_=this.$d.getTime()+g*O;return D.w(_,this)},f.subtract=function(g,T){return this.add(-1*g,T)},f.format=function(g){var T=this,p=this.$locale();if(!this.isValid())return p.invalidDate||R;var E=g||"YYYY-MM-DDTHH:mm:ssZ",v=D.z(this),b=this.$H,O=this.$m,_=this.$M,G=p.weekdays,q=p.months,W=function(x,Q,wt,Ot){return x&&(x[Q]||x(T,E))||wt[Q].slice(0,Ot)},yt=function(x){return D.s(b%12||12,x,"0")},Tt=p.meridiem||function(x,Q,wt){var Ot=x<12?"AM":"PM";return wt?Ot.toLowerCase():Ot},rt={YY:String(this.$y).slice(-2),YYYY:this.$y,M:_+1,MM:D.s(_+1,2,"0"),MMM:W(p.monthsShort,_,q,3),MMMM:W(q,_),D:this.$D,DD:D.s(this.$D,2,"0"),d:String(this.$W),dd:W(p.weekdaysMin,this.$W,G,2),ddd:W(p.weekdaysShort,this.$W,G,3),dddd:G[this.$W],H:String(b),HH:D.s(b,2,"0"),h:yt(1),hh:yt(2),a:Tt(b,O,!0),A:Tt(b,O,!1),m:String(O),mm:D.s(O,2,"0"),s:String(this.$s),ss:D.s(this.$s,2,"0"),SSS:D.s(this.$ms,3,"0"),Z:v};return E.replace(at,function(x,Q){return Q||rt[x]||v.replace(":","")})},f.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},f.diff=function(g,T,p){var E,v=D.p(T),b=$(g),O=(b.utcOffset()-this.utcOffset())*t,_=this-b,G=D.m(this,b);return G=(E={},E[s]=G/12,E[m]=G,E[l]=G/3,E[c]=(_-O)/6048e5,E[o]=(_-O)/864e5,E[r]=_/e,E[i]=_/t,E[a]=_/u,E)[v]||_,p?G:D.a(G)},f.daysInMonth=function(){return this.endOf(m).$D},f.$locale=function(){return w[this.$L]},f.locale=function(g,T){if(!g)return this.$L;var p=this.clone(),E=it(g,T,!0);return E&&(p.$L=E),p},f.clone=function(){return D.w(this.$d,this)},f.toDate=function(){return new Date(this.valueOf())},f.toJSON=function(){return this.isValid()?this.toISOString():null},f.toISOString=function(){return this.$d.toISOString()},f.toString=function(){return this.$d.toUTCString()},y}(),ee=Rt.prototype;return $.prototype=ee,[["$ms",n],["$s",a],["$m",i],["$H",r],["$W",o],["$M",m],["$y",s],["$D",h]].forEach(function(y){ee[y[1]]=function(f){return this.$g(f,y[0],y[1])}}),$.extend=function(y,f){return y.$i||(y(f,Rt,$),y.$i=!0),$},$.locale=it,$.isDayjs=P,$.unix=function(y){return $(1e3*y)},$.en=w[Y],$.Ls=w,$.p={},$})});var It="FVTT Encounter Statistics",N="encounter-stats";var $t="encounter-stats-data";var Nt="enable",se="enableExportJson",z="enableDiceStreak",ot="enableDiceStreakToChat";var st=class{static IsEnabled(){return typeof SimpleCalendar!="undefined"}static GetCurrentDateToString(){var t,e,n,a,i,r,o;return`${(t=SimpleCalendar.api.getCurrentDay())==null?void 0:t.name} ${(n=(e=SimpleCalendar.api)==null?void 0:e.getCurrentMonth())==null?void 0:n.name} ${(i=(a=SimpleCalendar.api)==null?void 0:a.getCurrentYear())==null?void 0:i.numericRepresentation} ${(o=(r=SimpleCalendar.api)==null?void 0:r.getCurrentYear())==null?void 0:o.postfix}`}};var Wt=class{static log(t,e="global",n={}){console.log("Encounter Stats",e,t,n)}static debug(t,e="global",n={}){console.debug("Encounter Stats",e,t,n)}static warn(t,e="global",n={}){console.warn("Encounter Stats",e,t,n)}static error(t,e="global",n={}){console.error("Encounter Stats",e,t,n)}},S=Wt;var me=ke(ce(),1),jt=class{static get now(){let t=(0,me.default)();return{id:t.toISOString().replace(/[-]/g,"").substring(0,8),dateTimeDisplay:t.format("DD MMMM YYYY HH:mm"),dateDisplay:t.format("DD MMMM YYYY")}}},L=jt;var ct=class{static get IsJournalSetup(){var t;return((t=game.journal)==null?void 0:t.find(e=>e.name===this.JOURNAL_TITLE))!==void 0}static CreateJournal(){return d(this,null,function*(){yield JournalEntry.create({name:this.JOURNAL_TITLE},{renderSheet:!1,activate:!1}),yield ct.CreateCampaignJournalEntryPage()})}static CreateJournalEntryPage(t){return d(this,null,function*(){var a;let e=`${L.now.dateTimeDisplay}`;st.IsEnabled()&&(e=`${st.GetCurrentDateToString()} (${t})`);let n=(a=game.journal)==null?void 0:a.find(i=>i.name===this.JOURNAL_TITLE);if(!n){S.error(`No Journal found with name ${this.JOURNAL_TITLE}`,"encounterjournal.CreateJournalEntryPage");return}yield n.createEmbeddedDocuments("JournalEntryPage",[{name:e,type:"text",text:{content:"",format:CONST.JOURNAL_ENTRY_PAGE_FORMATS.HTML},"flags.encounter-stats.encounterId":t}]),yield this.SortJournalData()})}static DeleteCampaignJournalEntryPageData(){return d(this,null,function*(){var e,n;((n=(e=game.journal)==null?void 0:e.find(a=>a.name===this.JOURNAL_TITLE))==null?void 0:n.pages.find(a=>a.getFlag("encounter-stats","campaignstats")==="data")).delete()})}static CreateCampaignJournalEntryPage(){return d(this,null,function*(){var e;let t=(e=game.journal)==null?void 0:e.find(n=>n.name===this.JOURNAL_TITLE);if(!t){S.error(`No Journal found with name ${this.JOURNAL_TITLE}`,"encounterjournal.CreateCampaignJournalEntryPage");return}yield t.createEmbeddedDocuments("JournalEntryPage",[{name:"Campaign Statistics",type:"text",text:{content:"",format:CONST.JOURNAL_ENTRY_PAGE_FORMATS.HTML},"flags.encounter-stats.campaignstats":"view"}])})}static UpdateJournalData(t,e,n){return d(this,null,function*(){var i,r;let a=(r=(i=game.journal)==null?void 0:i.find(o=>o.name===this.JOURNAL_TITLE))==null?void 0:r.pages.find(o=>o.getFlag("encounter-stats",e)===n);if(!a){S.error(`No Journal found with name ${this.JOURNAL_TITLE} and ${e} ${n}`,"encounterjournal.UpdateJournalData");return}yield ct._updateJournalPage({_id:a._id,flags:a.flags,text:{content:t}})})}static SortJournalData(){return d(this,null,function*(){var a;let t=(a=game.journal)==null?void 0:a.getName(this.JOURNAL_TITLE),e=2e3,n=new Map([...t.pages.entries()].sort((i,r)=>i.name>r.name?1:-1));for(let[,i]of n.entries())i.getFlag("encounter-stats","campaignstats")==="view"?yield ct._updateJournalPage({_id:i._id,flags:{},sort:1e3}):(yield ct._updateJournalPage({_id:i._id,flags:{},sort:e}),e=e+1e3)})}static _updateJournalPage(t){return d(this,null,function*(){var e;yield(e=game.journal)==null?void 0:e.getName(this.JOURNAL_TITLE).updateEmbeddedDocuments("JournalEntryPage",[t],{diff:!1,render:!1})})}static GetCampaignJournal(){return d(this,null,function*(){var e,n;let t=(n=(e=game.journal)==null?void 0:e.find(a=>a.name===this.JOURNAL_TITLE))==null?void 0:n.pages.find(a=>a.getFlag("encounter-stats","campaignstats")==="data");if(t)return JSON.parse(t.text.content.replace("<p>","").replace("</p>",""))})}},Mt=ct;Mt.JOURNAL_TITLE="Encounter Statistics";var J=Mt;var F=class{static IsCurrentSceneCombatSet(t){var e,n;return(e=game.combat)!=null&&e.active?((n=game.combat)==null?void 0:n.getFlag("encounter-stats",t))!==void 0:!1}static Get(t,e){return d(this,null,function*(){var a;if(!F.IsCurrentSceneCombatSet(t))return;let n=(a=game.combat)==null?void 0:a.getFlag("encounter-stats",t);if(e&&!n.combatants.find(i=>i.id===e)){let i=yield game.combats.find(r=>r.getFlag("encounter-stats",t).combatants.find(o=>o.id===e));if(!i)return;n=i.getFlag("encounter-stats",t)}return n})}static Save(t,e){return d(this,null,function*(){yield game.combats.find(n=>n.id===e.encounterId).setFlag("encounter-stats",t,e)})}};var Bt=(t=>(t[t.heal=1]="heal",t))(Bt||{}),Yt=(i=>(i[i.mwak=1]="mwak",i[i.rwak=2]="rwak",i[i.msak=3]="msak",i[i.rsak=4]="rsak",i[i.save=5]="save",i))(Yt||{}),qt=(r=>(r[r.mwak=1]="mwak",r[r.rwak=2]="rwak",r[r.msak=3]="msak",r[r.rsak=4]="rsak",r[r.save=5]="save",r[r.heal=6]="heal",r))(qt||{});var k=class{constructor(t){if(t){let e=L.now.dateTimeDisplay;this._encounter={encounterId:t,round:1,overview:{start:e,end:"",realDate:e,scene:{id:"",name:"",thumb:""}},enemies:[],combatants:[],top:{maxDamage:"",mostDamageInOneTurn:"",highestAvgDamage:"",highestMaxDamage:"",mostKills:"",mostHealing:"",mostSupportActions:"",mostBattlefieldActions:","},templateHealthCheck:[],partySummary:{averageDamagePerRound:0,lowestDamagePerRound:0,highestDamagePerRound:0,totalDamage:0,totalDamagePerRound:[]}}}}set encounter(t){this._encounter=t}get encounter(){return this._encounter}get hasEncounter(){return this._encounter!==void 0}get currentRound(){return this._encounter.round}UpdateEnd(){var t;(t=this._encounter)!=null&&t.overview&&(this._encounter.overview.end=L.now.dateTimeDisplay)}AddKill(t,e){let n={},a=this.GetCombatantStatsByTokenId(e);if(!a){S.warn(`No combatant statistics for TokenID ${e}`,"stat.AddKill",e);return}n.round=this.currentRound,n.tokenName=t,a.kills.push(n)}UpdateHealth(t){let e={};if(!t.id){S.warn("No Actor ID passed","stat.UpdateHealth",t);return}let n=this.GetCombatantStats(t.id);if(!n){S.warn(`No combatant statistics for TokenID ${t.id}`,"stat.UpdateHealth",t);return}e.round=this.currentRound,e.actorId=t==null?void 0:t.id,e.max=t.system.attributes.hp.max,e.current=t.system.attributes.hp.value,n.health.length>0?e.previous=n.health[n.health.length-1].current:e.previous=n.hp,e.current>e.previous?(e.diff=e.current-e.previous,e.isheal=!0):e.current<e.previous&&(e.diff=e.previous-e.current,e.isdamage=!0),n.health.push(e)}AddEnemy(t){this._encounter.enemies.push(t)}AddCombatant(t,e,n){return d(this,null,function*(){if(!t||!t.id||!t.name){S.warn(`No valid actor passed ${t}`,"stat.AddCombatant",t);return}let a=yield t.getTokenImages();if(!k.IsValidCombatant(t==null?void 0:t.type))return;let i={name:t.name,id:t.id,tokenId:e,img:a.length>0?a[0]:t.img,type:t.type,hp:t.system.attributes.hp.value,max:t.system.attributes.hp.max,ac:t.system.attributes.ac.value,initiative:n,abilities:{cha:t.system.abilities.cha.value,con:t.system.abilities.con.value,dex:t.system.abilities.dex.value,int:t.system.abilities.int.value,str:t.system.abilities.str.value,wis:t.system.abilities.wis.value},events:[],health:[],kills:[],summaryList:{min:0,max:0,avg:0,total:0},roundSummary:{totals:[{round:this.currentRound,damageTotal:0}]}},r=this._encounter.combatants.find(o=>o.id===i.id);r||(this._encounter.combatants.push(i),r=this._encounter.combatants.find(o=>o.id===i.id),r!=null&&r.initiative&&this._encounter.combatants.sort((o,c)=>{var m,l;return((m=o.initiative)!=null?m:0)>((l=c.initiative)!=null?l:0)?1:-1})),!(r!=null&&r.initiative)&&i.initiative&&(r.initiative=i.initiative,this._encounter.combatants.sort((o,c)=>{var m,l;return((m=o.initiative)!=null?m:0)<((l=c.initiative)!=null?l:0)?1:-1}))})}IsValidAttack(t){return Object.values(Yt).includes(t)}IsHealingSpell(t){return Object.values(Bt).includes(t)}static IsValidCombatant(t){return t==="character"}IsValidRollEvent(t){return Object.values(qt).includes(t)}UpdateScene(t,e,n){var a,i;(i=(a=this._encounter)==null?void 0:a.overview)!=null&&i.scene&&(this._encounter.overview.scene.name=e,this._encounter.overview.scene.thumb=n,this._encounter.overview.scene.id=t)}UpdateRound(t){this._encounter.round!==t&&(this._encounter.round=t)}GetCombatantStats(t){var e,n;return(n=(e=this._encounter)==null?void 0:e.combatants)==null?void 0:n.find(a=>a.id===t)}GetCombatantStatsByTokenId(t){return this._encounter.combatants.find(e=>e.tokenId===t)}Save(){return d(this,null,function*(){var t;(t=this._encounter)!=null&&t.combatants&&(this.GenerateCombatantStats(),this.GetTopStats(),this._partySummary(this._encounter),yield I.SaveStat(this._encounter))})}SetTopEncounter(t){this._encounter.top=t}_setPartySummary(t){this._encounter.partySummary=t}GenerateCombatantStats(){this._encounter.combatants.forEach(t=>{let e=t.events.filter(i=>this.IsValidAttack(i.actionType)),n=e.map(i=>{var r;return(r=i.damageTotal)!=null?r:0});t.summaryList=this.GetSummaryStatsFromArray(n);let a=e.map(i=>{var r;return{round:i.round,damageTotal:(r=i.damageTotal)!=null?r:0}});t.roundSummary=this.GetRoundSummaryStats(a)})}GetRoundSummaryStats(t){let e=this.GroupBy(t,"round"),n={totals:[]};for(let a in e)n.totals.push({round:parseInt(a),damageTotal:e[a].map(i=>{var r;return(r=i.damageTotal)!=null?r:0}).reduce(this.AddAccumulator,0)});return n}GetSummaryStatsFromArray(t){return t.length===0?{min:0,max:0,avg:0,total:0}:{min:Math.min(...t),max:Math.max(...t),avg:Math.round(t.reduce(this.AddAccumulator,0)/t.length),total:t.reduce(this.AddAccumulator,0)}}GetTopStats(){if(this._encounter.combatants.length===0){this.SetTopEncounter({maxDamage:"",mostDamageInOneTurn:"",highestAvgDamage:"",highestMaxDamage:"",mostKills:"",mostHealing:"",mostSupportActions:"",mostBattlefieldActions:""});return}let t=this._encounter.combatants.map(l=>l.kills.length===0?{name:"None",total:0}:{name:l.name,total:l.kills.length}).reduce(function(l,s){return s.total>l.total?s:l}),e=this._encounter.combatants.map(l=>l.events.length===0?{name:"None",total:0}:{name:l.name,total:l.events.filter(s=>s.actionType==="heal").length}).reduce(function(l,s){return s.total>l.total?s:l}),n=this._encounter.combatants.map(l=>l.events.length===0?{name:"None",total:0}:{name:l.name,total:l.events.filter(s=>s.actionType==="save"||s.actionType==="heal").length}).reduce(function(l,s){return s.total>l.total?s:l}),a=this._encounter.combatants.map(l=>l.events.length===0?{name:"None",total:0}:{name:l.name,total:l.events.filter(s=>s.actionType==="other").length}).reduce(function(l,s){return s.total>l.total?s:l}),i=this._encounter.combatants.map(l=>l.roundSummary.totals.length===0?{name:"None",total:0}:{name:l.name,total:l.roundSummary.totals.reduce(function(s,h){return h.damageTotal>s.damageTotal?h:s}).damageTotal}).reduce((l,s)=>l.total>s.total?l:s),r=this._encounter.combatants.map(l=>l.summaryList.total===0?{name:"None",min:0,max:0,avg:0,total:0}:{name:l.name,min:l.summaryList.min,max:l.summaryList.max,avg:l.summaryList.avg,total:l.summaryList.total}),o=r.reduce(function(l,s){return s.total>l.total?s:l}),c=r.reduce(function(l,s){return s.avg>l.avg?s:l}),m=r.reduce(function(l,s){return s.max>l.max?s:l});this.SetTopEncounter({maxDamage:`${o.name}<br />${o.total}`,mostDamageInOneTurn:`${i.name}<br />${i.total}`,highestAvgDamage:`${c.name}<br />${c.avg}`,highestMaxDamage:`${m.name}<br />${m.max}`,mostKills:`${t.name}<br />${t.total}`,mostHealing:`${e.name}<br />${e.total}`,mostSupportActions:`${n.name}<br />${n.total}`,mostBattlefieldActions:`${a.name}<br />${a.total}`})}_partySummary(t){var c,m,l;if(t.combatants.length===0)return;let e=t.combatants.filter(s=>s.type==="character").map(s=>({totals:s.roundSummary.totals})).reduce((s,h)=>{var R,A;return{totals:(A=(R=s.totals)==null?void 0:R.concat(h.totals))!=null?A:{}}}),n=0,a=[];(e==null?void 0:e.totals.length)>0&&(n=(c=e.totals.reduce((s,h)=>s+h.damageTotal,0))!=null?c:0,e.totals.reduce(function(s,h){return s[h.round]||(s[h.round]={round:h.round,damageTotal:0},a.push(s[h.round])),s[h.round].damageTotal+=h.damageTotal,s},{}));let i=0,r=0,o=0;return a.length>0&&(i=n/a.length,r=(m=a==null?void 0:a.reduce(function(s,h){return h.damageTotal<s.damageTotal?h:s}).damageTotal)!=null?m:0,o=(l=a==null?void 0:a.reduce(function(s,h){return h.damageTotal>s.damageTotal?h:s}).damageTotal)!=null?l:0),this._setPartySummary({averageDamagePerRound:Math.round(i),lowestDamagePerRound:Math.round(r),highestDamagePerRound:Math.round(o),totalDamage:Math.round(n),totalDamagePerRound:a}),{averageDamagePerRound:Math.round(i),lowestDamagePerRound:Math.round(r),highestDamagePerRound:Math.round(o),totalDamage:Math.round(n),totalDamagePerRound:a}}GroupBy(t,e){return t.reduce(function(n,a){return(n[a[e]]=n[a[e]]||[]).push(a),n},{})}AddAccumulator(t,e){return t+e}};var Qt=class{static Get(t){return game.i18n.format(`EncounterStats.${t}`)}},C=Qt;var zt=class{static Render(t){return d(this,null,function*(){var i,r,o,c;let e=t;e.enemyNumber=(r=(i=e.enemies)==null?void 0:i.length)!=null?r:0;for(let m of e.combatants)m.type!=="character"&&e.combatants.pop(m);for(let m of e.combatants){m.rounds=[];for(let s of m.events)s.damageOrHeal=yield this.getHealOrDamageClass(s.actionType),s.rollAdvDis=s.advantage?"advantage":s.disadvantage?"disadvantage":"normal",s.damageMultipleEnemiesTotal=(o=s.damageMultipleEnemiesTotal)!=null?o:s.damageTotal,s.actionTypeIcon=this.getAttackTypeFAIcon(s.actionType),s.attackTotal=s.isCritical?`${s.attackTotal} (c)`:`${s.attackTotal}`,m.rounds[s.round-1]||(m.rounds[s.round-1]={round:s.round}),m.rounds[s.round-1].attacks||(m.rounds[s.round-1].attacks=[]),m.rounds[s.round-1].attacks.push(s);for(let s of m.kills)m.rounds[s.round-1]||(m.rounds[s.round-1]={round:s.round}),m.rounds[s.round-1].kills||(m.rounds[s.round-1].kills=[]),m.rounds[s.round-1].kills.push({tokenName:s.tokenName});let l=0;for(let s of m.health){s.isdamage&&s.current<1&&l++,m.rounds[s.round-1]||(m.rounds[s.round-1]={round:s.round}),m.rounds[s.round-1].health||(m.rounds[s.round-1].health=[]);let h=m.rounds[s.round-1];s.diff&&h.health.push({current:s.current,diff:`${s.isheal?"+":"-"} ${s.diff}`})}m.downed=l;for(let s of m.roundSummary.totals){let h=m.rounds.find(R=>(R==null?void 0:R.round)===s.round);h?h.damageTotal=s.damageTotal:m.rounds[s.round-1]=(c=s.round)!=null?c:0}}let n="./modules/encounter-stats/templates/encounter_1.hbs";return{html:yield renderTemplate(n,e),data:e}})}static getHealOrDamageClass(t){return d(this,null,function*(){let e=new k;if(e.IsHealingSpell(t))return"blue";if(e.IsValidAttack(t))return"red"})}static getAttackTypeFAIcon(t){let e="dice-d20",n=C.Get("actiontypes.other");switch(t){case"heal":e="heart",n=C.Get("actiontypes.heal");break;case"msak":e="scroll",n=C.Get("actiontypes.msak");break;case"rsak":e="scroll",n=C.Get("actiontypes.rsak");break;case"mwak":e="fist-raised",n=C.Get("actiontypes.mwak");break;case"rwak":e="fist-raised",n=C.Get("actiontypes.rwak");break;case"save":e="shield-alt",n=C.Get("actiontypes.save");break}return`<i title="${n}" class="fas fa-${e}"></i>`}},ue=zt;var vt=class{static IsInCombat(){return F.IsCurrentSceneCombatSet($t)}static GetStat(t){return d(this,null,function*(){let e=yield F.Get($t,t);return deepClone(e)})}static SaveStat(t){return d(this,null,function*(){var a;let e=yield vt.GetStat();if(e){let i=diffObject(e,t);if(((a=Object.keys(i))==null?void 0:a.length)<1)return}if(!(t!=null&&t.encounterId)){S.error("No encounterId to save stat","statmanager.SaveStat");return}yield F.Save($t,t);let n=yield ue.Render(t);yield J.UpdateJournalData(n.html,"encounterId",t.encounterId)})}},I=vt;var Et=class extends k{AddAttack(t){var a;if(!((a=t==null?void 0:t.actor)!=null&&a.id)){S.error("No Actor ID in encounter","midiqolstat.AddAttack",t);return}let e=this.GetCombatantStats(t.actor.id);if(!e){S.log(`No combatant found for Actor ID ${t.actor.id}`,"midiqolstat.AddAttack",t);return}let n={id:t.id,actorId:t.actor.id,item:t.item,advantage:t.advantage,disadvantage:t.disadvantage,actionType:t.actionType,round:this.currentRound,enemyHit:t.enemyHit,attackTotal:0,damageTotal:0,damageMultipleEnemiesTotal:0,isCritical:!1};this.IsValidAttack(n.actionType)&&t.attackTotal&&(n.attackTotal=t.attackTotal),this.IsValidRollEvent(n.actionType)&&t.damageTotal&&(n.damageMultipleEnemiesTotal=t.damageMultipleEnemiesTotal,n.damageTotal=t.damageTotal,n.isCritical=t.isCritical),e.events.push(n)}};var St=class extends k{AddAttack(t){var a;if(!((a=t==null?void 0:t.actor)!=null&&a.id)){S.error("No Actor ID in encounter","dnd5estat.AddAttack",t);return}let e=this.GetCombatantStats(t.actor.id);if(!e)return;if(e.events.find(i=>i.id===t.id&&i.round===this.currentRound)!==void 0&&t.type!=="itemCard"){let i=e.events.filter(r=>r.id===t.id).reverse()[0];t.type==="damage"?(i.damageTotal=t.damageTotal,i.damageMultipleEnemiesTotal=t.damageMultipleEnemiesTotal,i.isCritical=t.isCritical):t.type==="attack"&&(i.attackTotal=t.attackTotal,i.isFumble=t.isFumble,i.advantage=t.advantage,i.disadvantage=t.disadvantage)}else if(t.type==="itemCard"){let i={id:t.id,actorId:t.actor.id,item:t.item,round:this.currentRound,attackTotal:0,damageTotal:0,actionType:t.actionType};e.events.push(i)}}};var Zt=class{static Render(t){return d(this,null,function*(){let e={nat1:yield this.GenerateSummaryRow(t,"nat1"),nat20:yield this.GenerateSummaryRow(t,"nat20"),heals:yield this.GenerateSummaryRow(t,"heals"),kills:yield this.GenerateSummaryRow(t,"kills"),criticalHistory:yield this.GenerateRollRow(t.nat20),fumbleHistory:yield this.GenerateRollRow(t.nat1),healsHistory:yield this.GenerateHealRow(t.heals),killsHistory:yield this.GenerateKillsRow(t.kills),rollstreak:yield this.GenerateKillStreakRow(t.rollstreak),customEventHistory:yield this.GenerateCustomEventRows(t),partySummary:[...t.partySummary].reverse()},n="./modules/encounter-stats/templates/campaign_1.hbs";return{html:yield renderTemplate(n,e),data:e}})}static GenerateCustomEventRows(t){return d(this,null,function*(){let e=[],n=t.custom;return n.length===0?void 0:([].concat(...n==null?void 0:n.map(i=>i.data.map(r=>r.EventName))).reduce((i,r)=>i.includes(r)?i:[...i,r],[]).forEach(i=>{let r={name:i,events:[]};n.forEach(o=>{let c=o.data.filter(l=>l.EventName===i);if((c==null?void 0:c.length)===0)return;let m={date:o.dateDisplay,entries:[]};c.forEach(l=>{m.entries.push({actorName:l.actorName,flavor:l.FlavorText,date:l.date})}),r.events.push(m)}),e.push(r)}),e)})}static GenerateHealRow(t){return d(this,null,function*(){let e=[];return t.reverse().forEach(n=>{let a={date:n.dateDisplay,entries:[]};n.data.forEach(i=>{a.entries.push({actorName:i.actorName,flavor:i.itemLink?i.itemLink:i.spellName,date:i.date,total:i.total})}),e.push(a)}),e})}static GenerateKillStreakRow(t){return d(this,null,function*(){let e=[];if(!game.settings.get(`${N}`,`${z}`))return e;if(t)return t.reverse().forEach(n=>{let a={date:n.dateDisplay,entries:[]};a.entries.push({actorName:n.actorName,flavor:`<strong>${n.roll}</strong> - <i>${n.total}</i>`,date:n.dateDisplay}),e.push(a)}),e})}static GenerateKillsRow(t){return d(this,null,function*(){let e=[];return t.reverse().forEach(n=>{let a={date:n.dateDisplay,entries:[]};n.data.forEach(i=>{a.entries.push({actorName:i.actorName,flavor:i.tokenName,date:i.date})}),e.push(a)}),e})}static GenerateRollRow(t){return d(this,null,function*(){let e=[];return t.reverse().forEach(n=>{let a={date:n.dateDisplay,entries:[]};n.data.forEach(i=>{a.entries.push({actorName:i.actorName,flavor:i.flavor,date:i.date})}),e.push(a)}),e})}static GenerateSummaryRow(t,e){return d(this,null,function*(){let n=[],a;switch(e){case"nat20":a=t.nat20;break;case"nat1":a=t.nat1;break;case"heals":a=t.heals;break;case"kills":a=t.kills;break}let i=[].concat(...a==null?void 0:a.map(o=>{var c;return(c=o.data)==null?void 0:c.map(m=>m==null?void 0:m.actorName)})).reduce(function(o,c){return o[c]=(o[c]||0)+1,o},{}),r=[];return Object.entries(i).forEach(([o,c])=>{r.push({name:o,value:c})}),r.forEach(o=>{n.push({name:o.name,value:o.value})}),n})}},de=Zt;var Ct=class{static Send(t){return d(this,null,function*(){let e=ChatMessage.getWhisperRecipients("GM").map(a=>a.id),n={content:`<div>${t}</div>`,speaker:e};ChatMessage.create(n)})}};var K=class{static get GetActor(){return game.users.find(t=>t.isGM)}static get GetStats(){let t=K.GetActor.getFlag(this.FLAG_SCOPE,this.FLAG_NAME);return t||(t=K.DEFAULT_DATA,K.SetStats(t)),t}static SetStats(t){K.GetActor.setFlag(this.FLAG_SCOPE,this.FLAG_NAME,t)}static DeleteStats(){K.GetActor.setFlag(this.FLAG_SCOPE,this.FLAG_NAME,K.DEFAULT_DATA),H.Save(K.DEFAULT_DATA)}},mt=K;mt.FLAG_SCOPE="encounter-stats",mt.FLAG_NAME="campaign-stats",mt.DEFAULT_DATA={kills:[],nat1:[],nat20:[],heals:[],custom:[],rollstreak:[],rollstreaklog:[],partySummary:[],partySummaryTotal:{averageDamagePerRound:0,lowestDamagePerRound:0,highestDamagePerRound:0,totalDamage:0,totalDamagePerRound:[]}};var j=mt;var H=class{static AddKill(t,e){return d(this,null,function*(){let n=yield this.Get(),a=L.now,i={actorName:t,tokenName:e,date:a.dateTimeDisplay},r=n.kills.find(o=>o.id===a.id);r?r.data.push(i):n.kills.push({id:a.id,dateDisplay:a.dateDisplay,data:[i]}),yield this.Save(n)})}static AddHeal(t,e,n,a){return d(this,null,function*(){let i=yield this.Get(),r=L.now,o={actorName:t,itemLink:e,spellName:n,total:a,date:r.dateTimeDisplay},c=i.heals.find(m=>m.id===r.id);c?c.data.push(o):i.heals.push({id:r.id,dateDisplay:r.dateDisplay,data:[o]}),yield this.Save(i)})}static AddRole(t,e,n){return d(this,null,function*(){let a=yield this.Get(),i=L.now,r={actorName:e,flavor:n,date:i.dateTimeDisplay};if(t==="fumble"){let o=a.nat1.find(c=>c.id===i.id);o?o.data.push(r):a.nat1.push({id:i.id,dateDisplay:i.dateDisplay,data:[r]})}else if(t==="critical"){let o=a.nat20.find(c=>c.id===i.id);o?o.data.push(r):a.nat20.push({id:i.id,dateDisplay:i.dateDisplay,data:[r]})}yield this.Save(a)})}static AddRollStreak(t,e,n){return d(this,null,function*(){if(!game.settings.get(`${N}`,`${z}`))return;let a=yield this.Get(),i=L.now;if(a.rollstreaklog||(a.rollstreaklog=[]),a.rollstreak||(a.rollstreak=[]),!a.rollstreaklog.find(o=>o.actorId===n))a.rollstreaklog.push({actorId:n,results:[t]});else{let o=a.rollstreaklog.findIndex(m=>m.actorId===n),c=a.rollstreaklog[o].results;c.indexOf(t)>-1?(c.push(t),game.settings.get(`${N}`,`${ot}`)&&this._sendRollStreakChatMessage(e,c)):(c.length>1&&a.rollstreak.push({actorId:n,actorName:e,dateDisplay:i.dateDisplay,roll:c[0],total:c.length}),a.rollstreaklog[o].results=[t])}yield this.Save(a)})}static _sendRollStreakChatMessage(t,e){return d(this,null,function*(){yield Ct.Send(`<h2>${C.Get("template.roll_streak")}!</h2><p>@Actor[${t}] ${C.Get("template.rolled_a")} [[${e[0]}]] <strong>${e.length}</strong> ${C.Get("template.times_in_a_row")}!</p>`)})}static AddCustomEvent(t){return d(this,null,function*(){var o,c,m;let e=yield this.Get();e.custom||(e.custom=[]);let n=L.now,a="";t.actorId&&(a=(m=(c=(o=game.actors)==null?void 0:o.get(t.actorId))==null?void 0:c.name)!=null?m:"");let i={EventName:t.EventName,actorName:a,FlavorText:t.FlavorText,date:n.dateTimeDisplay},r=e.custom.find(l=>l.id===n.id);r?r.data.push(i):e.custom.push({id:n.id,dateDisplay:n.dateDisplay,data:[i]}),yield this.Save(e)})}static AddPartyEncounterStat(t,e){return d(this,null,function*(){let n=oe(re({},t),{date:L.now.dateTimeDisplay,encounterId:e}),a=yield this.Get();a.partySummary||(a.partySummary=[]),a.partySummary.push(n),yield this.Save(a)})}static Get(){return d(this,null,function*(){return j.GetStats})}static Save(t){return d(this,null,function*(){j.SetStats(t);let e=yield de.Render(t);J.UpdateJournalData(e.html,"campaignstats","view")})}};var bt=class extends k{AddAttack(t){var a;if(!((a=t==null?void 0:t.actor)!=null&&a.id)){S.error("No Actor ID in encounter","dnd5estat.AddAttack",t);return}let e=this.GetCombatantStats(t.actor.id);if(!e)return;if(e.events.find(i=>i.id===t.id&&i.round===this.currentRound)!==void 0&&t.type==="damage"){let i=e.events.filter(r=>r.id===t.id).reverse()[0];i.damageTotal=t.damageTotal,i.damageMultipleEnemiesTotal=t.damageMultipleEnemiesTotal,i.isCritical=t.isCritical}else if(t.type==="attack"){let i={id:t.id,actorId:t.actor.id,item:t.item,round:this.currentRound,attackTotal:0,damageTotal:0,actionType:t.actionType};i.attackTotal=t.attackTotal,i.isFumble=t.isFumble,i.advantage=t.advantage,i.disadvantage=t.disadvantage,e.events.push(i)}}};var At=class extends k{AddAttack(t){var i,r;if(!((i=t==null?void 0:t.actor)!=null&&i.id)){S.error("No Actor ID in encounter","rsr5e.rollProcessed",t);return}let e=this.GetCombatantStats(t.actor.id);if(!e){S.log(`No combatant found for Actor ID ${t.actor.id}`,"rsr5e.rollProcessed",t);return}let n=e.events[e.events.length-1];if(n!==void 0&&n.damageTotal!==void 0&&n.damageTotal===0&&t.damageTotal>0&&n.actorId===t.actor.id&&n.round===this.currentRound&&((r=n.item)==null?void 0:r.id)===t.item.id){let o=e.events[e.events.length-1];o.damageTotal=t.damageTotal}else{let o={id:t.id,actorId:t.actor.id,item:t.item,advantage:t.advantage,disadvantage:t.disadvantage,actionType:t.actionType,round:this.currentRound,enemyHit:t.enemyHit,attackTotal:0,damageTotal:0,damageMultipleEnemiesTotal:0,isCritical:!1};this.IsValidAttack(o.actionType)&&t.attackTotal&&(o.attackTotal=t.attackTotal),this.IsValidRollEvent(o.actionType)&&t.damageTotal&&(o.damageMultipleEnemiesTotal=t.damageMultipleEnemiesTotal,o.damageTotal=t.damageTotal,o.isCritical=t.isCritical),e.events.push(o)}}};function ut(u){H.AddCustomEvent(u)}function Z(u,t,e){return d(this,null,function*(){u&&H.AddRollStreak(u,t,e)})}function Gt(u,t,e){return d(this,null,function*(){u&&(u===1&&H.AddRole("fumble",t,e),u===20&&H.AddRole("critical",t,e))})}function ge(u){return d(this,null,function*(){var e;if(!u){S.log("No combat","handlers.OnDeleteCombat",u);return}if(!I.IsInCombat())return;let t=new k;t.encounter=yield I.GetStat(),H.AddPartyEncounterStat(t.encounter.partySummary,(e=t.encounter.encounterId)!=null?e:"")})}function Ht(u){return d(this,null,function*(){if(!u){S.log("No new round","handlers.OnUpdateCombat",u);return}if(!I.IsInCombat())return;let t=new k;t.encounter=yield I.GetStat(),t.UpdateRound(u),t.UpdateEnd(),yield t.Save(),S.debug(`Start of round ${u}`,"handlers.OnUpdateCombat")})}function xt(u){return d(this,null,function*(){var a,i,r,o,c,m,l,s,h,R;if(!u.hasCombat){S.log("Combat Tracker Event has no combat active","handlers.OnRenderCombatTracker",u);return}if(!I.IsInCombat())return;let t=new k;t.encounter=yield I.GetStat(),t.UpdateScene((i=(a=u.combat.scene)==null?void 0:a.id)!=null?i:"",(o=(r=u.combat.scene)==null?void 0:r.name)!=null?o:"",(m=(c=u.combat.scene)==null?void 0:c.thumb)!=null?m:"");let e=!1;((s=(l=t.encounter)==null?void 0:l.enemies)==null?void 0:s.length)===0&&(e=!0);let n=u.combat.combatants;for(let A of n){let at=A.actorId,nt=A.tokenId,B=A.initiative,V=(h=game.actors)==null?void 0:h.get(at);V&&(e&&((R=A.actor)==null?void 0:R.type)==="npc"?t.AddEnemy({tokenId:A.tokenId,name:A.name,img:A.actor.img,ac:A.actor.system.attributes.ac.value,hp:A.actor.system.attributes.hp.value}):yield t.AddCombatant(V,nt,B))}yield t.Save(),S.debug("Combatants Added","handlers.OnRenderCombatTracker")})}function Lt(u){return d(this,null,function*(){let t=u.id;if(!t){S.error("Missing encounterId","handlers.OnCreateCombat",u);return}let e=new k(t);yield J.CreateJournalEntryPage(t),yield e.Save(),S.debug("Combat Started","handlers.OnCreateCombat")})}function Dt(u){return d(this,null,function*(){u&&(u.isCritical||u.isFumble)&&H.AddRole(u.isCritical?"critical":"fumble",u.name,u.flavor)})}function U(u,t){return d(this,null,function*(){var n;if(!I.IsInCombat()||!u)return;let e;if(t===1)e=new St;else if(t===3)e=new bt;else if(t===2)e=new Et;else if(t===4)e=new At;else return;if(e.encounter=yield I.GetStat(u.actor.id),e.AddAttack(u),e.Save(),u.actionType&&u.item&&e.IsHealingSpell(u.actionType)){let a=e.GetCombatantStats(u.actor.id);a?H.AddHeal(a.name,u.item.link,u.item.name,(n=u.damageTotal)!=null?n:0):S.warn("Missing Combatant for Heal","handlers.OnEncounterWorkflowComplete",u)}})}function Pt(u){return d(this,null,function*(){if(!I.IsInCombat())return;let t=new k;t.encounter=yield I.GetStat(u.id),t.UpdateHealth(u),t.Save()})}function Jt(u,t){return d(this,null,function*(){if(!I.IsInCombat())return;let e=new k;e.encounter=yield I.GetStat(),e.AddKill(u,t),e.Save();let n=e.GetCombatantStatsByTokenId(t);n&&H.AddKill(n==null?void 0:n.name,u)})}var et=class{static ParseHook(t,e,n,a){return d(this,null,function*(){var o,c,m,l,s,h,R;let i=(o=game.user)==null?void 0:o.targets.map(A=>({tokenId:A.id,name:A.name})),r=Array.from(i).length>0?Array.from(i).length:1;if(n==="damage")return{id:t.id+e.id,actor:{id:e.id,actorName:e.name},damageTotal:(c=a==null?void 0:a.total)!=null?c:0,damageMultipleEnemiesTotal:a!=null&&a.total?a.total*r:0,isCritical:(m=a==null?void 0:a.options.critical)!=null?m:!1,type:n};if(n==="attack")return{id:t.id+e.id,actor:{id:e.id},attackTotal:(l=a==null?void 0:a.total)!=null?l:0,isFumble:((h=(s=a==null?void 0:a.terms[0])==null?void 0:s.results)==null?void 0:h.find(A=>A.active===!0).result)===1,advantage:(a==null?void 0:a.options.advantageMode)===1,disadvantage:(a==null?void 0:a.options.advantageMode)===-1,type:n,diceTotal:(R=a==null?void 0:a.dice[0])==null?void 0:R.total};if(n==="itemCard")return{id:t.id+e.id,actor:{id:e.id},item:{id:t.id,name:t.name,link:t.link,type:t.type,img:t.img},actionType:t.system.actionType,enemyHit:i,type:n}})}};var Xt=class{static ParseWorkflow(t){var n,a,i,r,o,c;let e=t.targets.map(m=>({tokenId:m.id,name:m.sheet.actor.name}));return{id:t.id,actor:{id:t.actor.id},item:{id:t.item.id,name:t.item.name,link:t.item.link,type:t.item.type,img:t.item.img},actionType:t.item.system.actionType,damageTotal:t.hitTargets.size>0&&(n=t.damageTotal)!=null?n:0,damageMultipleEnemiesTotal:t.damageTotal?t.damageTotal*Array.from(e).length:0,attackTotal:(a=t.attackTotal)!=null?a:0,workflowType:t.workflowType,advantage:((r=(i=t.attackRoll)==null?void 0:i.options)==null?void 0:r.advantageMode)===1,disadvantage:((c=(o=t.attackRoll)==null?void 0:o.options)==null?void 0:c.advantageMode)===-1,isCritical:t.isCritical,isFumble:t.isFumble,enemyHit:e,type:"midiqol",diceTotal:t.d20AttackRoll}}static RollCheck(t){var n;let e=t.actor.id;if(e){let a=(n=game.actors)==null?void 0:n.get(e);if(!a){S.log(`No actor found for actorId ${e}`,"midiqol.RollCheck",t);return}return a.type!=="character"?void 0:{isCritical:t.isCritical,isFumble:t.isFumble,flavor:t.item.name,name:a.name}}}},kt=Xt;var Vt=class{static ParseRollData(t){let e=t.fields.find(a=>a[0]==="attack"),n=t.fields.find(a=>a[0]==="damage");return{attackData:e,damageData:n}}static ParseWorkflow(t){var a,i;let e=[],n=this.ParseRollData(t);return{id:t.messageId,actor:{id:t.actorId},item:{id:t.item.id,name:t.item.name,link:t.item.link,type:t.item.type,img:t.item.img},actionType:t.item.system.actionType,damageTotal:n.damageData?(a=n.damageData[1].baseRoll)==null?void 0:a.total:0,attackTotal:n.attackData?(i=n.attackData[1].roll)==null?void 0:i.total:0,advantage:t.params.hasAdvantage,disadvantage:t.params.hasDisadvantage,isCritical:t.params.isCrit,isFumble:t.params.isFumble,enemyHit:e,type:"readysetroll",diceTotal:void 0}}static RollCheck(t){var n;let e=t.actorId;if(e){let a=(n=game.actors)==null?void 0:n.get(e);if(!a){S.log(`No actor found for actorId ${e}`,"rsr5e.rollProcessed",t);return}return a.type!=="character"?void 0:{isCritical:t.params.isCrit,isFumble:t.params.isFumble,flavor:t.item.name,name:a.name}}}},_t=Vt;var M=class{static Setup(){return d(this,null,function*(){var t,e,n,a,i;(t=game.user)!=null&&t.isGM?(M._setupSockerListeners(),window.Hooks.on("renderCombatTracker",function(r,o,c){return d(this,null,function*(){xt(c)})}),window.Hooks.on("createCombat",function(r){return d(this,null,function*(){Lt(r)})}),window.Hooks.on("updateCombat",function(r,o){return d(this,null,function*(){Ht(o.round)})}),window.Hooks.on("updateActor",function(r,o){return d(this,null,function*(){yield M.updateActorToken(r,o)})}),window.Hooks.on("updateToken",function(r,o,c){return d(this,null,function*(){yield M.updateActorToken(r,o,c)})}),(e=game.modules.get("midi-qol"))!=null&&e.active&&window.Hooks.on("midi-qol.RollComplete",function(r){return d(this,null,function*(){let o=kt.RollCheck(r),c=kt.ParseWorkflow(r);U(c,2),Dt(o),o&&c&&Z(c.diceTotal,o.name,c.actor.id)})}),(n=game.modules.get("ready-set-roll-5e"))!=null&&n.active&&window.Hooks.on("rsr5e.rollProcessed",function(r){return d(this,null,function*(){let o=_t.RollCheck(r),c=_t.ParseWorkflow(r);U(c,4),Dt(o)})}),Hooks.on("encounter-stats.customEvent",function(r){return d(this,null,function*(){ut(r)})})):(window.Hooks.on("updateActor",function(r,o){return d(this,null,function*(){var c;(c=game.socket)==null||c.emit(M.SOCKET_NAME,{event:"updateActor",data:{data:r,diff:o}})})}),window.Hooks.on("updateToken",function(r,o,c){return d(this,null,function*(){var m;(m=game.socket)==null||m.emit(M.SOCKET_NAME,{event:"updateToken",data:{data:r,diff:o,diffResult:c}})})}),(a=game.modules.get("midi-qol"))!=null&&a.active&&window.Hooks.on("midi-qol.RollComplete",function(r){return d(this,null,function*(){var o;(o=game.socket)==null||o.emit(M.SOCKET_NAME,{event:"midi-qol.RollComplete",data:{workflow:kt.ParseWorkflow(r),rollCheck:kt.RollCheck(r)}})})}),(i=game.modules.get("ready-set-roll-5e"))!=null&&i.active&&window.Hooks.on("rsr5e.rollProcessed",function(r){return d(this,null,function*(){var o;(o=game.socket)==null||o.emit(M.SOCKET_NAME,{event:"rsr5e.rollProcessed",data:{workflow:_t.ParseWorkflow(r),rollCheck:_t.RollCheck(r)}})})}),window.Hooks.on("dnd5e.useItem",function(r){return d(this,null,function*(){var o,c,m;!((o=game.modules.get("midi-qol"))!=null&&o.active)&&!((c=game.modules.get("ready-set-roll-5e"))!=null&&c.active)&&((m=game.socket)==null||m.emit(M.SOCKET_NAME,{event:"dnd5e.useItem",data:{EncounterWorkflow:yield et.ParseHook(r,r.actor,"itemCard",void 0),ChatType:1}}))})}),window.Hooks.on("dnd5e.rollAttack",function(r,o){return d(this,null,function*(){var c,m,l;!((c=game.modules.get("midi-qol"))!=null&&c.active)&&!((m=game.modules.get("ready-set-roll-5e"))!=null&&m.active)&&((l=game.socket)==null||l.emit(M.SOCKET_NAME,{event:"dnd5e.rollAttack",data:{EncounterWorkflow:yield et.ParseHook(r,r.actor,"attack",o),ChatType:1}}))})}),window.Hooks.on("dnd5e.rollDamage",function(r,o){return d(this,null,function*(){var c,m,l;!((c=game.modules.get("midi-qol"))!=null&&c.active)&&!((m=game.modules.get("ready-set-roll-5e"))!=null&&m.active)&&((l=game.socket)==null||l.emit(M.SOCKET_NAME,{event:"dnd5e.rollDamage",data:{EncounterWorkflow:yield et.ParseHook(r,r.actor,"damage",o),ChatType:1}}))})}),window.Hooks.on("dnd5e.rollAbilityTest",function(r,o){return d(this,null,function*(){var c,m,l,s;(s=game.socket)==null||s.emit(M.SOCKET_NAME,{event:"dnd5e.rollAbilityTest",data:{result:(l=(m=(c=o==null?void 0:o.terms[0])==null?void 0:c.results)==null?void 0:m.find(h=>h.active===!0).result)!=null?l:0,alias:r.name,actorId:r.id,flavor:o.options.flavor}})})}),window.Hooks.on("dnd5e.rollAbilitySave",function(r,o){return d(this,null,function*(){var c,m,l,s;(s=game.socket)==null||s.emit(M.SOCKET_NAME,{event:"dnd5e.rollAbilitySave",data:{result:(l=(m=(c=o==null?void 0:o.terms[0])==null?void 0:c.results)==null?void 0:m.find(h=>h.active===!0).result)!=null?l:0,alias:r.name,actorId:r.id,flavor:o.options.flavor}})})}),window.Hooks.on("dnd5e.rollSkill",function(r,o){return d(this,null,function*(){var c,m,l,s;(s=game.socket)==null||s.emit(M.SOCKET_NAME,{event:"dnd5e.rollSkill",data:{result:(l=(m=(c=o==null?void 0:o.terms[0])==null?void 0:c.results)==null?void 0:m.find(h=>h.active===!0).result)!=null?l:0,alias:r.name,actorId:r.id,flavor:o.options.flavor}})})}),window.Hooks.on("encounter-stats.customEvent",function(r){return d(this,null,function*(){var o;(o=game.socket)==null||o.emit(M.SOCKET_NAME,{event:"encounter-stats.customEvent",data:{customEvent:r}})})}))})}static _setupSockerListeners(){var t;(t=game.socket)==null||t.on(M.SOCKET_NAME,function(e){return d(this,null,function*(){switch(e.event){case"encounter-stats.customEvent":ut(e.data.customEvent);break;case"rsr5e.rollProcessed":U(e.data.workflow,4),Dt(e.data.rollCheck);break;case"midi-qol.RollComplete":U(e.data.workflow,2),Dt(e.data.rollCheck),Z(e.data.workflow.diceTotal,e.data.rollCheck.name,e.data.workflow.actor.id);break;case"dnd5e.rollAttack":U(e.data.EncounterWorkflow,e.data.ChatType),Z(e.data.EncounterWorkflow.diceTotal,e.data.EncounterWorkflow.actorName,e.data.EncounterWorkflow.actorId);break;case"dnd5e.useItem":case"dnd5e.rollDamage":U(e.data.EncounterWorkflow,e.data.ChatType);break;case"dnd5e.rollAbilityTest":case"dnd5e.rollAbilitySave":case"dnd5e.rollSkill":Gt(e.data.result,e.data.alias,e.data.flavor),Z(e.data.result,e.data.alias,e.data.actorId);break}})})}static updateActorToken(t,e){return d(this,null,function*(){var n,a,i,r,o,c,m;I.IsInCombat()&&t.name&&!t.hasPlayerOwner&&((i=(a=(n=e.system)==null?void 0:n.attributes)==null?void 0:a.hp)==null?void 0:i.value)===0&&(o=(r=game.combat)==null?void 0:r.current)!=null&&o.tokenId&&Jt(t.name,game.combat.current.tokenId),(m=(c=e.system)==null?void 0:c.attributes)!=null&&m.hp&&t.id&&k.IsValidCombatant(t==null?void 0:t.type)&&Pt(t)})}},dt=M;dt.SOCKET_NAME="module.encounter-stats";var lt=class{static ParseHook(t,e,n,a){return d(this,null,function*(){var o,c,m,l,s,h,R;let i=(o=game.user)==null?void 0:o.targets.map(A=>({tokenId:A.id,name:A.name})),r=Array.from(i).length>0?Array.from(i).length:1;if(n==="damage")return{id:t.id+e.id,actor:{id:e.id,actorName:e.name},damageTotal:(c=a==null?void 0:a.total)!=null?c:0,damageMultipleEnemiesTotal:a!=null&&a.total?a.total*r:0,isCritical:(m=a==null?void 0:a.options.critical)!=null?m:!1,type:n};if(n==="attack")return{id:t.id+e.id,actor:{id:e.id},item:{id:t.id,name:t.name,link:t.link,type:t.type,img:t.img},attackTotal:(l=a==null?void 0:a.total)!=null?l:0,isFumble:((h=(s=a==null?void 0:a.terms[0])==null?void 0:s.results)==null?void 0:h.find(A=>A.active===!0).result)===1,advantage:(a==null?void 0:a.options.advantageMode)===1,disadvantage:(a==null?void 0:a.options.advantageMode)===-1,actionType:"mwak",enemyHit:i,type:n,diceTotal:(R=a==null?void 0:a.dice[0])==null?void 0:R.total}})}};var X=class{static Setup(){return d(this,null,function*(){var t;(t=game.user)!=null&&t.isGM?(X._setupSockerListeners(),window.Hooks.on("createChatMessage",function(e){return d(this,null,function*(){var a,i,r,o,c,m,l,s,h,R,A,at,nt,B,V,Y,w;let n=(r=(i=(a=e==null?void 0:e.flags)==null?void 0:a.pf2e)==null?void 0:i.context)==null?void 0:r.type;if(!n)if(e.isDamageRoll)n="damage-roll";else return;if(n==="attack-roll"||n==="spell-attack-roll"){let P=yield lt.ParseHook(e.item,e.actor,"attack",e.roll);U(P,3),Z((l=(m=(c=(o=e.roll)==null?void 0:o.terms[0])==null?void 0:c.results)==null?void 0:m.find(it=>it.active===!0).result)!=null?l:0,e.actor.name,e.actor.id)}if(n==="damage-roll"){let P=yield lt.ParseHook(e.item,e.item.actor,"damage",e.roll);U(P,3)}(n==="saving-throw"||n.indexOf("-check")>0)&&(Gt((A=(R=(h=(s=e.roll)==null?void 0:s.terms[0])==null?void 0:h.results)==null?void 0:R.find(P=>P.active===!0).result)!=null?A:0,e.actor.name,(nt=(at=e==null?void 0:e.flags)==null?void 0:at.pf2e)==null?void 0:nt.modifierName),Z((w=(Y=(V=(B=e.roll)==null?void 0:B.terms[0])==null?void 0:V.results)==null?void 0:Y.find(P=>P.active===!0).result)!=null?w:0,e.actor.name,e.actor.id))})}),window.Hooks.on("renderCombatTracker",function(e,n,a){return d(this,null,function*(){xt(a)})}),window.Hooks.on("createCombat",function(e){return d(this,null,function*(){Lt(e)})}),window.Hooks.on("updateCombat",function(e,n){return d(this,null,function*(){Ht(n.round)})}),window.Hooks.on("updateActor",function(e,n){return d(this,null,function*(){yield X.updateActorToken(e,n)})}),window.Hooks.on("updateToken",function(e,n){return d(this,null,function*(){yield X.updateActorToken(e,n)})}),Hooks.on("encounter-stats.customEvent",function(e){return d(this,null,function*(){ut(e)})})):(window.Hooks.on("updateActor",function(e,n){return d(this,null,function*(){var a;(a=game.socket)==null||a.emit(X.SOCKET_NAME,{event:"updateActor",data:{data:e,diff:n}})})}),window.Hooks.on("updateToken",function(e,n){return d(this,null,function*(){var a;(a=game.socket)==null||a.emit(X.SOCKET_NAME,{event:"updateToken",data:{data:e,diff:n}})})}))})}static _setupSockerListeners(){var t;(t=game.socket)==null||t.on(X.SOCKET_NAME,function(e){return d(this,null,function*(){switch(e.event){case"encounter-stats.customEvent":ut(e.data.customEvent);break}})})}static updateActorToken(t,e){return d(this,null,function*(){var n,a,i,r,o,c,m;I.IsInCombat()&&t.name&&!t.hasPlayerOwner&&((i=(a=(n=e.system)==null?void 0:n.attributes)==null?void 0:a.hp)==null?void 0:i.value)===0&&(o=(r=game.combat)==null?void 0:r.current)!=null&&o.tokenId&&Jt(t.name,game.combat.current.tokenId),(m=(c=e.system)==null?void 0:c.attributes)!=null&&m.hp&&t.id&&k.IsValidCombatant(t==null?void 0:t.type)&&Pt(t)})}},gt=X;gt.SOCKET_NAME="module.encounter-stats";var pt=class{static Setup(){return d(this,null,function*(){game.system.id==="dnd5e"?dt.Setup():game.system.id==="pf2e"&&gt.Setup(),window.Hooks.on("preDeleteCombat",function(t){return d(this,null,function*(){ge(t)})})})}};pt.SOCKET_NAME="module.encounter-stats";var ft=class extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{title:C.Get("Settings.StatisticsManagement"),template:"modules/encounter-stats/templates/settings.html",id:`${It}-chat-settings`,width:520,height:"500",closeOnSubmit:!0})}activateListeners(t){t.find("#encounter-stats-delete-statistics").on("click",this.deleteStatistics),t.find("#encounter-stats-export-statistics").on("click",this.exportSettingsToJSON),t.find("#encounter-stats-import-statistics").on("click",()=>d(this,null,function*(){(yield this.importFromJSONDialog())&&this.close()}))}getData(){}deleteStatistics(){var t;return j.DeleteStats(),(t=ui.notifications)==null?void 0:t.info(C.Get("Settings.CampaignStatsDeleted"))}_updateObject(t,e){}exportSettingsToJSON(){let t="encounter-stats-export.json";saveDataToFile(JSON.stringify(j.GetStats,null,2),"text/json",t)}importSettingsFromJSON(t){var e;return typeof t=="string"&&(t=JSON.parse(t)),j.DeleteStats(),H.Save(t),(e=ui.notifications)==null?void 0:e.info(C.Get("Settings.CampaignStatsImported"))}importFromJSONDialog(){return d(this,null,function*(){let t=yield renderTemplate("templates/apps/import-data.html",{entity:"encounter-stats",name:"Campaign Statistics"});return yield new Promise((n,a)=>{new Dialog({title:C.Get("Settings.ImportCampaignStatistics"),content:t,buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:C.Get("Settings.Import"),callback:i=>{var o;let r=i.find("form")[0];if(!r.data.files.length)return(o=ui.notifications)==null?void 0:o.error(C.Get("Settings.FileUploadError"));readTextFromFile(r.data.files[0]).then(c=>{this.importSettingsFromJSON(c),n(!0)})}},no:{icon:'<i class="fas fa-times"></i>',label:C.Get("Settings.Cancel"),callback:i=>n(!1)}},default:"import"},{width:400}).render(!0)})})}};function pe(u){let t=[];for(let e of u){let n=e;for(let[a,i]of game.settings.settings.entries())if(a===`${N}.${n}`){let r=game.settings.get(N,n),o=[],c=!1;if(i.choices){c=!0;for(let m in i.choices)o.push({key:m.toString(),value:i.choices[m],selected:m.toString()===r})}t.push({module:i.namespace?i.namespace:i.module,key:i.key,type:i.type.name,isBoolean:i.type.name==="Boolean",isString:i.type.name==="String"&&!i.choices,isArray:c,displayname:game.i18n.format(i.name),hint:i.hint?game.i18n.format(i.hint):"",choices:i.choices?i.choices:[],value:r,choicesSelect:o})}}return t}function fe(u){for(let t in u){let e=t.split(".");game.settings.set(e[0],e[1],u[t])}}var ht=class extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{title:C.Get("Settings.CampaignTrackingOptions"),template:"modules/encounter-stats/templates/tracking.html",id:`${It}-tracking-settings`,width:520,height:"500",closeOnSubmit:!0})}settingsList(t){return pe(t)}getData(){let t=[z,ot];return{modules:this.settingsList(t)}}_updateObject(t,e){fe(e)}};var te=class{static Register(){game.settings.register(`${N}`,`${Nt}`,{name:C.Get("opt_enable_name"),hint:C.Get("opt_enable_hint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register(`${N}`,`${se}`,{name:C.Get("opt_enable_export_json_name"),hint:C.Get("opt_enable_export_json_hint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.registerMenu(`${N}`,"CampaignStatsPanel",{name:C.Get("Settings.StatisticsManagement"),label:C.Get("Settings.Configure"),icon:"fas fa-cog",scope:"world",type:ft,restricted:!0}),game.settings.registerMenu(`${N}`,"CampaignTrackingPanel",{name:C.Get("Settings.CampaignTrackingOptions"),label:C.Get("Settings.Configure"),icon:"fas fa-cog",scope:"world",type:ht,restricted:!0}),game.settings.register(`${N}`,`${z}`,{name:C.Get("opt_enable_dice_streak_name"),hint:C.Get("opt_enable_dice_streak_hint"),scope:"world",config:!1,default:!0,type:Boolean}),game.settings.register(`${N}`,`${ot}`,{name:C.Get("opt_enable_dice_streak_to_chat_name"),hint:C.Get("opt_enable_dice_streak_to_chat_hint"),scope:"world",config:!1,default:!0,type:Boolean})}},he=te;Hooks.once("init",function(){return d(this,null,function*(){he.Register(),S.log("Settings Registered","module.init")})});Hooks.once("ready",function(){return d(this,null,function*(){var u;if(game.settings.get(`${N}`,`${Nt}`)){if((u=game.user)!=null&&u.isGM){J.IsJournalSetup||(yield J.CreateJournal());let t=yield J.GetCampaignJournal();t&&(j.SetStats(t),J.DeleteCampaignJournalEntryPageData())}pt.Setup(),S.log("Module Ready","module.ready")}})});})();
//# sourceMappingURL=module.js.map
